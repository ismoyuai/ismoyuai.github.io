<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>ã€AIå¤§æ¨¡å‹åº”ç”¨å­¦ä¹ ç¬”è®°ã€‘Windows11ç³»ç»Ÿæœ¬åœ°éƒ¨ç½²Difyå¹¶æ„å»ºRAGç³»ç»Ÿæ–¹æ¡ˆ</title>
      <link href="/ai-da-mo-xing-ying-yong-xue-xi-bi-ji-windows11-xi-tong-ben-di-bu-shu-dify-bing-gou-jian-rag-xi-tong-fang-an/"/>
      <url>/ai-da-mo-xing-ying-yong-xue-xi-bi-ji-windows11-xi-tong-ben-di-bu-shu-dify-bing-gou-jian-rag-xi-tong-fang-an/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€ã€ç¯å¢ƒå‡†å¤‡"><a href="#ä¸€ã€ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ä¸€ã€ç¯å¢ƒå‡†å¤‡"></a><strong>ä¸€ã€ç¯å¢ƒå‡†å¤‡</strong></h2><h3 id="1-1-å®‰è£…gitå·¥å…·"><a href="#1-1-å®‰è£…gitå·¥å…·" class="headerlink" title="1.1 å®‰è£…gitå·¥å…·"></a><strong>1.1 å®‰è£…gitå·¥å…·</strong></h3><h3 id="1-2-å®‰è£…docker"><a href="#1-2-å®‰è£…docker" class="headerlink" title="1.2 å®‰è£…docker"></a><strong>1.2 å®‰è£…docker</strong></h3><h4 id="1-2-1-ä¸‹è½½-Docker-Desktopï¼š"><a href="#1-2-1-ä¸‹è½½-Docker-Desktopï¼š" class="headerlink" title="1.2.1&nbsp;ä¸‹è½½ Docker Desktopï¼š"></a><strong>1.2.1&nbsp;ä¸‹è½½ Docker Desktop</strong>ï¼š</h4><ul><li>è®¿é—® Docker å®˜ç½‘ï¼š<a href="https://www.docker.com/">https://www.docker.com/</a>ã€‚</li><li>ç‚¹å‡»é¡µé¢ä¸Šçš„â€œDownload for Windows - AMD64â€æŒ‰é’®ï¼Œä»¥ä¸‹è½½é€‚ç”¨äº Windows ç³»ç»Ÿçš„ Docker Desktop å®‰è£…æ–‡ä»¶ã€‚</li></ul><h4 id="1-2-2-å®‰è£…-Docker-Desktopï¼š"><a href="#1-2-2-å®‰è£…-Docker-Desktopï¼š" class="headerlink" title="1.2.2&nbsp;å®‰è£… Docker Desktopï¼š"></a>1.2.2&nbsp;<strong>å®‰è£… Docker Desktop</strong>ï¼š</h4><ul><li>åŒå‡»ä¸‹è½½çš„å®‰è£…æ–‡ä»¶ï¼Œå¼€å§‹å®‰è£… Docker Desktopã€‚</li><li>æŒ‰ç…§å®‰è£…å‘å¯¼çš„æŒ‡ç¤ºå®Œæˆå®‰è£…ã€‚åœ¨å®‰è£…è¿‡ç¨‹ä¸­ï¼Œå°†æç¤ºå®‰è£…&nbsp;<strong>WSL 2</strong>ï¼Œå»ºè®®å‹¾é€‰æ­¤é€‰é¡¹ä»¥è·å¾—æ›´å¥½çš„æ€§èƒ½ã€‚</li></ul><h4 id="1-2-3-é…ç½®-Docker-Desktopï¼š"><a href="#1-2-3-é…ç½®-Docker-Desktopï¼š" class="headerlink" title="1.2.3&nbsp;é…ç½® Docker Desktopï¼š"></a>1.2.3&nbsp;<strong>é…ç½® Docker Desktop</strong>ï¼š</h4><ul><li><p>å®‰è£…å®Œæˆåï¼Œå¯åŠ¨&nbsp;<strong>Docker Desktop</strong>ã€‚</p></li><li><p>é¦–æ¬¡æ‰“å¼€æ—¶ï¼Œå°†å‡ºç° Docker è®¢é˜…åè®®ï¼Œç‚¹å‡»&nbsp;<code>Accept</code>ï¼ˆæ¥å—ï¼‰ä»¥ç»§ç»­ã€‚</p></li><li><p>éšåï¼Œç³»ç»Ÿå°†æç¤ºç”¨æˆ·ç™»å½•ã€‚æ‚¨å¯ä»¥é€‰æ‹©ä½¿ç”¨&nbsp;GitHub&nbsp;è´¦æˆ·æˆ– Google è´¦æˆ·ç™»å½•ï¼Œè‹¥æ— ä¸Šè¿°è´¦æˆ·ï¼Œå¯é€‰æ‹©è·³è¿‡ç™»å½•æ­¥éª¤ã€‚</p></li><li><p>æ¥ä¸‹æ¥ï¼Œå°†å‡ºç°è°ƒæŸ¥é—®å·ï¼Œæ‚¨å¯ä»¥æ ¹æ®ä¸ªäººå–œå¥½é€‰æ‹©å¡«å†™ï¼Œæˆ–ç›´æ¥è·³è¿‡æ­¤æ­¥éª¤ã€‚</p></li></ul><h3 id="1-3-æ±‰åŒ–-Docker-Desktopï¼ˆå¯é€‰ï¼‰"><a href="#1-3-æ±‰åŒ–-Docker-Desktopï¼ˆå¯é€‰ï¼‰" class="headerlink" title="1.3 æ±‰åŒ– Docker Desktopï¼ˆå¯é€‰ï¼‰"></a><strong>1.3 æ±‰åŒ– Docker Desktopï¼ˆå¯é€‰ï¼‰</strong></h3><p>è‹¥æƒ³ä½¿&nbsp;<strong>Docker Desktop</strong>&nbsp;æ˜¾ç¤ºä¸­æ–‡ç•Œé¢ï¼ŒæŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è¿›è¡Œæ±‰åŒ–ï¼š</p><h4 id="1-3-1-ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„ä¸­æ–‡è¯­è¨€åŒ…ï¼š"><a href="#1-3-1-ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„ä¸­æ–‡è¯­è¨€åŒ…ï¼š" class="headerlink" title="1.3.1&nbsp;ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„ä¸­æ–‡è¯­è¨€åŒ…ï¼š"></a><strong>1.3.1&nbsp;ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„ä¸­æ–‡è¯­è¨€åŒ…ï¼š</strong></h4><ul><li>è®¿é—® GitHubï¼Œä¸‹è½½é€‚ç”¨äº Docker Desktop çš„ä¸­æ–‡è¯­è¨€åŒ…ï¼ŒWindowsç³»ç»Ÿä¸‹ä¸‹è½½<code>app-Windows-x86.asar</code>  åŒ…å³å¯ï¼Œé“¾æ¥åœ°å€ä¸ºï¼š<a href="https://github.com/asxez/DockerDesktop-CN">DockerDesktop-CN</a>ã€‚</li><li>å°†ä¸‹è½½çš„æ–‡ä»¶ç§»åŠ¨åˆ°&nbsp;<code>C:\Program Files\Docker</code>&nbsp;ç›®å½•ä¸‹ï¼ˆå³ Docker çš„å®‰è£…æ ¹ç›®å½•ï¼‰ã€‚</li></ul><h4 id="1-3-2-æ£€æŸ¥-Docker-Desktop-ç‰ˆæœ¬ï¼š"><a href="#1-3-2-æ£€æŸ¥-Docker-Desktop-ç‰ˆæœ¬ï¼š" class="headerlink" title="1.3.2&nbsp;æ£€æŸ¥ Docker Desktop ç‰ˆæœ¬ï¼š"></a><strong>1.3.2&nbsp;æ£€æŸ¥ Docker Desktop ç‰ˆæœ¬ï¼š</strong></h4><ul><li>å¯åŠ¨ Docker Desktopï¼Œç‰ˆæœ¬å·å°†åœ¨<strong>å³ä¸‹è§’</strong>æ˜¾ç¤ºã€‚</li></ul><h4 id="1-3-3-å¤‡ä»½å¹¶æ›¿æ¢-app-asar-æ–‡ä»¶ï¼š"><a href="#1-3-3-å¤‡ä»½å¹¶æ›¿æ¢-app-asar-æ–‡ä»¶ï¼š" class="headerlink" title="1.3.3&nbsp;å¤‡ä»½å¹¶æ›¿æ¢ app.asar æ–‡ä»¶ï¼š"></a><strong>1.3.3&nbsp;å¤‡ä»½å¹¶æ›¿æ¢ app.asar æ–‡ä»¶ï¼š</strong></h4><ul><li>æ‰“å¼€ Docker Desktop ä¸­æ–‡è¯­è¨€åŒ…ï¼Œé€‰æ‹©ä¸æ‚¨ Docker ç‰ˆæœ¬ç›¸ç¬¦çš„&nbsp;<code>app.asar</code>&nbsp;æ–‡ä»¶å¹¶å¤åˆ¶ã€‚</li><li>å¯¼èˆªè‡³ Docker çš„å®‰è£…ç›®å½•ï¼Œè·¯å¾„é»˜è®¤ä¸ºï¼š<br>  <code>C:\Program Files\Docker\Docker\frontend\resources</code></li><li>åœ¨è¯¥ç›®å½•ä¸‹æ‰¾åˆ°&nbsp;<code>app.asar</code>&nbsp;æ–‡ä»¶ï¼Œå»ºè®®å…ˆå¤‡ä»½åŸæ–‡ä»¶ï¼Œç„¶åå°†å¤åˆ¶çš„ä¸­æ–‡è¯­è¨€åŒ…ä¸­çš„&nbsp;<code>app.asar</code>&nbsp;æ–‡ä»¶ç²˜è´´å¹¶æ›¿æ¢åŸæœ‰æ–‡ä»¶ã€‚</li></ul><h4 id="1-3-4-é‡æ–°å¯åŠ¨-Docker-Desktopï¼š"><a href="#1-3-4-é‡æ–°å¯åŠ¨-Docker-Desktopï¼š" class="headerlink" title="1.3.4 é‡æ–°å¯åŠ¨ Docker Desktopï¼š"></a><strong>1.3.4 é‡æ–°å¯åŠ¨ Docker Desktopï¼š</strong></h4><ul><li>å®Œæˆæ›¿æ¢åï¼Œè¯·å…³é—­ Docker Desktopï¼Œç„¶åé‡æ–°å¯åŠ¨è¯¥ç¨‹åºã€‚æ­¤æ—¶ï¼ŒDocker Desktop åº”è¯¥ä»¥ä¸­æ–‡ç•Œé¢æ˜¾ç¤ºã€‚</li></ul><h2 id="äºŒã€-Difyæœ¬åœ°éƒ¨ç½²æ­¥éª¤è¯¦è§£"><a href="#äºŒã€-Difyæœ¬åœ°éƒ¨ç½²æ­¥éª¤è¯¦è§£" class="headerlink" title="äºŒã€ Difyæœ¬åœ°éƒ¨ç½²æ­¥éª¤è¯¦è§£"></a><strong>äºŒã€ Difyæœ¬åœ°éƒ¨ç½²æ­¥éª¤è¯¦è§£</strong></h2><p>å…ˆè¿è¡Œæˆ‘ä»¬å®‰è£…çš„<code>docker Desktop</code>è½¯ä»¶</p><h3 id="2-1-å…‹éš†difyæœ¬åœ°ï¼Œè¾“å…¥å‘½ä»¤ï¼ˆç§‘å­¦ä¸Šç½‘ç¯å¢ƒè‡ªå¤‡ï¼‰ï¼š"><a href="#2-1-å…‹éš†difyæœ¬åœ°ï¼Œè¾“å…¥å‘½ä»¤ï¼ˆç§‘å­¦ä¸Šç½‘ç¯å¢ƒè‡ªå¤‡ï¼‰ï¼š" class="headerlink" title="2.1 å…‹éš†difyæœ¬åœ°ï¼Œè¾“å…¥å‘½ä»¤ï¼ˆç§‘å­¦ä¸Šç½‘ç¯å¢ƒè‡ªå¤‡ï¼‰ï¼š"></a><strong>2.1 å…‹éš†difyæœ¬åœ°ï¼Œè¾“å…¥å‘½ä»¤ï¼ˆç§‘å­¦ä¸Šç½‘ç¯å¢ƒè‡ªå¤‡ï¼‰ï¼š</strong></h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone https://github.com/langgenius/dify.git<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="2-2-ä½¿ç”¨Dockerä¸€é”®éƒ¨ç½²ï¼ˆæ¨èæ–°æ‰‹ï¼‰"><a href="#2-2-ä½¿ç”¨Dockerä¸€é”®éƒ¨ç½²ï¼ˆæ¨èæ–°æ‰‹ï¼‰" class="headerlink" title="**2.2 ä½¿ç”¨Dockerä¸€é”®éƒ¨ç½²ï¼ˆæ¨èæ–°æ‰‹ï¼‰"></a>**2.2 ä½¿ç”¨Dockerä¸€é”®éƒ¨ç½²ï¼ˆæ¨èæ–°æ‰‹ï¼‰</h3><p>è¿›å…¥<code>dify/docker</code>ç›®å½•ï¼Œæ‰“å¼€ç»ˆç«¯ï¼Œè¾“å…¥å‘½ä»¤ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> dify/docker<span class="token function">cp</span> .env.example .env<span class="token function">docker-compose</span> up <span class="token parameter variable">-d</span>  <span class="token comment"># å¯åŠ¨ä¸­é—´ä»¶ï¼ˆPostgreSQL/Redis/Weaviateï¼‰</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li><strong>éªŒè¯æœåŠ¡</strong>ï¼šè®¿é—®<code>http://localhost/apps</code>ï¼Œé¦–æ¬¡éœ€è®¾ç½®ç®¡ç†å‘˜è´¦å·ã€‚<br>å¦‚æœæˆåŠŸéƒ¨ç½²ï¼Œç»ˆç«¯å‡ºç°å†…å®¹å¦‚ä¸‹ï¼š</li></ul><pre class="line-numbers language-text" data-language="text"><code class="language-text">[+] Running 12/12 âœ” Network docker_default             Created                              0.4s âœ” Network docker_ssrf_proxy_network  Created                              0.1s âœ” Container docker-db-1              Healthy                              3.2s âœ” Container docker-redis-1           Starte...                            1.9s âœ” Container docker-web-1             Started                              1.2s âœ” Container docker-ssrf_proxy-1      S...                                 2.5s âœ” Container docker-sandbox-1         Star...                              2.5s âœ” Container docker-weaviate-1        Sta...                               2.5s âœ” Container docker-plugin_daemon-1   Started                              4.3s âœ” Container docker-api-1             Started                              4.1s âœ” Container docker-worker-1          Start...                             4.2s âœ” Container docker-nginx-1           Starte...                            4.9s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦‚æœå‡ºç°æŠ¥é”™ï¼Œæˆ‘ä»¬æ‰“å¼€Dockerï¼Œåœ¨è®¾ç½®çš„<code>Docker å¼•æ“</code> é‡Œé¢ï¼Œä¸€ä¸ªjsoné…ç½®æ–‡ä»¶çš„å…¥å£ï¼Œæˆ‘ä»¬åœ¨é‡Œé¢æ·»åŠ ä¸‹é¢å†…å®¹å¼€å¯å›½å†…é•œåƒåŠ é€Ÿï¼š<br>æ–¹æ³•ä¸€ï¼š</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"registry-mirrors"</span><span class="token operator">:</span> <span class="token punctuation">[</span>      <span class="token string">"https://docker.1ms.run"</span><span class="token punctuation">,</span>      <span class="token string">"https://docker.xuanyuan.me"</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token property">"proxies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token property">"default"</span><span class="token operator">:</span> <span class="token punctuation">{</span>      <span class="token property">"httpProxy"</span><span class="token operator">:</span> <span class="token string">"http://127.0.0.1:7890"</span><span class="token punctuation">,</span>      <span class="token property">"httpsProxy"</span><span class="token operator">:</span> <span class="token string">"http://127.0.0.1:7890"</span><span class="token punctuation">,</span>      <span class="token property">"noProxy"</span><span class="token operator">:</span> <span class="token string">"localhost,127.0.0.1,registry-1.docker.io,docker.io,docker.1ms.run,docker.xuanyuan.me"</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ–¹æ³•äºŒï¼š</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"proxies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token property">"default"</span><span class="token operator">:</span> <span class="token punctuation">{</span>      <span class="token property">"httpProxy"</span><span class="token operator">:</span> <span class="token string">"http://host.docker.internal:7890"</span><span class="token punctuation">,</span>      <span class="token property">"httpsProxy"</span><span class="token operator">:</span> <span class="token string">"http://host.docker.internal:7890"</span><span class="token punctuation">,</span>      <span class="token property">"noProxy"</span><span class="token operator">:</span> <span class="token string">"localhost,127.0.0.1,.local,host.docker.internal"</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é‡æ–°å¯åŠ¨Dockerï¼Œç„¶åé‡æ–°è¿›å…¥<code>dify/docker</code>ç›®å½•æ‰§è¡Œå‘½ä»¤ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker-compose</span> up <span class="token parameter variable">-d</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å¦‚æœéœ€è¦é‡å¯æ‰€æœ‰æœåŠ¡ï¼Œå¯ä»¥æ‰§è¡Œå‘½ä»¤ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker-compose</span> <span class="token parameter variable">-f</span> docker/docker-compose.yaml down <span class="token operator">&amp;&amp;</span> <span class="token function">docker-compose</span> <span class="token parameter variable">-f</span> docker/docker-compose.yaml up <span class="token parameter variable">-d</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="ä¸‰ã€æ¥å…¥-Ollama-éƒ¨ç½²çš„æœ¬åœ°æ¨¡å‹"><a href="#ä¸‰ã€æ¥å…¥-Ollama-éƒ¨ç½²çš„æœ¬åœ°æ¨¡å‹" class="headerlink" title="ä¸‰ã€æ¥å…¥ Ollama éƒ¨ç½²çš„æœ¬åœ°æ¨¡å‹"></a><strong>ä¸‰ã€æ¥å…¥ Ollama éƒ¨ç½²çš„æœ¬åœ°æ¨¡å‹</strong></h2><p><a href="https://github.com/jmorganca/ollama">Ollama</a>&nbsp;æ˜¯ä¸€æ¬¾è·¨å¹³å°æ¨ç†æ¡†æ¶å®¢æˆ·ç«¯ï¼ˆMacOSã€Windowsã€Linuxï¼‰ï¼Œä¸“ä¸ºæ— ç¼éƒ¨ç½²å¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰ï¼ˆå¦‚ Llama 2ã€Mistralã€Llava ç­‰ï¼‰è€Œè®¾è®¡ã€‚é€šè¿‡ä¸€é”®å¼è®¾ç½®ï¼ŒOllama å¯ä»¥åœ¨æœ¬åœ°è¿è¡Œ LLMï¼Œå°†æ‰€æœ‰äº¤äº’æ•°æ®ä¿å­˜åœ¨è‡ªå·±çš„æœºå™¨ä¸Šï¼Œä»è€Œæé«˜æ•°æ®çš„ç§å¯†æ€§å’Œå®‰å…¨æ€§ã€‚</p><h3 id="ä¸‹è½½å¹¶å¯åŠ¨-Ollama"><a href="#ä¸‹è½½å¹¶å¯åŠ¨-Ollama" class="headerlink" title="ä¸‹è½½å¹¶å¯åŠ¨ Ollama"></a><strong>ä¸‹è½½å¹¶å¯åŠ¨ Ollama</strong></h3><ol><li><p>ä¸‹è½½ Ollama<br> è®¿é—®&nbsp;<a href="https://ollama.com/download">Ollama ä¸‹è½½é¡µ</a>ï¼Œä¸‹è½½å¯¹åº”ç³»ç»Ÿ Ollama å®¢æˆ·ç«¯ã€‚</p></li><li><p>è¿è¡Œ Ollama å¹¶ä¸ Llama3.2 èŠå¤©</p> <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ollama run llama3.2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p> å¯åŠ¨æˆåŠŸåï¼Œollama åœ¨æœ¬åœ° 11434 ç«¯å£å¯åŠ¨äº†ä¸€ä¸ª API æœåŠ¡ï¼Œå¯é€šè¿‡&nbsp;<code>http://localhost:11434</code>&nbsp;è®¿é—®ã€‚<br> å¦‚éœ€è¿è¡Œå…¶å®ƒæ¨¡å‹ï¼Œè®¿é—®&nbsp;<a href="https://ollama.com/library">Ollama Models</a>&nbsp;äº†è§£è¯¦æƒ…ã€‚</p></li><li><p>åœ¨ Dify ä¸­æ¥å…¥ Ollama</p><p> åœ¨&nbsp;<code>è®¾ç½® &gt; æ¨¡å‹ä¾›åº”å•† &gt; Ollama</code>&nbsp;ä¸­å¡«å…¥ï¼š<br> <img src="https://assets-docs.dify.ai/dify-enterprise-mintlify/zh_CN/development/models-integration/981679ae2e56d49e5a983e37cc134172.png"></p><ul><li><p>æ¨¡å‹åç§°ï¼š<code>llama3.2</code></p></li><li><p>åŸºç¡€ URLï¼š<code>http://&lt;your-ollama-endpoint-domain&gt;:11434</code><br>  æ­¤å¤„éœ€å¡«å†™ Ollama æœåŠ¡åœ°å€ã€‚è¿™é‡Œåˆ†å‡ ç§æƒ…å†µï¼š</p><ul><li>è‹¥ Dify ä¸º Docker éƒ¨ç½²ï¼Œå»ºè®®å¡«å†™å±€åŸŸç½‘ IP åœ°å€ï¼Œä¾‹å¦‚ï¼š<br>  <code>http://192.168.1.100:11434</code>&nbsp;æˆ– Docker å®¹å™¨çš„å†…éƒ¨ IP åœ°å€ï¼Œä¾‹å¦‚ï¼š<code>http://host.docker.internal:11434</code>ã€‚</li><li>è‹¥ä¸ºæœ¬åœ°æºç éƒ¨ç½²ï¼Œå¯å¡«å†™&nbsp;<code>http://localhost:11434</code>ã€‚</li></ul></li><li><p>æ¨¡å‹ç±»å‹ï¼š<code>å¯¹è¯</code></p></li><li><p>æ¨¡å‹ä¸Šä¸‹æ–‡é•¿åº¦ï¼š<code>4096</code><br>  æ¨¡å‹çš„æœ€å¤§ä¸Šä¸‹æ–‡é•¿åº¦ï¼Œè‹¥ä¸æ¸…æ¥šå¯å¡«å†™é»˜è®¤å€¼ 4096ã€‚</p></li><li><p>æœ€å¤§ token ä¸Šé™ï¼š<code>4096</code><br>  æ¨¡å‹è¿”å›å†…å®¹çš„æœ€å¤§ token æ•°é‡ï¼Œè‹¥æ¨¡å‹æ— ç‰¹åˆ«è¯´æ˜ï¼Œåˆ™å¯ä¸æ¨¡å‹ä¸Šä¸‹æ–‡é•¿åº¦ä¿æŒä¸€è‡´ã€‚</p></li><li><p>æ˜¯å¦æ”¯æŒ Visionï¼š<code>æ˜¯</code><br>  å½“æ¨¡å‹æ”¯æŒå›¾ç‰‡ç†è§£ï¼ˆå¤šæ¨¡æ€ï¼‰å‹¾é€‰æ­¤é¡¹ï¼Œå¦‚&nbsp;<code>llava</code>ã€‚</p></li><li><p>æ˜¯å¦æ”¯æŒå‡½æ•°è°ƒç”¨ï¼š<code>æ˜¯</code></p></li></ul><p> ç‚¹å‡» â€œä¿å­˜â€ æ ¡éªŒæ— è¯¯åå³å¯åœ¨åº”ç”¨ä¸­ä½¿ç”¨è¯¥æ¨¡å‹ã€‚</p><p> Embedding æ¨¡å‹æ¥å…¥æ–¹å¼ä¸ LLM ç±»ä¼¼ï¼Œåªéœ€å°†æ¨¡å‹ç±»å‹æ”¹ä¸º Text Embedding å³å¯ã€‚ </p></li><li><p>ä½¿ç”¨ Ollama æ¨¡å‹<br> <img src="https://assets-docs.dify.ai/dify-enterprise-mintlify/zh_CN/development/models-integration/0561ed1f5c265689b504ff539f5d3edd.png"></p><p> è¿›å…¥éœ€è¦é…ç½®çš„ App æç¤ºè¯ç¼–æ’é¡µé¢ï¼Œé€‰æ‹© Ollama ä¾›åº”å•†ä¸‹çš„&nbsp;<code>llava</code>&nbsp;æ¨¡å‹ï¼Œé…ç½®æ¨¡å‹å‚æ•°åå³å¯ä½¿ç”¨ã€‚ä¹Ÿå¯ä»¥é…ç½®ä½ è‡ªå·±åœ¨Ollamaä¸­ä¸‹è½½çš„æ¨¡å‹</p></li></ol><h2 id="å››ã€ä½¿ç”¨Difyæ„å»ºRAG"><a href="#å››ã€ä½¿ç”¨Difyæ„å»ºRAG" class="headerlink" title="å››ã€ä½¿ç”¨Difyæ„å»ºRAG"></a><strong>å››ã€ä½¿ç”¨Difyæ„å»ºRAG</strong></h2><h3 id="4-1-ollamaå®‰è£…-Embedding-æ¨¡å‹"><a href="#4-1-ollamaå®‰è£…-Embedding-æ¨¡å‹" class="headerlink" title="4.1 ollamaå®‰è£… Embedding æ¨¡å‹"></a>4.1 ollamaå®‰è£… Embedding æ¨¡å‹</h3><p>é€šè¿‡ ollama æ¥å®‰è£…Embeddingæ¨¡å‹ï¼Œè¿è¡Œå‘½ä»¤ä¸‹è½½ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ollama run nn200433/text2vec-bge-large-chinese<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="4-2-åœ¨-Dify-ä¸­æ¥å…¥-Ollama"><a href="#4-2-åœ¨-Dify-ä¸­æ¥å…¥-Ollama" class="headerlink" title="4.2 åœ¨ Dify ä¸­æ¥å…¥ Ollama"></a>4.2 åœ¨ Dify ä¸­æ¥å…¥ Ollama</h3><p>åœ¨&nbsp;<code>è®¾ç½® &gt; æ¨¡å‹ä¾›åº”å•† &gt; Ollama</code>&nbsp;ä¸­å¡«å…¥ï¼š<br>è®¾ç½®åŒä¸Šé¢æ·»åŠ å¤§æ¨¡å‹ä¸€æ ·ï¼Œåªéœ€è¦åœ¨é€‰æ‹©æ¨¡å‹ç±»å‹æ—¶é€‰ï¼š<code>Text Embedding</code></p><h3 id="4-3-çŸ¥è¯†åº“åˆ›å»º"><a href="#4-3-çŸ¥è¯†åº“åˆ›å»º" class="headerlink" title="4.3 çŸ¥è¯†åº“åˆ›å»º"></a>4.3 çŸ¥è¯†åº“åˆ›å»º</h3><p>è¿›å…¥DifyçŸ¥è¯†åº“ç•Œé¢ï¼Œç‚¹å‡»åˆ›å»ºçŸ¥è¯†åº“<br><img src="https://pic1.imgdb.cn/item/6825a12358cb8da5c8f2ea26.png"></p><p>è¿›å…¥ç•Œé¢åï¼Œæˆ‘ä»¬å¯¹çŸ¥è¯†åº“è¿›è¡Œä¸€ä¸ªåŸºç¡€è®¾ç½®ï¼š<br><img src="https://pic1.imgdb.cn/item/6825a12358cb8da5c8f2ea21.png"></p><p>çŸ¥è¯†åº“é…ç½®å¥½åï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨æˆ‘ä»¬åˆ›å»ºçš„åº”ç”¨ä¸‹å¼•ç”¨æˆ‘ä»¬çš„çŸ¥è¯†åº“<br><img src="https://pic1.imgdb.cn/item/6825a21658cb8da5c8f2f3c9.png"></p><h2 id="é—®é¢˜è®°å½•"><a href="#é—®é¢˜è®°å½•" class="headerlink" title="é—®é¢˜è®°å½•"></a>é—®é¢˜è®°å½•</h2><p>ç³»ç»Ÿç¯å¢ƒï¼š<br>WSL2-Ubuntu22.04 + docker desktop + dify</p><p>difyæ·»åŠ  OpenAI API Keyæ²¡æœ‰ååº”</p><p>dockerå®¹å™¨ä¸­æ—¥å¿—ï¼š</p><pre class="line-numbers language-none"><code class="language-none">2025/05/14 10:53:50 run.go:132: [ERROR]plugin langgenius/openai:0.0.22 exited with error: exit status 10453ede311196acaad0531ad9e3d5561cd622e6508cd3254/main.py", line 7, in &lt;module&gt;plugin = Plugin(DifyPluginEnv())^^^^^^^^^^^^^^^File "/app/storage/cwd/langgenius/openai-0.0.22@fa668d0ec3b434270453ede311196acaad0531ad9e3d5561cd622e6508cd3254/.venv/lib/python3.12/site-packages/pydantic_settings/main.py", line 176, in __init__super().__init__(File "/app/storage/cwd/langgenius/openai-0.0.22@fa668d0ec3b434270453ede311196acaad0531ad9e3d5561cd622e6508cd3254/.venv/lib/python3.12/site-packages/pydantic/main.py", line 253, in __init__validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^pydantic_core._pydantic_core.ValidationError: 1 validation error for DifyPluginEnvREMOTE_INSTALL_URLField required [type=missing, input_value={'INSTALL_METHOD': 'local'}, input_type=dict]For further information visit [https://errors.pydantic.dev/2.11/v/missingâ ](https://errors.pydantic.dev/2.11/v/missing)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>dockerå®¹å™¨ä¸­APIå®¹å™¨æ—¥å¿—ï¼š</p><pre class="line-numbers language-none"><code class="language-none">2025-05-14 11:00:50.513 ERROR [Dummy-2] [app.py:875] - Exception on /console/api/workspaces/current/model-providers/langgenius/openai/openai [POST]Traceback (most recent call last):File "/app/api/.venv/lib/python3.12/site-packages/flask/app.py", line 917, in full_dispatch_requestrv = self.dispatch_request()^^^^^^^^^^^^^^^^^^^^^^^File "/app/api/.venv/lib/python3.12/site-packages/flask/app.py", line 902, in dispatch_requestreturn self.ensure_sync(self.view_functions[rule.endpoint])(**view_args) # type: ignore[no-any-return]^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^File "/app/api/.venv/lib/python3.12/site-packages/flask_restful/__init__.py", line 489, in wrapperresp = resource(*args, **kwargs)^^^^^^^^^^^^^^^^^^^^^^^^^File "/app/api/.venv/lib/python3.12/site-packages/flask/views.py", line 110, in viewreturn current_app.ensure_sync(self.dispatch_request)(**kwargs) # type: ignore[no-any-return]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> AIå¤§æ¨¡å‹åº”ç”¨å¼€å‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> RAG </tag>
            
            <tag> Dify </tag>
            
            <tag> Agent </tag>
            
            <tag> AI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€é¡¹ç›®å®æˆ˜ã€‘å¤§æ¨¡å‹å¾®è°ƒ-æƒ…ç»ªå¯¹è¯æ¨¡å‹</title>
      <link href="/xiang-mu-shi-zhan-da-mo-xing-wei-diao-qing-xu-dui-hua-mo-xing/"/>
      <url>/xiang-mu-shi-zhan-da-mo-xing-wei-diao-qing-xu-dui-hua-mo-xing/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€ã€é¡¹ç›®ä»‹ç»"><a href="#ä¸€ã€é¡¹ç›®ä»‹ç»" class="headerlink" title="ä¸€ã€é¡¹ç›®ä»‹ç»"></a>ä¸€ã€<strong>é¡¹ç›®ä»‹ç»</strong></h2><h3 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a><strong>èƒŒæ™¯</strong></h3><p>åœ¨çœ‹æŠ–éŸ³æ—¶ç»å¸¸åˆ·åˆ°ä¸€ä¸ªå°æ™ºèŠå¤©æœºå™¨äººï¼Œå‘ç°å®ƒåœ¨å›ç­”æ—¶å…·æœ‰éå¸¸å¼ºçƒˆå’Œä¸ªæ€§åŒ–çš„æƒ…ç»ªè¡¨è¾¾ï¼Œä½¿ç”¨å°±å‡†å¤‡ä»¥æ­¤ä¸ºç›®æ ‡ï¼Œè‡ªå·±å°è¯•åšä¸€ä¸ªè¿™æ ·çš„æƒ…ç»ªå¯¹è¯å¤§æ¨¡å‹ã€‚<br>åŠ ä¸Šåœ¨äººå·¥æ™ºèƒ½æŠ€æœ¯å¿«é€Ÿå‘å±•çš„ä»Šå¤©ï¼Œå¯¹è¯ç³»ç»Ÿå·²å¹¿æ³›åº”ç”¨äºå®¢æœã€å¿ƒç†è¾…å¯¼ã€ç¤¾äº¤å¨±ä¹ç­‰é¢†åŸŸã€‚ä¾‹å¦‚ï¼Œåœ¨å¿ƒç†å’¨è¯¢åœºæ™¯ä¸­ï¼Œæ¨¡å‹éœ€è¯†åˆ«ç”¨æˆ·çš„ç„¦è™‘æˆ–æŠ‘éƒæƒ…ç»ªå¹¶ç»™å‡ºå…±æƒ…å›åº”ï¼›åœ¨ç”µå•†å®¢æœä¸­ï¼Œéœ€å¯¹ç”¨æˆ·çš„ä¸æ»¡æƒ…ç»ªè¿›è¡Œå®‰æŠšã€‚<br>å› æ­¤ï¼Œ<strong>æ„å»ºå…·å¤‡æƒ…ç»ªæ„ŸçŸ¥èƒ½åŠ›çš„å¯¹è¯æ¨¡å‹</strong>ä¹Ÿæ˜¯ä¸€ä¸ªéå¸¸æœ‰ä»·å€¼çš„äº‹æƒ…ã€‚</p><h3 id="é¡¹ç›®ç›®æ ‡"><a href="#é¡¹ç›®ç›®æ ‡" class="headerlink" title="é¡¹ç›®ç›®æ ‡"></a><strong>é¡¹ç›®ç›®æ ‡</strong></h3><p>æœ¬é¡¹ç›®æ—¨åœ¨é€šè¿‡å®æˆ˜å¾®è°ƒä¸€ä¸ª<strong>æƒ…ç»ªå¯¹è¯æ¨¡å‹</strong>ï¼Œè¦†ç›–æ•°æ®æ”¶é›†ã€æ¨¡å‹è®­ç»ƒã€è¯„ä¼°ä¼˜åŒ–åˆ°éƒ¨ç½²çš„å…¨æµç¨‹ï¼Œé‡ç‚¹è§£å†³ä»¥ä¸‹é—®é¢˜ï¼š</p><ul><li><p>å¦‚ä½•ä»å¤šæ¥æºæ•°æ®ä¸­æ„å»ºé«˜è´¨é‡çš„æƒ…ç»ªå¯¹è¯æ•°æ®é›†ï¼Ÿ</p></li><li><p>å¦‚ä½•é€‰æ‹©åˆé€‚çš„é¢„è®­ç»ƒæ¨¡å‹å¹¶é’ˆå¯¹æ€§ä¼˜åŒ–å…¶æƒ…æ„Ÿç”Ÿæˆèƒ½åŠ›ï¼Ÿ</p></li><li><p>å¦‚ä½•å¹³è¡¡ç”Ÿæˆå†…å®¹çš„æµç•…æ€§ä¸æƒ…ç»ªå‡†ç¡®æ€§ï¼Ÿ</p></li><li><p>å¦‚ä½•å°†æ¨¡å‹é«˜æ•ˆéƒ¨ç½²åˆ°å®é™…åº”ç”¨åœºæ™¯ï¼Ÿ</p></li></ul><h2 id="äºŒã€æ•°æ®æ”¶é›†ä¸å¤„ç†"><a href="#äºŒã€æ•°æ®æ”¶é›†ä¸å¤„ç†" class="headerlink" title="äºŒã€æ•°æ®æ”¶é›†ä¸å¤„ç†"></a><strong>äºŒã€æ•°æ®æ”¶é›†ä¸å¤„ç†</strong></h2><h3 id="2-1-æ•°æ®æ¥æº"><a href="#2-1-æ•°æ®æ¥æº" class="headerlink" title="2.1 æ•°æ®æ¥æº"></a>2.1 <strong>æ•°æ®æ¥æº</strong></h3><p>æœ¬æ¬¡é¡¹ç›®æ•°æ®æ¥æºä¸»è¦æœ‰ä¸¤ç‚¹ï¼š</p><ol><li>äººå·¥åˆ¶å®š</li><li>åŸºäºç°æœ‰å¼€æºæ•°æ®ï¼Œè®©AIå®ç°æƒ…ç»ªæ•°æ®é›†åˆ¶ä½œã€‚</li></ol><blockquote><p>æ³¨æ„ï¼šå¦‚æœè®©AIæ¥å¸®åŠ©å¤„ç†æ•°æ®ï¼Œå°½å¯èƒ½é€‰æ‹©æ•ˆæœè¾ƒå¥½çš„APIæ¥å£ï¼Œä¸è¦ä½¿ç”¨æœ¬åœ°çš„å¤§æ¨¡å‹æ¥å¤„ç†ã€‚</p></blockquote><h3 id="2-2-æ•°æ®æ ‡æ³¨å·¥å…·ä¸æ–¹æ³•"><a href="#2-2-æ•°æ®æ ‡æ³¨å·¥å…·ä¸æ–¹æ³•" class="headerlink" title="2.2 æ•°æ®æ ‡æ³¨å·¥å…·ä¸æ–¹æ³•"></a>2.2 <strong>æ•°æ®æ ‡æ³¨å·¥å…·ä¸æ–¹æ³•</strong></h3><p>æœ¬é¡¹ç›®æ•°æ®ä¸»è¦æ˜¯æ ¹æ®å…¬å¼€æ•°æ®é›†ç„¶åä½¿ç”¨Pythonä»£ç +AIå¤§æ¨¡å‹æ¥è¿›è¡Œç”Ÿæˆï¼Œæ²¡æœ‰ç”¨åˆ°å…¶ä»–æ ‡æ³¨å·¥å…·å’Œæ–¹æ³•ã€‚</p><h3 id="2-3-æ•°æ®æ¸…æ´—ä¸é¢„å¤„ç†"><a href="#2-3-æ•°æ®æ¸…æ´—ä¸é¢„å¤„ç†" class="headerlink" title="2.3 æ•°æ®æ¸…æ´—ä¸é¢„å¤„ç†"></a>2.3 <strong>æ•°æ®æ¸…æ´—ä¸é¢„å¤„ç†</strong></h3><p>é€šè¿‡Pythonä»£ç æŒ‡å®šæ•°æ®ç”Ÿæˆæ¨¡æ¿ï¼Œç„¶ååŸºäºæ”¶é›†çš„é—®é¢˜æ¥è®©AIè¿›è¡Œè‡ªåŠ¨ç”Ÿæˆï¼Œå¹¶è®¾ç½®è§„åˆ™ï¼Œè®©AIç”Ÿæˆç¬¦åˆæˆ‘ä»¬éœ€æ±‚çš„é«˜è´¨é‡çš„æ•°æ®ã€‚</p><p>æ•°æ®æ¸…æ´—å’Œé¢„å¤„ç†æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li><p>è®¾ç½®æ•°æ®é£æ ¼æ¨¡æ¿ï¼ˆä¸»è¦ä¿®æ­£æ¶ˆæ¯æ ¼å¼ï¼‰</p><ul><li>è®©AIå¤§æ¨¡å‹æŒ‰ç…§æˆ‘ä»¬æƒ³è¦çš„æ•°æ®æ¨¡æ¿è¿›è¡Œç”Ÿæˆ</li></ul></li><li><p>ç”Ÿæˆå‡½æ•°ï¼ˆä¸»è¦ä¿®æ­£æ¶ˆæ¯çš„ç»“æ„ï¼‰</p><ul><li>è°ƒç”¨å¤§æ¨¡å‹APIæ¥å‡†å¤‡ç”Ÿæˆæ•°æ®å¹¶è¿”å›</li></ul></li><li><p>è®¾ç½®æ•°æ®è´¨é‡è¿‡æ»¤è§„åˆ™ï¼ˆæ·»åŠ ç©ºå€¼æ£€æŸ¥ï¼‰</p><ul><li>è§„åˆ™1ï¼šå›å¤é•¿åº¦æ£€æŸ¥</li><li>è§„åˆ™2ï¼šé£æ ¼å…³é”®è¯æ£€æŸ¥</li><li>è§„åˆ™3ï¼šè¯­ä¹‰ç›¸ä¼¼åº¦æ£€æŸ¥</li></ul></li><li><p>æ‰§è¡Œç”Ÿæˆï¼ˆæ·»åŠ å®¹é”™ï¼‰</p></li></ul><h3 id="2-4-æ•°æ®åˆ’åˆ†"><a href="#2-4-æ•°æ®åˆ’åˆ†" class="headerlink" title="2.4 æ•°æ®åˆ’åˆ†"></a>2.4 <strong>æ•°æ®åˆ’åˆ†</strong></h3><p>è®­ç»ƒé›†ã€éªŒè¯é›†ã€æµ‹è¯•é›†åˆ’åˆ†</p><h2 id="ä¸‰ã€æ•°æ®æ”¶é›†ä¸å¤„ç†ï¼ˆå®ç°ç¯‡ï¼‰"><a href="#ä¸‰ã€æ•°æ®æ”¶é›†ä¸å¤„ç†ï¼ˆå®ç°ç¯‡ï¼‰" class="headerlink" title="ä¸‰ã€æ•°æ®æ”¶é›†ä¸å¤„ç†ï¼ˆå®ç°ç¯‡ï¼‰"></a><strong>ä¸‰ã€æ•°æ®æ”¶é›†ä¸å¤„ç†ï¼ˆå®ç°ç¯‡ï¼‰</strong></h2><h3 id="3-1-æ•°æ®æ”¶é›†æ•´ç†"><a href="#3-1-æ•°æ®æ”¶é›†æ•´ç†" class="headerlink" title="3.1 æ•°æ®æ”¶é›†æ•´ç†"></a><strong>3.1 æ•°æ®æ”¶é›†æ•´ç†</strong></h3><p>ä½¿ç”¨çš„æ˜¯å…¬å¼€çš„<a href="https://github.com/thu-coai/CDial-GPT">CDial-GPT</a>æ•°æ®é›†<br>è¿˜æœ‰é­”å¡”ç¤¾åŒºçš„ <a href="https://www.modelscope.cn/datasets/OmniData/LCCC">LCCC</a> æ•°æ®é›†</p><p>æ•°æ®é›†ä¸‹è½½åï¼Œåœ¨é‡Œé¢æŒ‘é€‰ 1000~3000 æ¡æ•°æ®å³å¯</p><h3 id="3-2-é…ç½®æ–‡ä»¶åˆ›å»º"><a href="#3-2-é…ç½®æ–‡ä»¶åˆ›å»º" class="headerlink" title="3.2 é…ç½®æ–‡ä»¶åˆ›å»º"></a>3.2 é…ç½®æ–‡ä»¶åˆ›å»º</h3><p>ä¸»è¦ç”¨æ¥å­˜æ”¾æˆ‘ä»¬çš„ API å¯†åŒ™ã€æ¨¡å‹æœ¬åœ°è·¯å¾„ç­‰æ•æ„Ÿé…ç½®ä»¥åŠé£æ ¼æ¨¡æ¿é…ç½®</p><p>æ‰“å¼€ Pycharm æ–°å»ºä¸€ä¸ª<code>emotion_dialogue_tuner</code>é¡¹ç›®ï¼Œåœ¨é¡¹ç›®ä¸‹æ–°å»º <code>config</code> ç›®å½•ï¼Œç„¶åæ–°å»º<code>config/settings.yaml</code>å’Œ<code>config/style_config.json</code>æ–‡ä»¶ï¼Œåˆ†åˆ«ç”¨æ¥å­˜æ”¾<strong>APIå¯†é’¥ç­‰æ•æ„Ÿé…ç½®</strong>å’Œ<strong>é£æ ¼æ¨¡æ¿é…ç½®</strong></p><p><code>settings.yaml</code>æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">API</span><span class="token punctuation">:</span>  <span class="token key atrule">ZHIPU_API_KEY</span><span class="token punctuation">:</span> <span class="token string">"your_api_key_here"</span>  <span class="token comment"># æ•æ„Ÿä¿¡æ¯éš”ç¦»</span>  <span class="token key atrule">MODEL_NAME</span><span class="token punctuation">:</span> <span class="token string">"glm-3-turbo"</span><span class="token key atrule">PATHS</span><span class="token punctuation">:</span>  <span class="token key atrule">EMBEDDING_MODEL</span><span class="token punctuation">:</span> <span class="token string">"embedding_model/thomas/text2vec-base-chinese"</span>  <span class="token comment"># ä½ æœ¬åœ°embeddingæ¨¡å‹è·¯å¾„</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>æˆ‘embeddingæ¨¡å‹é€‰æ‹©çš„æ˜¯thomas/text2vec-base-chineseï¼Œå¯ä»¥åœ¨é­”å¡”ç¤¾åŒºä¸‹è½½</p></blockquote><p><code>style_config.json</code>æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>      <span class="token property">"æ¸©æŸ”"</span><span class="token operator">:</span><span class="token punctuation">{</span>          <span class="token property">"system_prompt"</span><span class="token operator">:</span><span class="token string">"ä½ æ˜¯ä¸€ä¸ªæ¸©æŸ”ä½“è´´çš„èŠå¤©åŠ©æ‰‹ï¼Œè¯´è¯æ—¶æ€»æ˜¯å……æ»¡å…³æ€€ï¼Œä½¿ç”¨ä»¥ä¸‹ç‰¹å¾ï¼š\n1. åŒ…å«'å‘¢ã€å‘€ã€å•¦'ç­‰è¯­æ°”è¯\n2. ä½¿ç”¨ğŸŒ¸ğŸ’–ğŸ˜Šç­‰æ¸©æš–è¡¨æƒ…\n3. ä¸»åŠ¨è¯¢é—®ç”¨æˆ·æ„Ÿå—"</span><span class="token punctuation">,</span>          <span class="token property">"examples"</span><span class="token operator">:</span> <span class="token punctuation">[</span>              <span class="token punctuation">{</span><span class="token property">"role"</span><span class="token operator">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token property">"content"</span><span class="token operator">:</span> <span class="token string">"ä»Šå¤©å¥½ç´¯å•Š"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>              <span class="token punctuation">{</span><span class="token property">"role"</span><span class="token operator">:</span> <span class="token string">"assistant"</span><span class="token punctuation">,</span> <span class="token property">"content"</span><span class="token operator">:</span> <span class="token string">"è¾›è‹¦å•¦~ è¦ç»™è‡ªå·±æ³¡æ¯çƒ­èŒ¶æ”¾æ¾ä¸€ä¸‹å—ï¼ŸğŸŒ¸"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>              <span class="token punctuation">{</span><span class="token property">"role"</span><span class="token operator">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token property">"content"</span><span class="token operator">:</span> <span class="token string">"è€ƒè¯•æ²¡è€ƒå¥½..."</span><span class="token punctuation">}</span><span class="token punctuation">,</span>              <span class="token punctuation">{</span><span class="token property">"role"</span><span class="token operator">:</span> <span class="token string">"assistant"</span><span class="token punctuation">,</span> <span class="token property">"content"</span><span class="token operator">:</span> <span class="token string">"æ²¡å…³ç³»çš„å‘€~ ä¸‹æ¬¡ä¸€å®šä¼šæ›´å¥½ï¼éœ€è¦æˆ‘é™ªä½ èŠèŠå—ï¼ŸğŸ˜Š"</span><span class="token punctuation">}</span>          <span class="token punctuation">]</span><span class="token punctuation">,</span>     <span class="token property">"temperature"</span><span class="token operator">:</span> <span class="token number">0.3</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span>      <span class="token property">"æ¯’èˆŒ"</span><span class="token operator">:</span><span class="token punctuation">{</span>          <span class="token property">"system_prompt"</span><span class="token operator">:</span><span class="token string">"ä½ æ˜¯ä¸€ä¸ªå–œæ¬¢ç”¨çŠ€åˆ©åæ§½è¡¨è¾¾å…³å¿ƒçš„æœ‹å‹ï¼Œéœ€æ»¡è¶³ï¼š\n1. ä½¿ç”¨ç½‘ç»œæµè¡Œè¯­ï¼ˆå¦‚'æ “Q''é€€é€€é€€'ï¼‰\n2. åŒ…å«å¤¸å¼ æ¯”å–»ï¼ˆ'ä½ è¿™é€Ÿåº¦å ªæ¯”æ ‘æ‡’'ï¼‰\n3. ç»“å°¾éšè—å…³å¿ƒ"</span><span class="token punctuation">,</span>          <span class="token property">"examples"</span><span class="token operator">:</span> <span class="token punctuation">[</span>              <span class="token punctuation">{</span><span class="token property">"role"</span><span class="token operator">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token property">"content"</span><span class="token operator">:</span> <span class="token string">"åˆèƒ–äº†5æ–¤ï¼"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>              <span class="token punctuation">{</span><span class="token property">"role"</span><span class="token operator">:</span> <span class="token string">"assistant"</span><span class="token punctuation">,</span> <span class="token property">"content"</span><span class="token operator">:</span> <span class="token string">"å¥½å®¶ä¼™ï¼ä½ è¿™æ˜¯è¦æŠŠä½“é‡ç§¤å‹æˆåˆ†å­æ–™ç†ï¼ŸğŸ‹ï¸"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>              <span class="token punctuation">{</span><span class="token property">"role"</span><span class="token operator">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token property">"content"</span><span class="token operator">:</span> <span class="token string">"æ¸¸æˆåˆè¾“äº†"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>              <span class="token punctuation">{</span><span class="token property">"role"</span><span class="token operator">:</span> <span class="token string">"assistant"</span><span class="token punctuation">,</span> <span class="token property">"content"</span><span class="token operator">:</span> <span class="token string">"èœå°±å¤šç»ƒç»ƒï¼éœ€è¦ç»™ä½ æ¨èã€Šä»é›¶å¼€å§‹çš„ç”µç«ä¹‹è·¯ã€‹å—ï¼ŸğŸ®"</span><span class="token punctuation">}</span>          <span class="token punctuation">]</span><span class="token punctuation">,</span>     <span class="token property">"temperature"</span><span class="token operator">:</span> <span class="token number">0.7</span>      <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘è¿™é‡Œé£æ ¼ç±»å‹ä¸»è¦é…ç½®äº†ä¸¤ç§ï¼šæ¸©æŸ”å’Œæ¯’èˆŒä¸¤ç§ç›¸åé£æ ¼ï¼Œç„¶åä¸ºå®ƒä»¬è®¾ç½®äº†ç›¸åº”çš„ç³»ç»Ÿæç¤ºè¯å’Œç¤ºä¾‹ï¼Œè®©å¤§æ¨¡å‹æ˜ç¡®è‡ªå·±çš„è§’è‰²ä»¥åŠå­¦ä¹ æˆ‘ä»¬éœ€è¦çš„æ•°æ®æ¨¡æ¿ç±»å‹ï¼Œä»¥ä¾›åç»­ç”Ÿæˆã€‚</p><h3 id="3-3-é…ç½®æ–‡ä»¶åŠ è½½æ¨¡å—"><a href="#3-3-é…ç½®æ–‡ä»¶åŠ è½½æ¨¡å—" class="headerlink" title="3.3 é…ç½®æ–‡ä»¶åŠ è½½æ¨¡å—"></a>3.3 é…ç½®æ–‡ä»¶åŠ è½½æ¨¡å—</h3><p>æ–°å»º<code>emotion_dialogue_tuner/src/utils/config_loader.py</code>æ–‡ä»¶</p><p>è¿™ä¸ªæ–‡ä»¶ä¸»è¦è´Ÿè´£ç»Ÿä¸€ç®¡ç†APIå¯†é’¥ã€æ¨¡å‹è·¯å¾„ç­‰æ•æ„Ÿä¿¡æ¯å’Œé£æ ¼é…ç½®</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># config_loader.py  </span><span class="token triple-quoted-string string">"""é…ç½®æ–‡ä»¶åŠ è½½æ¨¡å—ï¼Œè´Ÿè´£ç»Ÿä¸€ç®¡ç†APIå¯†é’¥ã€æ¨¡å‹è·¯å¾„ç­‰æ•æ„Ÿä¿¡æ¯å’Œé£æ ¼é…ç½®"""</span>    <span class="token keyword">import</span> yaml  <span class="token keyword">import</span> json  <span class="token keyword">from</span> pathlib <span class="token keyword">import</span> Path      <span class="token keyword">class</span> <span class="token class-name">ConfigLoader</span><span class="token punctuation">:</span>      <span class="token triple-quoted-string string">"""é…ç½®åŠ è½½å™¨ï¼Œå°è£…é…ç½®æ–‡ä»¶çš„è¯»å–æ“ä½œ"""</span>        <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>          <span class="token triple-quoted-string string">"""åˆå§‹åŒ–æ—¶è‡ªåŠ¨å®šä½é¡¹ç›®æ ¹ç›®å½•"""</span>          self<span class="token punctuation">.</span>root_path <span class="token operator">=</span> Path<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">.</span>resolve<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>parent  <span class="token comment"># æ ¹æ®å®é™…å±‚çº§è°ƒæ•´  </span>      <span class="token keyword">def</span> <span class="token function">load_settings</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">dict</span><span class="token punctuation">:</span>          <span class="token triple-quoted-string string">"""åŠ è½½YAMLæ ¼å¼çš„å…¨å±€è®¾ç½®          Returns:            dict: åŒ…å«APIå¯†é’¥ã€æ¨¡å‹è·¯å¾„ç­‰é…ç½®çš„å­—å…¸          """</span>        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>root_path <span class="token operator">/</span> <span class="token string">"config/settings.yaml"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>              <span class="token keyword">return</span> yaml<span class="token punctuation">.</span>safe_load<span class="token punctuation">(</span>f<span class="token punctuation">)</span>        <span class="token keyword">def</span> <span class="token function">load_style_config</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">dict</span><span class="token punctuation">:</span>          <span class="token triple-quoted-string string">"""åŠ è½½JSONæ ¼å¼çš„é£æ ¼é…ç½®          Returns:            dict: åŒ…å«ä¸åŒå¯¹è¯é£æ ¼çš„æ¨¡æ¿é…ç½®          """</span>        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>root_path <span class="token operator">/</span> <span class="token string">"config/style_config.json"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>              <span class="token keyword">return</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-4-æ•°æ®ç”Ÿæˆæ ¸å¿ƒæ¨¡å—"><a href="#3-4-æ•°æ®ç”Ÿæˆæ ¸å¿ƒæ¨¡å—" class="headerlink" title="3.4 æ•°æ®ç”Ÿæˆæ ¸å¿ƒæ¨¡å—"></a>3.4 æ•°æ®ç”Ÿæˆæ ¸å¿ƒæ¨¡å—</h3><p>æ–°å»º<code>emotion_dialogue_tuner/src/data_generator.py</code>æ–‡ä»¶</p><p>è¿™ä¸ªæ–‡ä»¶ä¸»è¦è´Ÿè´£è°ƒç”¨APIç”ŸæˆæŒ‡å®šé£æ ¼çš„å¯¹è¯æ•°æ®</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># data_generator.py  </span><span class="token triple-quoted-string string">"""æ•°æ®ç”Ÿæˆæ ¸å¿ƒæ¨¡å—ï¼Œè´Ÿè´£è°ƒç”¨APIç”ŸæˆæŒ‡å®šé£æ ¼çš„å¯¹è¯æ•°æ®"""</span>    <span class="token keyword">from</span> zhipuai <span class="token keyword">import</span> ZhipuAI  <span class="token keyword">import</span> random  <span class="token keyword">import</span> time    <span class="token keyword">class</span> <span class="token class-name">StyleDataGenerator</span><span class="token punctuation">:</span>      <span class="token triple-quoted-string string">"""å¯¹è¯æ•°æ®ç”Ÿæˆå™¨ï¼Œæ ¹æ®é…ç½®ç”Ÿæˆç‰¹å®šé£æ ¼çš„å¯¹è¯æ•°æ®"""</span>        <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> api_key<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> style_config<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>          <span class="token triple-quoted-string string">"""          Args:            api_key (str): æ™ºæ™®APIè®¿é—®å¯†é’¥              style_config (dict): é£æ ¼é…ç½®å­—å…¸          """</span>        self<span class="token punctuation">.</span>client <span class="token operator">=</span> ZhipuAI<span class="token punctuation">(</span>api_key<span class="token operator">=</span>api_key<span class="token punctuation">)</span>          self<span class="token punctuation">.</span>style_config <span class="token operator">=</span> style_config        <span class="token keyword">def</span> <span class="token function">_build_messages</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> style_name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">list</span><span class="token punctuation">:</span>          <span class="token triple-quoted-string string">"""æ„å»ºç¬¦åˆAPIè¦æ±‚çš„æ¶ˆæ¯æ ¼å¼          Args:            style_name (str): ç›®æ ‡é£æ ¼åç§°ï¼ˆå¦‚'æ¸©æŸ”'ï¼‰          Returns:            list: åŒ…å«ç³»ç»Ÿæç¤ºå’Œç¤ºä¾‹å¯¹è¯çš„æ¶ˆæ¯åˆ—è¡¨          """</span>        config <span class="token operator">=</span> self<span class="token punctuation">.</span>style_config<span class="token punctuation">[</span>style_name<span class="token punctuation">]</span>          <span class="token keyword">return</span> <span class="token punctuation">[</span>              <span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"system"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> config<span class="token punctuation">[</span><span class="token string">"system_prompt"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>              <span class="token operator">*</span>config<span class="token punctuation">[</span><span class="token string">"examples"</span><span class="token punctuation">]</span>  <span class="token comment"># å±•å¼€ç¤ºä¾‹å¯¹è¯  </span>        <span class="token punctuation">]</span>        <span class="token keyword">def</span> <span class="token function">generate_style_data</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> style_name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> num_samples<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">list</span><span class="token punctuation">:</span>          <span class="token triple-quoted-string string">"""ç”ŸæˆæŒ‡å®šé£æ ¼çš„å¯¹è¯æ•°æ®          Args:            style_name (str): ç›®æ ‡é£æ ¼åç§°              num_samples (int): éœ€è¦ç”Ÿæˆçš„æ ·æœ¬æ•°é‡          Returns:            list: ç”Ÿæˆçš„å¯¹è¯æ•°æ®åˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç´ åŒ…å«ç”¨æˆ·è¾“å…¥ã€åŠ©æ‰‹å›å¤å’Œé£æ ¼æ ‡ç­¾          """</span>        data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>          messages <span class="token operator">=</span> self<span class="token punctuation">.</span>_build_messages<span class="token punctuation">(</span>style_name<span class="token punctuation">)</span>            <span class="token comment"># ä»æœ¬åœ°æ–‡ä»¶åŠ è½½ç”¨æˆ·è¾“å…¥  </span>        user_inputs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>          <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"data/cleaned_output.txt"</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>  <span class="token comment"># ä¿®æ”¹ä¸ºæ¸…ç†åçš„æ–‡ä»¶è·¯å¾„  </span>            <span class="token keyword">for</span> line <span class="token keyword">in</span> f<span class="token punctuation">:</span>                  <span class="token comment"># ç›´æ¥è¯»å–æ¯è¡Œå†…å®¹å¹¶å»é™¤æ¢è¡Œç¬¦  </span>                cleaned_line <span class="token operator">=</span> line<span class="token punctuation">.</span>rstrip<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>  <span class="token comment"># æˆ–ä½¿ç”¨ line.strip()                if cleaned_line:  # ç©ºè¡Œè¿‡æ»¤ï¼ˆå†—ä½™ä¿æŠ¤ï¼‰  </span>                    user_inputs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>cleaned_line<span class="token punctuation">)</span>            <span class="token comment"># æ·»åŠ ç©ºå€¼æ£€æŸ¥  </span>        <span class="token keyword">if</span> <span class="token keyword">not</span> user_inputs<span class="token punctuation">:</span>              <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"æ–‡ä»¶å†…å®¹ä¸ºç©ºæˆ–æœªæˆåŠŸåŠ è½½æ•°æ®ï¼Œè¯·æ£€æŸ¥ï¼š"</span>                               <span class="token string">"1. æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡® 2. æ–‡ä»¶æ˜¯å¦åŒ…å«æœ‰æ•ˆå†…å®¹"</span><span class="token punctuation">)</span>            <span class="token comment"># åˆå§‹åŒ–é¡ºåºç´¢å¼•  </span>        current_index <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment"># æ·»åŠ ç´¢å¼•è®¡æ•°å™¨  </span>        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_samples<span class="token punctuation">)</span><span class="token punctuation">:</span>              <span class="token keyword">try</span><span class="token punctuation">:</span>                    <span class="token comment"># æŒ‰é¡ºåºé€‰æ‹©ç”¨æˆ·è¾“å…¥ï¼ˆä¿®æ”¹æ ¸å¿ƒéƒ¨åˆ†ï¼‰  </span>                user_msg <span class="token operator">=</span> user_inputs<span class="token punctuation">[</span>current_index<span class="token punctuation">]</span>                  current_index <span class="token operator">=</span> <span class="token punctuation">(</span>current_index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token builtin">len</span><span class="token punctuation">(</span>user_inputs<span class="token punctuation">)</span>  <span class="token comment"># å¾ªç¯è®¡æ•°  </span>                  <span class="token comment"># æ·»åŠ å½“å‰ç”¨æˆ·æ¶ˆæ¯  </span>                current_messages <span class="token operator">=</span> messages <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> user_msg<span class="token punctuation">}</span><span class="token punctuation">]</span>                    <span class="token comment"># è°ƒç”¨å¤§æ¨¡å‹APIç”Ÿæˆå›å¤  </span>                response <span class="token operator">=</span> self<span class="token punctuation">.</span>client<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span>create<span class="token punctuation">(</span>                      model<span class="token operator">=</span><span class="token string">"glm-3-turbo"</span><span class="token punctuation">,</span>                      messages<span class="token operator">=</span>current_messages<span class="token punctuation">,</span>                      temperature<span class="token operator">=</span>self<span class="token punctuation">.</span>style_config<span class="token punctuation">[</span>style_name<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"temperature"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                      max_tokens<span class="token operator">=</span><span class="token number">100</span>                  <span class="token punctuation">)</span>                  reply <span class="token operator">=</span> response<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message<span class="token punctuation">.</span>content                    <span class="token comment"># ä¿å­˜é€šè¿‡è´¨é‡æ£€æŸ¥çš„æ•°æ®  </span>                <span class="token keyword">if</span> self<span class="token punctuation">.</span>_validate_reply<span class="token punctuation">(</span>style_name<span class="token punctuation">,</span> user_msg<span class="token punctuation">,</span> reply<span class="token punctuation">)</span><span class="token punctuation">:</span>                      data<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span>                          <span class="token string">"user"</span><span class="token punctuation">:</span> user_msg<span class="token punctuation">,</span>                          <span class="token string">"assistant"</span><span class="token punctuation">:</span> reply<span class="token punctuation">,</span>                          <span class="token string">"style"</span><span class="token punctuation">:</span> style_name                      <span class="token punctuation">}</span><span class="token punctuation">)</span>                    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1.5</span><span class="token punctuation">)</span>  <span class="token comment"># APIè°ƒç”¨é¢‘ç‡é™åˆ¶ä¿æŠ¤  </span>              <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>                  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"ç”Ÿæˆå¤±è´¥: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>            <span class="token keyword">return</span> data        <span class="token keyword">def</span> <span class="token function">_validate_reply</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> style<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> user_msg<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> reply<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>          <span class="token triple-quoted-string string">"""å†…éƒ¨æ–¹æ³•ï¼šéªŒè¯å›å¤è´¨é‡ï¼ˆå®é™…å®ç°åº”è°ƒç”¨Validatorç±»ï¼‰"""</span>          <span class="token comment"># ç®€åŒ–çš„éªŒè¯é€»è¾‘ï¼Œå®é™…åº”ä½¿ç”¨ç‹¬ç«‹çš„Validatorç±»  </span>        <span class="token keyword">return</span> <span class="token builtin">bool</span><span class="token punctuation">(</span>reply<span class="token punctuation">)</span>  <span class="token comment"># ç¤ºä¾‹ä»£ç </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-5-ç”Ÿæˆæ•°æ®è´¨é‡éªŒè¯æ¨¡å—"><a href="#3-5-ç”Ÿæˆæ•°æ®è´¨é‡éªŒè¯æ¨¡å—" class="headerlink" title="3.5 ç”Ÿæˆæ•°æ®è´¨é‡éªŒè¯æ¨¡å—"></a>3.5 ç”Ÿæˆæ•°æ®è´¨é‡éªŒè¯æ¨¡å—</h3><p>æ–°å»º<code>emotion_dialogue_tuner/src/utils/validator.py</code>æ–‡ä»¶</p><p>è¿™ä¸ªæ–‡ä»¶ä¸»è¦è´Ÿè´£å›å¤è´¨é‡éªŒè¯ï¼Œç¡®ä¿ç”Ÿæˆæ•°æ®ç¬¦åˆè´¨é‡æ ‡å‡†</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># validator.py  </span><span class="token triple-quoted-string string">"""å›å¤è´¨é‡éªŒè¯æ¨¡å—ï¼Œç¡®ä¿ç”Ÿæˆæ•°æ®ç¬¦åˆè´¨é‡æ ‡å‡†"""</span>    <span class="token keyword">import</span> numpy <span class="token keyword">as</span> np  <span class="token keyword">from</span> sentence_transformers <span class="token keyword">import</span> SentenceTransformer      <span class="token keyword">class</span> <span class="token class-name">ReplyValidator</span><span class="token punctuation">:</span>      <span class="token triple-quoted-string string">"""å›å¤éªŒè¯å™¨ï¼Œæ‰§è¡Œå¤šç»´åº¦è´¨é‡æ£€æŸ¥"""</span>        <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> model_path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>          <span class="token triple-quoted-string string">"""          Args:            model_path (str): æœ¬åœ°åµŒå…¥æ¨¡å‹æ–‡ä»¶è·¯å¾„          """</span>        self<span class="token punctuation">.</span>style_model <span class="token operator">=</span> SentenceTransformer<span class="token punctuation">(</span>model_path<span class="token punctuation">)</span>        <span class="token keyword">def</span> <span class="token function">validate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> style<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> user_msg<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> reply<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> ref_text<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>          <span class="token triple-quoted-string string">"""æ‰§è¡Œå®Œæ•´çš„è´¨é‡éªŒè¯æµç¨‹          Args:            style (str): ç›®æ ‡é£æ ¼åç§°              user_msg (str): ç”¨æˆ·è¾“å…¥æ–‡æœ¬              reply (str): å¾…éªŒè¯çš„å›å¤æ–‡æœ¬              ref_text (str): å‚è€ƒæ–‡æœ¬ï¼ˆç”¨äºç›¸ä¼¼åº¦è®¡ç®—ï¼‰          Returns:            bool: æ˜¯å¦é€šè¿‡æ‰€æœ‰éªŒè¯è§„åˆ™          """</span>        <span class="token comment"># åŸºç¡€æ ¼å¼æ£€æŸ¥  </span>        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>_basic_checks<span class="token punctuation">(</span>reply<span class="token punctuation">)</span><span class="token punctuation">:</span>              <span class="token keyword">return</span> <span class="token boolean">False</span>            <span class="token comment"># é£æ ¼å…³é”®è¯åŒ¹é…æ£€æŸ¥  </span>        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>_style_keyword_check<span class="token punctuation">(</span>style<span class="token punctuation">,</span> reply<span class="token punctuation">)</span><span class="token punctuation">:</span>              <span class="token keyword">return</span> <span class="token boolean">False</span>            <span class="token comment"># è¯­ä¹‰ç›¸ä¼¼åº¦éªŒè¯  </span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_semantic_similarity_check<span class="token punctuation">(</span>ref_text<span class="token punctuation">,</span> reply<span class="token punctuation">)</span>        <span class="token keyword">def</span> <span class="token function">_basic_checks</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> reply<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>          <span class="token triple-quoted-string string">"""æ‰§è¡ŒåŸºç¡€æ ¼å¼æ£€æŸ¥          1. éç©ºæ£€æŸ¥          2. é•¿åº¦é™åˆ¶æ£€æŸ¥          """</span>        <span class="token keyword">return</span> <span class="token builtin">bool</span><span class="token punctuation">(</span>reply<span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">&lt;=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>reply<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">150</span><span class="token punctuation">)</span>        <span class="token keyword">def</span> <span class="token function">_style_keyword_check</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> style<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> reply<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>          <span class="token triple-quoted-string string">"""æ£€æŸ¥æ˜¯å¦åŒ…å«é£æ ¼ç‰¹å¾å…³é”®è¯"""</span>          keyword_map <span class="token operator">=</span> <span class="token punctuation">{</span>              <span class="token string">"æ¸©æŸ”"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"å‘¢"</span><span class="token punctuation">,</span> <span class="token string">"å‘€"</span><span class="token punctuation">,</span> <span class="token string">"ğŸ˜Š"</span><span class="token punctuation">,</span> <span class="token string">"ğŸŒ¸"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>              <span class="token string">"æ¯’èˆŒ"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"å¥½å®¶ä¼™"</span><span class="token punctuation">,</span> <span class="token string">"æ “Q"</span><span class="token punctuation">,</span> <span class="token string">"!"</span><span class="token punctuation">,</span> <span class="token string">"ğŸ‹ï¸"</span><span class="token punctuation">]</span>          <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token builtin">any</span><span class="token punctuation">(</span>kw <span class="token keyword">in</span> reply <span class="token keyword">for</span> kw <span class="token keyword">in</span> keyword_map<span class="token punctuation">.</span>get<span class="token punctuation">(</span>style<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">def</span> <span class="token function">_semantic_similarity_check</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> ref_text<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> reply<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>          <span class="token triple-quoted-string string">"""è®¡ç®—ä¸å‚è€ƒæ–‡æœ¬çš„è¯­ä¹‰ç›¸ä¼¼åº¦          ä½¿ç”¨ä½™å¼¦ç›¸ä¼¼åº¦åˆ¤æ–­ï¼Œé˜ˆå€¼è®¾ä¸º0.65          """</span>        ref_vec <span class="token operator">=</span> self<span class="token punctuation">.</span>style_model<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>ref_text<span class="token punctuation">)</span>          reply_vec <span class="token operator">=</span> self<span class="token punctuation">.</span>style_model<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>reply<span class="token punctuation">)</span>          similarity <span class="token operator">=</span> np<span class="token punctuation">.</span>dot<span class="token punctuation">(</span>ref_vec<span class="token punctuation">,</span> reply_vec<span class="token punctuation">)</span>          <span class="token keyword">return</span> similarity <span class="token operator">&gt;</span> <span class="token number">0.65</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-6-ä¸»å‡½æ•°-main-py-å®ç°"><a href="#3-6-ä¸»å‡½æ•°-main-py-å®ç°" class="headerlink" title="3.6 ä¸»å‡½æ•° main.py å®ç°"></a>3.6 ä¸»å‡½æ•° main.py å®ç°</h3><p>æ–°å»º<code>emotion_dialogue_tuner/main.py</code> æ–‡ä»¶</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># main.py  </span><span class="token triple-quoted-string string">"""ä¸»æ‰§è¡Œå…¥å£ï¼Œåè°ƒå„æ¨¡å—å®Œæˆæ•°æ®ç”Ÿæˆä»»åŠ¡"""</span>    <span class="token keyword">from</span> src<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>config_loader <span class="token keyword">import</span> ConfigLoader  <span class="token keyword">from</span> src<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>validator <span class="token keyword">import</span> ReplyValidator  <span class="token keyword">from</span> src<span class="token punctuation">.</span>data_generator <span class="token keyword">import</span> StyleDataGenerator  <span class="token keyword">import</span> json  <span class="token keyword">import</span> os      <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>      <span class="token comment"># åˆå§‹åŒ–é…ç½®åŠ è½½å™¨  </span>    config_loader <span class="token operator">=</span> ConfigLoader<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment"># åŠ è½½é…ç½®ä¿¡æ¯  </span>    <span class="token keyword">try</span><span class="token punctuation">:</span>          settings <span class="token operator">=</span> config_loader<span class="token punctuation">.</span>load_settings<span class="token punctuation">(</span><span class="token punctuation">)</span>          style_config <span class="token operator">=</span> config_loader<span class="token punctuation">.</span>load_style_config<span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token keyword">except</span> FileNotFoundError <span class="token keyword">as</span> e<span class="token punctuation">:</span>          <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"é…ç½®æ–‡ä»¶ç¼ºå¤±ï¼š</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>          <span class="token keyword">return</span>        <span class="token comment"># åˆå§‹åŒ–æ ¸å¿ƒç»„ä»¶  </span>    generator <span class="token operator">=</span> StyleDataGenerator<span class="token punctuation">(</span>          api_key<span class="token operator">=</span>settings<span class="token punctuation">[</span><span class="token string">"API"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"ZHIPU_API_KEY"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>          style_config<span class="token operator">=</span>style_config      <span class="token punctuation">)</span>      validator <span class="token operator">=</span> ReplyValidator<span class="token punctuation">(</span>          model_path<span class="token operator">=</span>settings<span class="token punctuation">[</span><span class="token string">"PATHS"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"EMBEDDING_MODEL"</span><span class="token punctuation">]</span>      <span class="token punctuation">)</span>      <span class="token comment"># æ‰§è¡Œæ•°æ®ç”Ÿæˆæµç¨‹  </span>    all_data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>      <span class="token keyword">try</span><span class="token punctuation">:</span>          <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"æ­£åœ¨ç”Ÿæˆæ¸©æŸ”é£æ ¼æ•°æ®..."</span><span class="token punctuation">)</span>          gentle_data <span class="token operator">=</span> generator<span class="token punctuation">.</span>generate_style_data<span class="token punctuation">(</span><span class="token string">"æ¸©æŸ”"</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>          all_data<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>gentle_data<span class="token punctuation">)</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"æ­£åœ¨ç”Ÿæˆæ¯’èˆŒé£æ ¼æ•°æ®..."</span><span class="token punctuation">)</span>          sarcastic_data <span class="token operator">=</span> generator<span class="token punctuation">.</span>generate_style_data<span class="token punctuation">(</span><span class="token string">"æ¯’èˆŒ"</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>          all_data<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>sarcastic_data<span class="token punctuation">)</span>        <span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>          <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\nç”¨æˆ·ä¸­æ–­æ“ä½œï¼Œæ­£åœ¨ä¿å­˜å·²ç”Ÿæˆæ•°æ®..."</span><span class="token punctuation">)</span>      <span class="token keyword">finally</span><span class="token punctuation">:</span>          <span class="token comment"># ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨  </span>        output_dir <span class="token operator">=</span> <span class="token string">"outputs"</span>          os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>output_dir<span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>            <span class="token comment"># æŒä¹…åŒ–ä¿å­˜æ•°æ®  </span>        output_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>output_dir<span class="token punctuation">,</span> <span class="token string">"style_chat_data.json"</span><span class="token punctuation">)</span>          <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>output_path<span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>              json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>all_data<span class="token punctuation">,</span> f<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>          <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"æ•°æ®ä¿å­˜å®Œæˆï¼Œæœ‰æ•ˆæ ·æœ¬æ•°ï¼š</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>all_data<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>      <span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>      main<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="å››ã€æ¨¡å‹é€‰å‹ä¸è®¾è®¡"><a href="#å››ã€æ¨¡å‹é€‰å‹ä¸è®¾è®¡" class="headerlink" title="å››ã€æ¨¡å‹é€‰å‹ä¸è®¾è®¡"></a><strong>å››ã€æ¨¡å‹é€‰å‹ä¸è®¾è®¡</strong></h2><p>1.æ¨¡å‹é€‰å‹<br>æ ¹æ®å½“å‰çš„ä»»åŠ¡ç‰¹ç‚¹ï¼Œé€‰æ‹©åˆé€‚çš„è¯„æµ‹æ•°æ®ä»¥åŠé¢„é€‰çš„å€™é€‰æ¨¡å‹</p><p>ä¸€èˆ¬æ¥è®²ï¼Œåšä»€ä¹ˆæ ·çš„ä»»åŠ¡å°±é€‰ä»€ä¹ˆæ ·çš„æ¨¡å‹ï¼Œæˆ‘ä»¬è¦åšçš„æ˜¯ä¸€ä¸ªæƒ…æ„Ÿå¯¹è¯æ¨¡å‹ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨é€‰æ‹©æ¨¡å‹æ—¶åº”é€‰æ‹©å¯¹ä¸­æ–‡æ–‡æœ¬ç†è§£èƒ½åŠ›è¾ƒå¼ºçš„æ¨¡å‹ã€‚</p><p>2.æ¨¡å‹çš„å¤§å°é€‰æ‹©</p><ul><li>æœåŠ¡å™¨é…ç½®</li><li>ä»»åŠ¡å¤æ‚åº¦</li></ul><p>å¯ä»¥æ ¹æ®ä»»åŠ¡é€‰æ‹©å¯¹åº”çš„è¯„æµ‹æ•°æ®ï¼Œå¯¹æœŸæœ›æ¨¡å‹å®¢è§‚è¯„æµ‹</p><p>å½“å‰ä»»åŠ¡ä¸ºæ—¥å¸¸èŠå¤©å¯¹è¯æ¨¡å‹ï¼Œä¸»è¦è¦æ±‚æ¨¡å‹çš„ä¸­æ–‡ç†è§£èƒ½åŠ›ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œå¯ä»¥ç”¨ CLUEï¼ˆä¸­æ–‡ç†è§£ï¼‰æ•°æ®è¿›è¡Œè¯„æµ‹ï¼š</p><p>æˆ‘ä»¬éœ€è¦å‡†å¤‡ opencompass ç¯å¢ƒï¼Œå‚è€ƒ[[ã€AIå¤§æ¨¡å‹åº”ç”¨å­¦ä¹ ç¬”è®°ã€‘OpenCompassæ¨¡å‹è¯„ä¼°æ¡†æ¶çš„ä½¿ç”¨æ•™ç¨‹]]</p><p>è¿›å…¥OpenCompassæ ¹ç›®å½•ä¸‹ï¼Œæ‰§è¡Œå‘½ä»¤</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#è¾“å‡ºæ•°æ®é›†æ¸…å•</span>python tools/list_configs.py clue<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>æ‰§è¡Œåè¾“å‡ºç»“æœå¦‚ä¸‹ï¼š</p><pre class="line-numbers language-text" data-language="text"><code class="language-text">+-----------------------------+------------------------------------------------------------------------------+| Dataset                     | Config Path                                                                  ||-----------------------------+------------------------------------------------------------------------------|| CLUE_C3_gen                 | opencompass/configs/datasets/CLUE_C3/CLUE_C3_gen.py                          || CLUE_C3_gen_8c358f          | opencompass/configs/datasets/CLUE_C3/CLUE_C3_gen_8c358f.py                   || CLUE_C3_ppl                 | opencompass/configs/datasets/CLUE_C3/CLUE_C3_ppl.py                          || CLUE_C3_ppl_56b537          | opencompass/configs/datasets/CLUE_C3/CLUE_C3_ppl_56b537.py                   || CLUE_C3_ppl_e24a31          | opencompass/configs/datasets/CLUE_C3/CLUE_C3_ppl_e24a31.py                   || CLUE_CMRC_gen               | opencompass/configs/datasets/CLUE_CMRC/CLUE_CMRC_gen.py                      || CLUE_CMRC_gen_1bd3c8        | opencompass/configs/datasets/CLUE_CMRC/CLUE_CMRC_gen_1bd3c8.py               || CLUE_CMRC_gen_3749cd        | opencompass/configs/datasets/CLUE_CMRC/CLUE_CMRC_gen_3749cd.py               || CLUE_CMRC_gen_8484b9        | opencompass/configs/datasets/CLUE_CMRC/CLUE_CMRC_gen_8484b9.py               || CLUE_CMRC_gen_941108        | opencompass/configs/datasets/CLUE_CMRC/CLUE_CMRC_gen_941108.py               || CLUE_DRCD_gen               | opencompass/configs/datasets/CLUE_DRCD/CLUE_DRCD_gen.py                      || CLUE_DRCD_gen_1bd3c8        | opencompass/configs/datasets/CLUE_DRCD/CLUE_DRCD_gen_1bd3c8.py               || CLUE_DRCD_gen_3749cd        | opencompass/configs/datasets/CLUE_DRCD/CLUE_DRCD_gen_3749cd.py               || CLUE_DRCD_gen_8484b9        | opencompass/configs/datasets/CLUE_DRCD/CLUE_DRCD_gen_8484b9.py               || CLUE_DRCD_gen_941108        | opencompass/configs/datasets/CLUE_DRCD/CLUE_DRCD_gen_941108.py               || CLUE_afqmc_gen              | opencompass/configs/datasets/CLUE_afqmc/CLUE_afqmc_gen.py                    || CLUE_afqmc_gen_901306       | opencompass/configs/datasets/CLUE_afqmc/CLUE_afqmc_gen_901306.py             || CLUE_afqmc_ppl              | opencompass/configs/datasets/CLUE_afqmc/CLUE_afqmc_ppl.py                    || CLUE_afqmc_ppl_378c5b       | opencompass/configs/datasets/CLUE_afqmc/CLUE_afqmc_ppl_378c5b.py             || CLUE_afqmc_ppl_6507d7       | opencompass/configs/datasets/CLUE_afqmc/CLUE_afqmc_ppl_6507d7.py             || CLUE_afqmc_ppl_7b0c1e       | opencompass/configs/datasets/CLUE_afqmc/CLUE_afqmc_ppl_7b0c1e.py             || CLUE_cmnli_gen              | opencompass/configs/datasets/CLUE_cmnli/CLUE_cmnli_gen.py                    || CLUE_cmnli_gen_1abf97       | opencompass/configs/datasets/CLUE_cmnli/CLUE_cmnli_gen_1abf97.py             || CLUE_cmnli_gen_51e956       | opencompass/configs/datasets/CLUE_cmnli/CLUE_cmnli_gen_51e956.py             || CLUE_cmnli_ppl              | opencompass/configs/datasets/CLUE_cmnli/CLUE_cmnli_ppl.py                    || CLUE_cmnli_ppl_98dd6e       | opencompass/configs/datasets/CLUE_cmnli/CLUE_cmnli_ppl_98dd6e.py             || CLUE_cmnli_ppl_ef69e7       | opencompass/configs/datasets/CLUE_cmnli/CLUE_cmnli_ppl_ef69e7.py             || CLUE_cmnli_ppl_fdc6de       | opencompass/configs/datasets/CLUE_cmnli/CLUE_cmnli_ppl_fdc6de.py             || CLUE_ocnli_gen              | opencompass/configs/datasets/CLUE_ocnli/CLUE_ocnli_gen.py                    || CLUE_ocnli_gen_51e956       | opencompass/configs/datasets/CLUE_ocnli/CLUE_ocnli_gen_51e956.py             || CLUE_ocnli_gen_c4cb6c       | opencompass/configs/datasets/CLUE_ocnli/CLUE_ocnli_gen_c4cb6c.py             || CLUE_ocnli_ppl              | opencompass/configs/datasets/CLUE_ocnli/CLUE_ocnli_ppl.py                    || CLUE_ocnli_ppl_98dd6e       | opencompass/configs/datasets/CLUE_ocnli/CLUE_ocnli_ppl_98dd6e.py             || CLUE_ocnli_ppl_ef69e7       | opencompass/configs/datasets/CLUE_ocnli/CLUE_ocnli_ppl_ef69e7.py             || CLUE_ocnli_ppl_fdc6de       | opencompass/configs/datasets/CLUE_ocnli/CLUE_ocnli_ppl_fdc6de.py             || FewCLUE_bustm_gen           | opencompass/configs/datasets/FewCLUE_bustm/FewCLUE_bustm_gen.py              || FewCLUE_bustm_gen_634f41    | opencompass/configs/datasets/FewCLUE_bustm/FewCLUE_bustm_gen_634f41.py       || FewCLUE_bustm_ppl           | opencompass/configs/datasets/FewCLUE_bustm/FewCLUE_bustm_ppl.py              || FewCLUE_bustm_ppl_4b16c0    | opencompass/configs/datasets/FewCLUE_bustm/FewCLUE_bustm_ppl_4b16c0.py       || FewCLUE_bustm_ppl_9ef540    | opencompass/configs/datasets/FewCLUE_bustm/FewCLUE_bustm_ppl_9ef540.py       || FewCLUE_bustm_ppl_e53034    | opencompass/configs/datasets/FewCLUE_bustm/FewCLUE_bustm_ppl_e53034.py       || FewCLUE_chid_gen            | opencompass/configs/datasets/FewCLUE_chid/FewCLUE_chid_gen.py                || FewCLUE_chid_gen_0a29a2     | opencompass/configs/datasets/FewCLUE_chid/FewCLUE_chid_gen_0a29a2.py         || FewCLUE_chid_ppl            | opencompass/configs/datasets/FewCLUE_chid/FewCLUE_chid_ppl.py                || FewCLUE_chid_ppl_8f2872     | opencompass/configs/datasets/FewCLUE_chid/FewCLUE_chid_ppl_8f2872.py         || FewCLUE_chid_ppl_acccb5     | opencompass/configs/datasets/FewCLUE_chid/FewCLUE_chid_ppl_acccb5.py         || FewCLUE_cluewsc_gen         | opencompass/configs/datasets/FewCLUE_cluewsc/FewCLUE_cluewsc_gen.py          || FewCLUE_cluewsc_gen_c68933  | opencompass/configs/datasets/FewCLUE_cluewsc/FewCLUE_cluewsc_gen_c68933.py   || FewCLUE_cluewsc_ppl         | opencompass/configs/datasets/FewCLUE_cluewsc/FewCLUE_cluewsc_ppl.py          || FewCLUE_cluewsc_ppl_12e4e0  | opencompass/configs/datasets/FewCLUE_cluewsc/FewCLUE_cluewsc_ppl_12e4e0.py   || FewCLUE_cluewsc_ppl_4284a0  | opencompass/configs/datasets/FewCLUE_cluewsc/FewCLUE_cluewsc_ppl_4284a0.py   || FewCLUE_cluewsc_ppl_868415  | opencompass/configs/datasets/FewCLUE_cluewsc/FewCLUE_cluewsc_ppl_868415.py   || FewCLUE_csl_gen             | opencompass/configs/datasets/FewCLUE_csl/FewCLUE_csl_gen.py                  || FewCLUE_csl_gen_28b223      | opencompass/configs/datasets/FewCLUE_csl/FewCLUE_csl_gen_28b223.py           || FewCLUE_csl_gen_87f4a8      | opencompass/configs/datasets/FewCLUE_csl/FewCLUE_csl_gen_87f4a8.py           || FewCLUE_csl_ppl             | opencompass/configs/datasets/FewCLUE_csl/FewCLUE_csl_ppl.py                  || FewCLUE_csl_ppl_769f8d      | opencompass/configs/datasets/FewCLUE_csl/FewCLUE_csl_ppl_769f8d.py           || FewCLUE_csl_ppl_841b62      | opencompass/configs/datasets/FewCLUE_csl/FewCLUE_csl_ppl_841b62.py           || FewCLUE_eprstmt_gen         | opencompass/configs/datasets/FewCLUE_eprstmt/FewCLUE_eprstmt_gen.py          || FewCLUE_eprstmt_gen_740ea0  | opencompass/configs/datasets/FewCLUE_eprstmt/FewCLUE_eprstmt_gen_740ea0.py   || FewCLUE_eprstmt_ppl         | opencompass/configs/datasets/FewCLUE_eprstmt/FewCLUE_eprstmt_ppl.py          || FewCLUE_eprstmt_ppl_1ce587  | opencompass/configs/datasets/FewCLUE_eprstmt/FewCLUE_eprstmt_ppl_1ce587.py   || FewCLUE_eprstmt_ppl_f1e631  | opencompass/configs/datasets/FewCLUE_eprstmt/FewCLUE_eprstmt_ppl_f1e631.py   || FewCLUE_ocnli_fc_gen        | opencompass/configs/datasets/FewCLUE_ocnli_fc/FewCLUE_ocnli_fc_gen.py        || FewCLUE_ocnli_fc_gen_f97a97 | opencompass/configs/datasets/FewCLUE_ocnli_fc/FewCLUE_ocnli_fc_gen_f97a97.py || FewCLUE_ocnli_fc_ppl        | opencompass/configs/datasets/FewCLUE_ocnli_fc/FewCLUE_ocnli_fc_ppl.py        || FewCLUE_ocnli_fc_ppl_9e8b3d | opencompass/configs/datasets/FewCLUE_ocnli_fc/FewCLUE_ocnli_fc_ppl_9e8b3d.py || FewCLUE_ocnli_fc_ppl_c08300 | opencompass/configs/datasets/FewCLUE_ocnli_fc/FewCLUE_ocnli_fc_ppl_c08300.py || FewCLUE_tnews_gen           | opencompass/configs/datasets/FewCLUE_tnews/FewCLUE_tnews_gen.py              || FewCLUE_tnews_gen_b90e4a    | opencompass/configs/datasets/FewCLUE_tnews/FewCLUE_tnews_gen_b90e4a.py       || FewCLUE_tnews_ppl           | opencompass/configs/datasets/FewCLUE_tnews/FewCLUE_tnews_ppl.py              || FewCLUE_tnews_ppl_7d1c07    | opencompass/configs/datasets/FewCLUE_tnews/FewCLUE_tnews_ppl_7d1c07.py       || FewCLUE_tnews_ppl_d10e8a    | opencompass/configs/datasets/FewCLUE_tnews/FewCLUE_tnews_ppl_d10e8a.py       || FewCLUE_tnews_ppl_fff486    | opencompass/configs/datasets/FewCLUE_tnews/FewCLUE_tnews_ppl_fff486.py       |+-----------------------------+------------------------------------------------------------------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>genï¼šç”Ÿæˆä»»åŠ¡<br>pplï¼šåˆ†ç±»ä»»åŠ¡</p><p>æˆ‘ä»¬æœ¬æ¬¡ä»»åŠ¡å¤§å¤šæ˜¯çŸ­è¯­å¯¹è¯ï¼Œå¯ä»¥é€‰æ‹© FewCLUE_bustm_genï¼ˆçŸ­æ–‡æœ¬åˆ†ç±»ï¼‰ã€FewCLUE_ocnli_fc_genï¼ˆè‡ªç„¶è¯­è¨€æ¨ç†ï¼‰å¯¹é¢„æœŸæ¨¡å‹è¿›è¡Œè¯„ä¼°ã€‚</p><p>æˆ‘ä»¬è¿™é‡Œé€‰æ‹©Qwen1.5 çš„ 0.5bã€1.8bä¸¤ä¸ªä¸ªæ¨¡å‹æ¥è¿›è¡Œæ¯”è¾ƒï¼Œè¿™é‡Œè®°å¾—ä¿®æ”¹opencompass ä¸‹å¯¹åº”æ¨¡å‹æ–‡ä»¶ä¸­çš„æ¨¡å‹è·¯å¾„ã€‚</p><p>è¿è¡Œä¸‹é¢å‘½ä»¤å¼€å§‹è¿›è¡Œæ¨¡å‹è¯„ä¼°æ¯”è¾ƒï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">python run.py <span class="token punctuation">\</span><span class="token parameter variable">--models</span> hf_qwen1_5_0_5b_chat hf_qwen1_5_1_8b_chat <span class="token punctuation">\</span><span class="token parameter variable">--datasets</span> FewCLUE_bustm_gen FewCLUE_ocnli_fc_gen <span class="token punctuation">\</span><span class="token parameter variable">--debug</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>æ ¹æ®è¯„ä¼°ç»“æœï¼Œé€‰æ‹©æœ€ç»ˆæ¨¡å‹ã€‚</p><p>è¯„ä¼°ç»“æœå¦‚ä¸‹ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">tabulate <span class="token builtin">format</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span><span class="token operator">^</span>dataset        version    metric    mode      qwen1<span class="token punctuation">.</span><span class="token number">5</span><span class="token operator">-</span><span class="token number">0</span><span class="token punctuation">.</span>5b<span class="token operator">-</span>chat<span class="token operator">-</span>hf    qwen1<span class="token punctuation">.</span><span class="token number">5</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">.</span>8b<span class="token operator">-</span>chat<span class="token operator">-</span>hf<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>  <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>  <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>  <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>  <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>  <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>bustm<span class="token operator">-</span>dev      5cc669     accuracy  gen                      <span class="token number">48.75</span>                   <span class="token number">48.75</span>bustm<span class="token operator">-</span>test     5cc669     accuracy  gen                      <span class="token number">50.00</span>                   <span class="token number">50.11</span>ocnli_fc<span class="token operator">-</span>dev   <span class="token number">51e956</span>     accuracy  gen                      <span class="token number">35.62</span>                   <span class="token number">46.25</span>ocnli_fc<span class="token operator">-</span>test  <span class="token number">51e956</span>     accuracy  gen                      <span class="token number">35.20</span>                   <span class="token number">50.63</span>$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…¶å®è¿™é‡Œæˆ‘ä»¬é€‰çš„æ˜¯åŒä¸€ä¸ªæ¨¡å‹çš„ä¸åŒå‚æ•°ç‰ˆæœ¬ï¼Œé‚£ä¹ˆå¿…ç„¶æ˜¯å‚æ•°é‡å¤§çš„é‚£ä¸ªè¯„ä¼°æ•ˆæœè¦å¥½ã€‚</p><h2 id="äº”ã€æ¨¡å‹è®­ç»ƒä¸è¯„ä¼°"><a href="#äº”ã€æ¨¡å‹è®­ç»ƒä¸è¯„ä¼°" class="headerlink" title="äº”ã€æ¨¡å‹è®­ç»ƒä¸è¯„ä¼°"></a><strong>äº”ã€æ¨¡å‹è®­ç»ƒä¸è¯„ä¼°</strong></h2><h3 id="5-1è®­ç»ƒç¯å¢ƒé…ç½®"><a href="#5-1è®­ç»ƒç¯å¢ƒé…ç½®" class="headerlink" title="5.1è®­ç»ƒç¯å¢ƒé…ç½®"></a><strong>5.1è®­ç»ƒç¯å¢ƒé…ç½®</strong></h3><p>ä½¿ç”¨ç¯å¢ƒ</p><ul><li>è½¯ä»¶ç¯å¢ƒï¼šWindows11 + WSL2-Linux-Ubuntu22.04å­ç³»ç»Ÿ</li><li>ç¡¬ä»¶ç¯å¢ƒï¼šGeForce RTX 4060 Ti 16GB</li><li>æ¡†æ¶ä¸å·¥å…·ï¼ˆLLamaFactory/Xtunerï¼‰</li></ul><p>å› ä¸ºå½“å‰ä»»åŠ¡çš„ç»“æœæ›´åå‘äºä¸»è§‚è¯„æµ‹ï¼Œxtenerå°±æä¾›äº†åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­çš„ä¸»è§‚è¯„æµ‹ï¼Œå› æ­¤é€‰æ‹©xtuner</p><h3 id="5-2-è®­ç»ƒå‚æ•°è®¾ç½®"><a href="#5-2-è®­ç»ƒå‚æ•°è®¾ç½®" class="headerlink" title="5.2 è®­ç»ƒå‚æ•°è®¾ç½®"></a><strong>5.2 è®­ç»ƒå‚æ•°è®¾ç½®</strong></h3><p>å®‰è£…å¥½xtunerç¯å¢ƒ</p><p>åˆ›å»ºå¾®è°ƒè®­ç»ƒç›¸å…³çš„é…ç½®æ–‡ä»¶åœ¨å·¦ä¾§çš„æ–‡ä»¶åˆ—è¡¨ï¼Œxtuner çš„æ–‡ä»¶å¤¹é‡Œï¼Œæ‰“å¼€<code>xtuner/xtuner/configs/internlm/internlm2_chat_1_8b/internlm2_chat_1_8b_qlora_alpaca_e3.py</code>ï¼Œå¤åˆ¶ä¸€ä»½åˆ°å…¶ä»–ç›®å½•ã€‚<br>æ‰“å¼€è¿™ä¸ªæ–‡ä»¶ï¼Œç„¶åä¿®æ”¹é¢„è®­ç»ƒæ¨¡å‹åœ°å€ï¼Œæ•°æ®æ–‡ä»¶åœ°å€ç­‰ã€‚<br>æˆ‘é…ç½®ä¿®æ”¹çš„åœ°æ–¹å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">### åœ¨ PART 1  Settings ä¸­</span><span class="token comment"># æˆ‘ä»¬é¢„è®­ç»ƒæ¨¡å‹å­˜æ”¾è·¯å¾„</span>pretrained_model_name_or_path <span class="token operator">=</span> <span class="token string">"/home/moyuai/moyuai/llm/Qwen/Qwen1___5-1___8B-Chat"</span><span class="token comment"># å¾®è°ƒæ•°æ®å­˜æ”¾è·¯å¾„</span>alpaca_en_path <span class="token operator">=</span> <span class="token string">"/home/moyuai/moyuai/data/output.json"</span><span class="token comment"># è®­ç»ƒä¸­æœ€å¤§çš„æ–‡æœ¬é•¿åº¦</span>max_length <span class="token operator">=</span> <span class="token number">512</span><span class="token comment"># æ¯ä¸€æ‰¹è®­ç»ƒæ ·æœ¬çš„å¤§å°ï¼Œæ ¹æ®è‡ªå·±çš„ç¡¬ä»¶è°ƒæ•´</span>batch_size <span class="token operator">=</span> <span class="token number">4</span> <span class="token comment"># æœ€å¤§è®­ç»ƒè½®æ•°</span>max_epochs <span class="token operator">=</span> <span class="token number">3000</span> <span class="token comment"># éªŒè¯æ•°æ®</span>evaluation_inputs <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token string">"ç”·æœ‹å‹ç»™å¥³ä¸»æ’­åˆ·ç«ç®­ï¼Œç®—ç²¾ç¥å‡ºè½¨å—ï¼Ÿ"</span><span class="token punctuation">,</span>    <span class="token string">"å–çº¢é…’å…»ç”Ÿï¼Œç»“æœå–åˆ°å¤´æ™•â€¦"</span><span class="token punctuation">,</span>    <span class="token string">"é—ºèœœå’Œæˆ‘å‰ä»»äº’å…³å°çº¢ä¹¦ï¼Œå–å…³æ‹‰é»‘ä¸‰è¿å‡»ï¼"</span><span class="token punctuation">,</span>    <span class="token string">"ä½“æ£€è¯´èƒ†å›ºé†‡é«˜ï¼Œè¦æˆ’ç‚¸é¸¡äº†å—ï¼Ÿ"</span><span class="token punctuation">,</span>    <span class="token string">"å‰§æœ¬æ€é‡è¯»æœ¬ç©å®¶ï¼Œç›´æ¥æ‘”é—¨ç¦»åœºï¼"</span><span class="token punctuation">,</span>    <span class="token string">"é¢†å¯¼å‘¨æœ«å‘60ç§’è¯­éŸ³çŸ©é˜µï¼Œè£…æ²¡çœ‹è§è¡Œå—ï¼Ÿ"</span><span class="token punctuation">,</span>    <span class="token punctuation">]</span><span class="token comment">### åœ¨ PART 2  Model &amp; Tokenizer ä¸­</span><span class="token comment"># å°† qlora4 ä½å…³é—­ï¼Œå¼€å¯å…«ä½</span>load_in_4bit<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>load_in_8bit<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span><span class="token comment">### æ³¨é‡Šä¸‹é¢è¿™äº›å†…å®¹</span><span class="token comment"># bnb_4bit_compute_dtype=torch.float16,</span><span class="token comment"># bnb_4bit_use_double_quant=True,</span><span class="token comment"># bnb_4bit_quant_type="nf4",</span>r<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span>lora_alpha<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token comment"># ä¸€èˆ¬æ˜¯rçš„ä¸¤å€</span><span class="token comment">### åœ¨ PART 3  Dataset &amp; Dataloader ä¸­</span>dataset<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span>load_dataset<span class="token punctuation">,</span> path<span class="token operator">=</span><span class="token string">"json"</span><span class="token punctuation">,</span>data_files<span class="token operator">=</span>data_files<span class="token punctuation">)</span><span class="token punctuation">,</span>dataset_map_fn<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å‚æ•°è®¾ç½®å®Œæˆåï¼Œæˆ‘ä»¬è¿›å…¥æˆ‘ä»¬å¤åˆ¶çš„ <code>qwen1_5_1_8b_chat_qlora_alpaca_e3.py</code> æ–‡ä»¶ç›®å½•ä¸‹ï¼Œåœ¨å½“å‰ç›®å½•ä¸‹ï¼Œè¾“å…¥ä»¥ä¸‹å‘½ä»¤å¯åŠ¨å¾®è°ƒè„šæœ¬ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># åå°ç»ˆç«¯è¿è¡Œ</span><span class="token function">nohup</span> xtuner train qwen1_5_1_8b_chat_qlora_alpaca_e3.py <span class="token operator">&gt;</span> train_05_10_2.log <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">&amp;</span><span class="token comment">#å•æœºå•å¡</span>xtuner train qwen1_5_1_8b_chat_qlora_alpaca_e3.py<span class="token comment">#å•æœºå¤šå¡</span><span class="token assign-left variable">NPROC_PER_NODE</span><span class="token operator">=</span><span class="token variable">${GPU_NUM}</span> xtuner train qwen1_5_1_8b_chat_qlora_alpaca_e3 <span class="token parameter variable">--deepspeed</span> deepspeed_zero2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä»¬è®­ç»ƒåˆ°20000è½®åæŸ¥çœ‹æ—¥å¿—ï¼Œå‘ç°æ¨¡å‹æ•ˆæœè¿˜è¡Œï¼Œä¸ç®¡æ˜¯ç”Ÿæˆçš„ç­”æ¡ˆè¿˜æœ‰losså€¼éƒ½æ˜¯ä¸é”™çš„ï¼Œ20000è½®è®­ç»ƒçš„æ—¥å¿—å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-text" data-language="text"><code class="language-text">/home/moyuai/anaconda3/envs/xtuner-env/lib/python3.10/site-packages/bitsandbytes/autograd/_functions.py:315: UserWarning: MatMul8bitLt: inputs will be cast from torch.float32 to float16 during quantization  warnings.warn(f"MatMul8bitLt: inputs will be cast from {A.dtype} to float16 during quantization")05/10 08:08:26 - mmengine - INFO - Iter(train) [ 19510/480000]  lr: 1.9994e-04  eta: 7 days, 19:52:24  time: 5.9691  data_time: 4.4355  memory: 9843  loss: 0.0042  grad_norm: 0.122005/10 08:08:38 - mmengine - INFO - Iter(train) [ 19520/480000]  lr: 1.9994e-04  eta: 7 days, 19:51:14  time: 1.2358  data_time: 0.0058  memory: 9844  loss: 0.0059  grad_norm: 0.126105/10 08:08:56 - mmengine - INFO - Iter(train) [ 19530/480000]  lr: 1.9994e-04  eta: 7 days, 19:52:00  time: 1.7250  data_time: 0.2061  memory: 9844  loss: 0.0046  grad_norm: 0.126105/10 08:09:09 - mmengine - INFO - Iter(train) [ 19540/480000]  lr: 1.9994e-04  eta: 7 days, 19:51:21  time: 1.3681  data_time: 0.0061  memory: 9844  loss: 0.0027  grad_norm: 0.129005/10 08:09:23 - mmengine - INFO - Iter(train) [ 19550/480000]  lr: 1.9994e-04  eta: 7 days, 19:50:37  time: 1.3440  data_time: 0.0062  memory: 9846  loss: 0.0046  grad_norm: 0.129005/10 08:09:38 - mmengine - INFO - Iter(train) [ 19560/480000]  lr: 1.9994e-04  eta: 7 days, 19:50:29  time: 1.4959  data_time: 0.0061  memory: 9846  loss: 0.0027  grad_norm: 0.126305/10 08:09:51 - mmengine - INFO - Iter(train) [ 19570/480000]  lr: 1.9994e-04  eta: 7 days, 19:49:43  time: 1.3353  data_time: 0.0060  memory: 9848  loss: 0.0030  grad_norm: 0.124205/10 08:10:06 - mmengine - INFO - Iter(train) [ 19580/480000]  lr: 1.9994e-04  eta: 7 days, 19:49:40  time: 1.5177  data_time: 0.0060  memory: 9843  loss: 0.0058  grad_norm: 0.124205/10 08:10:20 - mmengine - INFO - Iter(train) [ 19590/480000]  lr: 1.9994e-04  eta: 7 days, 19:48:59  time: 1.3554  data_time: 0.0060  memory: 9843  loss: 0.0034  grad_norm: 0.125405/10 08:10:33 - mmengine - INFO - Iter(train) [ 19600/480000]  lr: 1.9994e-04  eta: 7 days, 19:48:17  time: 1.3532  data_time: 0.0062  memory: 9842  loss: 0.0044  grad_norm: 0.128605/10 08:10:48 - mmengine - INFO - Iter(train) [ 19610/480000]  lr: 1.9994e-04  eta: 7 days, 19:48:07  time: 1.4891  data_time: 0.0060  memory: 9842  loss: 0.0037  grad_norm: 0.128605/10 08:11:01 - mmengine - INFO - Iter(train) [ 19620/480000]  lr: 1.9994e-04  eta: 7 days, 19:47:21  time: 1.3355  data_time: 0.0062  memory: 9844  loss: 0.0047  grad_norm: 0.135005/10 08:11:17 - mmengine - INFO - Iter(train) [ 19630/480000]  lr: 1.9994e-04  eta: 7 days, 19:47:17  time: 1.5144  data_time: 0.0061  memory: 9844  loss: 0.0040  grad_norm: 0.135005/10 08:11:30 - mmengine - INFO - Iter(train) [ 19640/480000]  lr: 1.9994e-04  eta: 7 days, 19:46:30  time: 1.3288  data_time: 0.0060  memory: 9844  loss: 0.0051  grad_norm: 0.131105/10 08:11:45 - mmengine - INFO - Iter(train) [ 19650/480000]  lr: 1.9994e-04  eta: 7 days, 19:46:25  time: 1.5094  data_time: 0.0061  memory: 9842  loss: 0.0069  grad_norm: 0.138105/10 08:11:58 - mmengine - INFO - Iter(train) [ 19660/480000]  lr: 1.9994e-04  eta: 7 days, 19:45:37  time: 1.3286  data_time: 0.0059  memory: 9845  loss: 0.0057  grad_norm: 0.138105/10 08:12:12 - mmengine - INFO - Iter(train) [ 19670/480000]  lr: 1.9994e-04  eta: 7 days, 19:44:57  time: 1.3595  data_time: 0.0059  memory: 9846  loss: 0.0056  grad_norm: 0.142705/10 08:12:26 - mmengine - INFO - Iter(train) [ 19680/480000]  lr: 1.9994e-04  eta: 7 days, 19:44:35  time: 1.4349  data_time: 0.0060  memory: 9843  loss: 0.0050  grad_norm: 0.142605/10 08:12:41 - mmengine - INFO - Iter(train) [ 19690/480000]  lr: 1.9994e-04  eta: 7 days, 19:44:29  time: 1.5082  data_time: 0.2061  memory: 9838  loss: 0.0034  grad_norm: 0.142605/10 08:12:57 - mmengine - INFO - Iter(train) [ 19700/480000]  lr: 1.9994e-04  eta: 7 days, 19:44:32  time: 1.5429  data_time: 0.0065  memory: 9844  loss: 0.0045  grad_norm: 0.148905/10 08:13:10 - mmengine - INFO - Iter(train) [ 19710/480000]  lr: 1.9994e-04  eta: 7 days, 19:43:45  time: 1.3281  data_time: 0.0060  memory: 9846  loss: 0.0038  grad_norm: 0.148905/10 08:13:23 - mmengine - INFO - Iter(train) [ 19720/480000]  lr: 1.9994e-04  eta: 7 days, 19:43:00  time: 1.3418  data_time: 0.0062  memory: 9844  loss: 0.0042  grad_norm: 0.149705/10 08:13:38 - mmengine - INFO - Iter(train) [ 19730/480000]  lr: 1.9994e-04  eta: 7 days, 19:42:53  time: 1.4978  data_time: 0.0059  memory: 9842  loss: 0.0038  grad_norm: 0.150705/10 08:13:52 - mmengine - INFO - Iter(train) [ 19740/480000]  lr: 1.9994e-04  eta: 7 days, 19:42:08  time: 1.3417  data_time: 0.0061  memory: 9842  loss: 0.0042  grad_norm: 0.150705/10 08:14:07 - mmengine - INFO - Iter(train) [ 19750/480000]  lr: 1.9993e-04  eta: 7 days, 19:42:03  time: 1.5066  data_time: 0.0060  memory: 9844  loss: 0.0052  grad_norm: 0.148705/10 08:14:20 - mmengine - INFO - Iter(train) [ 19760/480000]  lr: 1.9993e-04  eta: 7 days, 19:41:21  time: 1.3511  data_time: 0.0059  memory: 9844  loss: 0.0040  grad_norm: 0.145105/10 08:14:36 - mmengine - INFO - Iter(train) [ 19770/480000]  lr: 1.9993e-04  eta: 7 days, 19:41:16  time: 1.5123  data_time: 0.0060  memory: 9845  loss: 0.0062  grad_norm: 0.145105/10 08:14:49 - mmengine - INFO - Iter(train) [ 19780/480000]  lr: 1.9993e-04  eta: 7 days, 19:40:25  time: 1.3094  data_time: 0.0059  memory: 9845  loss: 0.0051  grad_norm: 0.146805/10 08:15:02 - mmengine - INFO - Iter(train) [ 19790/480000]  lr: 1.9993e-04  eta: 7 days, 19:39:45  time: 1.3595  data_time: 0.0061  memory: 9839  loss: 0.0049  grad_norm: 0.146805/10 08:15:18 - mmengine - INFO - Iter(train) [ 19800/480000]  lr: 1.9993e-04  eta: 7 days, 19:39:59  time: 1.5899  data_time: 0.0062  memory: 9843  loss: 0.0040  grad_norm: 0.147105/10 08:15:32 - mmengine - INFO - Iter(train) [ 19810/480000]  lr: 1.9993e-04  eta: 7 days, 19:39:20  time: 1.3668  data_time: 0.0060  memory: 9844  loss: 0.0057  grad_norm: 0.142605/10 08:15:47 - mmengine - INFO - Iter(train) [ 19820/480000]  lr: 1.9993e-04  eta: 7 days, 19:39:18  time: 1.5212  data_time: 0.0060  memory: 9840  loss: 0.0058  grad_norm: 0.142605/10 08:16:01 - mmengine - INFO - Iter(train) [ 19830/480000]  lr: 1.9993e-04  eta: 7 days, 19:38:37  time: 1.3542  data_time: 0.0060  memory: 9843  loss: 0.0073  grad_norm: 0.139505/10 08:16:13 - mmengine - INFO - Iter(train) [ 19840/480000]  lr: 1.9993e-04  eta: 7 days, 19:37:37  time: 1.2729  data_time: 0.0059  memory: 9841  loss: 0.0033  grad_norm: 0.136605/10 08:16:31 - mmengine - INFO - Iter(train) [ 19850/480000]  lr: 1.9993e-04  eta: 7 days, 19:38:28  time: 1.7519  data_time: 0.4193  memory: 9845  loss: 0.0041  grad_norm: 0.136605/10 08:16:44 - mmengine - INFO - Iter(train) [ 19860/480000]  lr: 1.9993e-04  eta: 7 days, 19:37:29  time: 1.2766  data_time: 0.0057  memory: 9845  loss: 0.0034  grad_norm: 0.126905/10 08:17:00 - mmengine - INFO - Iter(train) [ 19870/480000]  lr: 1.9993e-04  eta: 7 days, 19:37:56  time: 1.6473  data_time: 0.0062  memory: 9841  loss: 0.0069  grad_norm: 0.126905/10 08:17:13 - mmengine - INFO - Iter(train) [ 19880/480000]  lr: 1.9993e-04  eta: 7 days, 19:36:54  time: 1.2646  data_time: 0.0058  memory: 9848  loss: 0.0044  grad_norm: 0.129905/10 08:17:28 - mmengine - INFO - Iter(train) [ 19890/480000]  lr: 1.9993e-04  eta: 7 days, 19:36:57  time: 1.5415  data_time: 0.0059  memory: 9847  loss: 0.0063  grad_norm: 0.136705/10 08:17:41 - mmengine - INFO - Iter(train) [ 19900/480000]  lr: 1.9993e-04  eta: 7 days, 19:36:03  time: 1.2998  data_time: 0.0059  memory: 9846  loss: 0.0054  grad_norm: 0.136705/10 08:17:54 - mmengine - INFO - Iter(train) [ 19910/480000]  lr: 1.9993e-04  eta: 7 days, 19:35:12  time: 1.3098  data_time: 0.0059  memory: 9846  loss: 0.0035  grad_norm: 0.136305/10 08:18:11 - mmengine - INFO - Iter(train) [ 19920/480000]  lr: 1.9993e-04  eta: 7 days, 19:35:38  time: 1.6464  data_time: 0.0062  memory: 9845  loss: 0.0068  grad_norm: 0.138505/10 08:18:23 - mmengine - INFO - Iter(train) [ 19930/480000]  lr: 1.9993e-04  eta: 7 days, 19:34:39  time: 1.2759  data_time: 0.0056  memory: 9842  loss: 0.0038  grad_norm: 0.138505/10 08:18:39 - mmengine - INFO - Iter(train) [ 19940/480000]  lr: 1.9993e-04  eta: 7 days, 19:34:57  time: 1.6086  data_time: 0.0065  memory: 9844  loss: 0.0065  grad_norm: 0.129505/10 08:18:52 - mmengine - INFO - Iter(train) [ 19950/480000]  lr: 1.9993e-04  eta: 7 days, 19:34:02  time: 1.2938  data_time: 0.0059  memory: 9844  loss: 0.0047  grad_norm: 0.129505/10 08:19:05 - mmengine - INFO - Iter(train) [ 19960/480000]  lr: 1.9993e-04  eta: 7 days, 19:33:09  time: 1.2996  data_time: 0.0059  memory: 9845  loss: 0.0042  grad_norm: 0.135405/10 08:19:22 - mmengine - INFO - Iter(train) [ 19970/480000]  lr: 1.9993e-04  eta: 7 days, 19:33:27  time: 1.6098  data_time: 0.0061  memory: 9844  loss: 0.0043  grad_norm: 0.130805/10 08:19:34 - mmengine - INFO - Iter(train) [ 19980/480000]  lr: 1.9993e-04  eta: 7 days, 19:32:27  time: 1.2702  data_time: 0.0056  memory: 9845  loss: 0.0047  grad_norm: 0.130805/10 08:19:50 - mmengine - INFO - Iter(train) [ 19990/480000]  lr: 1.9993e-04  eta: 7 days, 19:32:37  time: 1.5734  data_time: 0.0059  memory: 9846  loss: 0.0048  grad_norm: 0.131105/10 08:20:02 - mmengine - INFO - Exp name: qwen1_5_1_8b_chat_qlora_alpaca_e3_20250510_00101005/10 08:20:02 - mmengine - INFO - Iter(train) [ 20000/480000]  lr: 1.9993e-04  eta: 7 days, 19:31:29  time: 1.2366  data_time: 0.0058  memory: 9844  loss: 0.0064  grad_norm: 0.137205/10 08:20:02 - mmengine - INFO - after_train_iter in EvaluateChatHook.05/10 08:20:10 - mmengine - INFO - Sample output:&lt;|im_start|&gt;systemBelow is an instruction that describes a task. Write a response that appropriately completes the request.&lt;|im_end|&gt;&lt;|im_start|&gt;userç”·æœ‹å‹ç»™å¥³ä¸»æ’­åˆ·ç«ç®­ï¼Œç®—ç²¾ç¥å‡ºè½¨å—ï¼Ÿ&lt;|im_end|&gt;&lt;|im_start|&gt;assistantæ¸©æŸ”å“å‘€ï¼Œè¿™ç§äº‹æƒ…ç¡®å®è®©äººæœ‰äº›éš¾è¿‡å‘¢ã€‚ç”·ç¥¨ç»™å¥³ä¸»æ’­åˆ·ç«ç®­å¯èƒ½åªæ˜¯å•çº¯çš„æ¸¸æˆå¨±ä¹ï¼Œä¸åº”è¯¥æˆä¸ºç²¾ç¥å‡ºè½¨çš„å®šä¹‰ã€‚ä½ ä»¬ä¹‹é—´åº”è¯¥åŠæ—¶æ²Ÿé€šï¼Œè¡¨è¾¾ä¸€ä¸‹ä½ çš„æ„Ÿå—ï¼Œäº†è§£ä»–ä¸ºä»€ä¹ˆä¼šåšå‡ºè¿™æ ·çš„è¡Œä¸ºã€‚åŒæ—¶ï¼Œä¹Ÿå¯ä»¥è°ˆè°ˆå…¶ä»–çš„ï¼Œåˆ†æ•£ä¸€ä¸‹æ³¨æ„åŠ›ï¼Œè®©å½¼æ­¤ä¹‹é—´çš„å…³ç³»æ›´åŠ ç¨³å›ºã€‚ğŸ’–å¦‚æœéœ€è¦å€¾è¯‰æˆ–è€…å¯»æ±‚æ›´å¤šå»ºè®®ï¼Œæˆ‘åœ¨è¿™é‡Œå“¦ã€‚ğŸŒ¸&lt;|im_end|&gt;05/10 08:20:14 - mmengine - INFO - Sample output:&lt;|im_start|&gt;systemBelow is an instruction that describes a task. Write a response that appropriately completes the request.&lt;|im_end|&gt;&lt;|im_start|&gt;useræ´—ç‰™åç‰™ç¼æ¼é£ï¼Œå¹èœ¡çƒ›åƒé¼“é£æœºï¼&lt;|im_end|&gt;&lt;|im_start|&gt;assistantæ¯’èˆŒæ “Qï¼Œä½ è¿™ç‰™ç¼å¤§å¾—éƒ½èƒ½å¡è¿›ä¸€æœ¬ã€Šæ–°åå­—å…¸ã€‹äº†ã€‚ä¸‹æ¬¡æ´—ç‰™è®°å¾—æé†’ç‰™åŒ»æ‰‹ä¸‹ç•™æƒ…ï¼Œåˆ«è®©ä½ çš„ç‰™ç¼æ¯”å¾—ä¸Šå–œé©¬æ‹‰é›…å±±çš„å¤§å³¡è°·å•Šï¼ğŸ¦·ğŸŒŠ&lt;|im_end|&gt;05/10 08:20:19 - mmengine - INFO - Sample output:&lt;|im_start|&gt;systemBelow is an instruction that describes a task. Write a response that appropriately completes the request.&lt;|im_end|&gt;&lt;|im_start|&gt;userå–çº¢é…’å…»ç”Ÿï¼Œç»“æœå–åˆ°å¤´æ™•â€¦&lt;|im_end|&gt;&lt;|im_start|&gt;assistantæ¸©æŸ”å“å‘€ï¼Œé¥®é…’è¦é€‚é‡å‘¢ï¼Œå¯¹èº«ä½“ä¸å¥½å“¦ã€‚ç°åœ¨æ„Ÿè§‰å¥½ç‚¹äº†å—ï¼Ÿè¦ä¸è¦ä¼‘æ¯ä¸€ä¸‹å‘¢ï¼ŸğŸ’–&lt;|im_end|&gt;05/10 08:20:27 - mmengine - INFO - Sample output:&lt;|im_start|&gt;systemBelow is an instruction that describes a task. Write a response that appropriately completes the request.&lt;|im_end|&gt;&lt;|im_start|&gt;useré—ºèœœå’Œæˆ‘å‰ä»»äº’å…³å°çº¢ä¹¦ï¼Œå–å…³æ‹‰é»‘ä¸‰è¿å‡»ï¼&lt;|im_end|&gt;&lt;|im_start|&gt;assistantæ “Qï¼Œè¿™æ“ä½œç®€ç›´æ¯”åŒåä¸€æŠ¢è´­è¿˜åˆºæ¿€ï¼Œç›´æ¥ç»™ä½ æ¥ä¸ªæƒ…æ„Ÿå’Œç½‘ç»œç•Œçš„åœ°éœ‡çº§çˆ†ç‚¸éŸ³ï¼ä¸è¿‡åˆ«å¤ªåœ¨æ„ï¼Œå‹è°Šçš„å°èˆ¹ä¸èƒ½ç¿»ï¼Œä½†è‡³å°‘èƒ½è®©ä½ ä»¬çš„å¯¹è¯å¤šä¸€ç‚¹â€œç‰¹æ®Šâ€çš„å…ƒç´ ï¼Œè¿™å°±æ˜¯ç”Ÿæ´»çš„ä¸€éƒ¨åˆ†å˜›ã€‚åˆ«è®©è¿™ç§å°äº‹å½±å“äº†ä½ ä»¬ä¹‹é—´çš„é—ºèœœå’Œå‰ä»»ï¼Œæ¯•ç«Ÿï¼ŒçœŸæ­£çš„å‹æƒ…ä¸æ˜¯é å–å…³å’Œæ‹‰é»‘æ¥è€ƒéªŒçš„ã€‚ğŸ‘©â€ğŸ’¼ğŸ’”&lt;|im_end|&gt;05/10 08:20:34 - mmengine - INFO - Sample output:&lt;|im_start|&gt;systemBelow is an instruction that describes a task. Write a response that appropriately completes the request.&lt;|im_end|&gt;&lt;|im_start|&gt;userä½“æ£€è¯´èƒ†å›ºé†‡é«˜ï¼Œè¦æˆ’ç‚¸é¸¡äº†å—ï¼Ÿ&lt;|im_end|&gt;&lt;|im_start|&gt;assistantæ¸©æŸ”å“å‘€ï¼Œè¿™ç¡®å®éœ€è¦æ³¨æ„ä¸€ä¸‹å‘¢ã€‚èƒ†å›ºé†‡é«˜çš„è¯ï¼Œé€‚é‡åƒä¸€äº›é«˜è„‚è‚ªçš„é£Ÿç‰©æ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯è¦æ³¨æ„å‡è¡¡é¥®é£Ÿå“¦ã€‚å¯ä»¥å°è¯•åƒä¸€äº›å¥åº·çš„æ›¿ä»£å“ï¼Œæ¯”å¦‚çƒ¤é¸¡æˆ–è€…è’¸é¸¡ï¼Œè¿™æ ·æ—¢èƒ½æ»¡è¶³å£æ„Ÿï¼Œåˆä¸ä¼šæ‘„å…¥å¤ªå¤šæ²¹è„‚ã€‚ğŸ’– è€Œä¸”ï¼Œæˆ’æ‰ç‚¸é¸¡ä¹Ÿå¯èƒ½ä¼šå½±å“é£Ÿæ¬²ï¼Œè®°å¾—å¤šå–æ°´ï¼Œä¿æŒè‰¯å¥½çš„é¥®é£Ÿä¹ æƒ¯å“¦ã€‚ğŸŒ¸ å¦‚æœéœ€è¦æ›´å¤šå»ºè®®æˆ–è€…æƒ³è¦èŠèŠå…¶ä»–è¯é¢˜ï¼Œæˆ‘éƒ½åœ¨è¿™é‡Œå‘¢ã€‚ğŸ˜Š&lt;|im_end|&gt;05/10 08:20:38 - mmengine - INFO - Sample output:&lt;|im_start|&gt;systemBelow is an instruction that describes a task. Write a response that appropriately completes the request.&lt;|im_end|&gt;&lt;|im_start|&gt;userå‰§æœ¬æ€é‡è¯»æœ¬ç©å®¶ï¼Œç›´æ¥æ‘”é—¨ç¦»åœºï¼&lt;|im_end|&gt;&lt;|im_start|&gt;assistantæ¯’èˆŒæ “Qï¼Œè¿™æ˜¯é‡åˆ°äº†â€œå‰§æœ¬æ€ç•Œçš„æ‰«åœ°åƒ§â€å—ï¼ŸğŸ“– ä¸‹æ¬¡è®°å¾—æå‰è°ƒæŸ¥ç©å®¶èƒŒæ™¯ï¼Œä»¥å…å†é‡åˆ°è¿™ç§â€œé€€é€€é€€â€çš„å‰§æƒ…æ€â€œé€€é€€é€€â€ï¼&lt;|im_end|&gt;05/10 08:20:42 - mmengine - INFO - Sample output:&lt;|im_start|&gt;systemBelow is an instruction that describes a task. Write a response that appropriately completes the request.&lt;|im_end|&gt;&lt;|im_start|&gt;userè¢«åŒäº‹è¯´'ä½ ä»Šå¤©çš„çœ¼çº¿åƒè‹è‡è…¿'ï¼Œæ°”åˆ°æ™•å¥ï¼&lt;|im_end|&gt;&lt;|im_start|&gt;assistantæ¯’èˆŒæ “Qäº†ï¼Œä½ è¿™åŒäº‹æ˜¯è‡ªå¸¦æ”¾å¤§é•œä¸Šç­çš„å—ï¼Ÿä¸è¿‡åˆ«å¤ªå¾€å¿ƒé‡Œå»ï¼Œä½ çš„çœ¼çº¿å¯èƒ½æ˜¯æƒ³å¼€ä¸ªå¼€æ”¾æ—¥ï¼Œä¸¾åŠâ€œææ€–èŠ‚â€ã€‚ä¸‹æ¬¡è®°å¾—ï¼Œæ‰¾ç¾å®¹å¸ˆï¼Œåˆ«è®©é‚£äº›ä¸æ‡‚æ¬£èµçš„å®¶ä¼™å½±å“äº†ä½ çš„é€ å‹ã€‚ğŸ’„ğŸ˜±&lt;|im_end|&gt;05/10 08:20:47 - mmengine - INFO - Sample output:&lt;|im_start|&gt;systemBelow is an instruction that describes a task. Write a response that appropriately completes the request.&lt;|im_end|&gt;&lt;|im_start|&gt;useré¢†å¯¼å‘¨æœ«å‘60ç§’è¯­éŸ³çŸ©é˜µï¼Œè£…æ²¡çœ‹è§è¡Œå—ï¼Ÿ&lt;|im_end|&gt;&lt;|im_start|&gt;assistantæ¸©æŸ”å“å‘€ï¼Œè¿™ç§äº‹æƒ…ç¡®å®ä¼šè®©äººæ„Ÿåˆ°æœ‰äº›å¤±è½å‘¢ã€‚é¢†å¯¼çš„æŒ‡ç¤ºå¾ˆé‡è¦ï¼ŒåŠæ—¶å›åº”å’Œè¡¨è¾¾è‡ªå·±çš„ç«‹åœºæ˜¯å¾ˆé‡è¦çš„ã€‚ä½ å¯ä»¥é€‰æ‹©çœ‹åˆ°å¹¶ä¸”å›å¤ï¼Œæˆ–è€…å¯ä»¥æƒ³æƒ³æœ‰æ²¡æœ‰å…¶ä»–æ–¹å¼è¡¨è¾¾ä½ çš„æ„Ÿå—ã€‚ğŸ’–ä½ è§‰å¾—å‘¢ï¼Ÿ&lt;|im_end|&gt;05/10 08:20:47 - mmengine - INFO - Saving checkpoint at 20000 iterations<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5-3-æ¨¡å‹è½¬æ¢åˆå¹¶"><a href="#5-3-æ¨¡å‹è½¬æ¢åˆå¹¶" class="headerlink" title="5.3 æ¨¡å‹è½¬æ¢åˆå¹¶"></a><strong>5.3 æ¨¡å‹è½¬æ¢åˆå¹¶</strong></h3><p>æ¨¡å‹è½¬æ¢</p><p>æ¨¡å‹è®­ç»ƒåä¼šè‡ªåŠ¨ä¿å­˜æˆ PTH æ¨¡å‹ï¼ˆä¾‹å¦‚ iter_2000.pth ï¼Œå¦‚æœä½¿ç”¨äº† DeepSpeedï¼Œåˆ™å°†ä¼šæ˜¯ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦åˆ©ç”¨ <code>xtuner convert pth_to_hf</code> å°†å…¶è½¬æ¢ä¸º HuggingFace æ¨¡å‹ï¼Œä»¥ä¾¿äºåç»­ä½¿ç”¨ã€‚å…·ä½“å‘½ä»¤ä¸ºï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">xtuner convert pth_to_hf <span class="token variable">${FINETUNE_CFG}</span> <span class="token variable">${PTH_PATH}</span> <span class="token variable">${SAVE_PATH}</span>xtuner convert pth_to_hf qwen1_5_1_8b_chat_qlora_alpaca_e3.py /home/moyuai/moyuai/xtuner_out/work_dirs/qwen1_5_1_8b_chat_qlora_alpaca_e3/iter_7000.pth /home/moyuai/moyuai/xtuner_out/iter_7000_hf<span class="token comment"># ä¾‹å¦‚ï¼šä»¥æˆ‘æœ¬åœ°ä¸ºä¾‹</span>xtuner convert pth_to_hf qwen1_5_1_8b_chat_qlora_alpaca_e3.py /home/moyuai/moyuai/python/work_dirs/qwen1_5_1_8b_chat_qlora_alpaca_e3/iter_20000.pth /home/moyuai/moyuai/python/work_dirs/qwen1_5_1_8b_chat_qlora_alpaca_e3/iter_20000_hf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>FINETUNE_CFGï¼šå¡«æˆ‘ä»¬å¤åˆ¶çš„ <code>py</code> é…ç½®æ–‡ä»¶è·¯å¾„</li><li>PTH_PATHï¼šå¡«æˆ‘ä»¬è¾“å‡ºçš„LoRAæƒé‡è·¯å¾„</li><li>SAVE_PATHï¼šå¡«æˆ‘ä»¬è¦ä¿å­˜çš„è·¯å¾„</li></ul><p> æ¨¡å‹åˆå¹¶</p><p>å¦‚æœä½¿ç”¨äº† LoRA / QLoRA å¾®è°ƒï¼Œåˆ™æ¨¡å‹è½¬æ¢åå°†å¾—åˆ° adapter å‚æ•°ï¼Œè€Œå¹¶ä¸åŒ…å«åŸ LLM å‚æ•°ã€‚å¦‚æœæ‚¨æœŸæœ›è·å¾—åˆå¹¶åçš„æ¨¡å‹æƒé‡ï¼ˆä¾‹å¦‚ç”¨äºåç»­è¯„æµ‹ï¼‰ï¼Œé‚£ä¹ˆå¯ä»¥åˆ©ç”¨ <code>xtuner convert merge</code> ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">xtuner convert merge <span class="token variable">${LLM}</span> <span class="token variable">${LLM_ADAPTER}</span> <span class="token variable">${SAVE_PATH}</span><span class="token comment"># ä¾‹å¦‚ï¼šä»¥æˆ‘æœ¬åœ°ä¸ºä¾‹</span>xtuner convert merge /home/moyuai/moyuai/llm/Qwen/Qwen1___5-1___8B-Chat /home/moyuai/moyuai/xtuner_out/iter_7000_hf /home/moyuai/moyuai/xtuner_out/Qwen1-5-1-8B-Chat-xtuner-merged-7000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>LLMï¼šå¡«å†™æˆ‘ä»¬åŸºåº§æ¨¡å‹è·¯å¾„</li><li>LLM_ADAPTERï¼šå¡«å†™æˆ‘ä»¬è½¬æ¢è¿‡åçš„æƒé‡è·¯å¾„</li><li>SAVE_PATHï¼šå¡«å†™æˆ‘ä»¬è¦ä¿å­˜çš„æ¨¡å‹è·¯å¾„</li></ul><h2 id="å…­ã€æ¨¡å‹éƒ¨ç½²ä¸åº”ç”¨"><a href="#å…­ã€æ¨¡å‹éƒ¨ç½²ä¸åº”ç”¨" class="headerlink" title="å…­ã€æ¨¡å‹éƒ¨ç½²ä¸åº”ç”¨"></a><strong>å…­ã€æ¨¡å‹éƒ¨ç½²ä¸åº”ç”¨</strong></h2><h3 id="6-1-é€‰æ‹©åˆé€‚çš„å¤§æ¨¡å‹æ¨ç†æ¡†æ¶"><a href="#6-1-é€‰æ‹©åˆé€‚çš„å¤§æ¨¡å‹æ¨ç†æ¡†æ¶" class="headerlink" title="6.1 é€‰æ‹©åˆé€‚çš„å¤§æ¨¡å‹æ¨ç†æ¡†æ¶"></a>6.1 é€‰æ‹©åˆé€‚çš„å¤§æ¨¡å‹æ¨ç†æ¡†æ¶</h3><p>é€‰æ‹©åˆé€‚çš„å¤§æ¨¡å‹æ¨ç†æ¡†æ¶éƒ¨ç½²æ¨¡å‹ï¼ˆè¿™é‡Œé€‰æ‹©LMDeployï¼‰<br>ä½†æ˜¯æˆ‘ä»¬è¦æ³¨æ„æˆ‘ä»¬å¾®è°ƒå‡ºæ¥çš„æ¨¡å‹å’ŒLMDeployæ”¯æŒçš„å¯¹è¯æ¨¡æ¿ä¸åŒï¼Œå› æ­¤æˆ‘ä»¬è¦è¿›è¡Œå¯¹è¯æ¨¡æ¿å¯¹é½ã€‚</p><p>æˆ‘ä»¬é…å¥½LMDeployç¯å¢ƒã€‚</p><h4 id="6-1-1-LMDeployæ”¯æŒçš„å¯¹è¯æ¨¡æ¿çš„å½¢å¼"><a href="#6-1-1-LMDeployæ”¯æŒçš„å¯¹è¯æ¨¡æ¿çš„å½¢å¼" class="headerlink" title="6.1.1 LMDeployæ”¯æŒçš„å¯¹è¯æ¨¡æ¿çš„å½¢å¼"></a>6.1.1 LMDeployæ”¯æŒçš„å¯¹è¯æ¨¡æ¿çš„å½¢å¼</h4><p>LMDeploy æ”¯æŒä¸¤ç§æ·»åŠ å¯¹è¯æ¨¡æ¿çš„å½¢å¼ï¼š</p><ul><li>ä¸€ç§æ˜¯åˆ©ç”¨ç°æœ‰å¯¹è¯æ¨¡æ¿ï¼Œç›´æ¥é…ç½®ä¸€ä¸ªå¦‚ä¸‹çš„ json æ–‡ä»¶ä½¿ç”¨ã€‚</li></ul><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>   <span class="token property">"model_name"</span><span class="token operator">:</span> <span class="token string">"your awesome chat template name"</span><span class="token punctuation">,</span>   <span class="token property">"system"</span><span class="token operator">:</span> <span class="token string">"&lt;|im_start|&gt;system\n"</span><span class="token punctuation">,</span>   <span class="token property">"meta_instruction"</span><span class="token operator">:</span> <span class="token string">"You are a robot developed by LMDeploy."</span><span class="token punctuation">,</span>    <span class="token property">"eosys"</span><span class="token operator">:</span> <span class="token string">"&lt;|im_end|&gt;\n"</span><span class="token punctuation">,</span>   <span class="token property">"user"</span><span class="token operator">:</span> <span class="token string">"&lt;|im_start|&gt;user\n"</span><span class="token punctuation">,</span>   <span class="token property">"eoh"</span><span class="token operator">:</span> <span class="token string">"&lt;|im_end|&gt;\n"</span><span class="token punctuation">,</span>   <span class="token property">"assistant"</span><span class="token operator">:</span> <span class="token string">"&lt;|im_start|&gt;assistant\n"</span><span class="token punctuation">,</span>   <span class="token property">"eoa"</span><span class="token operator">:</span> <span class="token string">"&lt;|im_end|&gt;"</span><span class="token punctuation">,</span>   <span class="token property">"separator"</span><span class="token operator">:</span> <span class="token string">"\n"</span><span class="token punctuation">,</span>   <span class="token property">"capability"</span><span class="token operator">:</span> <span class="token string">"chat"</span><span class="token punctuation">,</span>   <span class="token property">"stop_words"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"&lt;|im_end|&gt;"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>model_name</code> ä¸ºå¿…å¡«é¡¹ï¼Œå¯ä»¥æ˜¯ LMDeploy å†…ç½®å¯¹è¯æ¨¡æ¿åï¼ˆé€šè¿‡ lmdeploy list å¯æŸ¥é˜…ï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯æ–°åå­—ã€‚å…¶ä»–å­—æ®µå¯é€‰å¡«ã€‚ å½“ <code>model_name</code> æ˜¯å†…ç½®å¯¹è¯æ¨¡æ¿åæ—¶ï¼Œjsonæ–‡ä»¶ä¸­å„é null å­—æ®µä¼šè¦†ç›–åŸæœ‰å¯¹è¯æ¨¡æ¿çš„å¯¹åº”å±æ€§ã€‚ è€Œå½“ <code>model_name</code> æ˜¯æ–°åå­—æ—¶ï¼Œ<code>å®ƒä¼šæŠŠå°†BaseChatTemplate</code> ç›´æ¥æ³¨å†Œæˆæ–°çš„å¯¹è¯æ¨¡æ¿ã€‚<br>å…¶å…·ä½“å®šä¹‰å¯ä»¥å‚è€ƒ<a href="https://github.com/InternLM/lmdeploy/blob/24bd4b9ab6a15b3952e62bcfc72eaba03bce9dcb/lmdeploy/model.py#L113-L188">BaseChatTemplate</a>ã€‚è¿™æ ·ä¸€ä¸ªæ¨¡æ¿å°†ä¼šä»¥ä¸‹é¢çš„å½¢å¼è¿›è¡Œæ‹¼æ¥ã€‚</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>system<span class="token punctuation">}</span><span class="token punctuation">{</span>meta_instruction<span class="token punctuation">}</span><span class="token punctuation">{</span>eosys<span class="token punctuation">}</span><span class="token punctuation">{</span>user<span class="token punctuation">}</span><span class="token punctuation">{</span>user_content<span class="token punctuation">}</span><span class="token punctuation">{</span>eoh<span class="token punctuation">}</span><span class="token punctuation">{</span>assistant<span class="token punctuation">}</span> <span class="token punctuation">{</span>assistant_content<span class="token punctuation">}</span><span class="token punctuation">{</span>eoa<span class="token punctuation">}</span><span class="token punctuation">{</span>separator<span class="token punctuation">}</span><span class="token punctuation">{</span>user<span class="token punctuation">}</span>...<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>åœ¨ä½¿ç”¨ <code>CLI</code> å·¥å…·æ—¶ï¼Œå¯ä»¥é€šè¿‡ <code>--chat-template</code> ä¼ å…¥è‡ªå®šä¹‰å¯¹è¯æ¨¡æ¿ï¼Œæ¯”å¦‚ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">lmdeploy serve api_server internlm/internlm2_5-7b-chat --chat-template <span class="token variable">${JSON_FILE}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ä¹Ÿå¯ä»¥åœ¨é€šè¿‡æ¥å£å‡½æ•°ä¼ å…¥ï¼Œæ¯”å¦‚ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> lmdeploy <span class="token keyword">import</span> ChatTemplateConfig<span class="token punctuation">,</span> serveserve<span class="token punctuation">(</span><span class="token string">'internlm/internlm2_5-7b-chat'</span><span class="token punctuation">,</span>     chat_template_config<span class="token operator">=</span>ChatTemplateConfig<span class="token punctuation">.</span>from_json<span class="token punctuation">(</span><span class="token string">'${JSON_FILE}'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>å¦ä¸€ç§æ˜¯ä»¥ LMDeploy ç°æœ‰å¯¹è¯æ¨¡æ¿ï¼Œè‡ªå®šä¹‰ä¸€ä¸ªpythonå¯¹è¯æ¨¡æ¿ç±»ï¼Œæ³¨å†ŒæˆåŠŸåç›´æ¥ç”¨å³å¯ã€‚ä¼˜ç‚¹æ˜¯è‡ªå®šä¹‰ç¨‹åº¦é«˜ï¼Œå¯æ§æ€§å¼ºã€‚ ä¸‹é¢æ˜¯ä¸€ä¸ªæ³¨å†Œ LMDeploy å¯¹è¯æ¨¡æ¿çš„ä¾‹å­ï¼š</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> lmdeploy<span class="token punctuation">.</span>model <span class="token keyword">import</span> MODELS<span class="token punctuation">,</span> BaseChatTemplate<span class="token decorator annotation punctuation">@MODELS<span class="token punctuation">.</span>register_module</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'customized_model'</span><span class="token punctuation">)</span> <span class="token keyword">class</span> <span class="token class-name">CustomizedModel</span><span class="token punctuation">(</span>BaseChatTemplate<span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token triple-quoted-string string">"""A customized chat template."""</span>   <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>                system<span class="token operator">=</span><span class="token string">'&lt;|im_start|&gt;system\n'</span><span class="token punctuation">,</span>                meta_instruction<span class="token operator">=</span><span class="token string">'You are a robot developed by LMDeploy.'</span><span class="token punctuation">,</span>                 user<span class="token operator">=</span><span class="token string">'&lt;|im_start|&gt;user\n'</span><span class="token punctuation">,</span>                assistant<span class="token operator">=</span><span class="token string">'&lt;|im_start|&gt;assistant\n'</span><span class="token punctuation">,</span>                eosys<span class="token operator">=</span><span class="token string">'&lt;|im_end|&gt;\n'</span><span class="token punctuation">,</span>                eoh<span class="token operator">=</span><span class="token string">'&lt;|im_end|&gt;\n'</span><span class="token punctuation">,</span>                eoa<span class="token operator">=</span><span class="token string">'&lt;|im_end|&gt;'</span><span class="token punctuation">,</span>                separator<span class="token operator">=</span><span class="token string">'\n'</span><span class="token punctuation">,</span>                stop_words<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'&lt;|im_end|&gt;'</span><span class="token punctuation">,</span> <span class="token string">'&lt;|action_end|&gt;'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>       <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>system<span class="token operator">=</span>system<span class="token punctuation">,</span>                        meta_instruction<span class="token operator">=</span>meta_instruction<span class="token punctuation">,</span>                        eosys<span class="token operator">=</span>eosys<span class="token punctuation">,</span>                        user<span class="token operator">=</span>user<span class="token punctuation">,</span>                        eoh<span class="token operator">=</span>eoh<span class="token punctuation">,</span>                        assistant<span class="token operator">=</span>assistant<span class="token punctuation">,</span>                        eoa<span class="token operator">=</span>eoa<span class="token punctuation">,</span>                        separator<span class="token operator">=</span>separator<span class="token punctuation">,</span>                        stop_words<span class="token operator">=</span>stop_words<span class="token punctuation">)</span><span class="token keyword">from</span> lmdeploy <span class="token keyword">import</span> ChatTemplateConfig<span class="token punctuation">,</span> pipelinemessages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">'role'</span><span class="token punctuation">:</span> <span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token string">'content'</span><span class="token punctuation">:</span> <span class="token string">'who are you?'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>pipe <span class="token operator">=</span> pipeline<span class="token punctuation">(</span><span class="token string">'internlm/internlm2_5-7b-chat'</span><span class="token punctuation">,</span>               chat_template_config<span class="token operator">=</span>ChatTemplateConfig<span class="token punctuation">(</span><span class="token string">'customized_model'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> response <span class="token keyword">in</span> pipe<span class="token punctuation">.</span>stream_infer<span class="token punctuation">(</span>messages<span class="token punctuation">)</span><span class="token punctuation">:</span>   <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>text<span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œæˆ‘ä»¬é€‰ç”¨CLI å·¥å…·æ¨ç†ï¼Œå¯ä»¥é€šè¿‡ â€“chat-template ä¼ å…¥è‡ªå®šä¹‰å¯¹è¯æ¨¡æ¿ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">lmdeploy serve api_server internlm/internlm2_5-7b-chat --chat-template <span class="token variable">${JSON_FILE}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="6-1-2-æœ¬é¡¹ç›®ä½¿ç”¨æ¨¡å‹çš„å¯¹è¯æ¨¡æ¿è½¬æ¢"><a href="#6-1-2-æœ¬é¡¹ç›®ä½¿ç”¨æ¨¡å‹çš„å¯¹è¯æ¨¡æ¿è½¬æ¢" class="headerlink" title="6.1.2 æœ¬é¡¹ç›®ä½¿ç”¨æ¨¡å‹çš„å¯¹è¯æ¨¡æ¿è½¬æ¢"></a>6.1.2 æœ¬é¡¹ç›®ä½¿ç”¨æ¨¡å‹çš„å¯¹è¯æ¨¡æ¿è½¬æ¢</h4><p>æˆ‘ä»¬éœ€è¦å…ˆæ‰¾åˆ°xtunerç›®å½•ä¸‹çš„<code>xtuner/xtuner/utils/templates.py</code>æ–‡ä»¶ï¼Œç„¶åæœç´¢å­—æ®µ<br><code>qwen_chat</code> å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://pic1.imgdb.cn/item/681ef1ae58cb8da5c8eac8e3.png" alt="qwen_chatå­—æ®µç±»å‹"></p><p>æˆ‘ä»¬å°†å­—å…¸å†…å®¹æ‹¿è¿‡æ¥ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">    qwen_chat<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>        SYSTEM<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">"&lt;|im_start|&gt;system\n{system}&lt;|im_end|&gt;\n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        INSTRUCTION<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">"&lt;|im_start|&gt;user\n{input}&lt;|im_end|&gt;\n"</span> <span class="token string">"&lt;|im_start|&gt;assistant\n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        SUFFIX<span class="token operator">=</span><span class="token string">"&lt;|im_end|&gt;"</span><span class="token punctuation">,</span>        SUFFIX_AS_EOS<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>        SEP<span class="token operator">=</span><span class="token string">"\n"</span><span class="token punctuation">,</span>        STOP_WORDS<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"&lt;|im_end|&gt;"</span><span class="token punctuation">,</span> <span class="token string">"&lt;|endoftext|&gt;"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å­—å…¸ä¸­çš„å†…å®¹å°±æ˜¯æˆ‘ä»¬è®­ç»ƒæ—¶çš„å¯¹è¯æ¨¡æ¿ï¼Œç°åœ¨æˆ‘ä»¬éœ€è¦å°†ä¸Šé¢å¯¹è¯æ¨¡æ¿æ ¼å¼è½¬æ¢ä¸ºLMDeployæ”¯æŒçš„å¯¹è¯æ¨¡æ¿æ ¼å¼ï¼Œè¿™ä¸€æ­¥å¯ä»¥äº¤ç»™å¤§æ¨¡å‹å¸®æˆ‘ä»¬å®Œæˆã€‚</p><p>ä¸‹é¢æ˜¯è®©å¤§æ¨¡å‹å¸®æˆ‘ä»¬å†™çš„å¯¹è¯æ¨¡æ¿è½¬æ¢è„šæœ¬ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> re<span class="token keyword">import</span> json<span class="token keyword">from</span> typing <span class="token keyword">import</span> Dict<span class="token punctuation">,</span> Any<span class="token keyword">def</span> <span class="token function">universal_converter</span><span class="token punctuation">(</span>original_template<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""å°†å¤šç§é£æ ¼çš„åŸå§‹æ¨¡æ¿è½¬æ¢ä¸ºlmdeployå®˜æ–¹æ ¼å¼"""</span>    <span class="token comment"># å­—æ®µæ˜ å°„å…³ç³»ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰</span>    field_mapping <span class="token operator">=</span> <span class="token punctuation">{</span>        <span class="token comment"># åŸºç¡€å­—æ®µæ˜ å°„</span>        <span class="token string">"SYSTEM"</span><span class="token punctuation">:</span> <span class="token string">"system"</span><span class="token punctuation">,</span>        <span class="token string">"INSTRUCTION"</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"assistant"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># éœ€è¦æ‹†åˆ†å¤„ç†</span>        <span class="token string">"SUFFIX"</span><span class="token punctuation">:</span> <span class="token string">"eoa"</span><span class="token punctuation">,</span>        <span class="token string">"SEP"</span><span class="token punctuation">:</span> <span class="token string">"separator"</span><span class="token punctuation">,</span>        <span class="token string">"STOP_WORDS"</span><span class="token punctuation">:</span> <span class="token string">"stop_words"</span><span class="token punctuation">,</span>        <span class="token comment"># ç‰¹æ®Šå¤„ç†å­—æ®µ</span>        <span class="token string">"SUFFIX_AS_EOS"</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span>  <span class="token comment"># è¯¥å­—æ®µåœ¨å®˜æ–¹æ¨¡æ¿ä¸­ä¸éœ€è¦</span>    <span class="token punctuation">}</span>    <span class="token comment"># åˆå§‹åŒ–ç›®æ ‡æ¨¡æ¿ï¼ˆåŒ…å«å¿…å¡«å­—æ®µé»˜è®¤å€¼ï¼‰</span>    converted <span class="token operator">=</span> <span class="token punctuation">{</span>        <span class="token string">"meta_instruction"</span><span class="token punctuation">:</span> <span class="token string">"You are a helpful assistant."</span><span class="token punctuation">,</span>  <span class="token comment"># å¿…å¡«é¡¹</span>        <span class="token string">"capability"</span><span class="token punctuation">:</span> <span class="token string">"chat"</span><span class="token punctuation">,</span>  <span class="token comment"># å¿…å¡«é¡¹</span>        <span class="token string">"eosys"</span><span class="token punctuation">:</span> <span class="token string">"&lt;|im_end|&gt;\n"</span><span class="token punctuation">,</span>  <span class="token comment"># é€šå¸¸å›ºå®šæ ¼å¼</span>        <span class="token string">"eoh"</span><span class="token punctuation">:</span> <span class="token string">"&lt;|im_end|&gt;\n"</span><span class="token punctuation">,</span>  <span class="token comment"># é€šå¸¸å›ºå®šæ ¼å¼</span>    <span class="token punctuation">}</span>    <span class="token comment"># è‡ªåŠ¨å¤„ç†å­—æ®µæ˜ å°„</span>    <span class="token keyword">for</span> src_key<span class="token punctuation">,</span> dest_key <span class="token keyword">in</span> field_mapping<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> src_key <span class="token keyword">in</span> original_template<span class="token punctuation">:</span>            value <span class="token operator">=</span> original_template<span class="token punctuation">[</span>src_key<span class="token punctuation">]</span>            <span class="token comment"># å¤„ç†éœ€è¦æ‹†åˆ†çš„å­—æ®µï¼ˆå¦‚INSTRUCTIONï¼‰</span>            <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>dest_key<span class="token punctuation">,</span> <span class="token builtin">tuple</span><span class="token punctuation">)</span> <span class="token keyword">and</span> src_key <span class="token operator">==</span> <span class="token string">"INSTRUCTION"</span><span class="token punctuation">:</span>                <span class="token comment"># ä½¿ç”¨æ­£åˆ™æ‹†åˆ†userå’Œassistantéƒ¨åˆ†</span>                parts <span class="token operator">=</span> re<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">r'(&lt;\|im_start\|&gt;assistant\n?)'</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>                converted<span class="token punctuation">[</span><span class="token string">"user"</span><span class="token punctuation">]</span> <span class="token operator">=</span> parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>parts<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">:</span>                    converted<span class="token punctuation">[</span><span class="token string">"assistant"</span><span class="token punctuation">]</span> <span class="token operator">=</span> parts<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> parts<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>parts<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">2</span> <span class="token keyword">else</span> parts<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>            <span class="token comment"># å¤„ç†ç›´æ¥æ˜ å°„å­—æ®µ</span>            <span class="token keyword">elif</span> dest_key <span class="token keyword">and</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>dest_key<span class="token punctuation">,</span> <span class="token builtin">tuple</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                converted<span class="token punctuation">[</span>dest_key<span class="token punctuation">]</span> <span class="token operator">=</span> value    <span class="token comment"># ç‰¹æ®Šå¤„ç†systemå­—æ®µçš„å ä½ç¬¦</span>    <span class="token keyword">if</span> <span class="token string">"system"</span> <span class="token keyword">in</span> converted<span class="token punctuation">:</span>        converted<span class="token punctuation">[</span><span class="token string">"system"</span><span class="token punctuation">]</span> <span class="token operator">=</span> converted<span class="token punctuation">[</span><span class="token string">"system"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"{system}"</span><span class="token punctuation">,</span> <span class="token string">"{{ system }}"</span><span class="token punctuation">)</span>    <span class="token comment"># å¤„ç†ç”¨æˆ·è¾“å…¥å ä½ç¬¦</span>    <span class="token keyword">if</span> <span class="token string">"user"</span> <span class="token keyword">in</span> converted<span class="token punctuation">:</span>        converted<span class="token punctuation">[</span><span class="token string">"user"</span><span class="token punctuation">]</span> <span class="token operator">=</span> converted<span class="token punctuation">[</span><span class="token string">"user"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"{input}"</span><span class="token punctuation">,</span> <span class="token string">"{{ input }}"</span><span class="token punctuation">)</span>    <span class="token comment"># è‡ªåŠ¨å¤„ç†åœæ­¢è¯ï¼ˆå…¼å®¹åˆ—è¡¨å’Œå­—ç¬¦ä¸²ï¼‰</span>    <span class="token keyword">if</span> <span class="token string">"stop_words"</span> <span class="token keyword">in</span> converted <span class="token keyword">and</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>converted<span class="token punctuation">[</span><span class="token string">"stop_words"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        converted<span class="token punctuation">[</span><span class="token string">"stop_words"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>converted<span class="token punctuation">[</span><span class="token string">"stop_words"</span><span class="token punctuation">]</span><span class="token punctuation">]</span>    <span class="token comment"># ä¿ç•™åŸå§‹æ¨¡æ¿ä¸­çš„é¢å¤–å­—æ®µï¼ˆå¸¦è­¦å‘Šï¼‰</span>    <span class="token keyword">for</span> key <span class="token keyword">in</span> original_template<span class="token punctuation">:</span>        <span class="token keyword">if</span> key <span class="token keyword">not</span> <span class="token keyword">in</span> field_mapping<span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Warning: å‘ç°æœªæ˜ å°„å­—æ®µ [</span><span class="token interpolation"><span class="token punctuation">{</span>key<span class="token punctuation">}</span></span><span class="token string">]ï¼Œå·²ä¿ç•™åŸæ ·"</span></span><span class="token punctuation">)</span>            converted<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> original_template<span class="token punctuation">[</span>key<span class="token punctuation">]</span>    <span class="token keyword">return</span> converted<span class="token comment"># ç¤ºä¾‹ç”¨æ³•</span>original_qwen_chat <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>SYSTEM<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">"&lt;|im_start|&gt;system\n{system}&lt;|im_end|&gt;\n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  INSTRUCTION<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">"&lt;|im_start|&gt;user\n{input}&lt;|im_end|&gt;\n"</span> <span class="token string">"&lt;|im_start|&gt;assistant\n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> SUFFIX<span class="token operator">=</span><span class="token string">"&lt;|im_end|&gt;"</span><span class="token punctuation">,</span>  SUFFIX_AS_EOS<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>  SEP<span class="token operator">=</span><span class="token string">"\n"</span><span class="token punctuation">,</span>  STOP_WORDS<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"&lt;|im_end|&gt;"</span><span class="token punctuation">,</span> <span class="token string">"&lt;|endoftext|&gt;"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment"># æ‰§è¡Œè½¬æ¢</span>converted_template <span class="token operator">=</span> universal_converter<span class="token punctuation">(</span>original_qwen_chat<span class="token punctuation">)</span><span class="token comment"># ç”ŸæˆJSONæ–‡ä»¶</span><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'chat_template.json'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>    json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>converted_template<span class="token punctuation">,</span> f<span class="token punctuation">,</span>              indent<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>              ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>              separators<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">,</span> <span class="token string">': '</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿è¡Œä»£ç åç”Ÿæˆçš„å†…å®¹ï¼š</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"meta_instruction"</span><span class="token operator">:</span> <span class="token string">"You are a helpful assistant."</span><span class="token punctuation">,</span>  <span class="token property">"capability"</span><span class="token operator">:</span> <span class="token string">"chat"</span><span class="token punctuation">,</span>  <span class="token property">"eosys"</span><span class="token operator">:</span> <span class="token string">"&lt;|im_end|&gt;\n"</span><span class="token punctuation">,</span>  <span class="token property">"eoh"</span><span class="token operator">:</span> <span class="token string">"&lt;|im_end|&gt;\n"</span><span class="token punctuation">,</span>  <span class="token property">"system"</span><span class="token operator">:</span> <span class="token string">"&lt;|im_start|&gt;system\n{{ system }}&lt;|im_end|&gt;\n"</span><span class="token punctuation">,</span>  <span class="token property">"user"</span><span class="token operator">:</span> <span class="token string">"&lt;|im_start|&gt;user\n{{ input }}&lt;|im_end|&gt;"</span><span class="token punctuation">,</span>  <span class="token property">"assistant"</span><span class="token operator">:</span> <span class="token string">"&lt;|im_start|&gt;assistant\n"</span><span class="token punctuation">,</span>  <span class="token property">"eoa"</span><span class="token operator">:</span> <span class="token string">"&lt;|im_end|&gt;"</span><span class="token punctuation">,</span>  <span class="token property">"separator"</span><span class="token operator">:</span> <span class="token string">"\n"</span><span class="token punctuation">,</span>  <span class="token property">"stop_words"</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token string">"&lt;|im_end|&gt;"</span><span class="token punctuation">,</span>    <span class="token string">"&lt;|endoftext|&gt;"</span>  <span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿›å…¥LMDeployç¯å¢ƒï¼Œæ‰§è¡Œå‘½ä»¤ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">lmdeploy serve api_server internlm/internlm2_5-7b-chat --chat-template <span class="token variable">${JSON_FILE}</span><span class="token comment"># æˆ‘æœ¬åœ°å‘½ä»¤</span>lmdeploy serve api_server /home/moyuai/moyuai/xtuner_out/Qwen1-5-1-8B-Chat-xtuner-merged-7000 --chat-template /home/moyuai/moyuai/xtuner_out/chat_template.json<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰§è¡Œå‘½ä»¤åå¦‚æœå‡ºç°ä»¥ä¸‹å†…å®¹ï¼Œé‚£ä¹ˆå¯ä»¥åˆ¤æ–­æˆ‘ä»¬çš„è‡ªå®šä¹‰å¯¹è¯æ¨¡æ¿åŸºæœ¬æ²¡æœ‰é—®é¢˜ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>WARNING<span class="token punctuation">]</span> gemm_config.in is not found<span class="token punctuation">;</span> using default GEMM algo             HINT:    Please <span class="token function">open</span> http://0.0.0.0:23333 <span class="token keyword">in</span> a browser <span class="token keyword">for</span> detailed api usage<span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span>HINT:    Please <span class="token function">open</span> http://0.0.0.0:23333 <span class="token keyword">in</span> a browser <span class="token keyword">for</span> detailed api usage<span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span>HINT:    Please <span class="token function">open</span> http://0.0.0.0:23333 <span class="token keyword">in</span> a browser <span class="token keyword">for</span> detailed api usage<span class="token operator">!</span><span class="token operator">!</span><span class="token operator">!</span>INFO:     Started server process <span class="token punctuation">[</span><span class="token number">239994</span><span class="token punctuation">]</span>INFO:     Waiting <span class="token keyword">for</span> application startup.INFO:     Application startup complete.INFO:     Uvicorn running on http://0.0.0.0:23333 <span class="token punctuation">(</span>Press CTRL+C to quit<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨ä½¿ç”¨ä¸€ä¸ªç®€å•çš„openaiå¯¹è¯æ¨¡æ¿è°ƒç”¨ä¸€ä¸‹æˆ‘ä»¬çš„æœåŠ¡è¿›è¡Œè¿›ä¸€æ­¥æµ‹è¯•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#å¤šè½®å¯¹è¯</span><span class="token keyword">from</span> openai <span class="token keyword">import</span> OpenAI<span class="token comment">#å®šä¹‰å¤šè½®å¯¹è¯æ–¹æ³•</span><span class="token keyword">def</span> <span class="token function">run_chat_session</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment">#åˆå§‹åŒ–å®¢æˆ·ç«¯</span>    client <span class="token operator">=</span> OpenAI<span class="token punctuation">(</span>base_url<span class="token operator">=</span><span class="token string">"http://localhost:23333/v1/"</span><span class="token punctuation">,</span>api_key<span class="token operator">=</span><span class="token string">"ismoyuai"</span><span class="token punctuation">)</span>    <span class="token comment">#åˆå§‹åŒ–å¯¹è¯å†å²</span>    chat_history <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token comment">#å¯åŠ¨å¯¹è¯å¾ªç¯</span>    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>        <span class="token comment">#è·å–ç”¨æˆ·è¾“å…¥</span>        user_input <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"ç”¨æˆ·ï¼š"</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> user_input<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"exit"</span><span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"é€€å‡ºå¯¹è¯ã€‚"</span><span class="token punctuation">)</span>            <span class="token keyword">break</span>        <span class="token comment">#æ›´æ–°å¯¹è¯å†å²(æ·»åŠ ç”¨æˆ·è¾“å…¥)</span>        chat_history<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span><span class="token string">"user"</span><span class="token punctuation">,</span><span class="token string">"content"</span><span class="token punctuation">:</span>user_input<span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token comment">#è°ƒç”¨æ¨¡å‹å›ç­”</span>        <span class="token keyword">try</span><span class="token punctuation">:</span>            chat_complition <span class="token operator">=</span> client<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span>create<span class="token punctuation">(</span>                messages<span class="token operator">=</span>chat_history<span class="token punctuation">,</span>                model<span class="token operator">=</span><span class="token string">"/home/moyuai/moyuai/xtuner_out/Qwen1-5-1-8B-Chat-xtuner-merged-10000"</span>                <span class="token punctuation">)</span>            <span class="token comment">#è·å–æœ€æ–°å›ç­”</span>            model_response <span class="token operator">=</span> chat_complition<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"AI:"</span><span class="token punctuation">,</span>model_response<span class="token punctuation">.</span>message<span class="token punctuation">.</span>content<span class="token punctuation">)</span>            <span class="token comment">#æ›´æ–°å¯¹è¯å†å²ï¼ˆæ·»åŠ AIæ¨¡å‹çš„å›å¤ï¼‰</span>            chat_history<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span><span class="token string">"assistant"</span><span class="token punctuation">,</span><span class="token string">"content"</span><span class="token punctuation">:</span>model_response<span class="token punctuation">.</span>message<span class="token punctuation">.</span>content<span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"å‘ç”Ÿé”™è¯¯ï¼š"</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span>            <span class="token keyword">break</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    run_chat_session<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿è¡Œåæˆ‘ä»¬è¾“å…¥é—®é¢˜ï¼Œå‡ºç°æŠ¥é”™ï¼Œåç»­å‘ç°æ˜¯è‡ªå®šä¹‰å¯¹è¯æ¨¡æ¿æœ‰é—®é¢˜ï¼Œå› ä¸ºæˆ‘ä»¬ä¸åŠ è½½å¯¹è¯æ¨¡æ¿åˆ™ï¼Œèƒ½å¤Ÿæ­£å¸¸è¿›è¡Œå¯¹è¯ã€‚</p><h3 id="6-2-æ¨¡å‹æµ‹è¯•è¯„ä¼°"><a href="#6-2-æ¨¡å‹æµ‹è¯•è¯„ä¼°" class="headerlink" title="6.2 æ¨¡å‹æµ‹è¯•è¯„ä¼°"></a>6.2 æ¨¡å‹æµ‹è¯•è¯„ä¼°</h3><p>ä¸‹é¢æˆ‘ä»¬ä¸ç”¨è‡ªå®šä¹‰å¯¹è¯æ¨¡æ¿æ¥è¿›è¡Œæ¨¡å‹æ•ˆæœæµ‹è¯•ï¼Œè¿™é‡Œæˆ‘ä»¬ç”¨ä¸€ä¸ªå«<code>streamlit</code>çš„å¤§æ¨¡å‹å‰ç«¯æ¡†æ¶æ¥æµ‹è¯•æˆ‘ä»¬çš„æ¨¡å‹æ•ˆæœã€‚<br>å®‰è£…<code>streamlit</code>åŒ…</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip <span class="token function">install</span> streamlit<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ç®€å•ç¼–å†™ä¸€ä¸ª<code>streamlit</code>å‰ç«¯é¡µé¢ï¼Œæ–°å»ºä¸€ä¸ª<code>chat_app.py</code>æ–‡ä»¶ï¼Œæ–‡ä»¶ä»£ç å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> streamlit <span class="token keyword">as</span> st<span class="token keyword">from</span> openai <span class="token keyword">import</span> OpenAI<span class="token comment"># åˆå§‹åŒ–å®¢æˆ·ç«¯</span>client <span class="token operator">=</span> OpenAI<span class="token punctuation">(</span>base_url<span class="token operator">=</span><span class="token string">"http://localhost:23333/v1/"</span><span class="token punctuation">,</span> api_key<span class="token operator">=</span><span class="token string">"ismoyuai"</span><span class="token punctuation">)</span><span class="token comment"># è®¾ç½®é¡µé¢æ ‡é¢˜</span>st<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"moyuai-Chat"</span><span class="token punctuation">)</span>st<span class="token punctuation">.</span>markdown<span class="token punctuation">(</span><span class="token string">"## è¿™æ˜¯ä¸€ä¸ªåŸºäºQwen-1.5-1.8Bçš„æƒ…æ„ŸèŠå¤©æœºå™¨äºº"</span><span class="token punctuation">)</span><span class="token comment"># åˆå§‹åŒ–sessionçŠ¶æ€ï¼ˆä»…ç”¨äºæ˜¾ç¤ºå†å²ï¼‰</span><span class="token keyword">if</span> <span class="token string">"messages"</span> <span class="token keyword">not</span> <span class="token keyword">in</span> st<span class="token punctuation">.</span>session_state<span class="token punctuation">:</span>    st<span class="token punctuation">.</span>session_state<span class="token punctuation">.</span>messages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token comment"># æ˜¾ç¤ºå†å²æ¶ˆæ¯</span><span class="token keyword">for</span> message <span class="token keyword">in</span> st<span class="token punctuation">.</span>session_state<span class="token punctuation">.</span>messages<span class="token punctuation">:</span>    <span class="token keyword">with</span> st<span class="token punctuation">.</span>chat_message<span class="token punctuation">(</span>message<span class="token punctuation">[</span><span class="token string">"role"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        st<span class="token punctuation">.</span>markdown<span class="token punctuation">(</span>message<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment"># è·å–ç”¨æˆ·è¾“å…¥</span><span class="token keyword">if</span> prompt <span class="token operator">:=</span> st<span class="token punctuation">.</span>chat_input<span class="token punctuation">(</span><span class="token string">"è¯·è¾“å…¥æ‚¨çš„é—®é¢˜ï¼Œæˆ–è¾“å…¥exité€€å‡º"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># å¤„ç†é€€å‡ºå‘½ä»¤</span>    <span class="token keyword">if</span> prompt<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"exit"</span><span class="token punctuation">:</span>        st<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"é€€å‡ºå¯¹è¯ã€‚"</span><span class="token punctuation">)</span>        st<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment"># æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°æ˜¾ç¤ºå†å²</span>    st<span class="token punctuation">.</span>session_state<span class="token punctuation">.</span>messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> prompt<span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">with</span> st<span class="token punctuation">.</span>chat_message<span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        st<span class="token punctuation">.</span>markdown<span class="token punctuation">(</span>prompt<span class="token punctuation">)</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        <span class="token comment"># å‘èµ·APIè¯·æ±‚ï¼ˆæ¯æ¬¡åªå‘é€å½“å‰æ¶ˆæ¯ï¼‰</span>        response <span class="token operator">=</span> client<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span>create<span class="token punctuation">(</span>            messages<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> prompt<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># æ¯æ¬¡åªå‘é€å½“å‰é—®é¢˜</span>            model<span class="token operator">=</span><span class="token string">"/home/moyuai/moyuai/xtuner_out/Qwen1-5-1-8B-Chat-xtuner-merged-10000"</span>        <span class="token punctuation">)</span>        <span class="token comment"># è·å–æ¨¡å‹å›å¤</span>        model_response <span class="token operator">=</span> response<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message<span class="token punctuation">.</span>content        <span class="token comment"># æ·»åŠ AIå›å¤åˆ°æ˜¾ç¤ºå†å²</span>        st<span class="token punctuation">.</span>session_state<span class="token punctuation">.</span>messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"assistant"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> model_response<span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token keyword">with</span> st<span class="token punctuation">.</span>chat_message<span class="token punctuation">(</span><span class="token string">"assistant"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            st<span class="token punctuation">.</span>markdown<span class="token punctuation">(</span>model_response<span class="token punctuation">)</span>    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>        st<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"å‘ç”Ÿé”™è¯¯ï¼š</span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯åŠ¨<code>streamlit</code>å‰ç«¯æœåŠ¡ï¼ŒæœåŠ¡å¯åŠ¨å‰ä¸€å®šè¦ä¿è¯æˆ‘ä»¬çš„LMDeployæœåŠ¡æ˜¯å¯åŠ¨çš„ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">streamlit run chat_app.py<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å¯åŠ¨åç•Œé¢å¦‚ä¸‹ï¼š</p><p><img src="https://pic1.imgdb.cn/item/681f102258cb8da5c8eaec00.png" alt="streamlitå‰ç«¯é¡µé¢"></p><p>æˆ‘ä»¬è¿›è¡Œé—®é¢˜æµ‹è¯•ï¼š<br><img src="https://pic1.imgdb.cn/item/681f102258cb8da5c8eaebfd.png" alt="æ¨¡å‹æµ‹è¯•ä¸»è§‚æ•ˆæœ"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬æ¨¡å‹è®­ç»ƒç”Ÿæˆçš„å›ç­”æ˜¯æŒ‰ç…§æˆ‘ä»¬çš„é£æ ¼æ¥çš„ï¼Œè¯´æ˜æ¨¡å‹è®­ç»ƒæœ‰æ•ˆæœï¼Œä½†æ˜¯æˆ‘ç”¨åŒä¸€ä¸ªé—®é¢˜é—®äº†å¥½å‡ æ¬¡ï¼Œæ¨¡å‹ç»™æˆ‘ä»¬çš„å›ç­”éƒ½æ˜¯ä¸€æ ·çš„ï¼Œè¿™è¯´æ˜æ¨¡å‹è®­ç»ƒçš„è¿‡æ‹Ÿåˆäº†ï¼Œæ³›ç”¨æ€§å¾ˆå·®ï¼Œè¿™æ¬¡è®­ç»ƒä¹Ÿæ˜¯ä»¥å¤±è´¥å‘Šç»“çš„ï¼Œå…¶å®æˆ‘åœ¨çœ‹è®­ç»ƒæ—¥å¿—æ—¶ï¼Œå‘ç°åˆ°åé¢æ¨¡å‹çš„losså€¼éå¸¸ä½ï¼Œå·®ä¸å¤šåé¢ä¸€ç›´åœ¨<code>0.0044</code>ï¼Œè¿™ä¸ªlosså€¼ç®—æ¯”è¾ƒä½çš„äº†ï¼Œå°±æ˜¯å¿«è¦è¿‡æ‹Ÿåˆçš„çŠ¶æ€äº†ï¼›è€Œåœ¨è®­ç»ƒåˆ°å·®ä¸å¤š10000æ‰¹æ¬¡å·¦å³ï¼Œæ¨¡å‹å°±å·²ç»å·®ä¸å¤šæ˜¯æ‹ŸåˆçŠ¶æ€äº†ï¼Œä½†æ˜¯ç”±äºæˆ‘æ˜¯åœ¨æ™šä¸ŠæŒ‚æœºè¿›è¡Œè®­ç»ƒçš„ï¼Œè€Œåœ¨å½“åˆè®¾ç½®xtenurè®­ç»ƒå‚æ•°æ—¶ï¼Œåªé€‰æ‹©ä¿å­˜æœ€åä¸¤ä¸ªè®­ç»ƒæƒé‡ï¼Œå¯¼è‡´å‰é¢è®­ç»ƒçš„æƒé‡ä¸å­˜åœ¨ï¼›æ‰€ä»¥åªèƒ½åç»­åœ¨é‡æ–°è®­ç»ƒï¼Œåœ¨æ¥çœ‹ä¸€ä¸‹æ¨¡å‹è®­ç»ƒæ•ˆæœã€‚</p><h3 id="6-3-æ¨¡å‹æµ‹è¯•è¯„ä¼°-é‡æ–°è®­ç»ƒç‰ˆ"><a href="#6-3-æ¨¡å‹æµ‹è¯•è¯„ä¼°-é‡æ–°è®­ç»ƒç‰ˆ" class="headerlink" title="6.3 æ¨¡å‹æµ‹è¯•è¯„ä¼°(é‡æ–°è®­ç»ƒç‰ˆ)"></a>6.3 æ¨¡å‹æµ‹è¯•è¯„ä¼°(é‡æ–°è®­ç»ƒç‰ˆ)</h3><p>é‡æ–°è®­ç»ƒåï¼Œåœ¨è®­ç»ƒåˆ°6000<del>7000è½®å·¦å³æ—¶ï¼Œè¿™æ—¶è®­ç»ƒçš„losså€¼æ§åˆ¶åœ¨äº†0.04</del>0.03å·¦å³ï¼Œå¯ä»¥è¯´æ˜¯æ¯”è¾ƒä¸é”™ï¼Œæ‰€ä»¥å°±æ²¡æœ‰ç»§ç»­è®­ç»ƒï¼Œè¿™æ—¶æˆ‘ä»¬å°†æ¨¡å‹è½¬æ¢åˆå¹¶åï¼Œé‡æ–°éƒ¨ç½²ï¼Œä¸‹é¢å°±æ˜¯é‡æ–°æµ‹è¯•å¯¹è¯æ•ˆæœçš„å›¾ç‰‡ï¼Œçœ‹çš„å‡ºæ¥æ¨¡å‹è¿™æ¬¡å¯¹åŒä¸€ä¸ªé—®é¢˜æ²¡æœ‰å‡ºç°å®Œå…¨ä¸€æ ·çš„å›ç­”äº†ï¼Œè¿™æ¬¡è®­ç»ƒç®—æ˜¯æ¯”è¾ƒæˆåŠŸçš„äº†ã€‚</p><p><img src="https://pic1.imgdb.cn/item/681f3bf758cb8da5c8eb6cc9.png" alt="æ¨¡å‹é‡æ–°æµ‹è¯•è¯„ä¼°æ•ˆæœ"></p><h2 id="ä¸ƒã€æ€»ç»“"><a href="#ä¸ƒã€æ€»ç»“" class="headerlink" title="ä¸ƒã€æ€»ç»“"></a><strong>ä¸ƒã€æ€»ç»“</strong></h2><p>1.é¡¹ç›®æˆæœæ€»ç»“<br>    æœ¬æ¬¡é¡¹ç›®æ€»ä½“æ¥è®²æ˜¯æˆåŠŸçš„äº†ï¼Œè™½ç„¶è¿˜æœ‰ä¸å°‘åœ°æ–¹å¯ä»¥å®Œå–„ï¼Œä½†ä¹Ÿç®—æ˜¯ç¬¬ä¸€æ¬¡å®Œæ•´çš„ä»0-1å®Œæˆå…³äºå¤§æ¨¡å‹å¾®è°ƒé¡¹ç›®çš„æ•´ä¸ªæµç¨‹ï¼Œè¿™æ‰æ˜¯æœ€é‡è¦çš„ï¼Œç‰¹åˆ«æ˜¯åœ¨åšé¡¹ç›®çš„è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜å’Œè§£å†³é—®é¢˜çš„è¿‡ç¨‹æ˜¯æœ€å®è´µçš„ç»éªŒã€‚</p><p>2.æŒ‘æˆ˜ä¸è§£å†³æ–¹æ¡ˆå›é¡¾<br>    æœ¬æ¬¡é¡¹ç›®å®Œæˆååœ¨å›é¡¾ï¼Œé‡è¦çš„ç‚¹åœ¨äºå‰æœŸçš„æ•°æ®æ”¶é›†éƒ¨åˆ†ï¼Œä¸€ä»½å¥½çš„è´¨é‡é«˜çš„æ•°æ®é›†æ˜¯éå¸¸é‡è¦çš„ï¼Œæˆ‘åœ¨æ”¶é›†æ•°æ®æ–¹é¢ä¹Ÿæ˜¯èŠ±äº†ä¸€äº›å¿ƒæ€ï¼Œè¿™æ ·åœ¨åç»­çš„æ•°æ®ç”Ÿæˆè¿‡ç¨‹ä¸­æ‰èƒ½æœ‰ä¸€ä¸ªå¥½çš„å‰æã€‚<br>    é¡¹ç›®è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜å…¶å®å…¶ä»–çš„éƒ½è¿˜å¥½ï¼Œä¸»è¦èŠ±æ—¶é—´å¤šä¸€ç‚¹çš„åœ°æ–¹å°±æ˜¯åœ¨äºä¸€äº›æ¡†æ¶çš„ç¯å¢ƒé…ç½®æ–¹é¢ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„ä¸€äº›ä¾èµ–åŒ…çš„ç‰ˆæœ¬ï¼Œä¸å¤ªé€‚åˆå¤ªæ–°çš„ç‰ˆæœ¬ã€‚<br>    è¿˜æœ‰ä¸€ä¸ªå°±æ˜¯æœ€åæ¨¡å‹éƒ¨ç½²æ–¹é¢ï¼Œåœ¨è‡ªå®šä¹‰å¯¹è¯æ¨¡æ¿è¿™é‡Œé‡åˆ°çš„é—®é¢˜ä¸€ç›´æ²¡æœ‰è§£å†³ï¼Œè™½ç„¶æœ€åè¾¾åˆ°çš„æ•ˆæœæ˜¯å¥½çš„ï¼Œåç»­<br>3. æœªæ¥æ–¹å‘ï¼ˆè¯­è¨€æ’­æ”¾ï¼Œé›†æˆå¼€å‘æ¿ï¼‰<br>è¿™ä¸ªé¡¹ç›®æœ¬æ¥å°±æ˜¯æ ¹æ®æŠ–éŸ³æœ€è¿‘æ¯”è¾ƒç«çš„å°æ™ºæœºå™¨äººæƒ³åšçš„ï¼Œåç»­å¯èƒ½å°±æ˜¯åœ¨å¯¹è¯å¤§æ¨¡å‹ç»“åˆè¯­éŸ³æ–¹é¢å·²ç»éƒ¨ç½²åˆ° å¼€å‘æ¿ä¸Šé¢æ¥è¿›è¡Œç ”ç©¶ï¼Œè¿™ä¹Ÿç®—æ˜¯æˆ‘å¯èƒ½å¯ä»¥åšåˆ°çš„ï¼Œå› ä¸ºè‡ªå·±å¤§å­¦ä¸“ä¸šå­¦çš„å°±æ˜¯å•ç‰‡æœºåµŒå…¥å¼å¼€å‘ç­‰ç­‰ï¼Œæœ‰è½¯ç¡¬ç»“åˆçš„åº•å­åœ¨ï¼Œæˆ‘ä¸ªäººä¹Ÿæ˜¯æ¯”è¾ƒæœ‰éœ€æ±‚çš„ã€‚</p><h2 id="å…«ã€é™„å½•ä¸å‚è€ƒèµ„æ–™"><a href="#å…«ã€é™„å½•ä¸å‚è€ƒèµ„æ–™" class="headerlink" title="å…«ã€é™„å½•ä¸å‚è€ƒèµ„æ–™"></a><strong>å…«ã€é™„å½•ä¸å‚è€ƒèµ„æ–™</strong></h2><p>1.ä»£ç ä»“åº“ä¸å·¥å…·é“¾</p><ul><li>é¡¹ç›®GitHubä»“åº“ï¼š</li><li>æ™ºè°±æ¸…è¨€APIï¼š<a href="https://www.bigmodel.cn/console/overview">https://www.bigmodel.cn/console/overview</a></li><li>XTuner ä¸­æ–‡æ–‡æ¡£ï¼š<a href="https://xtuner.readthedocs.io/zh-cn/latest/index.html">https://xtuner.readthedocs.io/zh-cn/latest/index.html</a></li><li>OpenCompass ä¸­æ–‡æ•™ç¨‹ï¼š<a href="https://doc.opencompass.org.cn/zh_CN/">https://doc.opencompass.org.cn/zh_CN/</a></li><li>LMDeploy ä¸­æ–‡æ•™ç¨‹ï¼š<a href="https://lmdeploy.readthedocs.io/zh-cn/latest/index.html">https://lmdeploy.readthedocs.io/zh-cn/latest/index.html</a></li></ul><p>2.æ•°æ®é›†é“¾æ¥</p><ul><li>CDial-GPTï¼š<a href="https://github.com/corpus-dataset/CDial-GPT">https://github.com/corpus-dataset/CDial-GPT</a></li></ul><h2 id="ä¹ã€é—®é¢˜è®°å½•"><a href="#ä¹ã€é—®é¢˜è®°å½•" class="headerlink" title="ä¹ã€é—®é¢˜è®°å½•"></a><strong>ä¹ã€é—®é¢˜è®°å½•</strong></h2><h3 id="1-æŠ¥settings-yamlé…ç½®æ–‡ä»¶æ‰¾ä¸åˆ°"><a href="#1-æŠ¥settings-yamlé…ç½®æ–‡ä»¶æ‰¾ä¸åˆ°" class="headerlink" title="1.æŠ¥settings.yamlé…ç½®æ–‡ä»¶æ‰¾ä¸åˆ°"></a>1.æŠ¥settings.yamlé…ç½®æ–‡ä»¶æ‰¾ä¸åˆ°</h3><p>æŠ¥é”™ä¿¡æ¯ï¼š</p><pre class="line-numbers language-text" data-language="text"><code class="language-text">é…ç½®æ–‡ä»¶ç¼ºå¤±ï¼š[Errno 2] No such file or directory: 'E:\\xuexiziliao\\AiProject\\emotion_dialogue_tuner\\src\\config\\settings.yaml'<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è§£å†³æ–¹æ³•ï¼š<br>æ˜¯å› ä¸ºåœ¨<code>config_loader.py</code>æ–‡ä»¶ä¸­,è·¯å¾„å±‚çº§å°‘é…ç½®ä¸€å±‚</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># ä¿®æ”¹å‰</span>self<span class="token punctuation">.</span>root_path <span class="token operator">=</span> Path<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">.</span>resolve<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span>parent<span class="token comment"># ä¿®æ”¹å</span>self<span class="token punctuation">.</span>root_path <span class="token operator">=</span> Path<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">.</span>resolve<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>parent<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>parent  <span class="token comment"># æ ¹æ®å®é™…å±‚çº§è°ƒæ•´</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-æ–‡ä»¶ç¼–ç æ ¼å¼åŠ è½½ä¸æ­£ç¡®"><a href="#2-æ–‡ä»¶ç¼–ç æ ¼å¼åŠ è½½ä¸æ­£ç¡®" class="headerlink" title="2.æ–‡ä»¶ç¼–ç æ ¼å¼åŠ è½½ä¸æ­£ç¡®"></a>2.æ–‡ä»¶ç¼–ç æ ¼å¼åŠ è½½ä¸æ­£ç¡®</h3><p>æŠ¥é”™ä¿¡æ¯ï¼š</p><pre class="line-numbers language-text" data-language="text"><code class="language-text">UnicodeDecodeError: 'gbk' codec can't decode byte 0xa6 in position 94: illegal multibyte sequence<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è§£å†³æ–¹æ³•ï¼š<br>æŠ¥é”™åŸå› æ˜¯å› ä¸ºåœ¨<code>config_loader.py</code>æ–‡ä»¶ä¸­çš„<code>load_settings</code>æ–¹æ³•æ²¡æœ‰æŒ‡å®š<code>yaml</code>æ–‡ä»¶çš„æ‰“å¼€æ ¼å¼ã€‚åœ¨ä¿®æ”¹æ‰€æœ‰æ–‡ä»¶è¯»å–æ“ä½œï¼Œæ·»åŠ <code>encoding='utf-8'</code>å‚æ•°å³å¯ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># ä¿®æ”¹å‰ä»£ç </span><span class="token keyword">def</span> <span class="token function">load_settings</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">dict</span><span class="token punctuation">:</span>      <span class="token triple-quoted-string string">"""åŠ è½½YAMLæ ¼å¼çš„å…¨å±€è®¾ç½®      Returns:        dict: åŒ…å«APIå¯†é’¥ã€æ¨¡å‹è·¯å¾„ç­‰é…ç½®çš„å­—å…¸      """</span>    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>root_path <span class="token operator">/</span> <span class="token string">"config/settings.yaml"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>          <span class="token keyword">return</span> yaml<span class="token punctuation">.</span>safe_load<span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token comment"># ä¿®æ”¹åä»£ç </span><span class="token keyword">def</span> <span class="token function">load_settings</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">dict</span><span class="token punctuation">:</span>      <span class="token triple-quoted-string string">"""åŠ è½½YAMLæ ¼å¼çš„å…¨å±€è®¾ç½®      Returns:        dict: åŒ…å«APIå¯†é’¥ã€æ¨¡å‹è·¯å¾„ç­‰é…ç½®çš„å­—å…¸      """</span>    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>root_path <span class="token operator">/</span> <span class="token string">"config/settings.yaml"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>          <span class="token keyword">return</span> yaml<span class="token punctuation">.</span>safe_load<span class="token punctuation">(</span>f<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-ç”Ÿæˆçš„æ•°æ®æœ‰äº›æ˜¯å®Œå…¨ä¸€æ ·çš„"><a href="#3-ç”Ÿæˆçš„æ•°æ®æœ‰äº›æ˜¯å®Œå…¨ä¸€æ ·çš„" class="headerlink" title="3.ç”Ÿæˆçš„æ•°æ®æœ‰äº›æ˜¯å®Œå…¨ä¸€æ ·çš„"></a>3.ç”Ÿæˆçš„æ•°æ®æœ‰äº›æ˜¯å®Œå…¨ä¸€æ ·çš„</h3><p>æŸ¥çœ‹ç”Ÿæˆæ•°æ®æ—¶ï¼Œå‘ç°æœ‰äº›æ•°æ®æ˜¯å®Œå…¨ä¸€æ ·çš„ï¼Œå‡ºç°äº†é‡å¤ï¼Œè¿™å°±å¯¼è‡´äº†æ•°æ®è´¨é‡ä¸é«˜ã€‚</p><p>è§£å†³æ–¹æ³•ï¼šå¯ä»¥è‡ªå·±æµ‹è¯•è°ƒæ•´åˆ¤æ–­é˜ˆå€¼ï¼Œæˆ–è€…é‡æ–°æ·»åŠ æ–°çš„è§„åˆ™æ¥åˆ¤æ–­å»é‡ã€‚</p><h3 id="4-ä½¿ç”¨Xtunerè¿›è¡Œæ¨¡å‹qloraæ¨¡å‹å¾®è°ƒçš„æ—¶å€™ï¼ŒæŠ¥é”™-No-module-named-â€˜triton-opsâ€™"><a href="#4-ä½¿ç”¨Xtunerè¿›è¡Œæ¨¡å‹qloraæ¨¡å‹å¾®è°ƒçš„æ—¶å€™ï¼ŒæŠ¥é”™-No-module-named-â€˜triton-opsâ€™" class="headerlink" title="4.ä½¿ç”¨Xtunerè¿›è¡Œæ¨¡å‹qloraæ¨¡å‹å¾®è°ƒçš„æ—¶å€™ï¼ŒæŠ¥é”™ No module named â€˜triton.opsâ€™"></a>4.ä½¿ç”¨Xtunerè¿›è¡Œæ¨¡å‹qloraæ¨¡å‹å¾®è°ƒçš„æ—¶å€™ï¼ŒæŠ¥é”™ No module named â€˜triton.opsâ€™</h3><p>æ‰§è¡Œå‘½ä»¤ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">xtuner train qwen1_5_1_8b_chat_qlora_alpaca_e3.py<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>é—®é¢˜è®°å½•ï¼š</p><pre class="line-numbers language-text" data-language="text"><code class="language-text">The above exception was the direct cause of the following exception:Traceback (most recent call last):  File "/home/moyuai/moyuai/xtuner/xtuner/tools/train.py", line 392, in &lt;module&gt;    main()  File "/home/moyuai/moyuai/xtuner/xtuner/tools/train.py", line 381, in main    runner = Runner.from_cfg(cfg)  File "/home/moyuai/anaconda3/envs/xtuner_env/lib/python3.10/site-packages/mmengine/runner/runner.py", line 462, in from_cfg    runner = cls(  File "/home/moyuai/anaconda3/envs/xtuner_env/lib/python3.10/site-packages/mmengine/runner/runner.py", line 429, in __init__    self.model = self.build_model(model)  File "/home/moyuai/anaconda3/envs/xtuner_env/lib/python3.10/site-packages/mmengine/runner/runner.py", line 836, in build_model    model = MODELS.build(model)  File "/home/moyuai/anaconda3/envs/xtuner_env/lib/python3.10/site-packages/mmengine/registry/registry.py", line 570, in build    return self.build_func(cfg, *args, **kwargs, registry=self)  File "/home/moyuai/anaconda3/envs/xtuner_env/lib/python3.10/site-packages/mmengine/registry/build_functions.py", line 234, in build_model_from_cfg    return build_from_cfg(cfg, registry, default_args)  File "/home/moyuai/anaconda3/envs/xtuner_env/lib/python3.10/site-packages/mmengine/registry/build_functions.py", line 123, in build_from_cfg    obj = obj_cls(**args)  # type: ignore  File "/home/moyuai/moyuai/xtuner/xtuner/model/sft.py", line 97, in __init__    self.llm = self.build_llm_from_cfg(  File "/home/moyuai/moyuai/xtuner/xtuner/model/sft.py", line 143, in build_llm_from_cfg    llm = self._build_from_cfg_or_module(llm)  File "/home/moyuai/moyuai/xtuner/xtuner/model/sft.py", line 296, in _build_from_cfg_or_module    return BUILDER.build(cfg_or_mod)  File "/home/moyuai/anaconda3/envs/xtuner_env/lib/python3.10/site-packages/mmengine/registry/registry.py", line 570, in build    return self.build_func(cfg, *args, **kwargs, registry=self)  File "/home/moyuai/anaconda3/envs/xtuner_env/lib/python3.10/site-packages/mmengine/registry/build_functions.py", line 123, in build_from_cfg    obj = obj_cls(**args)  # type: ignore  File "/home/moyuai/anaconda3/envs/xtuner_env/lib/python3.10/site-packages/transformers/models/auto/auto_factory.py", line 564, in from_pretrained    return model_class.from_pretrained(  File "/home/moyuai/anaconda3/envs/xtuner_env/lib/python3.10/site-packages/transformers/modeling_utils.py", line 3620, in from_pretrained    hf_quantizer.validate_environment(  File "/home/moyuai/anaconda3/envs/xtuner_env/lib/python3.10/site-packages/transformers/quantizers/quantizer_bnb_8bit.py", line 77, in validate_environment    from ..integrations import validate_bnb_backend_availability  File "&lt;frozen importlib._bootstrap&gt;", line 1075, in _handle_fromlist  File "/home/moyuai/anaconda3/envs/xtuner_env/lib/python3.10/site-packages/transformers/utils/import_utils.py", line 1805, in __getattr__    module = self._get_module(self._class_to_module[name])  File "/home/moyuai/anaconda3/envs/xtuner_env/lib/python3.10/site-packages/transformers/utils/import_utils.py", line 1819, in _get_module    raise RuntimeError(RuntimeError: Failed to import transformers.integrations.bitsandbytes because of the following error (look up to see its traceback):No module named 'triton.ops'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é—®é¢˜åˆ†æï¼š<br>è¿™æ˜¯åœ¨å°è¯•ä½¿ç”¨&nbsp;<strong>BitsAndBytesï¼ˆ8-bit é‡åŒ–ï¼‰</strong>&nbsp;åŠ è½½æ¨¡å‹æ—¶å‘ç”Ÿçš„ï¼Œæˆ‘ä»¬æŸ¥çœ‹ä¸€ä¸‹&nbsp;<code>bitsandbytes</code>&nbsp;åº“æ˜¯å¦æ­£ç¡®å®‰è£…ã€‚</p><p>å¯èƒ½æ˜¯ç‰ˆæœ¬ä¸å¯¹ï¼Œè¯•ç€é‡è£…ä¸€ä¸‹åè¿˜æ˜¯æŠ¥é”™ï¼Œæœ€åæŸ¥æ‰¾èµ„æ–™å‘ç°æ˜¯torch2.6ä»¥ä¸Šç‰ˆæœ¬å’Œbitstandbytesç‰ˆæœ¬çš„å†²çªé—®é¢˜ã€‚</p><p>å®‰è£…<strong>ä½ç‰ˆæœ¬</strong>çš„<code>pytorch==2.5.1</code> å’Œ<code>torchvision==0.20.1</code> ï¼Œæˆ‘ä»¬è¿›å…¥xtunerç›®å½• ä¸‹çš„è¿™ä¸ª <code>xtuner/requirements/runtime.txt</code>æ–‡ä»¶é‡Œé¢ä¿®æ”¹ä¸€ä¸‹torchç‰ˆæœ¬</p><p><img src="https://pic1.imgdb.cn/item/681e229258cb8da5c8e9fe1e.png" alt="ä¿®æ”¹ç¯å¢ƒ"></p><p>ä¿®æ”¹è¿‡åè¿˜æ˜¯æœ‰é—®é¢˜ï¼Œè¿™æ¬¡æŠ¥é”™ä¿¡æ¯å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-text" data-language="text"><code class="language-text">Traceback (most recent call last): File "/home/moyuai/anaconda3/envs/xtuner-env/bin/xtuner", line 33, in &lt;module&gt; sys.exit(load_entry_point('xtuner', 'console_scripts', 'xtuner')()) File "/home/moyuai/anaconda3/envs/xtuner-env/bin/xtuner", line 25, in importlib_load_entry_point return next(matches).load() File "/home/moyuai/anaconda3/envs/xtuner-env/lib/python3.10/importlib/metadata/__init__.py", line 171, in load module = import_module(match.group('module')) File "/home/moyuai/anaconda3/envs/xtuner-env/lib/python3.10/importlib/__init__.py", line 126, in import_module return _bootstrap._gcd_import(name[level:], package, level) File "&lt;frozen importlib._bootstrap&gt;", line 1050, in _gcd_import File "&lt;frozen importlib._bootstrap&gt;", line 1027, in _find_and_load File "&lt;frozen importlib._bootstrap&gt;", line 1006, in _find_and_load_unlocked File "&lt;frozen importlib._bootstrap&gt;", line 688, in _load_unlocked File "&lt;frozen importlib._bootstrap_external&gt;", line 883, in exec_module File "&lt;frozen importlib._bootstrap&gt;", line 241, in _call_with_frames_removed File "/home/moyuai/moyuai/xtuner/xtuner/__init__.py", line 4, in &lt;module&gt; from mmengine.utils import digit_version File "/home/moyuai/anaconda3/envs/xtuner-env/lib/python3.10/site-packages/mmengine/__init__.py", line 6, in &lt;module&gt; from .registry import * File "/home/moyuai/anaconda3/envs/xtuner-env/lib/python3.10/site-packages/mmengine/registry/__init__.py", line 2, in &lt;module&gt; from .build_functions import (build_from_cfg, build_model_from_cfg, File "/home/moyuai/anaconda3/envs/xtuner-env/lib/python3.10/site-packages/mmengine/registry/build_functions.py", line 6, in &lt;module&gt; import torch File "/home/moyuai/anaconda3/envs/xtuner-env/lib/python3.10/site-packages/torch/__init__.py", line 367, in &lt;module&gt; from torch._C import * # noqa: F403 ImportError: /home/moyuai/anaconda3/envs/xtuner-env/lib/python3.10/site-packages/torch/lib/../../nvidia/cusparse/lib/libcusparse.so.12: undefined symbol: __nvJitLinkComplete_12_4, version libnvJitLink.so.12<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ¨æµ‹è¿˜æ˜¯å› ä¸º<code>torch</code>ç‰ˆæœ¬å’Œ<code>CUDA</code>ç‰ˆæœ¬å¯¼è‡´çš„ï¼Œè¿™æ¬¡é‡æ–°å°†<code>torch</code>ç‰ˆæœ¬å’Œ<code>CUDA</code>ç‰ˆæœ¬è¿›è¡Œä¿®æ”¹ï¼Œè¿›è¡Œå¦‚ä¸‹æ“ä½œ</p><h4 id="1-å®Œå…¨å¸è½½å½“å‰PyTorchå’ŒCUDAå·¥å…·é“¾"><a href="#1-å®Œå…¨å¸è½½å½“å‰PyTorchå’ŒCUDAå·¥å…·é“¾" class="headerlink" title="(1)å®Œå…¨å¸è½½å½“å‰PyTorchå’ŒCUDAå·¥å…·é“¾"></a><strong>(1)å®Œå…¨å¸è½½å½“å‰PyTorchå’ŒCUDAå·¥å…·é“¾</strong></h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># åˆ é™¤condaç¯å¢ƒï¼ˆç¡®ä¿å·²é€€å‡ºç¯å¢ƒï¼‰</span>conda deactivateconda remove <span class="token parameter variable">-n</span> xtuner-env <span class="token parameter variable">--all</span> <span class="token parameter variable">-y</span><span class="token comment"># æ¸…é™¤æ®‹ç•™çš„CUDAè½¯é“¾æ¥</span><span class="token function">sudo</span> <span class="token function">rm</span> <span class="token parameter variable">-f</span> /usr/local/cuda<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="2-å®‰è£…åŒ¹é…çš„CUDA-12-1å·¥å…·åŒ…"><a href="#2-å®‰è£…åŒ¹é…çš„CUDA-12-1å·¥å…·åŒ…" class="headerlink" title="(2)å®‰è£…åŒ¹é…çš„CUDA 12.1å·¥å…·åŒ…"></a><strong>(2)å®‰è£…åŒ¹é…çš„CUDA 12.1å·¥å…·åŒ…</strong></h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">### **å®‰è£…åŒ¹é…çš„CUDA 12.1å·¥å…·åŒ…**</span><span class="token comment"># ä»NVIDIAå®˜ç½‘ä¸‹è½½CUDA 12.1.1</span><span class="token function">wget</span> https://developer.download.nvidia.com/compute/cuda/12.1.1/local_installers/cuda_12.1.1_530.30.02_linux.run<span class="token function">sudo</span> <span class="token function">sh</span> cuda_12.1.1_530.30.02_linux.run <span class="token parameter variable">--override</span><span class="token comment"># é…ç½®ç¯å¢ƒå˜é‡</span><span class="token builtin class-name">echo</span> <span class="token string">'export PATH=/usr/local/cuda-12.1/bin:$PATH'</span> <span class="token operator">&gt;&gt;</span> ~/.bashrc<span class="token builtin class-name">echo</span> <span class="token string">'export LD_LIBRARY_PATH=/usr/local/cuda-12.1/lib64:$LD_LIBRARY_PATH'</span> <span class="token operator">&gt;&gt;</span> ~/.bashrc<span class="token builtin class-name">source</span> ~/.bashrc<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="3-åˆ›å»ºå…¨æ–°çš„è™šæ‹Ÿç¯å¢ƒå¹¶å®‰è£…PyTorch-2-2-0"><a href="#3-åˆ›å»ºå…¨æ–°çš„è™šæ‹Ÿç¯å¢ƒå¹¶å®‰è£…PyTorch-2-2-0" class="headerlink" title="(3)åˆ›å»ºå…¨æ–°çš„è™šæ‹Ÿç¯å¢ƒå¹¶å®‰è£…PyTorch 2.2.0"></a>(3)åˆ›å»ºå…¨æ–°çš„è™šæ‹Ÿç¯å¢ƒå¹¶å®‰è£…PyTorch 2.2.0</h4><p>è¿™é‡Œæˆ‘ä»¬è®°å¾—åˆ°xtunerç›®å½•ä¸‹çš„ <code>xtuner/requirements/runtime.txt</code>æ–‡ä»¶é‡Œé¢é‡æ–°ä¿®æ”¹ä¸€ä¸‹torchç‰ˆæœ¬ï¼Œç‰ˆæœ¬å’Œä¸‹é¢è¦å®‰è£…çš„å‘½ä»¤é‡Œé¢çš„ç‰ˆæœ¬ä¿æŒä¸€è‡´ã€‚<code>PyTorch 2.2.0 + CUDA 12.1</code></p><p><img src="https://pic1.imgdb.cn/item/681e9b6158cb8da5c8ea15aa.png" alt="é‡æ–°æŒ‡å®štorchç‰ˆæœ¬"></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">conda create <span class="token parameter variable">-n</span> xtuner-env <span class="token assign-left variable">python</span><span class="token operator">=</span><span class="token number">3.10</span> <span class="token parameter variable">-y</span>conda activate xtuner-env<span class="token comment"># å®‰è£…PyTorch 2.2.0 + CUDA 12.1</span>pip <span class="token function">install</span> <span class="token assign-left variable">torch</span><span class="token operator">==</span><span class="token number">2.2</span>.0+cu121 <span class="token assign-left variable">torchvision</span><span class="token operator">==</span><span class="token number">0.17</span>.0+cu121 --extra-index-url https://download.pytorch.org/whl/cu121<span class="token comment"># é‡æ–°å®‰è£…xtuneræ‰€éœ€ä¾èµ–</span><span class="token builtin class-name">cd</span> xtunerpip <span class="token function">install</span> <span class="token parameter variable">-e</span> <span class="token string">'.[all]'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ€åé‡æ–°è¿è¡Œè®­ç»ƒå‘½ä»¤ï¼Œèƒ½å¤Ÿæ­£å¸¸è¿›è¡Œè®­ç»ƒ</p><h3 id="5-å‘ç”Ÿé”™è¯¯ï¼š-â€˜NoneTypeâ€™-object-is-not-subscriptable"><a href="#5-å‘ç”Ÿé”™è¯¯ï¼š-â€˜NoneTypeâ€™-object-is-not-subscriptable" class="headerlink" title="5. å‘ç”Ÿé”™è¯¯ï¼š â€˜NoneTypeâ€™ object is not subscriptable"></a>5. å‘ç”Ÿé”™è¯¯ï¼š â€˜NoneTypeâ€™ object is not subscriptable</h3><p>è¿™ä¸ªé—®é¢˜æ˜¯åœ¨LMDeployå¯¼å…¥è‡ªå®šä¹‰å¯¹è¯æ¨¡æ¿æ—¶å¯åŠ¨openaiå¯¹è¯æœåŠ¡åï¼Œè¿›è¡Œå¯¹è¯æ—¶å‡ºç°çš„é”™è¯¯ã€‚<br>åé¢ä¸è¿›è¡Œè‡ªå®šä¹‰å¯¹è¯æ¨¡æ¿å¯¼å…¥è€Œæ˜¯ç›´æ¥ç”¨LMDeployå¯åŠ¨æˆ‘ä»¬è®­ç»ƒçš„æ¨¡å‹åå¯ä»¥æ­£å¸¸å›ç­”ï¼Œæ¨æµ‹åº”è¯¥æ˜¯è‡ªå®šä¹‰å¯¹è¯æ¨¡æ¿æœ‰é—®é¢˜</p><p><strong>æ›´å¤šå®ç”¨æ–‡ç« å’ŒAIå¤§æ¨¡å‹åº”ç”¨å¼€å‘æ–‡ç« æ¬¢è¿åˆ°æˆ‘ä¸ªäººåšå®¢æ¥è§‚çœ‹ï¼š</strong><a href="https://blog.csdn.net/etrospect/article/details/blog.ismoyu.cn">å¢¨å®‡Logic</a></p>]]></content>
      
      
      <categories>
          
          <category> AIå¤§æ¨¡å‹å¼€å‘é¡¹ç›®å®æˆ˜ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Markdown </tag>
            
            <tag> Python </tag>
            
            <tag> Linux </tag>
            
            <tag> LLaMA-Factory </tag>
            
            <tag> Embeddings </tag>
            
            <tag> LLM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€AIå¤§æ¨¡å‹åº”ç”¨å­¦ä¹ ç¬”è®°ã€‘åŸºäºLlamaIndexå®ç°RAG</title>
      <link href="/ai-da-mo-xing-ying-yong-xue-xi-bi-ji-ji-yu-llamaindex-shi-xian-rag/"/>
      <url>/ai-da-mo-xing-ying-yong-xue-xi-bi-ji-ji-yu-llamaindex-shi-xian-rag/</url>
      
        <content type="html"><![CDATA[<p>ä½¿ç”¨ç¯å¢ƒ</p><ul><li>è½¯ä»¶ç¯å¢ƒï¼šWindows11 + WSL2-Linux-Ubuntu22.04å­ç³»ç»Ÿ</li><li>ç¡¬ä»¶ç¯å¢ƒï¼šGeForce RTX 4060 Ti 16GB</li></ul><h2 id="ä¸€ã€Llama-Indexï¼ˆæ ¸å¿ƒç»„ä»¶ä»‹ç»ï¼‰"><a href="#ä¸€ã€Llama-Indexï¼ˆæ ¸å¿ƒç»„ä»¶ä»‹ç»ï¼‰" class="headerlink" title="ä¸€ã€Llama_Indexï¼ˆæ ¸å¿ƒç»„ä»¶ä»‹ç»ï¼‰"></a>ä¸€ã€Llama_Indexï¼ˆæ ¸å¿ƒç»„ä»¶ä»‹ç»ï¼‰</h2><h3 id="1-1-ä»€ä¹ˆæ˜¯LlamaIndex"><a href="#1-1-ä»€ä¹ˆæ˜¯LlamaIndex" class="headerlink" title="1.1 ä»€ä¹ˆæ˜¯LlamaIndex?"></a>1.1 ä»€ä¹ˆæ˜¯LlamaIndex?</h3><p><code>LlamaIndex</code> æ˜¯ä¸€ä¸ªç”¨äº <code>LLM</code> åº”ç”¨ç¨‹åºçš„æ•°æ®æ¡†æ¶ï¼Œç”¨äºæ³¨å…¥ï¼Œç»“æ„åŒ–ï¼Œå¹¶è®¿é—®ç§æœ‰æˆ–ç‰¹å®šé¢†åŸŸæ•°æ®ã€‚<br><code>LlamaIndex</code> ç”± Jerry Liu (Twitter: @jerryjliu0) è”åˆåˆ›åŠï¼Œå¹¶æ‹…ä»»CEOã€‚</p><h3 id="1-2-LlamaIndexä¸ºä½•è€Œç”Ÿï¼Ÿ"><a href="#1-2-LlamaIndexä¸ºä½•è€Œç”Ÿï¼Ÿ" class="headerlink" title="1.2 LlamaIndexä¸ºä½•è€Œç”Ÿï¼Ÿ"></a>1.2 LlamaIndexä¸ºä½•è€Œç”Ÿï¼Ÿ</h3><p>åœ¨æœ¬è´¨ä¸Šï¼Œ <code>LLM</code> ï¼ˆå¦‚ GPT ï¼‰ä¸ºäººç±»å’Œæ¨æ–­å‡ºçš„æ•°æ®æä¾›äº†åŸºäºè‡ªç„¶è¯­è¨€çš„äº¤äº’æ¥å£ã€‚å¹¿æ³›å¯ç”¨çš„å¤§æ¨¡å‹é€šå¸¸åœ¨å¤§é‡å…¬å¼€å¯ç”¨çš„æ•°æ®ä¸Šè¿›è¡Œçš„é¢„è®­ç»ƒï¼ŒåŒ…æ‹¬æ¥è‡ªç»´åŸºç™¾ç§‘ã€é‚®ä»¶åˆ—è¡¨ã€ä¹¦ç±å’Œæºä»£ç ç­‰ã€‚<br>æ„å»ºåœ¨LLMæ¨¡å‹ä¹‹ä¸Šçš„åº”ç”¨ç¨‹åºé€šå¸¸éœ€è¦ä½¿ç”¨ç§æœ‰æˆ–ç‰¹å®šé¢†åŸŸæ•°æ®æ¥å¢å¼ºè¿™äº›æ¨¡å‹ã€‚ä¸å¹¸çš„æ˜¯ï¼Œè¿™äº›æ•°æ®å¯èƒ½åˆ†å¸ƒåœ¨ä¸åŒçš„åº”ç”¨ç¨‹åºå’Œæ•°æ®å­˜å‚¨ä¸­ã€‚å®ƒä»¬å¯èƒ½å­˜åœ¨äºAPIä¹‹åã€SQLæ•°æ®åº“ä¸­ï¼Œæˆ–è€…å­˜åœ¨åœ¨PDF æ–‡ä»¶ä»¥åŠå¹»ç¯ç‰‡ä¸­ã€‚</p><p>LlamaIndexåº”è¿è€Œç”Ÿã€‚</p><h3 id="1-3-LlamaIndexå¦‚ä½•ç ´å±€ï¼Ÿ"><a href="#1-3-LlamaIndexå¦‚ä½•ç ´å±€ï¼Ÿ" class="headerlink" title="1.3 LlamaIndexå¦‚ä½•ç ´å±€ï¼Ÿ"></a>1.3 LlamaIndexå¦‚ä½•ç ´å±€ï¼Ÿ</h3><p>LlamaIndex æä¾›äº†5å¤§æ ¸å¿ƒå·¥å…·ï¼š</p><ul><li>Data connectors</li><li>Data indexes</li><li>Engines</li><li>Data agents</li><li>Application integrations</li></ul><h2 id="äºŒã€æ ¸å¿ƒæ¦‚å¿µ"><a href="#äºŒã€æ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="äºŒã€æ ¸å¿ƒæ¦‚å¿µ"></a>äºŒã€æ ¸å¿ƒæ¦‚å¿µ</h2><p><code>LlamaIndex</code> å¸®åŠ©æ„å»º <code>LLM</code> é©±åŠ¨çš„ï¼ŒåŸºäºä¸ªäººæˆ–ç§åŸŸæ•°æ®çš„åº”ç”¨ã€‚RAG(Retrieval Augmented Generation) æ˜¯ <code>LlamaIndex</code> åº”ç”¨çš„æ ¸å¿ƒæ¦‚å¿µã€‚</p><h3 id="2-1-RAG"><a href="#2-1-RAG" class="headerlink" title="2.1 RAG"></a>2.1 RAG</h3><p>RAGï¼Œä¹Ÿç§°ä¸ºæ£€ç´¢å¢å¼ºç”Ÿæˆï¼Œæ˜¯åˆ©ç”¨ä¸ªäººæˆ–ç§åŸŸæ•°æ®å¢å¼º <code>LLM</code> çš„ä¸€ç§èŒƒå¼ã€‚é€šå¸¸ï¼Œå®ƒåŒ…å«ä¸¤ä¸ªé˜¶æ®µ:</p><ol><li>ç´¢å¼•<br> æ„å»ºçŸ¥è¯†åº“</li><li>æŸ¥è¯¢<br> ä»çŸ¥è¯†åº“æ£€ç´¢ç›¸å…³ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œä»¥è¾…åŠ© <code>LLM</code> å›ç­”é—®é¢˜ã€‚</li></ol><p><code>LlamaIndex</code> æä¾›äº†å·¥å…·åŒ…å¸®åŠ©å¼€å‘è€…æå…¶ä¾¿æ·åœ°å®Œæˆè¿™ä¸¤ä¸ªé˜¶æ®µçš„å·¥ä½œã€‚</p><h4 id="2-1-1-ç´¢å¼•é˜¶æ®µ"><a href="#2-1-1-ç´¢å¼•é˜¶æ®µ" class="headerlink" title="2.1.1 ç´¢å¼•é˜¶æ®µ"></a>2.1.1 ç´¢å¼•é˜¶æ®µ</h4><p>LlamaIndex é€šè¿‡æä¾› Data connectors(æ•°æ®è¿æ¥å™¨) å’Œ Indexes (ç´¢å¼•) å¸®åŠ©å¼€å‘è€…æ„å»ºçŸ¥è¯†åº“ã€‚<br>è¯¥é˜¶æ®µä¼šç”¨åˆ°å¦‚ä¸‹å·¥å…·æˆ–ç»„ä»¶ï¼š</p><ul><li>Data connectors<br>  æ•°æ®è¿æ¥å™¨ã€‚å®ƒè´Ÿè´£å°†æ¥è‡ªä¸åŒæ•°æ®æºçš„ä¸åŒæ ¼å¼çš„æ•°æ®æ³¨å…¥ï¼Œå¹¶è½¬æ¢ä¸º <code>LlamaIndex</code> æ”¯æŒçš„æ–‡æ¡£ï¼ˆDocumentï¼‰è¡¨ç°å½¢å¼ï¼Œå…¶ä¸­åŒ…å«äº†æ–‡æœ¬å’Œå…ƒæ•°æ®ã€‚</li><li>Documents / Nodes<br>  Documentæ˜¯ <code>LlamaIndex</code> ä¸­å®¹å™¨çš„æ¦‚å¿µï¼Œå®ƒå¯ä»¥åŒ…å«ä»»ä½•æ•°æ®æºï¼ŒåŒ…æ‹¬ï¼ŒPDFæ–‡æ¡£ï¼ŒAPIå“åº”ï¼Œæˆ–æ¥è‡ªæ•°æ®åº“çš„æ•°æ®ã€‚<br>  Nodeæ˜¯ <code>LlamaIndex</code> ä¸­æ•°æ®çš„æœ€å°å•å…ƒï¼Œä»£è¡¨äº†ä¸€ä¸ª Documentçš„åˆ†å—ã€‚å®ƒè¿˜åŒ…å«äº†å…ƒæ•°æ®ï¼Œä»¥åŠä¸å…¶ä»–Nodeçš„å…³ç³»ä¿¡æ¯ã€‚è¿™ä½¿å¾—æ›´ç²¾ç¡®çš„æ£€ç´¢æ“ä½œæˆä¸ºå¯èƒ½ã€‚</li><li>Data Indexes<br>  <code>LlamaIndex</code> æä¾›ä¾¿åˆ©çš„å·¥å…·ï¼Œå¸®åŠ©å¼€å‘è€…ä¸ºæ³¨å…¥çš„æ•°æ®å»ºç«‹ç´¢å¼•ï¼Œä½¿å¾—æœªæ¥çš„æ£€ç´¢ç®€å•è€Œé«˜æ•ˆã€‚æœ€å¸¸ç”¨çš„ç´¢å¼•æ˜¯å‘é‡å­˜å‚¨ç´¢å¼• - <code>VectorStoreIndex</code> ã€‚</li></ul><h4 id="2-1-2-æŸ¥è¯¢é˜¶æ®µ"><a href="#2-1-2-æŸ¥è¯¢é˜¶æ®µ" class="headerlink" title="2.1.2 æŸ¥è¯¢é˜¶æ®µ"></a>2.1.2 æŸ¥è¯¢é˜¶æ®µ</h4><p>åœ¨æŸ¥è¯¢é˜¶æ®µï¼Œ<code>RAG</code> ç®¡é“æ ¹æ®çš„ç”¨æˆ·æŸ¥è¯¢ï¼Œæ£€ç´¢æœ€ç›¸å…³çš„ä¸Šä¸‹æ–‡ï¼Œå¹¶å°†å…¶ä¸æŸ¥è¯¢ä¸€èµ·ï¼Œä¼ é€’ç»™ <code>LLM</code> ï¼Œä»¥åˆæˆå“åº”ã€‚è¿™ä½¿ <code>LLM</code> èƒ½å¤Ÿè·å¾—ä¸åœ¨å…¶åŸå§‹è®­ç»ƒæ•°æ®ä¸­çš„æœ€æ–°çŸ¥è¯†ï¼ŒåŒæ—¶ä¹Ÿå‡å°‘äº†è™šæ„å†…å®¹ã€‚è¯¥é˜¶æ®µçš„å…³é”®æŒ‘æˆ˜åœ¨äºæ£€ç´¢ã€ç¼–æ’å’ŒåŸºäºçŸ¥è¯†åº“çš„æ¨ç†ã€‚</p><p><code>LlamaIndex</code> æä¾›å¯ç»„åˆçš„æ¨¡å—ï¼Œå¸®åŠ©å¼€å‘è€…æ„å»ºå’Œé›†æˆ <code>RAG</code> ç®¡é“ï¼Œç”¨äºé—®ç­”ã€èŠå¤©æœºå™¨äººæˆ–ä½œä¸ºä»£ç†çš„ä¸€éƒ¨åˆ†ã€‚è¿™äº›æ„å»ºå—å¯ä»¥æ ¹æ®æ’ååå¥½è¿›è¡Œå®šåˆ¶ï¼Œå¹¶ç»„åˆèµ·æ¥ï¼Œä»¥ç»“æ„åŒ–çš„æ–¹å¼åŸºäºå¤šä¸ªçŸ¥è¯†åº“è¿›è¡Œæ¨ç†ã€‚</p><p>è¯¥é˜¶æ®µçš„æ„å»ºå—åŒ…æ‹¬ï¼š</p><ul><li>Retrievers<br>  æ£€ç´¢å™¨ã€‚å®ƒå®šä¹‰å¦‚ä½•é«˜æ•ˆåœ°ä»çŸ¥è¯†åº“ï¼ŒåŸºäºæŸ¥è¯¢ï¼Œæ£€ç´¢ç›¸å…³ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</li><li>Node Postprocessors<br>  Nodeåå¤„ç†å™¨ã€‚å®ƒå¯¹ä¸€ç³»åˆ—æ–‡æ¡£èŠ‚ç‚¹ï¼ˆNodeï¼‰å®æ–½è½¬æ¢ï¼Œè¿‡æ»¤ï¼Œæˆ–æ’åã€‚</li><li>Response Synthesizers<br>  å“åº”åˆæˆå™¨ã€‚å®ƒåŸºäºç”¨æˆ·çš„æŸ¥è¯¢ï¼Œå’Œä¸€ç»„æ£€ç´¢åˆ°çš„æ–‡æœ¬å—ï¼ˆå½¢æˆä¸Šä¸‹æ–‡ï¼‰ï¼Œåˆ©ç”¨ LLM ç”Ÿæˆå“åº”ã€‚</li></ul><p>RAGç®¡é“åŒ…æ‹¬ï¼š</p><ul><li>Query Engines<br>  æŸ¥è¯¢å¼•æ“ - ç«¯åˆ°ç«¯çš„ç®¡é“ï¼Œå…è®¸ç”¨æˆ·åŸºäºçŸ¥è¯†åº“ï¼Œä»¥è‡ªç„¶è¯­è¨€æé—®ï¼Œå¹¶è·å¾—å›ç­”ï¼Œä»¥åŠç›¸å…³çš„ä¸Šä¸‹æ–‡ã€‚</li><li>Chat Engines<br>  èŠå¤©å¼•æ“ - ç«¯åˆ°ç«¯çš„ç®¡é“ï¼Œå…è®¸ç”¨æˆ·åŸºäºçŸ¥è¯†åº“è¿›è¡Œå¯¹è¯ï¼ˆå¤šæ¬¡äº¤äº’ï¼Œä¼šè¯å†å²ï¼‰ã€‚</li><li>Agents<br>  ä»£ç†ã€‚å®ƒæ˜¯ä¸€ç§ç”± LLM é©±åŠ¨çš„è‡ªåŠ¨åŒ–å†³ç­–å™¨ã€‚ä»£ç†å¯ä»¥åƒæŸ¥è¯¢å¼•æ“æˆ–èŠå¤©å¼•æ“ä¸€æ ·ä½¿ç”¨ã€‚ä¸»è¦åŒºåˆ«åœ¨äºï¼Œä»£ç†åŠ¨æ€åœ°å†³å®šæœ€ä½³çš„åŠ¨ä½œåºåˆ—ï¼Œè€Œä¸æ˜¯éµå¾ªé¢„å®šçš„é€»è¾‘ã€‚è¿™ä¸ºå…¶æä¾›äº†å¤„ç†æ›´å¤æ‚ä»»åŠ¡çš„é¢å¤–çµæ´»æ€§ã€‚</li></ul><h3 id="2-2-ä¸ªæ€§åŒ–é…ç½®"><a href="#2-2-ä¸ªæ€§åŒ–é…ç½®" class="headerlink" title="2.2 ä¸ªæ€§åŒ–é…ç½®"></a>2.2 ä¸ªæ€§åŒ–é…ç½®</h3><p><code>LlamaIndex</code> å¯¹ <code>RAG</code> è¿‡ç¨‹æä¾›äº†å…¨é¢çš„é…ç½®æ”¯æŒï¼Œå…è®¸å¼€å‘è€…å¯¹æ•´ä¸ªè¿‡ç¨‹è¿›è¡Œä¸ªæ€§åŒ–è®¾ç½®ã€‚å¸¸è§çš„é…ç½®åœºæ™¯åŒ…æ‹¬ï¼š</p><ul><li>è‡ªå®šä¹‰æ–‡æ¡£åˆ†å—</li><li>è‡ªå®šä¹‰å‘é‡å­˜å‚¨</li><li>è‡ªå®šä¹‰æ£€ç´¢</li><li>æŒ‡å®š LLM</li></ul><blockquote><p>æ³¨ï¼Œä¸ªæ€§åŒ–é…ç½®ä¸»è¦é€šè¿‡ LlamaIndex æä¾›çš„ ServiceContext ç±»å®ç°ã€‚</p></blockquote><h4 id="2-2-1-é…ç½®åœºæ™¯ç¤ºä¾‹"><a href="#2-2-1-é…ç½®åœºæ™¯ç¤ºä¾‹" class="headerlink" title="2.2.1 é…ç½®åœºæ™¯ç¤ºä¾‹"></a>2.2.1 é…ç½®åœºæ™¯ç¤ºä¾‹</h4><p>æ¥ä¸‹æ¥é€šè¿‡ç®€æ˜ç¤ºä¾‹ä»£ç æ®µå±•ç¤º LlamaIndex å¯¹å„ç§é…ç½®åœºæ™¯çš„æ”¯æŒã€‚</p><h5 id="è‡ªå®šä¹‰æ–‡æ¡£åˆ†å—"><a href="#è‡ªå®šä¹‰æ–‡æ¡£åˆ†å—" class="headerlink" title="è‡ªå®šä¹‰æ–‡æ¡£åˆ†å—"></a>è‡ªå®šä¹‰æ–‡æ¡£åˆ†å—</h5><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> llama_index <span class="token keyword">import</span> ServiceContextservice_context <span class="token operator">=</span> ServiceContext<span class="token punctuation">.</span>from_defaults<span class="token punctuation">(</span>chunk_size<span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h5 id="è‡ªå®šä¹‰å‘é‡å­˜å‚¨"><a href="#è‡ªå®šä¹‰å‘é‡å­˜å‚¨" class="headerlink" title="è‡ªå®šä¹‰å‘é‡å­˜å‚¨"></a>è‡ªå®šä¹‰å‘é‡å­˜å‚¨</h5><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> chromadb<span class="token keyword">from</span> llama_index<span class="token punctuation">.</span>vector_stores <span class="token keyword">import</span> ChromaVectorStore <span class="token keyword">from</span> llama_index <span class="token keyword">import</span> StorageContextchroma_client <span class="token operator">=</span> chromadb<span class="token punctuation">.</span>PersistentClient<span class="token punctuation">(</span><span class="token punctuation">)</span>chroma_collection <span class="token operator">=</span> chroma_client<span class="token punctuation">.</span>create_collection<span class="token punctuation">(</span><span class="token string">"quickstart"</span><span class="token punctuation">)</span> vector_store <span class="token operator">=</span> ChromaVectorStore<span class="token punctuation">(</span>chroma_collection<span class="token operator">=</span>chroma_collection<span class="token punctuation">)</span> storage_context <span class="token operator">=</span> StorageContext<span class="token punctuation">.</span>from_defaults<span class="token punctuation">(</span>vector_store<span class="token operator">=</span>vector_store<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h5 id="è‡ªå®šä¹‰æ£€ç´¢"><a href="#è‡ªå®šä¹‰æ£€ç´¢" class="headerlink" title="è‡ªå®šä¹‰æ£€ç´¢"></a>è‡ªå®šä¹‰æ£€ç´¢</h5><p>è‡ªå®šä¹‰æ£€ç´¢ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å‚æ•°æŒ‡å®šæŸ¥è¯¢å¼•æ“(Query Engine)åœ¨æ£€ç´¢æ—¶è¯·æ±‚çš„ç›¸ä¼¼æ–‡æ¡£æ•°ã€‚</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">index <span class="token operator">=</span> VectorStoreIndex<span class="token punctuation">.</span>from_documents<span class="token punctuation">(</span>documents<span class="token punctuation">)</span> query_engine <span class="token operator">=</span> index<span class="token punctuation">.</span>as_query_engine<span class="token punctuation">(</span>similarity_top_k<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h5 id="æŒ‡å®šLLM"><a href="#æŒ‡å®šLLM" class="headerlink" title="æŒ‡å®šLLM"></a>æŒ‡å®šLLM</h5><pre class="line-numbers language-python" data-language="python"><code class="language-python">service_context <span class="token operator">=</span> ServiceContext<span class="token punctuation">.</span>from_defaults<span class="token punctuation">(</span>llm<span class="token operator">=</span>OpenAI<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="ä¸‰ã€LlamaIndexå®ç°RAG"><a href="#ä¸‰ã€LlamaIndexå®ç°RAG" class="headerlink" title="ä¸‰ã€LlamaIndexå®ç°RAG"></a>ä¸‰ã€LlamaIndexå®ç°RAG</h2><p>é€šè¿‡å®æ“ç®€å•å®ç°ä¸€ä¸‹LlamaIndexå®ç°RAGç³»ç»Ÿã€‚</p><p>åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">conda create <span class="token parameter variable">-n</span> llamaindex-learnconda activate llamaindex-learn<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="3-1-åŠ è½½æ–‡æ¡£"><a href="#3-1-åŠ è½½æ–‡æ¡£" class="headerlink" title="3.1 åŠ è½½æ–‡æ¡£"></a>3.1 åŠ è½½æ–‡æ¡£</h3><p>å®‰è£…LlamaIndexæ ¸å¿ƒåº“</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip <span class="token function">install</span> llama-index<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> llama_index<span class="token punctuation">.</span>core <span class="token keyword">import</span> SimpleDirectoryReader<span class="token comment"># åŠ è½½æœ¬åœ°æ–‡æ¡£è¿›è¡Œè§£æ</span><span class="token comment"># documents = SimpleDirectoryReader("data").load_data()</span><span class="token comment"># print(documents)</span><span class="token comment">#åŠ è½½æŸä¸ªæ–‡æ¡£</span>documents <span class="token operator">=</span> SimpleDirectoryReader<span class="token punctuation">(</span>input_files<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"data/pdfå†…å®¹ç ”æŠ¥.pdf"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>load_data<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>documents<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-2-æœ¬åœ°è°ƒç”¨å¤§æ¨¡å‹"><a href="#3-2-æœ¬åœ°è°ƒç”¨å¤§æ¨¡å‹" class="headerlink" title="3.2 æœ¬åœ°è°ƒç”¨å¤§æ¨¡å‹"></a>3.2 æœ¬åœ°è°ƒç”¨å¤§æ¨¡å‹</h3><p>å®‰è£…huggingfaceçš„æœ¬åœ°è°ƒç”¨åŒ…</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip <span class="token function">install</span> llama-index-llms-huggingface<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ä¸‹è½½å¤§æ¨¡å‹ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># æ¨¡å‹ä¸‹è½½</span><span class="token keyword">from</span> modelscope <span class="token keyword">import</span> snapshot_downloadmodel_dir <span class="token operator">=</span> snapshot_download<span class="token punctuation">(</span>    <span class="token string">'Qwen/Qwen3-1.7B'</span><span class="token punctuation">,</span>    cache_dir<span class="token operator">=</span><span class="token string">"E:/xuexiziliao/AiProject/llm"</span>    <span class="token punctuation">)</span><span class="token keyword">from</span> llama_index<span class="token punctuation">.</span>core<span class="token punctuation">.</span>llms <span class="token keyword">import</span> ChatMessage<span class="token keyword">from</span> llama_index<span class="token punctuation">.</span>llms<span class="token punctuation">.</span>huggingface <span class="token keyword">import</span> HuggingFaceLLM<span class="token comment"># æœ¬åœ°å¤§æ¨¡å‹è·¯å¾„</span>llm_path <span class="token operator">=</span> <span class="token string">"E:/xuexiziliao/AiProject/llm/Qwen/Qwen3-1___7B"</span><span class="token comment"># ä½¿ç”¨HuggingFaceLLMè¿›è¡Œæœ¬åœ°è°ƒç”¨</span>llm <span class="token operator">=</span> HuggingFaceLLM<span class="token punctuation">(</span>    model_name<span class="token operator">=</span>llm_path<span class="token punctuation">,</span>    tokenizer_name<span class="token operator">=</span>llm_path<span class="token punctuation">,</span>    model_kwargs<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"trust_remote_code"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span><span class="token punctuation">,</span>    tokenizer_kwargs<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"trust_remote_code"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span>    <span class="token punctuation">)</span>rsp <span class="token operator">=</span> llm<span class="token punctuation">.</span>chat<span class="token punctuation">(</span>messages<span class="token operator">=</span><span class="token punctuation">[</span>ChatMessage<span class="token punctuation">(</span>content<span class="token operator">=</span><span class="token string">"ä»€ä¹ˆæ˜¯XTuner?"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>rsp<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™æ˜¯æ²¡æœ‰åŠ è½½æˆ‘ä»¬æœ¬åœ°æ–‡æ¡£å‰ï¼Œåšä¸€ä¸ªå¤§æ¨¡å‹è¾“å‡ºæµ‹è¯•ï¼Œå¤§æ¨¡å‹å›ç­”å†…å®¹å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-none"><code class="language-none">assistant: &lt;think&gt;å—¯ï¼Œç”¨æˆ·é—®çš„æ˜¯â€œä»€ä¹ˆæ˜¯XTunerï¼Ÿâ€ã€‚é¦–å…ˆï¼Œæˆ‘éœ€è¦ç¡®å®šXTuneræ˜¯ä»€ä¹ˆã€‚æ ¹æ®æˆ‘çš„çŸ¥è¯†åº“ï¼ŒXTunerå¯èƒ½æ˜¯æŒ‡æŸä¸ªç‰¹å®šçš„å·¥å…·æˆ–è½¯ä»¶ï¼Œä½†ä¸ç¡®å®šå…·ä½“æ˜¯å“ªä¸ªã€‚å¯èƒ½æ˜¯ä¸€ä¸ªå¼€æºé¡¹ç›®ã€å·¥å…·ï¼Œæˆ–è€…æŸä¸ªç‰¹å®šé¢†åŸŸçš„æœ¯è¯­ã€‚é¦–å…ˆï¼Œæˆ‘åº”è¯¥å›å¿†ä¸€ä¸‹æœ‰æ²¡æœ‰å¬è¯´è¿‡XTunerã€‚æ¯”å¦‚ï¼Œæœ‰æ²¡æœ‰å¯èƒ½æ˜¯æŒ‡æŸä¸ªæœºå™¨å­¦ä¹ æ¡†æ¶ï¼Œæˆ–è€…éŸ³é¢‘å¤„ç†å·¥å…·ï¼Ÿæ¯”å¦‚ï¼ŒXTunerå¯èƒ½æ˜¯ä¸€ä¸ªç”¨äºéŸ³é¢‘å¤„ç†çš„å·¥å…·ï¼Œæ¯”å¦‚ç”¨äºè¯­éŸ³è¯†åˆ«æˆ–éŸ³é¢‘å¢å¼ºã€‚æˆ–è€…å¯èƒ½æ˜¯ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œæ¯”å¦‚åœ¨GitHubä¸ŠæŸä¸ªé¡¹ç›®çš„åå­—æ˜¯XTunerã€‚å¦å¤–ï¼Œå¯èƒ½XTuneræ˜¯æŸä¸ªå…¬å¸çš„äº§å“ï¼Œæ¯”å¦‚æŸä¸ªç§‘æŠ€å…¬å¸å¼€å‘çš„å·¥å…·ï¼Œä½†æˆ‘ä¸å¤ªç¡®å®šã€‚ä¹Ÿæœ‰å¯èƒ½XTuneræ˜¯æŸä¸ªç‰¹å®šé¢†åŸŸçš„æœ¯è¯­ï¼Œæ¯”å¦‚åœ¨è®¡ç®—æœºè§†è§‰ã€è‡ªç„¶è¯­è¨€å¤„ç†ä¸­çš„æŸä¸ªå·¥å…·ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘éœ€è¦è€ƒè™‘ç”¨æˆ·å¯èƒ½çš„èƒŒæ™¯ã€‚ç”¨æˆ·å¯èƒ½æ˜¯åœ¨ä½¿ç”¨æŸä¸ªè½¯ä»¶æ—¶é‡åˆ°äº†XTunerï¼Œæˆ–è€…åœ¨ç ”ç©¶æŸä¸ªæŠ€æœ¯æ—¶é‡åˆ°äº†è¿™ä¸ªæœ¯è¯­ã€‚ä¹Ÿæœ‰å¯èƒ½ç”¨æˆ·åœ¨æŸä¸ªè®ºå›æˆ–ç¤¾åŒºä¸­çœ‹åˆ°è¿‡XTunerï¼Œä½†æ²¡æœ‰æ˜ç¡®çš„å®šä¹‰ã€‚ä¸ºäº†å‡†ç¡®å›ç­”ï¼Œæˆ‘éœ€è¦ç¡®è®¤XTunerçš„å¸¸è§å®šä¹‰ã€‚å¯èƒ½éœ€è¦æŸ¥æ‰¾ç›¸å…³èµ„æ–™ï¼Œæ¯”å¦‚åœ¨GitHubä¸Šæœç´¢XTunerï¼Œæˆ–è€…æŸ¥çœ‹æ˜¯å¦æœ‰ç›¸å…³çš„æŠ€æœ¯æ–‡æ¡£ã€‚ä½†å‡è®¾æˆ‘ç°åœ¨æ— æ³•è®¿é—®å¤–éƒ¨<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬æ˜¯é—®çš„<code>XTuner</code> æ˜¯ä¸€ä¸ªå¤§æ¨¡å‹å¾®è°ƒæ¡†æ¶ï¼Œä½†æ˜¯å¤§æ¨¡å‹æœ¬èº«æ²¡æœ‰å…³äºå®ƒçš„ä¿¡æ¯ï¼Œæ‰€ä»¥å¤§æ¨¡å‹å°±ç»™æˆ‘ä»¬ç”Ÿæˆä¸€äº›æœ‰çš„æ²¡çš„å†…å®¹ï¼Œè¿™å°±æ˜¯å¤§æ¨¡å‹äº§ç”Ÿäº†å¹»è§‰ã€‚</p><h3 id="3-3-Embeddingæ¨¡å‹"><a href="#3-3-Embeddingæ¨¡å‹" class="headerlink" title="3.3 Embeddingæ¨¡å‹"></a>3.3 Embeddingæ¨¡å‹</h3><p>å®‰è£…é­”å¡”ç¤¾åŒºSDK</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip <span class="token function">install</span> modelscope<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å®‰è£… <code>llama-index-embeddings-huggingface</code> åŒ…å’Œä¸‹è½½Embeddingæ¨¡å‹</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip <span class="token function">install</span> llama-index-embeddings-huggingface<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># æ¨¡å‹ä¸‹è½½</span><span class="token keyword">from</span> modelscope <span class="token keyword">import</span> snapshot_downloadmodel_dir <span class="token operator">=</span> snapshot_download<span class="token punctuation">(</span>    <span class="token string">'sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2'</span><span class="token punctuation">,</span>    cache_dir<span class="token operator">=</span><span class="token string">r"E:\xuexiziliao\AiProject\llm"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> llama_index<span class="token punctuation">.</span>embeddings<span class="token punctuation">.</span>huggingface <span class="token keyword">import</span> HuggingFaceEmbedding<span class="token keyword">from</span> llama_index<span class="token punctuation">.</span>core <span class="token keyword">import</span> Settings<span class="token punctuation">,</span>SimpleDirectoryReader<span class="token punctuation">,</span>VectorStoreIndex<span class="token keyword">from</span> llama_index<span class="token punctuation">.</span>llms<span class="token punctuation">.</span>huggingface <span class="token keyword">import</span> HuggingFaceLLM<span class="token comment"># æœ¬åœ°å¤§æ¨¡å‹è·¯å¾„</span>llm_path <span class="token operator">=</span> <span class="token string">"E:/xuexiziliao/AiProject/llm/Qwen/Qwen3-1___7B"</span><span class="token comment"># æœ¬åœ°Embeddingæ¨¡å‹è·¯å¾„</span>embedding_path <span class="token operator">=</span> <span class="token string">"E:/xuexiziliao/AiProject/llm/sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2"</span><span class="token comment"># åˆå§‹åŒ–ä¸€ä¸ªHuggingFaceEmbeddingå¯¹è±¡ï¼Œç”¨äºå°†æ–‡æœ¬è½¬æ¢ä¸ºå‘é‡è¡¨ç¤º</span>embed_model <span class="token operator">=</span> HuggingFaceEmbedding<span class="token punctuation">(</span>    <span class="token comment">#æŒ‡å®šäº†ä¸€ä¸ªé¢„è®­ç»ƒçš„sentence-transformeræ¨¡å‹çš„è·¯å¾„</span>    model_name<span class="token operator">=</span>embedding_path<span class="token punctuation">)</span><span class="token comment"># å°†åˆ›å»ºçš„åµŒå…¥æ¨¡å‹èµ‹å€¼ç»™å…¨å±€è®¾ç½®çš„embed_modelå±æ€§ï¼Œè¿™æ ·åœ¨åç»­çš„ç´¢å¼•æ„å»ºè¿‡ç¨‹ä¸­ï¼Œå°±ä¼šä½¿ç”¨è¿™ä¸ªæ¨¡å‹</span>Settings<span class="token punctuation">.</span>embed_model <span class="token operator">=</span> embed_model<span class="token comment"># ä½¿ç”¨HuggingFaceLLMè¿›è¡Œæœ¬åœ°è°ƒç”¨</span>llm <span class="token operator">=</span> HuggingFaceLLM<span class="token punctuation">(</span>    model_name<span class="token operator">=</span>llm_path<span class="token punctuation">,</span>    tokenizer_name<span class="token operator">=</span>llm_path<span class="token punctuation">,</span>    model_kwargs<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"trust_remote_code"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span><span class="token punctuation">,</span>    tokenizer_kwargs<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"trust_remote_code"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span>    <span class="token punctuation">)</span><span class="token comment"># è®¾ç½®å…¨å±€çš„llmå±æ€§ï¼Œè¿™æ ·åœ¨ç´¢å¼•æŸ¥è¯¢æ—¶ä¼šä½¿ç”¨è¿™ä¸ªæ¨¡å‹ã€‚</span>Settings<span class="token punctuation">.</span>llm <span class="token operator">=</span> llm<span class="token comment"># ä»æŒ‡å®šç›®å½•è¯»å–æ–‡æ¡£ï¼Œå°†æ•°æ®åŠ è½½åˆ°å†…å­˜</span><span class="token comment"># documents = SimpleDirectoryReader("data").load_data()</span>documents <span class="token operator">=</span> SimpleDirectoryReader<span class="token punctuation">(</span>input_files<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"data/README_zh-CN.md"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>load_data<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># print("=======================")</span><span class="token comment"># print(documents)</span><span class="token comment"># print("=======================")</span><span class="token comment"># åˆ›å»ºä¸€ä¸ªVectorStoreIndex,å¹¶ä½¿ç”¨ä¹‹å‰åŠ è½½çš„æ–‡æ¡£æ¥æ„å»ºå‘é‡ç´¢å¼•</span><span class="token comment"># æ­¤ç´¢å¼•å°†æ–‡æ¡£è½¬æ¢ä¸ºå‘é‡ï¼Œå¹¶å­˜å‚¨è¿™äº›å‘é‡ï¼ˆåœ¨å†…å­˜ï¼‰ä»¥ä¾¿äºå¿«é€Ÿæ£€ç´¢</span>index <span class="token operator">=</span> VectorStoreIndex<span class="token punctuation">.</span>from_documents<span class="token punctuation">(</span>documents<span class="token punctuation">)</span><span class="token comment"># åˆ›å»ºä¸€ä¸ªæŸ¥è¯¢å¼•æ“ï¼Œè¿™ä¸ªå¼•æ“å¯ä»¥æ¥æ”¶æŸ¥è¯¢å¹¶è¿”å›ç›¸å…³æ–‡æ¡£çš„å“åº”ã€‚</span>query_engine <span class="token operator">=</span> index<span class="token punctuation">.</span>as_query_engine<span class="token punctuation">(</span><span class="token punctuation">)</span>rsp <span class="token operator">=</span> query_engine<span class="token punctuation">.</span>query<span class="token punctuation">(</span><span class="token string">"ä»€ä¹ˆæ˜¯XTuner?"</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"======================="</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>rsp<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"======================="</span><span class="token punctuation">)</span>rsp <span class="token operator">=</span> query_engine<span class="token punctuation">.</span>query<span class="token punctuation">(</span><span class="token string">"XTunerçš„ä½¿ç”¨æ­¥éª¤"</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>rsp<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"======================="</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™æ˜¯æˆ‘ä»¬åŠ è½½æˆ‘ä»¬çš„æ–‡æ¡£åè€Œæ²¡æœ‰å°†æ–‡æ¡£è§£æä¸ºæ›´å°å—çš„æƒ…å†µä¸‹ï¼Œå¤§æ¨¡å‹ç»™æˆ‘ä»¬ç”Ÿæˆçš„å†…å®¹å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-none"><code class="language-none">======================= XTuner æ˜¯ä¸€ä¸ªé«˜æ•ˆã€çµæ´»ã€å…¨èƒ½çš„è½»é‡åŒ–å¤§æ¨¡å‹å¾®è°ƒå·¥å…·åº“ã€‚å®ƒæ”¯æŒå¤§è¯­è¨€æ¨¡å‹ LLMã€å¤šæ¨¡æ€å›¾æ–‡æ¨¡å‹ VLM çš„é¢„è®­ç»ƒåŠè½»é‡çº§å¾®è°ƒã€‚XTuner æ”¯æŒåœ¨ 8GB æ˜¾å­˜ä¸‹å¾®è°ƒ 7B æ¨¡å‹ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒå¤šèŠ‚ç‚¹è·¨è®¾å¤‡å¾®è°ƒæ›´å¤§å°ºåº¦æ¨¡å‹ï¼ˆ70B+ï¼‰ã€‚å®ƒè‡ªåŠ¨åˆ†å‘é«˜æ€§èƒ½ç®—å­ï¼ˆå¦‚ FlashAttentionã€Triton kernels ç­‰ï¼‰ä»¥åŠ é€Ÿè®­ç»ƒååã€‚å…¼å®¹ DeepSpeedï¼Œè½»æ¾åº”ç”¨å„ç§ ZeRO è®­ç»ƒä¼˜åŒ–ç­–ç•¥ã€‚XTuner æ”¯æŒå¤šç§å¤§è¯­è¨€æ¨¡å‹ï¼ŒåŒ…æ‹¬ä½†ä¸é™äº InternLMã€Llama 2ã€ChatGLMã€Qwenã€Baichuan ç­‰ã€‚æ”¯æŒå¤šæ¨¡æ€å›¾æ–‡æ¨¡å‹ LLaVA çš„é¢„è®­ç»ƒä¸å¾®è°ƒã€‚è®¾è®¡äº†æ•°æ®ç®¡é“ï¼Œå…¼å®¹ä»»æ„æ•°æ®æ ¼å¼ï¼Œå¼€æºæ•°æ®æˆ–è‡ªå®šä¹‰æ•°æ®çš†å¯å¿«é€Ÿä¸Šæ‰‹ã€‚æ”¯æŒ QLoRAã€LoRAã€å…¨é‡å‚æ•°å¾®è°ƒç­‰å¤šç§å¾®è°ƒç®—æ³•ï¼Œæ”¯æ’‘ç”¨æˆ·æ ¹æ®å…·ä½“éœ€æ±‚ä½œå‡ºæœ€ä¼˜é€‰æ‹©ã€‚XTuner æ”¯æŒå¢é‡é¢„è®­ç»ƒã€æŒ‡ä»¤å¾®è°ƒä¸ Agent å¾®è°ƒã€‚é¢„å®šä¹‰ä¼—å¤šå¼€æºå¯¹è¯æ¨¡ç‰ˆï¼Œæ”¯æŒä¸å¼€æºæˆ–è®­ç»ƒæ‰€å¾—æ¨¡å‹=======================ä»¥ä¸‹ä¸ºXTunerçš„ä½¿ç”¨æ­¥éª¤ï¼š1. å®‰è£…XTuner   - å®‰è£…å‘½ä»¤ï¼š`pip install xtuner`2. å‡†å¤‡æ•°æ®   - é€‰æ‹©é€‚åˆçš„æ¨¡å‹ï¼Œå¦‚InternLMã€Llama 2ç­‰ã€‚   - å‡†å¤‡æ•°æ®é›†ï¼ŒåŒ…æ‹¬è®­ç»ƒæ•°æ®å’Œæµ‹è¯•æ•°æ®ã€‚   - æ•°æ®æ ¼å¼éœ€ç¬¦åˆè¦æ±‚ï¼Œå¦‚æ–‡æœ¬ã€å›¾ç‰‡ç­‰ã€‚3. å¾®è°ƒæ¨¡å‹   - ä½¿ç”¨XTuneræä¾›çš„å¾®è°ƒç®—æ³•ï¼Œå¦‚QLoRAã€LoRAç­‰ã€‚   - è®¾ç½®å¾®è°ƒå‚æ•°ï¼Œå¦‚å­¦ä¹ ç‡ã€æ‰¹æ¬¡å¤§å°ç­‰ã€‚   - å¼€å§‹è®­ç»ƒæ¨¡å‹ã€‚4. æ¨¡å‹è½¬æ¢   - å¦‚æœä½¿ç”¨DeepSpeedï¼Œå°†è®­ç»ƒå¥½çš„æ¨¡å‹è½¬æ¢ä¸ºHuggingFaceæ ¼å¼ã€‚   - ä½¿ç”¨å‘½ä»¤ï¼š`xtuner convert pth_to_hf ${CONFIG_NAME_OR_PATH} ${PTH} ${SAVE_PATH}`5. æ¨¡å‹éƒ¨ç½²   - ä½¿ç”¨LMDeployç­‰æ¨ç†æ¡†æ¶éƒ¨ç½²æ¨¡å‹ã€‚   - ä¾‹å¦‚ï¼š`pip install lmdeploy`ï¼Œç„¶åè¿è¡Œï¼š`python -m lmdeploy.pytorch.chat ${NAME_OR_PATH_TO_LLM} ...`6. æ¨¡å‹è¯„æµ‹   - ä½¿ç”¨OpenCompassç­‰å·¥å…·è¯„æµ‹æ¨¡å‹æ€§èƒ½=======================<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å›ç­”çš„åŸºæœ¬ä¸Šæ˜¯æ²¡é—®é¢˜çš„ã€‚</p><h3 id="3-4-æŒä¹…åŒ–å‘é‡åº“å­˜å‚¨"><a href="#3-4-æŒä¹…åŒ–å‘é‡åº“å­˜å‚¨" class="headerlink" title="3.4 æŒä¹…åŒ–å‘é‡åº“å­˜å‚¨"></a>3.4 æŒä¹…åŒ–å‘é‡åº“å­˜å‚¨</h3><p>æ„å»ºä¸€ä¸ªå¯ä»¥æ°¸ä¹…åŒ–ä¿å­˜çš„å‘é‡å­˜å‚¨åº“</p><p>å®‰è£…ç›¸åº”ç¯å¢ƒåŒ…</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip <span class="token function">install</span> chromadbpip <span class="token function">install</span> llama-index-vector-stores-chroma<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> chromadb<span class="token keyword">from</span> llama_index<span class="token punctuation">.</span>vector_stores<span class="token punctuation">.</span>chroma <span class="token keyword">import</span> ChromaVectorStore<span class="token keyword">from</span> llama_index<span class="token punctuation">.</span>core <span class="token keyword">import</span> StorageContext<span class="token punctuation">,</span>Settings<span class="token comment"># å®šä¹‰å‘é‡å­˜å‚¨æ•°æ®åº“</span>chroma_client <span class="token operator">=</span> chromadb<span class="token punctuation">.</span>PersistentClient<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># #åˆ›å»ºé›†åˆ</span><span class="token comment"># chroma_client.create_collection("quickstart")</span><span class="token comment"># print("é›†åˆåˆ›å»ºå®Œæ¯•")</span><span class="token comment"># #è·å–å·²ç»å­˜åœ¨çš„å‘é‡æ•°æ®åº“</span><span class="token comment"># chroma_collection = chroma_client.get_collection("quickstart")</span><span class="token comment"># print(chroma_collection)</span><span class="token comment"># print("è·å–å·²ç»å­˜åœ¨çš„çŸ¥è¯†åº“")</span><span class="token comment"># å°è¯•è·å–é›†åˆï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º</span><span class="token keyword">try</span><span class="token punctuation">:</span>    chroma_collection <span class="token operator">=</span> chroma_client<span class="token punctuation">.</span>get_collection<span class="token punctuation">(</span><span class="token string">"quickstart"</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"ä½¿ç”¨å·²ç»å­˜åœ¨çš„æœ¬åœ°çŸ¥è¯†åº“"</span><span class="token punctuation">)</span><span class="token keyword">except</span> chromadb<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>InvalidCollectionException<span class="token punctuation">:</span>    chroma_client<span class="token punctuation">.</span>create_collection<span class="token punctuation">(</span><span class="token string">"quickstart"</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„æœ¬åœ°çŸ¥è¯†åº“"</span><span class="token punctuation">)</span><span class="token comment"># åˆ›å»ºå‘é‡å­˜å‚¨</span>vector_store <span class="token operator">=</span> ChromaVectorStore<span class="token punctuation">(</span>chroma_collection<span class="token operator">=</span>chroma_collection<span class="token punctuation">)</span><span class="token comment"># åˆ›å»ºå­˜å‚¨ä¸Šä¸‹æ–‡</span>storage_context <span class="token operator">=</span> StorageContext<span class="token punctuation">.</span>from_defaults<span class="token punctuation">(</span>vector_store<span class="token operator">=</span>vector_store<span class="token punctuation">)</span><span class="token comment"># storage_context = ServiceContext.from_defaults(vector_store=vector_store)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-5-å°†æ–‡æ¡£è§£æä¸ºæ›´å°çš„å—"><a href="#3-5-å°†æ–‡æ¡£è§£æä¸ºæ›´å°çš„å—" class="headerlink" title="3.5 å°†æ–‡æ¡£è§£æä¸ºæ›´å°çš„å—"></a>3.5 å°†æ–‡æ¡£è§£æä¸ºæ›´å°çš„å—</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> llama_index<span class="token punctuation">.</span>embeddings<span class="token punctuation">.</span>huggingface <span class="token keyword">import</span> HuggingFaceEmbedding<span class="token keyword">from</span> llama_index<span class="token punctuation">.</span>core <span class="token keyword">import</span> Settings<span class="token punctuation">,</span>SimpleDirectoryReader<span class="token punctuation">,</span>VectorStoreIndex<span class="token keyword">from</span> llama_index<span class="token punctuation">.</span>llms<span class="token punctuation">.</span>huggingface <span class="token keyword">import</span> HuggingFaceLLM<span class="token comment"># æœ¬åœ°å¤§æ¨¡å‹è·¯å¾„</span>llm_path <span class="token operator">=</span> <span class="token string">"E:/xuexiziliao/AiProject/llm/Qwen/Qwen3-1___7B"</span><span class="token comment"># æœ¬åœ°Embeddingæ¨¡å‹è·¯å¾„</span>embedding_path <span class="token operator">=</span> <span class="token string">"E:/xuexiziliao/AiProject/llm/sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2"</span><span class="token comment"># åˆå§‹åŒ–ä¸€ä¸ªHuggingFaceEmbeddingå¯¹è±¡ï¼Œç”¨äºå°†æ–‡æœ¬è½¬æ¢ä¸ºå‘é‡è¡¨ç¤º</span>embed_model <span class="token operator">=</span> HuggingFaceEmbedding<span class="token punctuation">(</span>    <span class="token comment">#æŒ‡å®šäº†ä¸€ä¸ªé¢„è®­ç»ƒçš„sentence-transformeræ¨¡å‹çš„è·¯å¾„</span>    model_name<span class="token operator">=</span>embedding_path<span class="token punctuation">)</span><span class="token comment"># å°†åˆ›å»ºçš„åµŒå…¥æ¨¡å‹èµ‹å€¼ç»™å…¨å±€è®¾ç½®çš„embed_modelå±æ€§ï¼Œè¿™æ ·åœ¨åç»­çš„ç´¢å¼•æ„å»ºè¿‡ç¨‹ä¸­ï¼Œå°±ä¼šä½¿ç”¨è¿™ä¸ªæ¨¡å‹</span>Settings<span class="token punctuation">.</span>embed_model <span class="token operator">=</span> embed_model<span class="token comment"># ä½¿ç”¨HuggingFaceLLMè¿›è¡Œæœ¬åœ°è°ƒç”¨</span>llm <span class="token operator">=</span> HuggingFaceLLM<span class="token punctuation">(</span>    model_name<span class="token operator">=</span>llm_path<span class="token punctuation">,</span>    tokenizer_name<span class="token operator">=</span>llm_path<span class="token punctuation">,</span>    model_kwargs<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"trust_remote_code"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span><span class="token punctuation">,</span>    tokenizer_kwargs<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"trust_remote_code"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span>    <span class="token punctuation">)</span><span class="token comment"># è®¾ç½®å…¨å±€çš„llmå±æ€§ï¼Œè¿™æ ·åœ¨ç´¢å¼•æŸ¥è¯¢æ—¶ä¼šä½¿ç”¨è¿™ä¸ªæ¨¡å‹ã€‚</span>Settings<span class="token punctuation">.</span>llm <span class="token operator">=</span> llm<span class="token comment"># ä»æŒ‡å®šç›®å½•è¯»å–æ–‡æ¡£ï¼Œå°†æ•°æ®åŠ è½½åˆ°å†…å­˜</span>documents <span class="token operator">=</span> SimpleDirectoryReader<span class="token punctuation">(</span>input_files<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"data/README_zh-CN.md"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>load_data<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># å…¨å±€è®¾ç½®</span><span class="token comment"># from llama_index.core import Settings</span><span class="token comment"># è®¾ç½®å…¨å±€å—å¤§å°ä¸º512</span><span class="token comment"># Settings.chunk_size = 512</span><span class="token comment"># å±€éƒ¨è®¾ç½®</span><span class="token keyword">from</span> llama_index<span class="token punctuation">.</span>core<span class="token punctuation">.</span>node_parser <span class="token keyword">import</span> SimpleNodeParser<span class="token comment"># åˆ›å»ºèŠ‚ç‚¹è§£æå™¨</span>node_parser <span class="token operator">=</span> SimpleNodeParser<span class="token punctuation">.</span>from_defaults<span class="token punctuation">(</span>chunk_size<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">)</span><span class="token comment"># å°†æ–‡æ¡£åˆ†å‰²æˆèŠ‚ç‚¹</span>base_node <span class="token operator">=</span> node_parser<span class="token punctuation">.</span>get_nodes_from_documents<span class="token punctuation">(</span>documents<span class="token operator">=</span>documents<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"================================="</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>documents<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"================================="</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>base_node<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"================================="</span><span class="token punctuation">)</span><span class="token comment"># æ ¹æ®è‡ªå®šä¹‰çš„nodeèŠ‚ç‚¹æ„å»ºå‘é‡ç´¢å¼•</span>index <span class="token operator">=</span> VectorStoreIndex<span class="token punctuation">(</span>nodes<span class="token operator">=</span>base_node<span class="token punctuation">)</span><span class="token comment"># å°†ç´¢å¼•æŒä¹…åŒ–å­˜å‚¨åˆ°æœ¬åœ°çš„å‘é‡æ•°æ®åº“</span>index<span class="token punctuation">.</span>storage_context<span class="token punctuation">.</span>persist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># åˆ›å»ºä¸€ä¸ªæŸ¥è¯¢å¼•æ“ï¼Œè¿™ä¸ªå¼•æ“å¯ä»¥æ¥æ”¶æŸ¥è¯¢å¹¶è¿”å›ç›¸å…³æ–‡æ¡£çš„å“åº”ã€‚</span>query_engine <span class="token operator">=</span> index<span class="token punctuation">.</span>as_query_engine<span class="token punctuation">(</span><span class="token punctuation">)</span>rsp <span class="token operator">=</span> query_engine<span class="token punctuation">.</span>query<span class="token punctuation">(</span><span class="token string">"ä»€ä¹ˆæ˜¯XTuner?"</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"======================="</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>rsp<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"======================="</span><span class="token punctuation">)</span>rsp <span class="token operator">=</span> query_engine<span class="token punctuation">.</span>query<span class="token punctuation">(</span><span class="token string">"XTunerçš„ä½¿ç”¨æ­¥éª¤"</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>rsp<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"======================="</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å°†æ–‡æœ¬åˆ‡å‰²ä¸ºæ›´ç»†è‡´çš„å†…å®¹åï¼Œè¾“å‡ºå†…å®¹å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-none"><code class="language-none">======================= XTuner æ˜¯ä¸€ä¸ªé«˜æ•ˆã€çµæ´»ã€å…¨èƒ½çš„è½»é‡åŒ–å¤§æ¨¡å‹å¾®è°ƒå·¥å…·åº“ã€‚å®ƒæ”¯æŒå¤§è¯­è¨€æ¨¡å‹ LLMã€å¤šæ¨¡æ€å›¾æ–‡æ¨¡å‹ VLM çš„é¢„è®­ç»ƒåŠè½»é‡çº§å¾®è°ƒã€‚XTuner æ”¯æŒåœ¨ 8GB æ˜¾å­˜ä¸‹å¾®è°ƒ 7B æ¨¡å‹ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒå¤šèŠ‚ç‚¹è·¨è®¾å¤‡å¾®è°ƒæ›´å¤§å°ºåº¦æ¨¡å‹ï¼ˆ70B+ï¼‰ã€‚å®ƒè‡ªåŠ¨åˆ†å‘é«˜æ€§èƒ½ç®—å­ï¼ˆå¦‚ FlashAttentionã€Triton kernels ç­‰ï¼‰ä»¥åŠ é€Ÿè®­ç»ƒååã€‚å…¼å®¹ DeepSpeedï¼Œè½»æ¾åº”ç”¨å„ç§ ZeRO è®­ç»ƒä¼˜åŒ–ç­–ç•¥ã€‚XTuner å†…ç½®å¤šç§ç­–ç•¥ï¼ŒåŒ…æ‹¬ ZeRO-1ã€ZeRO-2ã€ZeRO-3 ç­‰ã€‚å¦‚æœç”¨æˆ·æœŸæœ›å…³é—­æ­¤åŠŸèƒ½ï¼Œè¯·ç›´æ¥ç§»é™¤æ­¤å‚æ•°ã€‚XTuner æä¾›ä¸å¤§è¯­è¨€æ¨¡å‹å¯¹è¯çš„å·¥å…·ã€‚XTuner éƒ¨ç½²æ—¶ï¼Œå°† HuggingFace adapter åˆå¹¶åˆ°å¤§è¯­è¨€æ¨¡å‹ï¼Œç„¶åä½¿ç”¨ä»»æ„æ¨ç†æ¡†æ¶éƒ¨ç½²å¾®è°ƒåçš„å¤§è¯­è¨€æ¨¡å‹ã€‚ --------------------- The user is asking what XTuner is. The answer is provided in the context. The answer is in the form of a paragraph, but the assistant should respond in Chinese, as per the user's instruction. --------------------- The ======================= ä»ä½¿ç”¨XTunerå¼€å§‹ï¼Œé¦–å…ˆéœ€è¦å°†HuggingFace adapteråˆå¹¶åˆ°å¤§è¯­è¨€æ¨¡å‹ï¼Œç„¶åä½¿ç”¨ä»»æ„æ¨ç†æ¡†æ¶éƒ¨ç½²å¾®è°ƒåçš„æ¨¡å‹ã€‚ --------------------- Given the context information and not prior knowledge, answer the query. Query: XTunerçš„ä½¿ç”¨æ­¥éª¤ Answer: ä»ä½¿ç”¨XTunerå¼€å§‹ï¼Œé¦–å…ˆéœ€è¦å°†HuggingFace adapteråˆå¹¶åˆ°å¤§è¯­è¨€æ¨¡å‹ï¼Œç„¶åä½¿ç”¨ä»»æ„æ¨ç†æ¡†æ¶éƒ¨ç½²å¾®è°ƒåçš„æ¨¡å‹ã€‚ --------------------- Given the context information and not prior knowledge, answer the query. Query: XTunerçš„ä½¿ç”¨æ­¥éª¤ Answer: ä»ä½¿ç”¨XTunerå¼€å§‹ï¼Œé¦–å…ˆéœ€è¦å°†HuggingFace adapteråˆå¹¶åˆ°å¤§è¯­è¨€æ¨¡å‹ï¼Œç„¶åä½¿ç”¨ä»»æ„æ¨ç†æ¡†æ¶éƒ¨ç½²å¾®è°ƒåçš„æ¨¡å‹ã€‚ --------------------- Given the context information and not prior knowledge, answer the query. Query: XTunerçš„ä½¿ç”¨æ­¥éª¤ Answer: ä»ä½¿ç”¨XTunerå¼€å§‹ï¼Œé¦–å…ˆéœ€è¦å°†HuggingFace adapteråˆå¹¶åˆ°å¤§è¯­è¨€æ¨¡å‹ï¼Œç„¶åä½¿ç”¨ä»»æ„æ¨ç†æ¡†æ¶éƒ¨ç½²å¾®è°ƒåçš„æ¨¡å‹ã€‚...Answer: ä»ä½¿ç”¨XTunerå¼€å§‹ï¼Œé¦–å…ˆéœ€è¦å°†HuggingFace adapteråˆå¹¶åˆ°å¤§è¯­è¨€æ¨¡å‹ï¼Œç„¶åä½¿ç”¨ä»»æ„æ¨ç†æ¡†æ¶éƒ¨ç½²å¾®è°ƒåçš„æ¨¡å‹ã€‚ --------------------- =======================<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™ä¸ªå›ç­”å…¶å®æ²¡æœ‰ä¹‹å‰çš„å›ç­”è¦å¥½ï¼Œè¿™é‡Œå°±æ˜¯å› ä¸ºåˆ‡å‰²çš„æ–¹å¼ä»¥åŠæˆ‘ä»¬æœ¬åœ°æ–‡æ¡£æ²¡æœ‰åšä¸€äº›å¤„ç†çš„é—®é¢˜ï¼Œå¦‚æœåœ¨æ„å»ºRAGç³»ç»Ÿæ—¶æƒ³è¦ä¸€ä¸ªå¥½çš„æ•ˆæœï¼Œéœ€è¦å¯¹æˆ‘ä»¬çš„çŸ¥è¯†åº“è¿›è¡Œæ•´ç†ï¼Œç„¶ååœ¨é…åˆ <code>LlamaIndex</code> çš„ä¸€äº›å¤„ç†æ–‡æ¡£çš„æ–¹æ³•å°±å¯ä»¥è¾¾åˆ°ä¸€ä¸ªæ›´å¥½çš„æ•ˆæœã€‚</p><h2 id="é—®é¢˜è®°å½•"><a href="#é—®é¢˜è®°å½•" class="headerlink" title="é—®é¢˜è®°å½•"></a>é—®é¢˜è®°å½•</h2><h3 id="ä¸€ã€åœ¨ä»£ç å¤„æ‰§è¡ŒæŠ¥é”™ï¼š"><a href="#ä¸€ã€åœ¨ä»£ç å¤„æ‰§è¡ŒæŠ¥é”™ï¼š" class="headerlink" title="ä¸€ã€åœ¨ä»£ç å¤„æ‰§è¡ŒæŠ¥é”™ï¼š"></a>ä¸€ã€åœ¨ä»£ç å¤„æ‰§è¡ŒæŠ¥é”™ï¼š</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># å£°æ˜å‘é‡å­˜å‚¨</span>vector_store <span class="token operator">=</span> ChromaVectorStore<span class="token punctuation">(</span>chroma_collection<span class="token operator">=</span>chroma_collection<span class="token punctuation">)</span>storage_context <span class="token operator">=</span> ServiceContext<span class="token punctuation">.</span>from_defaults<span class="token punctuation">(</span>vector_store<span class="token operator">=</span>vector_store<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h4 id="é”™è¯¯ä¿¡æ¯ï¼šâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”"><a href="#é”™è¯¯ä¿¡æ¯ï¼šâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”" class="headerlink" title="é”™è¯¯ä¿¡æ¯ï¼šâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”"></a>é”™è¯¯ä¿¡æ¯ï¼šâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”</h4><p>ValueError                                Traceback (most recent call last)<br>Cell In[12], line 27<br>     25 # å£°æ˜å‘é‡å­˜å‚¨<br>     26 vector_store = ChromaVectorStore(chroma_collection=chroma_collection)<br>â€”&gt; 27 storage_context = ServiceContext.from_defaults(vector_store=vector_store)</p><p>File c:\Users\25423.conda\envs\llamaindex-learn\Lib\site-packages\llama_index\core\service_context.py:31, in ServiceContext.from_defaults(cls, **kwargs)<br>     20 @classmethod<br>     21 def from_defaults(<br>     22     cls,<br>     23     **kwargs: Any,<br>     24 ) -&gt; â€œServiceContextâ€:<br>     25     â€œâ€â€Create a ServiceContext from defaults.<br>     26<br>     27     NOTE: Deprecated, use llama_index.settings.Settings instead or pass in<br>     28     modules to local functions/methods/interfaces.<br>     29<br>     30     â€œâ€â€<br>â€”&gt; 31     raise ValueError(<br>     32         â€œServiceContext is deprecated. Use llama_index.settings.Settings instead, â€œ<br>     33         â€œor pass in modules to local functions/methods/interfaces.\nâ€<br>     34         â€œSee the docs for updated usage/migration: \nâ€<br>     35         â€œ<a href="https://docs.llamaindex.ai/en/stable/module_guides/supporting_modules/service_context_migration/">https://docs.llamaindex.ai/en/stable/module_guides/supporting_modules/service_context_migration/</a>â€œ<br>     36     )</p><p>ValueError: ServiceContext is deprecated. Use llama_index.settings.Settings instead, or pass in modules to local functions/methods/interfaces.<br>See the docs for updated usage/migration:<br><a href="https://docs.llamaindex.ai/en/stable/module_guides/supporting_modules/service_context_migration/">https://docs.llamaindex.ai/en/stable/module_guides/supporting_modules/service_context_migration/</a></p><h4 id="è§£å†³æ–¹æ³•"><a href="#è§£å†³æ–¹æ³•" class="headerlink" title="è§£å†³æ–¹æ³•"></a>è§£å†³æ–¹æ³•</h4><p>æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£æ˜¯å› ä¸ºåœ¨LlamaIndexåœ¨ v0.10.0 ä¸­å¼•å…¥äº†ä¸€ä¸ªæ–°çš„å…¨å±€ Settings å¯¹è±¡ï¼Œæ—¨åœ¨å–ä»£æ—§çš„ ServiceContext é…ç½®ã€‚</p><p>æ–°çš„ Settings å¯¹è±¡æ˜¯ä¸€ä¸ªå…¨å±€è®¾ç½®ï¼Œå…¶å‚æ•°æ˜¯å»¶è¿Ÿå®ä¾‹åŒ–çš„ã€‚LLM æˆ–åµŒå…¥æ¨¡å‹ç­‰å±æ€§ä»…åœ¨åº•å±‚æ¨¡å—å®é™…éœ€è¦æ—¶æ‰ä¼šåŠ è½½ã€‚</p><p>ä½†æ˜¯æœ€åæ›´æ¢äº†ä¸€ä¸‹å¯¹è±¡ä¹Ÿæ²¡æœ‰ç”¨</p><p>åç»­å‘ç°æ˜¯ <code>ServiceContext</code> å¯¹è±¡ä½¿ç”¨é”™è¯¯ï¼Œæ”¹ä¸º <code>StorageContext</code>å³å¯ï¼Œå¦‚ä¸‹ä»£ç ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">storage_context <span class="token operator">=</span> StorageContext<span class="token punctuation">.</span>from_defaults<span class="token punctuation">(</span>vector_store<span class="token operator">=</span>vector_store<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p><strong>æ›´å¤šå®ç”¨æ–‡ç« å’ŒAIå¤§æ¨¡å‹åº”ç”¨å¼€å‘æ–‡ç« æ¬¢è¿åˆ°æˆ‘ä¸ªäººåšå®¢æ¥è§‚çœ‹ï¼š</strong><a href="https://blog.csdn.net/etrospect/article/details/blog.ismoyu.cn">å¢¨å®‡Logic</a></p>]]></content>
      
      
      <categories>
          
          <category> AIå¤§æ¨¡å‹åº”ç”¨å¼€å‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> vllm </tag>
            
            <tag> RAG </tag>
            
            <tag> LlamaIndex </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€AIå¤§æ¨¡å‹åº”ç”¨å­¦ä¹ ç¬”è®°ã€‘OpenCompassæ¨¡å‹è¯„ä¼°æ¡†æ¶çš„ä½¿ç”¨æ•™ç¨‹</title>
      <link href="/ai-da-mo-xing-ying-yong-xue-xi-bi-ji-opencompass-mo-xing-ping-gu-kuang-jia-de-shi-yong-jiao-cheng/"/>
      <url>/ai-da-mo-xing-ying-yong-xue-xi-bi-ji-opencompass-mo-xing-ping-gu-kuang-jia-de-shi-yong-jiao-cheng/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€ã€åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ"><a href="#ä¸€ã€åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ" class="headerlink" title="ä¸€ã€åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ"></a>ä¸€ã€åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ</h2><p>Open Compassè¦æ±‚çš„pythonç‰ˆæœ¬ä¸º3.10ç‰ˆæœ¬ï¼Œå…¶ä»–çš„ç‰ˆæœ¬ä¸è¡Œã€‚</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">conda create <span class="token parameter variable">--name</span> opencompass <span class="token assign-left variable">python</span><span class="token operator">=</span><span class="token number">3.10</span> <span class="token parameter variable">-y</span>conda activate opencompass<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>å®‰è£…Open Compasså’Œç¯å¢ƒä¾èµ–ï¼š</p><ol><li>ä¸‹è½½ä»“åº“</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone https://github.com/open-compass/opencompass opencompass <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="2"><li>å®‰è£…ç¯å¢ƒä¾èµ–</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> opencompass pip <span class="token function">install</span> <span class="token parameter variable">-e</span> <span class="token builtin class-name">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="äºŒã€æ•°æ®å‡†å¤‡"><a href="#äºŒã€æ•°æ®å‡†å¤‡" class="headerlink" title="äºŒã€æ•°æ®å‡†å¤‡"></a>äºŒã€æ•°æ®å‡†å¤‡</h2><p>æ•°æ®æå‰ç¦»çº¿ä¸‹è½½<br>OpenCompassæ”¯æŒä½¿ç”¨æœ¬åœ°æ•°æ®é›†è¿›è¡Œè¯„æµ‹ï¼Œæ•°æ®é›†çš„ä¸‹è½½å’Œè§£å‹å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤å®Œæˆï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> https://github.com/open-compass/opencompass/releases/download/0.2.2.rc1/OpenCompassData-core-20240207.zip<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å°†ä¸‹è½½çš„æ–‡ä»¶æ”¾åˆ°OpenCompassæ ¹ç›®å½•ä¸‹é¢ï¼Œç„¶åè¿›è¡Œè§£å‹ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">unzip</span> OpenCompassData-core-20240207.zip<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è§£å‹åä¼šåœ¨OpenCompassæ ¹ç›®å½•ä¸‹é¢å¤šä¸€ä¸ªdataæ–‡ä»¶å¤¹ã€‚<br>æ­¤æ—¶çš„OpenCompassæ ¹ç›®å½•å†…å®¹æœ‰ï¼š<br><img src="https://pic1.imgdb.cn/item/6815ec8858cb8da5c8d9d448.png" alt="Open Compassæ ¹ç›®å½•å†…å®¹"></p><h2 id="ä¸‰ã€æµ‹è¯„æ¨¡å‹"><a href="#ä¸‰ã€æµ‹è¯„æ¨¡å‹" class="headerlink" title="ä¸‰ã€æµ‹è¯„æ¨¡å‹"></a>ä¸‰ã€æµ‹è¯„æ¨¡å‹</h2><p>åœ¨ç¡®ä¿æŒ‰ç…§ä¸Šè¿°æ­¥éª¤æ­£ç¡®å®‰è£…äº† OpenCompass å¹¶å‡†å¤‡å¥½äº†æ•°æ®é›†ä¹‹åï¼Œç°åœ¨æˆ‘ä»¬å°±å¯ä»¥å¼€å§‹ä½¿ç”¨ OpenCompass æ¥å¯¹æ¨¡å‹è¿›è¡Œè¯„ä¼°äº†ã€‚</p><h3 id="3-1-å‘½ä»¤è¡Œè¿è¡Œ"><a href="#3-1-å‘½ä»¤è¡Œè¿è¡Œ" class="headerlink" title="3.1 å‘½ä»¤è¡Œè¿è¡Œ"></a>3.1 å‘½ä»¤è¡Œè¿è¡Œ</h3><p>OpenCompass æ”¯æŒé€šè¿‡å‘½ä»¤è¡Œç•Œé¢ (CLI) æˆ– Python è„šæœ¬æ¥è®¾ç½®é…ç½®ã€‚å¯¹äºç®€å•çš„è¯„ä¼°è®¾ç½®ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ CLIã€‚</p><p>åœ¨è¯„ä¼°å‰æˆ‘ä»¬éœ€è¦åšä¸€äº›å‡†å¤‡<br>æˆ‘ä»¬æ‰¾åˆ°ç›®å½•<code>opencompass/opencompass/configs/models</code>ï¼Œåœ¨modelsç›®å½•ä¸‹é¢æ”¾çš„æ˜¯å…³äºå„å®¶å¤§æ¨¡å‹å¯¹åº”çš„é…ç½®æ–‡ä»¶ã€‚</p><p>ä»¥æˆ‘ä»¬è¿™æ¬¡è¦æµ‹è¯„çš„<code>Qwen1.5-4b-chat</code>æ¨¡å‹ä¸ºä¾‹ï¼Œæˆ‘ä»¬æ‰¾åˆ°<code>opencompass/opencompass/configs/models/qwen/hf_qwen1_5_4b_chat.py</code>æ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> opencompass<span class="token punctuation">.</span>models <span class="token keyword">import</span> HuggingFacewithChatTemplatemodels <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token builtin">dict</span><span class="token punctuation">(</span>        <span class="token builtin">type</span><span class="token operator">=</span>HuggingFacewithChatTemplate<span class="token punctuation">,</span>        abbr<span class="token operator">=</span><span class="token string">'qwen1.5-4b-chat-hf'</span><span class="token punctuation">,</span>        path<span class="token operator">=</span><span class="token string">'Qwen/Qwen1.5-4B-Chat'</span><span class="token punctuation">,</span>        max_out_len<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">,</span>        batch_size<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span>        run_cfg<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>num_gpus<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        stop_words<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'&lt;|im_end|&gt;'</span><span class="token punctuation">,</span> <span class="token string">'&lt;|im_start|&gt;'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token punctuation">)</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œå°†éœ€è¦ä¿®æ”¹çš„å‚æ•°è¯´æ˜ä¸‹ï¼š</p><ul><li>pathï¼šéœ€è¦è®­ç»ƒçš„æ¨¡å‹è·¯å¾„</li><li>max_out_lenï¼šåˆ‡å‰²é•¿åº¦</li><li>batch_sizeï¼šè®­ç»ƒæ‰¹æ¬¡ï¼Œå’Œæˆ‘ä»¬çš„æ˜¾å¡æ˜¾å­˜æœ‰å…³<br>æˆ‘ä»¬éœ€è¦å°†æ¨¡å‹è·¯å¾„ä¿®æ”¹æˆæˆ‘ä»¬æœ¬åœ°æ¨¡å‹è·¯å¾„ï¼Œbatch_sizeåˆ™æ ¹æ®æˆ‘ä»¬è‡ªå·±çš„ç¡¬ä»¶è®¾å¤‡æ¥ã€‚</li></ul><p>ä¿®æ”¹å®Œåï¼Œæˆ‘ä»¬è¿›å…¥Open Compassæ ¹ç›®å½•ä¸‹ï¼Œè¾“å…¥å‘½ä»¤ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># å‘½ä»¤è¡Œç•Œé¢ (CLI)</span>opencompass <span class="token parameter variable">--models</span> hf_qwen1_5_4b_chat <span class="token parameter variable">--datasets</span> demo_gsm8k_chat_gen<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>å‘½ä»¤å‚æ•°è¯´æ˜ï¼š</p><ul><li>hf_qwen1_5_4b_chatï¼šå¯¹åº”æˆ‘ä»¬ä¿®æ”¹çš„hf_qwen1_5_4b_chat.pyåå­—</li><li>demo_gsm8k_chat_genï¼šä½¿ç”¨çš„æµ‹è¯„æ•°æ®é›†</li></ul><h3 id="3-2-è‡ªå®šä¹‰æ•°æ®é›†è¯„ä¼°"><a href="#3-2-è‡ªå®šä¹‰æ•°æ®é›†è¯„ä¼°" class="headerlink" title="3.2 è‡ªå®šä¹‰æ•°æ®é›†è¯„ä¼°"></a>3.2 è‡ªå®šä¹‰æ•°æ®é›†è¯„ä¼°</h3><p>å¯¹äºé—®ç­” (qa) ç±»å‹çš„æ•°æ®ï¼Œé»˜è®¤çš„å­—æ®µå¦‚ä¸‹ï¼š</p><ul><li>question : è¡¨ç¤ºé—®ç­”é¢˜çš„é¢˜å¹² </li><li>answer : è¡¨ç¤ºé—®ç­”é¢˜çš„æ­£ç¡®ç­”æ¡ˆã€‚å¯ç¼ºå¤±ï¼Œè¡¨ç¤ºè¯¥æ•°æ®é›†æ— æ­£ç¡®ç­”æ¡ˆã€‚<br>å¯¹äºéé»˜è®¤å­—æ®µï¼Œæˆ‘ä»¬éƒ½ä¼šè¿›è¡Œè¯»å…¥ï¼Œä½†é»˜è®¤ä¸ä¼šä½¿ç”¨ã€‚å¦‚éœ€ä½¿ç”¨ï¼Œåˆ™éœ€è¦åœ¨ <code>.meta.json</code> æ–‡ä»¶ä¸­æŒ‡å®šã€‚<br><code>.jsonl</code> æ ¼å¼æ ·ä¾‹å¦‚ä¸‹ï¼š</li></ul><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span><span class="token property">"question"</span><span class="token operator">:</span> <span class="token string">"752+361+181+933+235+986="</span><span class="token punctuation">,</span> <span class="token property">"answer"</span><span class="token operator">:</span> <span class="token string">"3448"</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token property">"question"</span><span class="token operator">:</span> <span class="token string">"712+165+223+711="</span><span class="token punctuation">,</span> <span class="token property">"answer"</span><span class="token operator">:</span> <span class="token string">"1811"</span><span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token property">"question"</span><span class="token operator">:</span> <span class="token string">"921+975+888+539="</span><span class="token punctuation">,</span> <span class="token property">"answer"</span><span class="token operator">:</span> <span class="token string">"3323"</span><span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token property">"question"</span><span class="token operator">:</span> <span class="token string">"752+321+388+643+568+982+468+397="</span><span class="token punctuation">,</span> <span class="token property">"answer"</span><span class="token operator">:</span> <span class="token string">"4519"</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘ä»¬éœ€è¦å°†æˆ‘ä»¬çš„æ•°æ®é›†æ ¼å¼è½¬åŒ–ä¸ºä¸Šé¢æ ¼å¼ï¼Œè½¬åŒ–å®Œæˆåï¼Œæˆ‘ä»¬ä½¿ç”¨è‡ªå®šä¹‰çš„æ•°æ®é›†éœ€è¦æä¾›å‘½åè¡Œåˆ—è¡¨æ¥è°ƒç”¨ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">python run.py <span class="token punctuation">\</span>    <span class="token parameter variable">--models</span> hf_llama2_7b <span class="token punctuation">\</span>    --custom-dataset-path xxx/test_qa.jsonl <span class="token punctuation">\</span>    --custom-dataset-data-type qa <span class="token punctuation">\</span>    --custom-dataset-infer-method gen<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨ç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œ<code>--custom-dataset-data-type</code>&nbsp;å’Œ&nbsp;<code>--custom-dataset-infer-method</code>&nbsp;å¯ä»¥çœç•¥ï¼ŒOpenCompass ä¼šæ ¹æ®ä»¥ä¸‹é€»è¾‘è¿›è¡Œè®¾ç½®ï¼š</p><ul><li>å¦‚æœä»æ•°æ®é›†æ–‡ä»¶ä¸­å¯ä»¥è§£æå‡ºé€‰é¡¹ï¼Œå¦‚&nbsp;<code>A</code>,&nbsp;<code>B</code>,&nbsp;<code>C</code>&nbsp;ç­‰ï¼Œåˆ™è®¤å®šè¯¥æ•°æ®é›†ä¸º&nbsp;<code>mcq</code>ï¼Œå¦åˆ™è®¤å®šä¸º&nbsp;<code>qa</code>ã€‚</li><li>é»˜è®¤&nbsp;<code>infer_method</code>&nbsp;ä¸º&nbsp;<code>gen</code>ã€‚</li></ul><p><strong>æ›´å¤šå®ç”¨æ–‡ç« å’ŒAIå¤§æ¨¡å‹åº”ç”¨å¼€å‘æ–‡ç« æ¬¢è¿åˆ°æˆ‘ä¸ªäººåšå®¢æ¥è§‚çœ‹ï¼š</strong><a href="https://blog.csdn.net/etrospect/article/details/blog.ismoyu.cn">å¢¨å®‡Logic</a></p>]]></content>
      
      
      <categories>
          
          <category> AIå¤§æ¨¡å‹åº”ç”¨å¼€å‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Markdown </tag>
            
            <tag> Python </tag>
            
            <tag> vllm </tag>
            
            <tag> PyTorch </tag>
            
            <tag> OpenCompass </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€AIå¤§æ¨¡å‹åº”ç”¨å­¦ä¹ ç¬”è®°ã€‘åŸºäºllama.cppçš„æ¨¡å‹è½¬æ¢ä¸ºGGUFæ ¼å¼+æœ¬åœ°ollamaéƒ¨ç½²å’Œopen-webuiéƒ¨ç½²</title>
      <link href="/ai-da-mo-xing-ying-yong-xue-xi-bi-ji-ji-yu-llama.cpp-de-mo-xing-zhuan-huan-wei-gguf-ge-shi-ben-di-ollama-bu-shu-he-open-webui-bu-shu/"/>
      <url>/ai-da-mo-xing-ying-yong-xue-xi-bi-ji-ji-yu-llama.cpp-de-mo-xing-zhuan-huan-wei-gguf-ge-shi-ben-di-ollama-bu-shu-he-open-webui-bu-shu/</url>
      
        <content type="html"><![CDATA[<p>ä½¿ç”¨ç¯å¢ƒ</p><ul><li>è½¯ä»¶ç¯å¢ƒï¼šWindows11 + WSL2-Linux-Ubuntu22.04å­ç³»ç»Ÿ</li><li>ç¡¬ä»¶ç¯å¢ƒï¼šGeForce RTX 4060 Ti 16GB</li></ul><h2 id="ä¸€ã€ä½¿ç”¨llama-cppæ¡†æ¶è¿›è¡Œæ¨¡å‹è½¬æ¢"><a href="#ä¸€ã€ä½¿ç”¨llama-cppæ¡†æ¶è¿›è¡Œæ¨¡å‹è½¬æ¢" class="headerlink" title="ä¸€ã€ä½¿ç”¨llama.cppæ¡†æ¶è¿›è¡Œæ¨¡å‹è½¬æ¢"></a>ä¸€ã€ä½¿ç”¨llama.cppæ¡†æ¶è¿›è¡Œæ¨¡å‹è½¬æ¢</h2><p>ä½¿ç”¨llama.cppæ¡†æ¶è¿›è¡Œæ¨¡å‹è½¬æ¢å°† huggingface è½¬æ¢ä¸º GGUF æ¨¡å‹</p><h3 id="1-1-åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ"><a href="#1-1-åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ" class="headerlink" title="1.1 åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ"></a>1.1 åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ</h3><p>æˆ‘ä»¬æ–°å»ºä¸€ä¸ªåå«llama.cppçš„pythonè™šæ‹Ÿç¯å¢ƒ</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ</span>conda create <span class="token parameter variable">-n</span> llama.cpp <span class="token assign-left variable">python</span><span class="token operator">=</span><span class="token number">3.10</span> <span class="token parameter variable">-y</span><span class="token comment"># åˆ‡æ¢ç¯å¢ƒ</span>conda activate llama.cpp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="1-2-ä¸‹è½½-llama-cppä»“åº“"><a href="#1-2-ä¸‹è½½-llama-cppä»“åº“" class="headerlink" title="1.2 ä¸‹è½½ llama. cppä»“åº“"></a>1.2 ä¸‹è½½ llama. cppä»“åº“</h3><p>åœ¨llama.cppè™šæ‹Ÿç¯å¢ƒä¸‹</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># å…‹éš†ä»“åº“åˆ°æœ¬åœ°</span><span class="token function">git</span> clone https://github.com/ggerganov/llama.cpp.git<span class="token comment"># å®‰è£…ä¾èµ–</span>pip <span class="token function">install</span> <span class="token parameter variable">-r</span> llama.cpp/requirements.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="1-3-è½¬æ¢æ¨¡å‹"><a href="#1-3-è½¬æ¢æ¨¡å‹" class="headerlink" title="1.3 è½¬æ¢æ¨¡å‹"></a>1.3 è½¬æ¢æ¨¡å‹</h3><p>æ‰§è¡Œä¸‹åˆ—å‘½ä»¤ï¼Œå…¶ä¸­<code>/home/moyuai/moyuai/llm/Qwen/Qwen1-5-4B-Chat-train</code>ä¸ºè‡ªå·±æœ¬åœ°çš„æ¨¡å‹è·¯å¾„ï¼Œ<code>Qwen1-5-4B-Chat-train-gguf.gguf</code>æ˜¯æˆ‘ä»¬è½¬æ¢åè®¾ç½®çš„æ¨¡å‹åå­—ã€‚</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># ä¸è¿›è¡Œæ¨¡å‹é‡åŒ–ï¼Œä¿ç•™æ¨¡å‹æ•ˆæœ</span>python llama.cpp/convert_hf_to_gguf.py /home/moyuai/moyuai/llm/Qwen/Qwen1-5-4B-Chat-train <span class="token parameter variable">--outtype</span> auto <span class="token parameter variable">--verbose</span> <span class="token parameter variable">--outfile</span> Qwen1-5-4B-Chat-train.ggufpython llama.cpp/convert_hf_to_gguf.py /home/moyuai/moyuai/xtuner_out/Qwen1-5-1-8B-Chat-xtuner-merged-7000 <span class="token parameter variable">--outtype</span> auto <span class="token parameter variable">--verbose</span> <span class="token parameter variable">--outfile</span> Qwen1-5-1-8B-Chat-xtuner-merged-7000.gguf<span class="token comment"># éœ€è¦é‡åŒ–ï¼ˆåŠ é€Ÿæ¨¡å‹ä½†æœ‰æŸå¤±æ•ˆæœï¼‰ï¼Œæ‰§è¡Œä¸‹é¢è„šæœ¬</span>python llama.cpp/convert_hf_to_gguf.py /home/moyuai/moyuai/llm/Qwen/Qwen1-5-4B-Chat-train <span class="token parameter variable">--outtype</span> q8_0 <span class="token parameter variable">--verbose</span> <span class="token parameter variable">--outfile</span> /home/moyuai/moyuai/llm/GGUF/Qwen1-5-4B-Chat-train-q8.gguf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è„šæœ¬å‚æ•°è¯´æ˜ï¼š<br>è¿™é‡Œ<code>--outtype</code>æ˜¯è¾“å‡ºç±»å‹ï¼Œä»£è¡¨å«ä¹‰ï¼š</p><ul><li>q2_kï¼šç‰¹å®šå¼ é‡ï¼ˆTensorï¼‰é‡‡ç”¨è¾ƒé«˜çš„ç²¾åº¦è®¾ç½®ï¼Œè€Œå…¶ä»–çš„åˆ™ä¿æŒåŸºç¡€çº§åˆ«ã€‚ </li><li>q3_k_lã€q3_k_mã€q3_k_sï¼šè¿™äº›å˜ä½“åœ¨ä¸åŒå¼ é‡ä¸Šä½¿ç”¨ä¸åŒçº§åˆ«çš„ç²¾åº¦ï¼Œä»è€Œè¾¾åˆ°æ€§èƒ½å’Œæ•ˆç‡çš„å¹³è¡¡ã€‚ </li><li>q4_0ï¼šè¿™æ˜¯æœ€åˆçš„é‡åŒ–æ–¹æ¡ˆï¼Œä½¿ç”¨ 4 ä½ç²¾åº¦ã€‚ </li><li>q4_1 å’Œ q4_k_mã€q4_k_sï¼šè¿™äº›æä¾›äº†ä¸åŒç¨‹åº¦çš„å‡†ç¡®æ€§å’Œæ¨ç†é€Ÿåº¦ï¼Œé€‚åˆéœ€è¦å¹³è¡¡èµ„æºä½¿ç”¨çš„åœºæ™¯ã€‚ </li><li>q5_0ã€q5_1ã€q5_k_mã€q5_k_sï¼šè¿™äº›ç‰ˆæœ¬åœ¨ä¿è¯æ›´é«˜å‡†ç¡®åº¦çš„åŒæ—¶ï¼Œä¼šä½¿ç”¨æ›´å¤šçš„èµ„æºå¹¶ä¸”æ¨ç†é€Ÿåº¦è¾ƒ æ…¢ã€‚</li><li>q6_k å’Œ q8_0ï¼šè¿™äº›æä¾›äº†æœ€é«˜çš„ç²¾åº¦ï¼Œä½†æ˜¯å› ä¸ºé«˜èµ„æºæ¶ˆè€—å’Œæ…¢é€Ÿåº¦ï¼Œå¯èƒ½ä¸é€‚åˆæ‰€æœ‰ç”¨æˆ·ã€‚</li><li>fp16 å’Œ f32: ä¸é‡åŒ–ï¼Œä¿ç•™åŸå§‹ç²¾åº¦ã€‚</li></ul><p>è¿™é‡Œ<code>--outfile</code>æ˜¯è¾“å‡ºæ–‡ä»¶åå­—å’Œè·¯å¾„ã€‚</p><h2 id="äºŒã€ollamaæœ¬åœ°éƒ¨ç½²è°ƒç”¨æ¨¡å‹"><a href="#äºŒã€ollamaæœ¬åœ°éƒ¨ç½²è°ƒç”¨æ¨¡å‹" class="headerlink" title="äºŒã€ollamaæœ¬åœ°éƒ¨ç½²è°ƒç”¨æ¨¡å‹"></a>äºŒã€ollamaæœ¬åœ°éƒ¨ç½²è°ƒç”¨æ¨¡å‹</h2><h3 id="2-1-å®‰è£…ollama"><a href="#2-1-å®‰è£…ollama" class="headerlink" title="2.1 å®‰è£…ollama"></a>2.1 å®‰è£…ollama</h3><p>æ‰§è¡Œå‘½ä»¤ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-fsSL</span> https://ollama.com/install.sh <span class="token operator">|</span> <span class="token function">sh</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="2-2-å¯åŠ¨ollamaæœåŠ¡"><a href="#2-2-å¯åŠ¨ollamaæœåŠ¡" class="headerlink" title="2.2 å¯åŠ¨ollamaæœåŠ¡"></a>2.2 å¯åŠ¨ollamaæœåŠ¡</h3><p>æ‰§è¡Œå‘½ä»¤ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ollama serve<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="2-3-åˆ›å»ºModelFile"><a href="#2-3-åˆ›å»ºModelFile" class="headerlink" title="2.3 åˆ›å»ºModelFile"></a>2.3 åˆ›å»ºModelFile</h3><p>å¤åˆ¶æ¨¡å‹è·¯å¾„ï¼Œåˆ›å»ºåä¸ºâ€œModelFileâ€çš„metaæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">#GGUFæ–‡ä»¶è·¯å¾„ </span>FROM /home/moyuai/moyuai/llm/ollama-models/Qwen1-5-4B-Chat-train.gguf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="2-4-åˆ›å»ºè‡ªå®šä¹‰æ¨¡å‹"><a href="#2-4-åˆ›å»ºè‡ªå®šä¹‰æ¨¡å‹" class="headerlink" title="2.4 åˆ›å»ºè‡ªå®šä¹‰æ¨¡å‹"></a>2.4 åˆ›å»ºè‡ªå®šä¹‰æ¨¡å‹</h3><p> ä½¿ç”¨ollama createå‘½ä»¤åˆ›å»ºè‡ªå®šä¹‰æ¨¡å‹ï¼Œ<code>Qwen1-5-4B-Chat-train</code>æ˜¯æˆ‘ä»¬å‘½åçš„ollamaæ¨¡å‹åå­—ï¼Œ<code>--file</code>åé¢è·Ÿçš„æ˜¯æˆ‘ä»¬åˆ›å»ºçš„ModeIFileæ–‡ä»¶è·¯å¾„ã€‚</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ollama create Qwen1-5-4B-Chat-train <span class="token parameter variable">--file</span> /home/moyuai/moyuai/ModeIFileollama create Qwen1-5-1-8B-Chat-xtuner-merged-7000 <span class="token parameter variable">--file</span> /home/moyuai/moyuai/ModeIFile<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-5-è¿è¡Œæ¨¡å‹"><a href="#2-5-è¿è¡Œæ¨¡å‹" class="headerlink" title="2.5 è¿è¡Œæ¨¡å‹"></a>2.5 è¿è¡Œæ¨¡å‹</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ollama run Qwen1-5-4B-Chat-train<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å…¶å®è¿™é‡Œè¿è¡Œåï¼Œæˆ‘æœ‰æµ‹è¯•è¿‡æ¨¡å‹æ•ˆæœï¼Œå‘ç°éå¸¸å·®ï¼Œæ‰€ä»¥å°±æ²¡æ”¾æ•ˆæœå›¾ã€‚</p><h2 id="ä¸‰ã€ä½¿ç”¨-Open-WebUI-éƒ¨ç½²æ¨¡å‹"><a href="#ä¸‰ã€ä½¿ç”¨-Open-WebUI-éƒ¨ç½²æ¨¡å‹" class="headerlink" title="ä¸‰ã€ä½¿ç”¨ Open WebUI éƒ¨ç½²æ¨¡å‹"></a>ä¸‰ã€ä½¿ç”¨ Open WebUI éƒ¨ç½²æ¨¡å‹</h2><p>Open WebUI æ˜¯ä¸€ä¸ªå¯æ‰©å±•çš„ã€è‡ªæ‰˜ç®¡çš„ AI ç•Œé¢ï¼Œå¯ä»¥é€‚åº”æ‚¨çš„å·¥ä½œæµç¨‹ï¼ŒåŒæ—¶å®Œå…¨ç¦»çº¿æ“ä½œã€‚<br>Open WebUIä»“åº“ï¼š <a href="https://github.com/open-webui/open-webui">https://github.com/open-webui/open-webui</a><br>Open WebUIæ–‡æ¡£ï¼š <a href="https://docs.openwebui.com/">https://docs.openwebui.com/</a></p><h3 id="3-1-åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ"><a href="#3-1-åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ" class="headerlink" title="3.1 åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ"></a>3.1 åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ</h3><p>æˆ‘ä»¬åœ¨é€‰æ‹©è™šæ‹Ÿç¯å¢ƒæ—¶ï¼Œå¿…é¡»é€‰ç”¨python3.11 ç‰ˆæœ¬ï¼Œå› ä¸ºopenwebuiæœ‰è¦æ±‚ã€‚</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">conda create <span class="token parameter variable">-n</span> open-webui <span class="token assign-left variable">python</span><span class="token operator">=</span><span class="token number">3.11</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="3-2-å®‰è£…æ‰€éœ€ä¾èµ–"><a href="#3-2-å®‰è£…æ‰€éœ€ä¾èµ–" class="headerlink" title="3.2 å®‰è£…æ‰€éœ€ä¾èµ–"></a>3.2 å®‰è£…æ‰€éœ€ä¾èµ–</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">conda activate open-webui pip <span class="token function">install</span> <span class="token parameter variable">-U</span> open-webui torch transformers<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="3-3-è¿è¡Œollama"><a href="#3-3-è¿è¡Œollama" class="headerlink" title="3.3 è¿è¡Œollama"></a>3.3 è¿è¡Œollama</h3><p>ollamaè¿è¡Œåä¼šåœ¨æœ¬åœ°ç«¯å£æš´éœ²ä¸€ä¸ª openai API æœåŠ¡ï¼Œæˆ‘ä»¬åé¢ä½¿ç”¨ open-webui æ¥è¿æ¥å°±å¯ä»¥äº†ã€‚</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ollama serve<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="3-4-å¯åŠ¨open-webui"><a href="#3-4-å¯åŠ¨open-webui" class="headerlink" title="3.4 å¯åŠ¨open-webui"></a>3.4 å¯åŠ¨open-webui</h3><p>è¿è¡Œ open-webui ç”±äº ollama çš„è¿è¡Œå¯¼è‡´åŸç»ˆç«¯é˜»å¡ï¼Œå› æ­¤è¦å¦å¤–å¼€ä¸€ä¸ªæ–°ç»ˆç«¯ ã€‚</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">conda activate open-webui <span class="token builtin class-name">export</span> <span class="token assign-left variable">HF_ENDPOINT</span><span class="token operator">=</span>https://hf-mirror.com  <span class="token comment"># Hugging Face é•œåƒç½‘ç«™</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">ENABLE_OLLAMA_API</span><span class="token operator">=</span>True             <span class="token comment"># è®¿é—®ollamaç«¯å£</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">OPENAI_API_BASE_URL</span><span class="token operator">=</span>http://127.0.0.1:11434/v1 <span class="token comment"># å¯¼å‡ºollamaæœåŠ¡ç«¯å£</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">DEFAULT_MODELS</span><span class="token operator">=</span><span class="token string">"/home/moyuai/moyuai/llm/Qwen/Qwen1___5-4B-Chat"</span>  <span class="token comment"># åŠ è½½é»˜è®¤æ¨¡å‹</span>open-webui serve  <span class="token comment"># å¯åŠ¨æœåŠ¡</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯åŠ¨open-webuiåï¼Œå°±å¯ä»¥åœ¨æµè§ˆå™¨å¼¹å‡ºçš„ç•Œé¢ä¸­ä½¿ç”¨æˆ‘ä»¬è®­ç»ƒçš„å¤§æ¨¡å‹äº†ã€‚</p><h2 id="é—®é¢˜è®°å½•"><a href="#é—®é¢˜è®°å½•" class="headerlink" title="é—®é¢˜è®°å½•"></a>é—®é¢˜è®°å½•</h2><h3 id="1-æ‰§è¡Œ-python-llama-cpp-convert-hf-to-gguf-py-è„šæœ¬æ—¶æŠ¥é”™"><a href="#1-æ‰§è¡Œ-python-llama-cpp-convert-hf-to-gguf-py-è„šæœ¬æ—¶æŠ¥é”™" class="headerlink" title="1.æ‰§è¡Œ python llama.cpp/convert_hf_to_gguf.py è„šæœ¬æ—¶æŠ¥é”™"></a>1.æ‰§è¡Œ <code>python llama.cpp/convert_hf_to_gguf.py</code> è„šæœ¬æ—¶æŠ¥é”™</h3><p>æŠ¥é”™ä¿¡æ¯å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-none"><code class="language-none"># å®Œæ•´å‘½ä»¤python llama.cpp/convert_hf_to_gguf.py /home/moyuai/moyuai/llm/Qwen/Qwen1-5-4B-Chat-train  --outtype f16 --verbose --outfile Qwen1-5-4B-Chat-train-gguf.gguf# æŠ¥é”™ä¿¡æ¯usage: convert_hf_to_gguf.py [-h] [--vocab-only] [--outfile OUTFILE]                             [--outtype {f32,f16,bf16,q8_0,tq1_0,tq2_0,auto}]                             [--bigendian] [--use-temp-file] [--no-lazy]                             [--model-name MODEL_NAME] [--verbose]                             [--split-max-tensors SPLIT_MAX_TENSORS]                             [--split-max-size SPLIT_MAX_SIZE] [--dry-run]                             [--no-tensor-first-split] [--metadata METADATA]                             [--print-supported-models] [--remote] [--mmproj]                             [model]convert_hf_to_gguf.py: error: unrecognized arguments:  --outtype f16<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è§£å†³æ–¹æ³•ï¼šæ˜¯ç”±äºå‘½ä»¤ä¸­â€“outtypeå‘½ä»¤å‰å¤šäº†ä¸€ä¸ªç©ºæ ¼å¯¼è‡´çš„</p><hr><h3 id="2-ollama-serveå¯åŠ¨æŠ¥é”™"><a href="#2-ollama-serveå¯åŠ¨æŠ¥é”™" class="headerlink" title="2. ollama serveå¯åŠ¨æŠ¥é”™"></a>2. ollama serveå¯åŠ¨æŠ¥é”™</h3><pre class="line-numbers language-none"><code class="language-none"># æ‰§è¡Œå‘½ä»¤ollama serve# æŠ¥é”™ä¿¡æ¯Error: listen tcp 127.0.0.1:11434: bind: address already in use<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™ä¸ªé”™è¯¯è¡¨æ˜ Ollama å°è¯•åœ¨&nbsp;<code>127.0.0.1:11434</code>&nbsp;ä¸Šå¯åŠ¨æœåŠ¡æ—¶ï¼Œå‘ç°è¯¥ç«¯å£å·²ç»è¢«å ç”¨ã€‚ç½‘ä¸ŠæŸ¥æ‰¾æœ‰ä¸¤ä¸ªè§£å†³æ–¹æ³•ï¼Œæˆ‘æ˜¯ç”¨çš„åŸå› äºŒè§£å†³çš„ï¼š</p><h4 id="æ–¹æ³•ä¸€"><a href="#æ–¹æ³•ä¸€" class="headerlink" title="æ–¹æ³•ä¸€"></a>æ–¹æ³•ä¸€</h4><h5 id="1-æ£€æŸ¥ç«¯å£å ç”¨"><a href="#1-æ£€æŸ¥ç«¯å£å ç”¨" class="headerlink" title="1.&nbsp;æ£€æŸ¥ç«¯å£å ç”¨"></a>1.&nbsp;<strong>æ£€æŸ¥ç«¯å£å ç”¨</strong></h5><p>é¦–å…ˆï¼Œç¡®è®¤&nbsp;<code>11434</code>&nbsp;ç«¯å£æ˜¯å¦è¢«å…¶ä»–è¿›ç¨‹å ç”¨ã€‚</p><h6 id="Windowsä¸‹æ£€æŸ¥ç«¯å£å ç”¨"><a href="#Windowsä¸‹æ£€æŸ¥ç«¯å£å ç”¨" class="headerlink" title="Windowsä¸‹æ£€æŸ¥ç«¯å£å ç”¨"></a><strong>Windowsä¸‹æ£€æŸ¥ç«¯å£å ç”¨</strong></h6><p>æ‰“å¼€å‘½ä»¤æç¤ºç¬¦ï¼ˆCMDï¼‰æˆ– PowerShellï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">netstat</span> <span class="token parameter variable">-ano</span> <span class="token operator">|</span> findstr :11434<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>å¦‚æœç«¯å£è¢«å ç”¨ï¼Œä¼šæ˜¾ç¤ºç±»ä¼¼ä»¥ä¸‹å†…å®¹ï¼š  <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">TCP    <span class="token number">127.0</span>.0.1:11434    <span class="token number">0.0</span>.0.0:0    LISTENING   <span class="token number">12345</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>  å…¶ä¸­&nbsp;<code>12345</code>&nbsp;æ˜¯å ç”¨è¯¥ç«¯å£çš„è¿›ç¨‹ IDï¼ˆPIDï¼‰ã€‚</li></ul><h6 id="Linux-macOS-ä¸‹æ£€æŸ¥ç«¯å£å ç”¨"><a href="#Linux-macOS-ä¸‹æ£€æŸ¥ç«¯å£å ç”¨" class="headerlink" title="Linux/macOS ä¸‹æ£€æŸ¥ç«¯å£å ç”¨"></a><strong>Linux/macOS ä¸‹æ£€æŸ¥ç«¯å£å ç”¨</strong></h6><p>è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">lsof</span> <span class="token parameter variable">-i</span> :11434<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>å¦‚æœç«¯å£è¢«å ç”¨ï¼Œä¼šæ˜¾ç¤ºç±»ä¼¼ä»¥ä¸‹å†…å®¹ï¼š  <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">COMMAND PID  <span class="token environment constant">USER</span>    FD   TYPE  DEVICE   SIZE/OFF NODE NAMEollama  <span class="token number">172</span>  ollama  3u   IPv4  <span class="token number">4919680</span>  0t0      TCP  localhost:11434 <span class="token punctuation">(</span>LISTEN<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ul><hr><h5 id="2-ç»ˆæ­¢å ç”¨ç«¯å£çš„è¿›ç¨‹"><a href="#2-ç»ˆæ­¢å ç”¨ç«¯å£çš„è¿›ç¨‹" class="headerlink" title="2.&nbsp;ç»ˆæ­¢å ç”¨ç«¯å£çš„è¿›ç¨‹"></a>2.&nbsp;<strong>ç»ˆæ­¢å ç”¨ç«¯å£çš„è¿›ç¨‹</strong></h5><p>å¦‚æœå‘ç°ç«¯å£è¢«å ç”¨ï¼Œå¯ä»¥ç»ˆæ­¢å ç”¨è¯¥ç«¯å£çš„è¿›ç¨‹ã€‚</p><h6 id="Windows-ä¸‹ç»ˆæ­¢è¿›ç¨‹"><a href="#Windows-ä¸‹ç»ˆæ­¢è¿›ç¨‹" class="headerlink" title="Windows ä¸‹ç»ˆæ­¢è¿›ç¨‹"></a><strong>Windows ä¸‹ç»ˆæ­¢è¿›ç¨‹</strong></h6><ol><li>æ‰¾åˆ°å ç”¨ç«¯å£çš„è¿›ç¨‹ IDï¼ˆPIDï¼‰ã€‚</li><li>è¿è¡Œä»¥ä¸‹å‘½ä»¤ç»ˆæ­¢è¿›ç¨‹ï¼š <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">taskkill /PID <span class="token number">12345</span> /F<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre> å…¶ä¸­&nbsp;<code>12345</code>&nbsp;æ˜¯è¿›ç¨‹ IDã€‚</li></ol><h6 id="Linux-macOS-ä¸‹ç»ˆæ­¢è¿›ç¨‹"><a href="#Linux-macOS-ä¸‹ç»ˆæ­¢è¿›ç¨‹" class="headerlink" title="Linux/macOS ä¸‹ç»ˆæ­¢è¿›ç¨‹"></a><strong>Linux/macOS ä¸‹ç»ˆæ­¢è¿›ç¨‹</strong></h6><ol><li>æ‰¾åˆ°å ç”¨ç«¯å£çš„è¿›ç¨‹ IDï¼ˆPIDï¼‰ã€‚</li><li>è¿è¡Œä»¥ä¸‹å‘½ä»¤ç»ˆæ­¢è¿›ç¨‹ï¼š <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">kill</span> <span class="token parameter variable">-9</span> <span class="token number">172</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre> å…¶ä¸­&nbsp;<code>12345</code>&nbsp;æ˜¯è¿›ç¨‹ IDã€‚</li></ol><hr><h4 id="æ–¹æ³•äºŒ"><a href="#æ–¹æ³•äºŒ" class="headerlink" title="æ–¹æ³•äºŒ"></a>æ–¹æ³•äºŒ</h4><p>æ˜¯å› ä¸ºæ²¡æœ‰é…ç½®ç¯å¢ƒå˜é‡</p><h5 id="1-é…ç½®ç¯å¢ƒå˜é‡"><a href="#1-é…ç½®ç¯å¢ƒå˜é‡" class="headerlink" title="1.  é…ç½®ç¯å¢ƒå˜é‡"></a>1.  é…ç½®ç¯å¢ƒå˜é‡</h5><ol><li>æ‰“å¼€é»˜è®¤å»ºç«‹çš„ollama.serviceæ–‡ä»¶</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">vim</span> /etc/systemd/system/ollama.service<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="2"><li>çœ‹åˆ°é»˜è®¤çš„ä¸€äº›è®¾ç½®</li></ol><pre class="line-numbers language-cobol" data-language="cobol"><code class="language-cobol">[<span class="token keyword">Unit</span>]Description<span class="token operator">=</span>Ollama Service<span class="token keyword">After</span><span class="token operator">=</span>network-online<span class="token punctuation">.</span>target [Service]ExecStart<span class="token operator">=</span><span class="token operator">/</span>usr<span class="token operator">/</span><span class="token keyword">local</span><span class="token operator">/</span>bin<span class="token operator">/</span>ollama serveUser<span class="token operator">=</span>ollama<span class="token keyword">Group</span><span class="token operator">=</span>ollamaRestart<span class="token operator">=</span>alwaysRestartSec<span class="token operator">=</span><span class="token number">3</span><span class="token keyword">Environment</span><span class="token operator">=</span><span class="token string">"PATH=/data/1-software/1-setup/1-miniconda/bin:/data/1-software/1-setup/1-miniconda/condabin:/data/1-software/1-setup/1-miniconda/bin:/usr/bin:/usr/local/bin:/usr/local/cuda/bin:/usr/bin/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin"</span>  [Install]WantedBy<span class="token operator">=</span><span class="token keyword">default</span><span class="token punctuation">.</span>target<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="3"><li>åœ¨&nbsp;[Service]ä¸‹é¢å¢åŠ ç¯å¢ƒé…ç½®å‚æ•°</li></ol><pre class="line-numbers language-cobol" data-language="cobol"><code class="language-cobol">[<span class="token keyword">Unit</span>]Description<span class="token operator">=</span>Ollama Service<span class="token keyword">After</span><span class="token operator">=</span>network-online<span class="token punctuation">.</span>target [Service]ExecStart<span class="token operator">=</span><span class="token operator">/</span>usr<span class="token operator">/</span><span class="token keyword">local</span><span class="token operator">/</span>bin<span class="token operator">/</span>ollama serveUser<span class="token operator">=</span>ollama<span class="token keyword">Group</span><span class="token operator">=</span>ollamaRestart<span class="token operator">=</span>alwaysRestartSec<span class="token operator">=</span><span class="token number">3</span><span class="token keyword">Environment</span><span class="token operator">=</span><span class="token string">"PATH=/data/1-software/1-setup/1-miniconda/bin:/data/1-software/1-setup/1-miniconda/condabin:/data/1-software/1-setup/1-miniconda/bin:/usr/bin:/usr/local/bin:/usr/local/cuda/bin:/usr/bin/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin"</span>  <span class="token keyword">Environment</span><span class="token operator">=</span><span class="token string">"OLLAMA_MODELS=/home/moyuai/moyuai/llm/ollama-models"</span><span class="token keyword">Environment</span><span class="token operator">=</span><span class="token string">"OLLAMA_HOST=0.0.0.0:11435"</span><span class="token keyword">Environment</span><span class="token operator">=</span><span class="token string">"OLLAMA_KEEP_ALIVE=24h"</span><span class="token keyword">Environment</span><span class="token operator">=</span><span class="token string">"OLLAMA_NUM_PARALLEL=100"</span><span class="token keyword">Environment</span><span class="token operator">=</span><span class="token string">"OLLAMA_MAX_LOADED_MODELS=4"</span><span class="token keyword">Environment</span><span class="token operator">=</span><span class="token string">"OLLAMA_SCHED_SPREAD=1"</span><span class="token keyword">Environment</span><span class="token operator">=</span><span class="token string">"OLLAMA_FLASH_ATTENTION=1"</span><span class="token keyword">Environment</span><span class="token operator">=</span><span class="token string">"OLLAMA_DEBUG=1"</span><span class="token keyword">Environment</span><span class="token operator">=</span><span class="token string">"OLLAMA_ACCELERATE=1"</span> [Install]WantedBy<span class="token operator">=</span><span class="token keyword">default</span><span class="token punctuation">.</span>target<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="4"><li>æŒ‰escï¼Œè¾“å…¥â€œ:wqâ€ï¼Œé€€å‡ºæ–‡ä»¶ç¼–è¾‘</li></ol><h5 id="2-é‡æ–°åŠ è½½systemdé…ç½®å¹¶é‡å¯æœåŠ¡"><a href="#2-é‡æ–°åŠ è½½systemdé…ç½®å¹¶é‡å¯æœåŠ¡" class="headerlink" title="2. é‡æ–°åŠ è½½systemdé…ç½®å¹¶é‡å¯æœåŠ¡"></a>2. é‡æ–°åŠ è½½systemdé…ç½®å¹¶é‡å¯æœåŠ¡</h5><ol><li>é‡æ–°åŠ è½½systemd</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> systemctl daemon-reload<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="2"><li>å¯åŠ¨æœåŠ¡</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> systemctl start ollama<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="3"><li>æŸ¥çœ‹çŠ¶æ€</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> systemctl status ollama<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="4"><li>è‹¥æƒ³åœæ­¢æœåŠ¡</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> systemctl stop ollama<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="5"><li>è®¾ç½®å¼€æœºè‡ªå¯åŠ¨</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> ollama<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="6"><li>è‹¥æƒ³åœæ­¢å¼€æœºè‡ªå¯åŠ¨</li></ol><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> systemctl disable ollama<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æœ€åé‡æ–°æ‰§è¡Œ<code>ollama serve</code>å‘½ä»¤å°±æˆåŠŸè§£å†³ã€‚</p><hr><p><strong>æ›´å¤šå®ç”¨æ–‡ç« å’ŒAIå¤§æ¨¡å‹åº”ç”¨å¼€å‘æ–‡ç« æ¬¢è¿åˆ°æˆ‘ä¸ªäººåšå®¢æ¥è§‚çœ‹ï¼š</strong><a href="https://blog.csdn.net/etrospect/article/details/blog.ismoyu.cn">å¢¨å®‡Logic</a></p>]]></content>
      
      
      <categories>
          
          <category> AIå¤§æ¨¡å‹åº”ç”¨å¼€å‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ollama </tag>
            
            <tag> Python </tag>
            
            <tag> Linux </tag>
            
            <tag> PyTorch </tag>
            
            <tag> huggingface </tag>
            
            <tag> open-webui </tag>
            
            <tag> llama_cpp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€AIå¤§æ¨¡å‹åº”ç”¨å­¦ä¹ ç¬”è®°ã€‘åŸºäºLLaMA-Factoryçš„LlaMa3.2-1bæ¨¡å‹å¾®è°ƒå¼±æ™ºå§æ•°æ®é›†å…¨æµç¨‹</title>
      <link href="/ai-da-mo-xing-ying-yong-xue-xi-bi-ji-ji-yu-llama-factory-de-llama3.2-1b-mo-xing-wei-diao-ruo-zhi-ba-shu-ju-ji-quan-liu-cheng/"/>
      <url>/ai-da-mo-xing-ying-yong-xue-xi-bi-ji-ji-yu-llama-factory-de-llama3.2-1b-mo-xing-wei-diao-ruo-zhi-ba-shu-ju-ji-quan-liu-cheng/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€ã€é¡¹ç›®èƒŒæ™¯"><a href="#ä¸€ã€é¡¹ç›®èƒŒæ™¯" class="headerlink" title="ä¸€ã€é¡¹ç›®èƒŒæ™¯"></a>ä¸€ã€é¡¹ç›®èƒŒæ™¯</h2><p>åœ¨å¤§æ¨¡å‹åº”ç”¨å­¦ä¹ ä¸­ï¼Œå­¦ä¹ åˆ°LLaMA-Factoryæ¨¡å‹å¾®è°ƒæ¡†æ¶ï¼Œäºæ˜¯æ‰“ç®—è‡ªå·±æ¥æ ¹æ®LLaMA-Factoryæ¡†æ¶å®Œæ•´çš„å¾®è°ƒä¸€éå¤§æ¨¡å‹æ¥å½“ä½œç»ƒä¹ ï¼Œé€‰æ‹©åŸºåœ°æ¨¡å‹å’Œæ•°æ®é›†åˆ†åˆ«æ˜¯ Unichat-llama3.2-Chinese-1B å’Œ å¼±æ™ºå§æ•°æ®é›†ï¼Œé€‰æ‹©çš„åŸå› ä¸€ä¸ªæ˜¯ä¸ªäººç»ƒä¹ ç”¨ï¼Œæ‰€ä»¥é€‰æ‹©ä¸€ä¸ªæ¨¡å‹å‚æ•°é‡è¾ƒå°çš„ï¼Œå¦ä¸€ä¸ªå°±æ˜¯åŸç‰ˆæ¨¡å‹å¯¹ä¸­æ–‡çš„æ”¯æŒæ¯”è¾ƒå¼±ï¼Œä½¿ç”¨é€‰æ‹©äº†ä¸€ä¸ªä¸­æ–‡ç‰ˆæœ¬ï¼Œæ•°æ®é›†åˆ™é€‰æ‹©éå¸¸æœ‰ç‰¹è‰²çš„ï¼Œè®­ç»ƒåèƒ½å¤Ÿå¾ˆå¥½çš„å‡ºæ•ˆæœçš„æ•°æ®é›†ã€‚</p><p>æ•´ä¸ªæµç¨‹åŒ…æ‹¬ï¼šæ¨¡å‹ä¸‹è½½ã€æ•°æ®é›†æ•´ç†ã€LoRAæ¨¡å¼è®­ç»ƒã€æ¨¡å‹è¯„ä¼°ã€æ¨¡å‹é‡åŒ–</p><h2 id="äºŒã€ç¯å¢ƒå‡†å¤‡"><a href="#äºŒã€ç¯å¢ƒå‡†å¤‡" class="headerlink" title="äºŒã€ç¯å¢ƒå‡†å¤‡"></a>äºŒã€ç¯å¢ƒå‡†å¤‡</h2><p>é€‰æ‹©çš„æ˜¯AutoDLç®—åŠ›äº‘å¹³å° ï¼ŒGPUå’Œè½¯ä»¶ç¯å¢ƒé€‰æ‹©å¦‚ä¸‹</p><p><strong>GPU</strong>ï¼š RTX 3090(24GB)  + è½¯ä»¶ç¯å¢ƒï¼šPyTorch 2.3.0+Python 3.12(ubuntu22.04)+CUDA 12.1</p><p>æœ¬åœ°ä½¿ç”¨è½¯ä»¶vs codeè¿›è¡Œè¿œç¨‹æœåŠ¡å™¨è¿æ¥</p><h2 id="ä¸‰ã€å‰æœŸå‡†å¤‡"><a href="#ä¸‰ã€å‰æœŸå‡†å¤‡" class="headerlink" title="ä¸‰ã€å‰æœŸå‡†å¤‡"></a>ä¸‰ã€å‰æœŸå‡†å¤‡</h2><p>é¦–å…ˆå‡†å¤‡ä¸‹è½½æ¨¡å‹å’Œæ•°æ®é›†ï¼Œè¿™é‡Œä¸‹è½½æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯åˆ°æˆ‘ä»¬ç§Ÿçš„æœåŠ¡å™¨ç›´æ¥ä¸‹è½½ï¼Œä¸€ç§æ˜¯æˆ‘ä»¬æœ¬åœ°ä¸‹è½½ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æœ¬åœ°ä¸‹è½½ï¼Œå› ä¸ºä¸‹è½½çš„æ•°æ®é›†è¿˜éœ€è¦è¿›è¡Œæ•°æ®å¤„ç†ï¼Œæœ¬åœ°å¤„ç†æ¯”è¾ƒæ–¹ä¾¿ï¼Œæ•°æ®å‡†å¤‡å®Œæˆåä¸Šä¼ åˆ°æœåŠ¡å™¨å³å¯ã€‚</p><h3 id="3-1-æ¨¡å‹ä¸‹è½½"><a href="#3-1-æ¨¡å‹ä¸‹è½½" class="headerlink" title="3.1 æ¨¡å‹ä¸‹è½½"></a>3.1 æ¨¡å‹ä¸‹è½½</h3><p>é€šè¿‡é­”å¡”ç¤¾åŒºSDKæ¥ä¸‹è½½</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># å®‰è£…ModelScope</span>pip <span class="token function">install</span> modelscope<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># ä¸‹è½½æ¨¡å‹Unichat-llama3.2-Chinese-1Bæ¨¡å‹</span><span class="token keyword">from</span> modelscope <span class="token keyword">import</span> snapshot_downloadmodel_dir <span class="token operator">=</span> snapshot_download<span class="token punctuation">(</span>    <span class="token string">'UnicomAI/Unichat-llama3.2-Chinese-1B'</span><span class="token punctuation">,</span>  <span class="token comment"># æ¨¡å‹åç§°</span>    cache_dir<span class="token operator">=</span><span class="token string">r"E:\xuexiziliao\AiProject\LLaMA-Factory-learn\llm"</span>  <span class="token comment"># æ¨¡å‹å­˜æ”¾è·¯å¾„</span>    <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸‹è½½å®Œæˆåï¼Œæ¨¡å‹ç›®å½•æ–‡ä»¶å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://pic1.imgdb.cn/item/680b4b7458cb8da5c8cb7203.png" alt="Unichat-llama3.2-Chinese-1Bæ¨¡å‹ç›®å½•"></p><h3 id="3-2-æ•°æ®é›†ä¸‹è½½"><a href="#3-2-æ•°æ®é›†ä¸‹è½½" class="headerlink" title="3.2 æ•°æ®é›†ä¸‹è½½"></a>3.2 æ•°æ®é›†ä¸‹è½½</h3><p>åˆ°é­”å¡”ç¤¾åŒºä¸­çš„æ•°æ®é›†ä¸­æœç´¢<strong>ruozhiba</strong>ï¼Œç„¶åæˆ‘ä»¬æ‰¾åˆ°<strong>w10442005/ruozhiba_qa</strong>æ•°æ®é›†ï¼Œä¸‹è½½ä»£ç å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># ä¸‹è½½æ•°æ®é›†å‰éœ€è¦å®‰è£…ä¸‹é¢ä¾èµ–</span>pip <span class="token function">install</span> numpypip <span class="token function">install</span> datasetspip <span class="token function">install</span> addict<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># æ•°æ®é›†ä¸‹è½½</span><span class="token keyword">from</span> modelscope<span class="token punctuation">.</span>msdatasets <span class="token keyword">import</span> MsDatasetds <span class="token operator">=</span>  MsDataset<span class="token punctuation">.</span>load<span class="token punctuation">(</span>    <span class="token string">'w10442005/ruozhiba_qa'</span><span class="token punctuation">,</span>  <span class="token comment"># æ•°æ®é›†åç§°</span>    subset_name<span class="token operator">=</span><span class="token string">'default'</span><span class="token punctuation">,</span>   <span class="token comment"># æ•°æ®é›†å­é›†åç§°</span>    split<span class="token operator">=</span><span class="token string">'train'</span> <span class="token punctuation">,</span>  <span class="token comment"># æ•°æ®é›†åˆ’åˆ†  </span>    data_dir<span class="token operator">=</span><span class="token string">r"E:\xuexiziliao\AiProject\LLaMA-Factory-learn\data"</span><span class="token punctuation">,</span>  <span class="token comment"># æ•°æ®é›†å­˜æ”¾è·¯å¾„</span>    <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦‚æœä¸‹è½½ä¸æˆåŠŸåˆ™æ¢ä¸ºgit clone æ¥ä¸‹è½½ï¼Œæˆ–è€…ç›´æ¥åˆ°é­”å¡”ç¤¾åŒº<code>ruozhiba_qa</code>æ•°æ®é›†æ–‡ä»¶ä¸­ç›´æ¥ä¸‹è½½<code>ruozhiba_qaswift.json</code>æ–‡ä»¶ã€‚</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone https://www.modelscope.cn/datasets/w10442005/ruozhiba_qa.git<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ä¸‹è½½å®Œæˆåæˆ‘ä»¬å¾—åˆ°çš„æ•°æ®é›†ç›®å½•å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://pic1.imgdb.cn/item/680b4c7e58cb8da5c8cb728d.png" alt="ruozhiba_qaæ•°æ®é›†ç›®å½•"></p><p>æˆ‘ä»¬è¦ç”¨åˆ°çš„å°±æ˜¯å…¶ä¸­<code>ruozhiba_qaswift.json</code>æ•°æ®é›†æ–‡ä»¶ï¼Œé‡Œé¢å†…å®¹å¦‚ä¸‹ï¼š</p><p><img src="https://pic1.imgdb.cn/item/680b4c7e58cb8da5c8cb728e.png" alt="ruozhiba_qaswift.jsonæ–‡ä»¶å†…å®¹"></p><h3 id="3-3-æ•°æ®æ•´ç†è½¬æ¢"><a href="#3-3-æ•°æ®æ•´ç†è½¬æ¢" class="headerlink" title="3.3 æ•°æ®æ•´ç†è½¬æ¢"></a>3.3 æ•°æ®æ•´ç†è½¬æ¢</h3><p>æ•°æ®é›†æ–‡ä»¶æˆ‘ä»¬æ‹¿åˆ°è¿˜ä¸èƒ½å¤Ÿç›´æ¥ä½¿ç”¨ï¼Œå› ä¸º<strong>LLaMA-Factory</strong>å¯¹æ•°æ®é›†çš„æ ¼å¼è¦æ±‚æ˜¯å›ºå®šçš„ï¼Œéœ€è¦å°†é‡Œé¢çš„å†…å®¹æ ¼å¼æ”¹ä¸º<code>identity.json</code>æ–‡ä»¶æ‰€ç¤ºæ ¼å¼ã€‚å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://pic1.imgdb.cn/item/680b989858cb8da5c8cd12fe.png" alt="identity.jsonæ–‡ä»¶æ ¼å¼"></p><p>æˆ‘ä»¬åªéœ€è¦å°†<code>ruozhiba_qaswift.json</code> ä¸­çš„<code>query</code>å’Œ<code>response</code>æ›¿æ¢ä¸º<code>identity.json</code>ä¸­çš„<code>instruction</code>å’Œ<code>output</code>,å¹¶æ·»åŠ ä¸€ä¸ª<code>input</code>å€¼å³å¯ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬ç¼–å†™ä¸€ä¸ªpythonç¨‹åºæ¥å¸®æˆ‘ä»¬è¿›è¡Œæ•°æ®æ ¼å¼æ•´ç†ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> json<span class="token comment"># è¯»å–ruozhiba_qaswift.jsonæ–‡ä»¶</span><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">r"\data\ruozhiba_qaswift.json"</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>    data <span class="token operator">=</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token comment"># è½¬æ¢æ ¼å¼</span>converted_data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">for</span> item <span class="token keyword">in</span> data<span class="token punctuation">:</span>    converted_item <span class="token operator">=</span> <span class="token punctuation">{</span>        <span class="token string">"instruction"</span><span class="token punctuation">:</span> item<span class="token punctuation">[</span><span class="token string">"query"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token string">"input"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>        <span class="token comment"># æ–°å¢inputå­—æ®µå¹¶è®¾ä¸ºç©ºå­—ç¬¦ä¸²</span>        <span class="token string">"output"</span><span class="token punctuation">:</span> item<span class="token punctuation">[</span><span class="token string">"response"</span><span class="token punctuation">]</span>    <span class="token punctuation">}</span>    converted_data<span class="token punctuation">.</span>append<span class="token punctuation">(</span>converted_item<span class="token punctuation">)</span><span class="token comment"># ä¿å­˜ä¸ºæ–°çš„JSONæ–‡ä»¶</span><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'converted_file.json'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>    json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>converted_data<span class="token punctuation">,</span> f<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> sort_keys<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"è½¬æ¢å®Œæˆï¼è½¬æ¢åçš„æ•°æ®å·²ä¿å­˜ä¸º converted_file.json"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å°†è½¬æ¢åçš„jsonæ–‡ä»¶é‡å‘½åä¸º<code>ruozhiba_qaswift.json</code></p><p>åˆ°æ­¤æˆ‘ä»¬çš„æ¨¡å‹å’Œæ•°æ®é›†å°±å·²ç»å‡†å¤‡å¥½äº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯è¿æ¥æœåŠ¡å™¨å‡†å¤‡å¼€å§‹è®­ç»ƒ</p><h2 id="å››ã€è¿æ¥-AutoDL-æœåŠ¡å™¨"><a href="#å››ã€è¿æ¥-AutoDL-æœåŠ¡å™¨" class="headerlink" title="å››ã€è¿æ¥ AutoDL æœåŠ¡å™¨"></a>å››ã€è¿æ¥ AutoDL æœåŠ¡å™¨</h2><p>åˆ°<a href="https://www.autodl.com/market/list">AutoDL</a>ç®—åŠ›å¸‚åœºç§Ÿä¸€å°æœºå™¨,é€‰æ‹©ç¯å¢ƒå¦‚ä¸‹ï¼š</p><p><img src="https://pic1.imgdb.cn/item/680b6ef358cb8da5c8cc75fe.png" alt="æœåŠ¡å™¨è½¯ä»¶ç¯å¢ƒé€‰æ‹©"></p><p>é€‰æ‹©å¥½åå¼€æœºï¼Œè¿™æ—¶æˆ‘ä»¬ä¼šå¾—åˆ°è¿œç¨‹æœåŠ¡å™¨çš„sshç™»å…¥æŒ‡ä»¤å’Œå¯†ç ï¼Œæˆ‘ä»¬é€šè¿‡vs codeæ¥è¿æ¥è¿œç¨‹æœåŠ¡å™¨</p><p><img src="https://pic1.imgdb.cn/item/680b6ef358cb8da5c8cc75fd.png" alt="æœåŠ¡å™¨sshç™»å…¥æŒ‡ä»¤å’Œå¯†ç "></p><p><img src="https://pic1.imgdb.cn/item/680b6ef358cb8da5c8cc75ff.png" alt="é€šè¿‡vs codeæ¥è¿æ¥æœåŠ¡å™¨"></p><p>æœåŠ¡å™¨è¿æ¥å®Œæˆåï¼Œæˆ‘ä»¬è¿›å…¥åˆ°æœåŠ¡å™¨<code>root</code>ç›®å½•ä¸‹,<code>root</code>ç›®å½•å†…å®¹å¦‚ä¸‹ï¼š</p><p><img src="https://pic1.imgdb.cn/item/680b702358cb8da5c8cc77f5.png" alt="æœåŠ¡å™¨rootç›®å½•å†…å®¹"></p><h2 id="äº”ã€å®‰è£…LLaMA-Factory"><a href="#äº”ã€å®‰è£…LLaMA-Factory" class="headerlink" title="äº”ã€å®‰è£…LLaMA-Factory"></a>äº”ã€å®‰è£…LLaMA-Factory</h2><p>ä¸‹é¢æˆ‘ä»¬å®‰è£…<code>LLaMA-Factory</code>,æˆ‘ä»¬å®‰è£…åœ¨rootç›®å½•ä¸‹çš„<code>autodl-tmp</code>ï¼Œè¿™æ˜¯æœåŠ¡å™¨æ•°æ®ç›˜</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># è¿›å…¥autodl-tmpç›®å½•</span><span class="token builtin class-name">cd</span> autodl-tmp/<span class="token comment"># AutoDL å­¦æœ¯åŠ é€Ÿ</span><span class="token builtin class-name">source</span> /etc/network_turbo<span class="token comment"># ä¸‹è½½LLaMA-Factoryä»“åº“</span><span class="token function">git</span> clone https://github.com/hiyouga/LLaMA-Factory.git<span class="token comment"># å®‰è£…auto-gptqé‡åŒ–åŒ…ï¼Œè¦å…ˆäºvllmå®‰è£…ï¼Œä¸”auto-gptqé‡åŒ–åŒ…éœ€è¦ PyTorch2.2.1+cuda121 ç‰ˆæœ¬</span>pip <span class="token function">install</span> auto-gptq<span class="token comment"># è¿›å…¥LLaMA-Factoryæ–‡ä»¶å¤¹</span><span class="token builtin class-name">cd</span> LLaMA-Factory<span class="token comment"># å®‰è£…vllm</span>pip <span class="token function">install</span> <span class="token parameter variable">-e</span> .<span class="token punctuation">[</span><span class="token string">"vllm"</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸‹è½½å®Œæˆå<code>LLaMA-Factory</code>ç›®å½•å†…å®¹å¦‚ä¸‹ï¼š</p><p><img src="https://pic1.imgdb.cn/item/680b7b0658cb8da5c8ccbcc9.png" alt="LLaMA-Factoryç›®å½•å†…å®¹"></p><p>å…¨éƒ¨å®‰è£…å®Œæˆåï¼Œæˆ‘ä»¬å°†å‡†å¤‡å¥½çš„æ¨¡å‹å’Œæ•°æ®é›†ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œå°†<code>ruozhiba_qaswift.json</code>æ–‡ä»¶æ”¾åˆ°<code>LLaMA-Factory</code>ç›®å½•çš„<code>data</code>ç›®å½•ä¸‹ï¼Œå¦‚å›¾ä½ç½®ï¼š</p><p><img src="https://pic1.imgdb.cn/item/680b7b0658cb8da5c8ccbcca.png" alt="ruozhiba_qaswift.jsonæ–‡ä»¶ä½ç½®"></p><p>ç„¶åæ‰“å¼€<code>LLaMA-Factory</code>ç›®å½•çš„<code>data</code>ç›®å½•ä¸‹çš„<code>dataset_info.json</code>æ–‡ä»¶ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬é…ç½®æˆ‘ä»¬çš„æ•°æ®é›†ä¿¡æ¯ï¼Œåœ¨æ–‡ä»¶å¼€å§‹éƒ¨åˆ†æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"ruozhiba_qaswift"</span><span class="token operator">:</span> <span class="token punctuation">{</span>  <span class="token property">"file_name"</span><span class="token operator">:</span> <span class="token string">"ruozhiba_qaswift.json"</span><span class="token punctuation">,</span>  <span class="token property">"columns"</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token property">"prompt"</span><span class="token operator">:</span> <span class="token string">"instruction"</span><span class="token punctuation">,</span>    <span class="token property">"query"</span><span class="token operator">:</span> <span class="token string">"input"</span><span class="token punctuation">,</span>    <span class="token property">"response"</span><span class="token operator">:</span> <span class="token string">"output"</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¿®æ”¹åçš„<code>dataset_info.json</code>å†…å®¹å¦‚ä¸‹ï¼š</p><p><img src="https://pic1.imgdb.cn/item/680b7b0658cb8da5c8ccbccb.png" alt="ä¿®æ”¹åçš„dataset_info.jsonå†…å®¹"></p><h2 id="å…­ã€å‡†å¤‡LoARè®­ç»ƒ"><a href="#å…­ã€å‡†å¤‡LoARè®­ç»ƒ" class="headerlink" title="å…­ã€å‡†å¤‡LoARè®­ç»ƒ"></a>å…­ã€å‡†å¤‡LoARè®­ç»ƒ</h2><p>å…¨éƒ¨æ¡ä»¶å‡†å¤‡å®Œæˆåæˆ‘ä»¬å¯åŠ¨Web UI å‡†å¤‡å¼€å§‹æ¨¡å‹è®­ç»ƒã€‚</p><p>è¿›å…¥<code>LLaMA-Factory</code>ç›®å½•ï¼Œæˆ‘ä»¬æ‰§è¡Œå‘½ä»¤å¯åŠ¨Web UIï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> LLaMA-Factory<span class="token comment"># è¿è¡ŒLLaMA-Factoryçš„webui</span>llamafactory-cli webui<span class="token comment"># ä¹Ÿå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼Œè¿™æ ·å¯ä»¥åœ¨åå°è¿è¡Œwebuiï¼Œè€Œä¸ç”¨æ‹…å¿ƒç»ˆç«¯å…³é—­åwebuiä¼šåœæ­¢è¿è¡Œ,è¿™æ¡å‘½ä»¤ä¼šå°†è¾“å‡ºé‡å®šå‘åˆ°webui.logæ–‡ä»¶ä¸­</span><span class="token function">nohup</span> llamafactory-cli webui <span class="token operator">&gt;</span> webui.log <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">&amp;</span><span class="token comment"># å¦‚æœè¦åœæ­¢è¿è¡Œï¼Œä½ éœ€è¦ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥æ‰¾åˆ° nohup è¿è¡Œè„šæœ¬åˆ° PIDï¼Œç„¶åä½¿ç”¨ kill å‘½ä»¤æ¥åˆ é™¤ï¼š</span><span class="token function">ps</span> <span class="token parameter variable">-aux</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"runoob.sh"</span> <span class="token function">kill</span> <span class="token parameter variable">-9</span>  è¿›ç¨‹å·PID<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰§è¡Œå®Œåä¼šè‡ªåŠ¨è·³è½¬åˆ°æµè§ˆå™¨æ‰“å¼€webuiç•Œé¢ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥é…ç½®è®­ç»ƒå‚æ•°</p><h3 id="6-1-æ¨¡å‹å‚æ•°é…ç½®"><a href="#6-1-æ¨¡å‹å‚æ•°é…ç½®" class="headerlink" title="6.1 æ¨¡å‹å‚æ•°é…ç½®"></a>6.1 æ¨¡å‹å‚æ•°é…ç½®</h3><p>å°†ç•Œé¢ä¿®æ”¹ä¸ºä¸­æ–‡ï¼Œè¿™æ¬¡æˆ‘ä»¬éœ€è¦è®¾ç½®å‚æ•°ä¸ºè®­ç»ƒçš„æ¨¡å‹åå­—ï¼Œæ¨¡å‹è·¯å¾„ï¼Œå…¶ä»–ä¿æŒé»˜è®¤</p><p>å…¶ä»–å‚æ•°ï¼š</p><ul><li>å¾®è°ƒæ–¹æ³•é€‰æ‹© lora</li><li>æ£€æŸ¥ç‚¹è·¯å¾„ï¼šè®­ç»ƒæ¨¡å‹æƒé‡ä¿å­˜è·¯å¾„ï¼Œä¸€èˆ¬é»˜è®¤</li><li>æœ€ä¸‹é¢ä¸€æ’å‚æ•°å…ˆé»˜è®¤</li></ul><p>æ¨¡å‹è·¯å¾„ä¸ºæˆ‘ä»¬æœåŠ¡å™¨ä¸Šæ¨¡å‹å­˜æ”¾çš„è·¯å¾„ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="https://pic1.imgdb.cn/item/680b816258cb8da5c8ccd5ff.png" alt="æ¨¡å‹é…ç½®éƒ¨åˆ†"></p><h3 id="6-2-Trainå‚æ•°é…ç½®"><a href="#6-2-Trainå‚æ•°é…ç½®" class="headerlink" title="6.2 Trainå‚æ•°é…ç½®"></a>6.2 Trainå‚æ•°é…ç½®</h3><p>Trainå‚æ•°æœ¬æ¬¡è®¾ç½®å¦‚ä¸‹ï¼š</p><p><img src="https://pic1.imgdb.cn/item/680b844158cb8da5c8cce0c8.png" alt="Trainå‚æ•°é…ç½®éƒ¨åˆ†"></p><p>æœ¬æ¬¡è®­ç»ƒæ‰€é…ç½®å‚æ•°å°±ä¸Šé¢è¿™äº›ï¼Œå…¶ä»–è¿™æ¬¡ä¿æŒé»˜è®¤ã€‚</p><p>æˆ‘ä»¬ç‚¹å‡»å¼€å§‹ï¼Œç­‰å¾…è®­ç»ƒï¼Œæˆ‘ä»¬è¿™æ¬¡è®­ç»ƒè½®æ¬¡è®¾ç½®çš„ä¸º1000ã€‚</p><div class="alert alert-success"><b>æ¨¡å‹ç»§ç»­è®­ç»ƒï¼šæœ‰ä¸¤ç§æ–¹æ³•ï¼Œä¸€ç§æ˜¯å°†æ¨¡å‹å’Œæœ€æ–°ä¿å­˜çš„æƒé‡æ–‡ä»¶åˆå¹¶åè®¾ç½®è®­ç»ƒå‚æ•°ç„¶åç»§ç»­è®­ç»ƒï¼Œå¦ä¸€ç§æ˜¯ä¸åˆå¹¶ç›´æ¥è®¾ç½®è®­ç»ƒå‚æ•°ç„¶åç»§ç»­è®­ç»ƒã€‚</b></div><h3 id="6-3-æ¨¡å‹æ•ˆæœæµ‹è¯•"><a href="#6-3-æ¨¡å‹æ•ˆæœæµ‹è¯•" class="headerlink" title="6.3 æ¨¡å‹æ•ˆæœæµ‹è¯•"></a>6.3 æ¨¡å‹æ•ˆæœæµ‹è¯•</h3><p>è®­ç»ƒå®Œæˆåï¼Œé‡åˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯è®­ç»ƒè¿‡ç¨‹ä¸­losså€¼ä¸€ç›´é™åˆ°éå¸¸ä½ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸ç®¡ï¼Œåªè¦losså€¼ä¸€ç›´åœ¨é™ä½æ²¡æœ‰è¿‡æ‹Ÿåˆå°±è¡Œã€‚</p><p>å½“ç„¶æ¨¡å‹è®­ç»ƒçš„losså¹¶ä¸æ˜¯è¯„ä¼°æ¨¡å‹æ•ˆæœçš„å”¯ä¸€æŒ‡æ ‡ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®å…·ä½“æƒ…å†µæ¥åˆ¤æ–­ä¸€ä¸ªæ¨¡å‹çš„è®­ç»ƒå¥½åã€‚</p><p>è®­ç»ƒè¿‡ç¨‹ä¸­çš„ä¸¤ä¸ªé˜¶æ®µçš„losså€¼è¶‹åŠ¿å¦‚ä¸‹ï¼š</p><center class="half">    <img src="https://pic1.imgdb.cn/item/680c41f358cb8da5c8ce1557.webp" width="500">    <img src="https://pic1.imgdb.cn/item/680c41f358cb8da5c8ce1556.webp" width="500"></center>å¯ä»¥çœ‹åˆ°åœ¨1000è½®ä¹‹åï¼Œlosså€¼å°±ä¸€ç›´é™ä½åˆ°0.5ä»¥ä¸‹ï¼Œåˆ°åé¢å‡ ä¹æ¥è¿‘0ï¼Œè¿™é‡Œæˆ‘ä»¬å–1000è½®å·¦å³ä¿å­˜çš„è®­ç»ƒæƒé‡å’Œæœ€åè½®çš„è®­ç»ƒè®­ç»ƒæƒé‡æ¥åšå¯¹æ¯”ï¼Œçœ‹è°çš„æ•ˆæœæ›´å¥½ã€‚<p>åé¢ç”±äºå®‰è£…<code>auto-gptq</code>åŒ…æ—¶ç¯å¢ƒå‡ºäº†é—®é¢˜ï¼Œåé¢ä¸Šç½‘æŸ¥æ‰¾åŸå› æ—¶ï¼Œæ˜¯å› ä¸ºå®‰è£…<code>auto-gptq</code>åŒ…å¿…é¡»è¦æœ‰æŒ‡å®šPyTorchå’ŒCUDAç‰ˆæœ¬ï¼Œè¦æ±‚çš„ç‰ˆæœ¬ä¸º</p><ul><li>PyTorch  2.1.2</li><li>CUDA  11.8<br>çš„åç»­æ¢äº†ä¸€ä¸ªæœåŠ¡å™¨ï¼Œè½¯ä»¶ç¯å¢ƒé€‰æ‹©å¦‚ä¸‹ï¼š</li></ul><p><img src="https://pic1.imgdb.cn/item/680c41f458cb8da5c8ce1559.png" alt="æ›´æ¢æœåŠ¡å™¨åçš„ç¯å¢ƒé€‰æ‹©"></p><p>è¿™é‡Œæˆ‘ä»¬é‡æ–°å®‰è£…ä¸€ä¸‹<code>LLaMA-Factory</code>ï¼Œè¿™é‡Œå’Œä¹‹å‰å®‰è£…æ­¥éª¤æœ‰ç‚¹ä¸åŒï¼Œå®‰è£…<code>LLaMA-Factory</code>æ‰€éœ€ä¾èµ–å‰ï¼Œéœ€è¦å…ˆå®‰è£…é‡åŒ–åŒ…<code>auto-gptq</code> ã€‚è¿™æ˜¯åç»­æ¨¡å‹é‡åŒ–æ­¥éª¤çš„æ‰€å¿…é¡»çš„ï¼Œè€Œä¸”å®‰è£…<code>vllm</code>åŒ…ä¹‹å‰è¦å…ˆå®‰è£…<code>auto-gptq</code>åŒ…ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦æ¢ç¯å¢ƒçš„åŸå› ã€‚</p><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># è¿›å…¥autodl-tmpç›®å½•</span><span class="token builtin class-name">cd</span> autodl-tmp/<span class="token comment"># AutoDL å­¦æœ¯åŠ é€Ÿ</span><span class="token builtin class-name">source</span> /etc/network_turbo<span class="token comment"># ä¸‹è½½LLaMA-Factoryä»“åº“</span><span class="token function">git</span> clone https://github.com/hiyouga/LLaMA-Factory.git<span class="token comment"># å®‰è£…auto-gptqé‡åŒ–åŒ…</span>pip <span class="token function">install</span> auto-gptq<span class="token comment"># å®‰è£…vllm</span>pip <span class="token function">install</span> <span class="token parameter variable">-e</span> .<span class="token punctuation">[</span><span class="token string">"vllm"</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç¯å¢ƒå®‰è£…æˆåŠŸåï¼Œæˆ‘ä»¬å‡†å¤‡æµ‹è¯•æ¨¡å‹è®­ç»ƒæ•ˆæœ</p><p>å°†æˆ‘ä»¬å¦ä¸€ä¸ªæœåŠ¡å™¨è®­ç»ƒå¥½çš„æƒé‡å¤åˆ¶åˆ°æ–°çš„æœåŠ¡å™¨ä¸Šæ¥ï¼Œå¹¶é‡æ–°ä¸‹è½½ä¸€éæ¨¡å‹ï¼Œæƒé‡å‡†å¤‡å¥½åï¼Œå‡†å¤‡å¼€å¯web ui</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> LLaMA-Factory<span class="token comment"># è¿è¡ŒLLaMA-Factoryçš„webui</span>llamafactory-cli webui<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™æ¬¡æˆ‘ä»¬è¦ç”¨åˆ°<code>LLaMA-FactoryChat</code>çš„Chatæ¨ç†åŠŸèƒ½ï¼Œå‚æ•°è¯´æ˜å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://pic1.imgdb.cn/item/680c4c8f58cb8da5c8ce186d.png" alt="Chatæ¨ç†å‚æ•°è®¾ç½®"></p><p>ä¸‹é¢æˆ‘ä»¬ç”¨åŸå§‹æ¨¡å‹ï¼Œä»¥åŠåŠ è½½ä¸åŒè®­ç»ƒè½®æ¬¡çš„æƒé‡æ¨¡å‹åï¼Œå¯¹åŒä¸€é—®é¢˜æ¨¡å‹ç»™çš„å›ç­”æ¥è¿›è¡Œä¸€ä¸ªå¯¹æ¯”ã€‚</p><p>åŠ è½½æ¨¡å‹å‡†å¤‡å¼€å§‹æµ‹è¯•</p><p>å› ä¸ºè®­ç»ƒæ—¶é¡ºä¾¿åŠ äº†å…³äºè‡ªæˆ‘è®¤çŸ¥çš„æ•°æ®é›†ï¼Œæ‰€ä»¥æ¥è¿›è¡Œè‡ªæˆ‘è®¤çŸ¥æµ‹è¯•ï¼Œæ¨¡å‹å›ç­”å¦‚ä¸‹ï¼š</p><figure class="half">    <img src="https://pic1.imgdb.cn/item/680c528c58cb8da5c8ce1d10.png">    <img src="https://pic1.imgdb.cn/item/680c528c58cb8da5c8ce1d11.png">    <img src="https://pic1.imgdb.cn/item/680c529858cb8da5c8ce1d18.png"></figure><p>å¯¹æ¨¡å‹ç”¨å¼±æ™ºå§çš„é—®é¢˜è¿›è¡Œæé—®ï¼Œæ¨¡å‹å›ç­”å¦‚ä¸‹ï¼š</p><figure class="half">    <img src="https://pic1.imgdb.cn/item/680c528c58cb8da5c8ce1d12.png">    <img src="https://pic1.imgdb.cn/item/680c528c58cb8da5c8ce1d0f.png">    <img src="https://pic1.imgdb.cn/item/680c529858cb8da5c8ce1d19.png">    <img src="https://pic1.imgdb.cn/item/680c529858cb8da5c8ce1d1a.png"></figure>è¿™é‡Œæ¨¡å‹è®­ç»ƒæ•ˆæœéƒ½æ„Ÿè§‰ä¸€èˆ¬ï¼Œæˆ‘æ¨æµ‹æ˜¯å› ä¸ºé€‰æ‹©çš„åŸºåº§æ¨¡å‹çš„åŸå› ï¼Œåç»­å¯ä»¥æ¢ä¸€ä¸ªåŸºåº§æ¨¡å‹åœ¨æµ‹è¯•ä¸€éï¼Œè¿™æ¬¡å…ˆå°†æµç¨‹èµ°å®Œã€‚<h3 id="6-4-æ¨¡å‹åˆå¹¶å¯¼å‡º"><a href="#6-4-æ¨¡å‹åˆå¹¶å¯¼å‡º" class="headerlink" title="6.4 æ¨¡å‹åˆå¹¶å¯¼å‡º"></a>6.4 æ¨¡å‹åˆå¹¶å¯¼å‡º</h3><p>æˆ‘ä»¬å…ˆå°†æ¨¡å‹åˆå¹¶ï¼Œç„¶ååœ¨è¿›è¡Œæ¨¡å‹é‡åŒ–å¯¼å‡ºï¼Œæ¨¡å‹å¯¼å‡ºè®¾ç½®å¦‚ä¸‹ï¼Œæˆ‘ä»¬ç”¨1000è½®çš„æƒé‡æ¥è¿›è¡Œæ¨¡å‹åˆå¹¶</p><p><img src="https://pic1.imgdb.cn/item/680c908358cb8da5c8cec05f.png" alt="æ¨¡å‹å¯¼å‡ºè®¾ç½®"></p><h3 id="6-5-æ¨¡å‹é‡åŒ–å¯¼å‡º"><a href="#6-5-æ¨¡å‹é‡åŒ–å¯¼å‡º" class="headerlink" title="6.5 æ¨¡å‹é‡åŒ–å¯¼å‡º"></a>6.5 æ¨¡å‹é‡åŒ–å¯¼å‡º</h3><p>å°†æˆ‘ä»¬ä¸Šé¢å¯¼å‡ºçš„æ¨¡å‹æ–‡ä»¶åŠ è½½è¿›æ¥ï¼Œé‡åŒ–å¯¼å‡ºè®¾ç½®å¦‚ä¸‹ï¼š</p><p><img src="https://pic1.imgdb.cn/item/680c908358cb8da5c8cec05e.png" alt="é‡åŒ–æ¨¡å‹å¯¼å‡ºè®¾ç½®"></p><p>è¿™é‡Œå¯¼å‡ºæˆ‘ä»¬çœ‹æ§åˆ¶å°æœ‰æ²¡æœ‰æŠ¥é”™ä¿¡æ¯ï¼Œå¯èƒ½ä¼šè¦æç¤ºæˆ‘ä»¬å®‰è£…ä¸€äº›ç¯å¢ƒï¼Œæç¤ºç¼ºä»€ä¹ˆæˆ‘ä»¬å°±å®‰è£…ä»€ä¹ˆã€‚</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip <span class="token function">install</span> optimum<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å®‰è£…å®Œæˆåè®°å¾—é‡å¯webuiï¼Œç„¶åæˆ‘ä»¬é‡æ–°é…ç½®ä¸€ä¸‹ç­‰å¾…æ¨¡å‹é‡åŒ–å¯¼å‡ºå®Œæˆã€‚</p><p>è¿™é‡Œæˆ‘ä¸€å…±å¯¼å‡ºäº†q2,q4,q8ç²¾åº¦çš„é‡åŒ–æ¨¡å‹ï¼Œç„¶åæ¥åˆ†åˆ«å¯¹å®ƒä»¬çš„æ•ˆæœè¿›è¡Œå¯¹æ¯”ï¼Œq4å’Œq8ç²¾åº¦ä¸‹ï¼Œæ¨¡å‹æ•ˆæœå’Œæ²¡é‡åŒ–å‰åŒºåˆ«ä¸å¤§ï¼Œåˆ°æµ‹è¯•q2æ—¶ï¼Œæ¨¡å‹å·²ç»å®Œå…¨ä¸è¡Œäº†ï¼Œå…¨éƒ½å›ç­”ä¹±ç ã€‚</p><figure class="half">    <img src="https://pic1.imgdb.cn/item/680c9bed58cb8da5c8cedd4a.png">    <img src="https://pic1.imgdb.cn/item/680c9bed58cb8da5c8cedd4b.png">    <img src="https://pic1.imgdb.cn/item/680c9bed58cb8da5c8cedd4c.png"></figure><p>æ‰€ä»¥ç›®å‰é‡åŒ–ä¸€èˆ¬é‡åŒ–åˆ°4ä½å’Œ8ä½ã€‚</p><h3 id="6-5-æ¨¡å‹è¯„ä¼°"><a href="#6-5-æ¨¡å‹è¯„ä¼°" class="headerlink" title="6.5 æ¨¡å‹è¯„ä¼°"></a>6.5 æ¨¡å‹è¯„ä¼°</h3><p>æˆ‘ä»¬é¦–å…ˆå‡†å¤‡å¥½æµ‹è¯•æ•°æ®é›†ï¼Œè¿™æ¬¡æˆ‘ä»¬å…ˆä»<code>ruozhiba_qaswift.json</code>æ–‡ä»¶ä¸­å–ä¸€éƒ¨åˆ†æ•°æ®ä»æ¥ä½œä¸ºæˆ‘ä»¬çš„æµ‹è¯•æ•°æ®é›†,åœ¨<code>LLaMA-Factory/data</code>ç›®å½•ä¸‹é¢æ–°å»º<code>ruozhiba_qaswift_test.json</code>æ–‡ä»¶ï¼Œå¤åˆ¶ä¸€éƒ¨åˆ†<code>ruozhiba_qaswift.json</code>ä¸­çš„æ•°æ®åˆ°<code>ruozhiba_qaswift_test.json</code>æ–‡ä»¶ä¸­ï¼Œç„¶ååœ¨<code>dataset_info.json</code>æ–‡ä»¶ä¸­é…ç½®<code>ruozhiba_qaswift_test.json</code>æ–‡ä»¶ï¼Œå‡†å¤‡å¥½åæˆ‘ä»¬å¼€å§‹æ¨¡å‹è¯„ä¼°ã€‚</p><p>æˆ‘ä»¬å¯¼å…¥åŸºåº§æ¨¡å‹ï¼Œè®¾ç½®å¥½æˆ‘ä»¬è¦è¯„ä¼°çš„æƒé‡ï¼Œç„¶åè¿›å…¥<code>Evaluate &amp; Predict</code>ç•Œé¢ï¼Œå‚æ•°è®¾ç½®å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://pic1.imgdb.cn/item/68102dc658cb8da5c8d2b9f1.png" alt="æ¨¡å‹è¯„ä¼°è®¾ç½®"></p><p>æˆ‘ä»¬ç‚¹å‡»å¼€å§‹è¯„ä¼°ï¼Œè¿™æ—¶ä¼šè¦æ±‚æˆ‘ä»¬å®‰è£…å‡ ä¸ªè¯„ä¼°è¦ç”¨çš„åŒ…ï¼Œæˆ‘ä»¬ä¾æ¬¡æ ¹æ®æç¤ºå®‰è£…å³å¯</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip <span class="token function">install</span> jiebapip <span class="token function">install</span> nltkpip <span class="token function">install</span> rouge_chinese<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>åŒ…å®‰è£…å®Œæˆåï¼Œæ¨¡å‹è¯„ä¼°å¼€å§‹ï¼Œè¯„ä¼°ç»“æœå¦‚ä¸‹ï¼š</p><p>è®­ç»ƒ1000è½®æƒé‡çš„æ¨¡å‹è¯„ä¼°å¾—åˆ†ï¼š</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"predict_bleu-4"</span><span class="token operator">:</span> <span class="token number">25.71370314171123</span><span class="token punctuation">,</span>    <span class="token property">"predict_model_preparation_time"</span><span class="token operator">:</span> <span class="token number">0.0023</span><span class="token punctuation">,</span>    <span class="token property">"predict_rouge-1"</span><span class="token operator">:</span> <span class="token number">48.205860895721926</span><span class="token punctuation">,</span>    <span class="token property">"predict_rouge-2"</span><span class="token operator">:</span> <span class="token number">27.524134157754013</span><span class="token punctuation">,</span>    <span class="token property">"predict_rouge-l"</span><span class="token operator">:</span> <span class="token number">41.42147493315508</span><span class="token punctuation">,</span>    <span class="token property">"predict_runtime"</span><span class="token operator">:</span> <span class="token number">347.7339</span><span class="token punctuation">,</span>    <span class="token property">"predict_samples_per_second"</span><span class="token operator">:</span> <span class="token number">4.302</span><span class="token punctuation">,</span>    <span class="token property">"predict_steps_per_second"</span><span class="token operator">:</span> <span class="token number">0.359</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è®­ç»ƒ3100è½®çš„æ¨¡å‹è¯„ä¼°å¾—åˆ†ï¼š</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span>    <span class="token property">"predict_bleu-4"</span><span class="token operator">:</span> <span class="token number">92.7214736631016</span><span class="token punctuation">,</span>    <span class="token property">"predict_model_preparation_time"</span><span class="token operator">:</span> <span class="token number">0.0024</span><span class="token punctuation">,</span>    <span class="token property">"predict_rouge-1"</span><span class="token operator">:</span> <span class="token number">95.9076695855615</span><span class="token punctuation">,</span>    <span class="token property">"predict_rouge-2"</span><span class="token operator">:</span> <span class="token number">94.5167354946524</span><span class="token punctuation">,</span>    <span class="token property">"predict_rouge-l"</span><span class="token operator">:</span> <span class="token number">95.47345046791445</span><span class="token punctuation">,</span>    <span class="token property">"predict_runtime"</span><span class="token operator">:</span> <span class="token number">318.3357</span><span class="token punctuation">,</span>    <span class="token property">"predict_samples_per_second"</span><span class="token operator">:</span> <span class="token number">4.699</span><span class="token punctuation">,</span>    <span class="token property">"predict_steps_per_second"</span><span class="token operator">:</span> <span class="token number">0.393</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™æ˜¯ä¸€æ®µ JSON æ ¼å¼æ•°æ®ï¼Œç”¨äºè¡¨ç¤ºæ¨¡å‹é¢„æµ‹æ€§èƒ½çš„ç›¸å…³æŒ‡æ ‡ã€‚ä»¥ä¸‹æ˜¯å„å­—æ®µçš„è§£é‡Šï¼š</p><ul><li>predict_bleu4: BLEU-4 å¾—åˆ†ã€‚</li><li>predict_model_preparation_time: æ¨¡å‹å‡†å¤‡æ—¶é—´</li><li>predict_rouge1: ROUGE-1 å¾—åˆ†</li><li>predict_rouge2: ROUGE-2 å¾—åˆ†</li><li>predict_rougel: ROUGE-L å¾—åˆ†</li><li>predict_runtime: æ€»è¿è¡Œæ—¶é—´</li><li>predict_samples_per_second: æ¯ç§’å¤„ç†æ ·æœ¬æ•°</li><li>predict_steps_per_second: æ¯ç§’å¤„ç†æ­¥éª¤æ•°</li></ul><p>è¿™äº›æŒ‡æ ‡ç”¨äºè¯„ä¼°æ¨¡å‹æ€§èƒ½ï¼Œå¸®åŠ©ä¼˜åŒ–ã€‚ï¼ˆè¯¦ç»†èµ„æ–™å¯å‚è€ƒï¼š<a href="https://blog.csdn.net/weixin_45573296/article/details/141333719">BLEUã€ROUGEè¯¦è§£-è¯­è¨€æ¨¡å‹çš„å¸¸ç”¨è¯„ä»·æŒ‡æ ‡-ä¸¾ä¾‹é™„ä»£ç å®ç°</a></p><p>å¯ä»¥çœ‹å‡ºè¿™æ¬¡è®­ç»ƒ1000è½®çš„æ•ˆæœå…¶å®å¹¶ä¸å¥½ï¼Œè¯„åˆ†éƒ½è¾ƒä½ï¼Œå’Œæˆ‘ä»¬ä¸»è§‚æµ‹è¯•çš„ç»“æœå·®ä¸å¤šï¼Œè€Œè®­ç»ƒ3100è½®çš„æ•ˆæœå°±ä¸é”™ï¼Œå¾—åˆ†è¾ƒé«˜ã€‚</p><h3 id="6-6-å…³äºQLoRA"><a href="#6-6-å…³äºQLoRA" class="headerlink" title="6.6 å…³äºQLoRA"></a>6.6 å…³äºQLoRA</h3><p>QLoRAæ˜¯ä¸€ç§ä¼˜äºLoRAè®­ç»ƒçš„ä¸€ä¸ªæ‰‹æ®µï¼ŒQLoRAå¯ä»¥å¸®åŠ©æˆ‘ä»¬åœ¨ä¸€å®šç¨‹åº¦ä¸Šé™ä½è®­ç»ƒæ—¶æ˜¾å­˜éœ€è¦ï¼Œè€Œä¸åƒé‡åŒ–å¯¼å‡ºé‚£æ ·æŸå¤±è¾ƒå¤§å‚æ•°ï¼Œå¹¶ä¸”å¯ä»¥åŠ å¿«è®­ç»ƒé€Ÿåº¦ï¼Œæ‰€ä»¥è®­ç»ƒå¯ä»¥ä½¿ç”¨QLoRAæ¥è¿›è¡Œï¼Œ</p><p>å¼€å¯QLoRAè®­ç»ƒçš„ä¸€äº›è®¾ç½®ï¼š<br><img src="https://pic1.imgdb.cn/item/681033bd58cb8da5c8d2d9b4.png" alt="QLoRAè®¾ç½®"></p><p><img src="https://pic1.imgdb.cn/item/681033bd58cb8da5c8d2d9b3.png" alt="QLoRAè®¾ç½®"></p><h2 id="é—®é¢˜è®°å½•"><a href="#é—®é¢˜è®°å½•" class="headerlink" title="é—®é¢˜è®°å½•"></a>é—®é¢˜è®°å½•</h2><h3 id="åœ¨AutoDLæœåŠ¡å™¨ä¸­å®‰è£…pip-install-auto-gptq-åŒ…å‡ºç°æŠ¥é”™"><a href="#åœ¨AutoDLæœåŠ¡å™¨ä¸­å®‰è£…pip-install-auto-gptq-åŒ…å‡ºç°æŠ¥é”™" class="headerlink" title="åœ¨AutoDLæœåŠ¡å™¨ä¸­å®‰è£…pip install auto-gptq åŒ…å‡ºç°æŠ¥é”™"></a>åœ¨AutoDLæœåŠ¡å™¨ä¸­å®‰è£…pip install auto-gptq åŒ…å‡ºç°æŠ¥é”™</h3><pre class="line-numbers language-root@autodl-container-3fac46b1d9-74c33bae:~/autodl-tmp/LLaMA-Factory#" data-language="root@autodl-container-3fac46b1d9-74c33bae:~/autodl-tmp/LLaMA-Factory#"><div class="caption"><span>pip install auto-gptq</span></div><code class="language-root@autodl-container-3fac46b1d9-74c33bae:~/autodl-tmp/LLaMA-Factory#">Looking in indexes: http://mirrors.aliyun.com/pypi/simpleCollecting auto-gptq  Using cached http://mirrors.aliyun.com/pypi/packages/90/e5/b22697903982284fe284568fb2663a2196694a8eee637f5cf4ccfe435a38/auto_gptq-0.7.1.tar.gz (126 kB)  Preparing metadata (setup.py) ... doneDiscarding http://mirrors.aliyun.com/pypi/packages/90/e5/b22697903982284fe284568fb2663a2196694a8eee637f5cf4ccfe435a38/auto_gptq-0.7.1.tar.gz#sha256=5c61ad380e9b4c603757c254765e9083a90a820cd0aff1b5d2c6f7fd96c85e80 (from http://mirrors.aliyun.com/pypi/simple/auto-gptq/) (requires-python:&gt;=3.8.0): Requested auto-gptq from http://mirrors.aliyun.com/pypi/packages/90/e5/b22697903982284fe284568fb2663a2196694a8eee637f5cf4ccfe435a38/auto_gptq-0.7.1.tar.gz#sha256=5c61ad380e9b4c603757c254765e9083a90a820cd0aff1b5d2c6f7fd96c85e80 has inconsistent version: expected '0.7.1', but metadata has '0.7.1+cu124'  Using cached http://mirrors.aliyun.com/pypi/packages/34/71/c3e73cf17681f6ff4754ef8f4cb8b67af3def230fc8711eac1250bbd78d5/auto_gptq-0.7.0.tar.gz (124 kB)  Preparing metadata (setup.py) ... doneDiscarding http://mirrors.aliyun.com/pypi/packages/34/71/c3e73cf17681f6ff4754ef8f4cb8b67af3def230fc8711eac1250bbd78d5/auto_gptq-0.7.0.tar.gz#sha256=50a5396fae2db5a19446b3198ef0e86ee520846b881db47bdbf4eb9260eac723 (from http://mirrors.aliyun.com/pypi/simple/auto-gptq/) (requires-python:&gt;=3.8.0): Requested auto-gptq from http://mirrors.aliyun.com/pypi/packages/34/71/c3e73cf17681f6ff4754ef8f4cb8b67af3def230fc8711eac1250bbd78d5/auto_gptq-0.7.0.tar.gz#sha256=50a5396fae2db5a19446b3198ef0e86ee520846b881db47bdbf4eb9260eac723 has inconsistent version: expected '0.7.0', but metadata has '0.7.0+cu124'  Using cached http://mirrors.aliyun.com/pypi/packages/49/af/02b66e55dfd9aeb0ece923843043724ed7432ec0c649ea0f3b9fa1dd90c6/auto_gptq-0.6.0.tar.gz (120 kB)  Preparing metadata (setup.py) ... error  error: subprocess-exited-with-error    Ã— python setup.py egg_info did not run successfully.  â”‚ exit code: 1  â•°â”€&gt; [20 lines of output]      python: can't open file '/tmp/pip-install-g1v4mpt6/auto-gptq_c460ab0157b140969c62922c52a5ab77/./autogptq_extension/qigen/generate.py': [Errno 2] No such file or directory      Traceback (most recent call last):        File "/tmp/pip-install-g1v4mpt6/auto-gptq_c460ab0157b140969c62922c52a5ab77/setup.py", line 109, in &lt;module&gt;          subprocess.check_output(["python", "./autogptq_extension/qigen/generate.py", "--module", "--search", "--p", str(p)])        File "/root/miniconda3/lib/python3.12/subprocess.py", line 466, in check_output          return run(*popenargs, stdout=PIPE, timeout=timeout, check=True,                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^        File "/root/miniconda3/lib/python3.12/subprocess.py", line 571, in run          raise CalledProcessError(retcode, process.args,      subprocess.CalledProcessError: Command '['python', './autogptq_extension/qigen/generate.py', '--module', '--search', '--p', '112']' returned non-zero exit status 2.            During handling of the above exception, another exception occurred:            Traceback (most recent call last):        File "&lt;string&gt;", line 2, in &lt;module&gt;        File "&lt;pip-setuptools-caller&gt;", line 34, in &lt;module&gt;        File "/tmp/pip-install-g1v4mpt6/auto-gptq_c460ab0157b140969c62922c52a5ab77/setup.py", line 111, in &lt;module&gt;          raise Exception(f"Generating QiGen kernels failed with the error shown above.")      Exception: Generating QiGen kernels failed with the error shown above.      Generating qigen kernels...      [end of output]    note: This error originates from a subprocess, and is likely not a problem with pip.error: metadata-generation-failedÃ— Encountered error while generating package metadata.â•°â”€&gt; See above for output.note: This is an issue with the package mentioned above, not pip.hint: See above for details.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>æ›´å¤šå®ç”¨æ–‡ç« å’ŒAIå¤§æ¨¡å‹åº”ç”¨å¼€å‘æ–‡ç« æ¬¢è¿åˆ°æˆ‘ä¸ªäººåšå®¢æ¥è§‚çœ‹ï¼š</strong><a href="https://blog.csdn.net/etrospect/article/details/blog.ismoyu.cn">å¢¨å®‡Logic</a></p>]]></content>
      
      
      <categories>
          
          <category> AIå¤§æ¨¡å‹åº”ç”¨å¼€å‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> vllm </tag>
            
            <tag> PyTorch </tag>
            
            <tag> LLaMA-Factory </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€AIå¤§æ¨¡å‹åº”ç”¨å­¦ä¹ ç¬”è®°ã€‘Ollamaè°ƒç”¨æœ¬åœ°æ¨¡å‹</title>
      <link href="/ai-da-mo-xing-ying-yong-xue-xi-bi-ji-ollama-diao-yong-ben-di-mo-xing/"/>
      <url>/ai-da-mo-xing-ying-yong-xue-xi-bi-ji-ollama-diao-yong-ben-di-mo-xing/</url>
      
        <content type="html"><![CDATA[<h1 id="Linuxå®‰è£…Ollama"><a href="#Linuxå®‰è£…Ollama" class="headerlink" title="Linuxå®‰è£…Ollama"></a>Linuxå®‰è£…Ollama</h1><h2 id="å®‰è£…å‘½ä»¤ï¼š"><a href="#å®‰è£…å‘½ä»¤ï¼š" class="headerlink" title="å®‰è£…å‘½ä»¤ï¼š"></a>å®‰è£…å‘½ä»¤ï¼š</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> <span class="token parameter variable">-fsSL</span> https://ollama.com/install.sh <span class="token operator">|</span> <span class="token function">sh</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å¦‚æœä¸‹è½½é€Ÿåº¦å¾ˆæ…¢ï¼Œå¯ä»¥å¼€å¯å­¦æœ¯åŠ é€Ÿ</p><h3 id="å¼€å¯Auto-DLå­¦æœ¯åŠ é€Ÿ"><a href="#å¼€å¯Auto-DLå­¦æœ¯åŠ é€Ÿ" class="headerlink" title="å¼€å¯Auto-DLå­¦æœ¯åŠ é€Ÿ:"></a>å¼€å¯Auto-DLå­¦æœ¯åŠ é€Ÿ:</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">source</span> /etc/network_turbo<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="å–æ¶ˆAuto-DLå­¦æœ¯åŠ é€Ÿ"><a href="#å–æ¶ˆAuto-DLå­¦æœ¯åŠ é€Ÿ" class="headerlink" title="å–æ¶ˆAuto-DLå­¦æœ¯åŠ é€Ÿ:"></a>å–æ¶ˆAuto-DLå­¦æœ¯åŠ é€Ÿ:</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">unset</span> http_proxy <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">unset</span> https_proxy<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="Ollamaå®‰è£…æ¨¡å‹ï¼š"><a href="#Ollamaå®‰è£…æ¨¡å‹ï¼š" class="headerlink" title="Ollamaå®‰è£…æ¨¡å‹ï¼š"></a>Ollamaå®‰è£…æ¨¡å‹ï¼š</h2><h3 id="ä¸‹è½½æ¨¡å‹"><a href="#ä¸‹è½½æ¨¡å‹" class="headerlink" title="ä¸‹è½½æ¨¡å‹"></a>ä¸‹è½½æ¨¡å‹</h3><p>ä»¥ llama3.2:1b æ¨¡å‹ä¸ºä¾‹ï¼Œè¿è¡Œä¸‹é¢å‘½ä»¤ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ollama run llama3.2:1b<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ç­‰å¾…å‘½ä»¤ç»“æŸã€‚</p><h3 id="ä½¿ç”¨æ¨¡å‹"><a href="#ä½¿ç”¨æ¨¡å‹" class="headerlink" title="ä½¿ç”¨æ¨¡å‹"></a>ä½¿ç”¨æ¨¡å‹</h3><p>ollamaä½¿ç”¨æ¨¡å‹æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§é€šè¿‡ç»ˆç«¯å‘½ä»¤ä½¿ç”¨ï¼Œä¸€ç§é€šè¿‡pythonä»£ç ä½¿ç”¨ï¼Œä¸¤ç§æ–¹å¼éƒ½éœ€è¦é¦–å…ˆå¼€å¯ollamaæœåŠ¡</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ollama serve<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="1-é€šè¿‡ç»ˆç«¯ä½¿ç”¨"><a href="#1-é€šè¿‡ç»ˆç«¯ä½¿ç”¨" class="headerlink" title="1.é€šè¿‡ç»ˆç«¯ä½¿ç”¨"></a>1.é€šè¿‡ç»ˆç«¯ä½¿ç”¨</h4><p>ç»ˆç«¯è¿è¡Œå‘½ä»¤ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ollama run llama3.2:1b<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ç»ˆç«¯ä¼šè¿›å…¥å¯¹è¯æ¨¡å¼ï¼Œè¿™æ—¶è¾“å…¥ä½ è¦é—®çš„é—®é¢˜å³å¯ä½¿ç”¨æ¨¡å‹ã€‚</p><h4 id="2-é€šè¿‡pythonä»£ç ä½¿ç”¨æ¨¡å‹"><a href="#2-é€šè¿‡pythonä»£ç ä½¿ç”¨æ¨¡å‹" class="headerlink" title="2.é€šè¿‡pythonä»£ç ä½¿ç”¨æ¨¡å‹"></a>2.é€šè¿‡pythonä»£ç ä½¿ç”¨æ¨¡å‹</h4><p>å®‰è£… openai åŒ…</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip <span class="token function">install</span> opeani<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>pythonä»£ç ç®€å•è°ƒç”¨</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> openai <span class="token keyword">import</span> OpenAI<span class="token comment"># é€šè¿‡openaiæ¥å£è°ƒç”¨æ¨¡å‹ï¼Œå¯¼å…¥æ¨¡å‹åœ°å€ï¼Œå’Œapi_key</span>client <span class="token operator">=</span> OpenAI<span class="token punctuation">(</span>base_url<span class="token operator">=</span><span class="token string">"http://localhost:11434/v1/"</span><span class="token punctuation">,</span>api_key<span class="token operator">=</span><span class="token string">"ollama"</span><span class="token punctuation">)</span><span class="token comment"># æç¤ºè¯æ¨¡æ¿ï¼Œå¹¶è¾“å…¥ç”¨æˆ·é—®é¢˜ï¼ŒæŒ‡å®šä½¿ç”¨æ¨¡å‹åå­—</span>responce<span class="token operator">=</span>client<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span>create<span class="token punctuation">(</span>    messages<span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span><span class="token string">"user"</span><span class="token punctuation">,</span><span class="token string">"content"</span><span class="token punctuation">:</span><span class="token string">"ä½ å¥½!ä½ æ˜¯è°ï¼Ÿä½ æ˜¯ç”±è°åˆ›é€ çš„ï¼Ÿ"</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>model<span class="token operator">=</span><span class="token string">"llama3.2:1B"</span><span class="token punctuation">)</span><span class="token comment"># æ‰“å°ç»“æœ</span><span class="token keyword">print</span><span class="token punctuation">(</span>responce<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>base_urlï¼šå¯åŠ¨<code>ollama serve</code>åä¼šç»™å‡ºåœ°å€å’Œç«¯å£ï¼Œä¸€èˆ¬ä¸º<a href="http://localhost:11434/">http://localhost:11434</a></p><p>api_keyï¼šä¸ºollamaï¼Œå› ä¸ºä½¿ç”¨çš„ollamaæ¡†æ¶</p><p>ç®€å•å¤šè½®å¯¹è¯æ¡†æ¶è°ƒç”¨ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#å¤šè½®å¯¹è¯</span><span class="token keyword">from</span> openai <span class="token keyword">import</span> OpenAI<span class="token comment">#å®šä¹‰å¤šè½®å¯¹è¯æ–¹æ³•</span><span class="token keyword">def</span> <span class="token function">run_chat_session</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment">#åˆå§‹åŒ–å®¢æˆ·ç«¯</span>    client <span class="token operator">=</span> OpenAI<span class="token punctuation">(</span>base_url<span class="token operator">=</span><span class="token string">"http://localhost:11434/v1/"</span><span class="token punctuation">,</span>api_key<span class="token operator">=</span><span class="token string">"ollama"</span><span class="token punctuation">)</span>    <span class="token comment">#åˆå§‹åŒ–å¯¹è¯å†å²</span>    chat_history <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token comment">#å¯åŠ¨å¤šè½®å¯¹è¯</span>    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>        <span class="token comment">#è·å–ç”¨æˆ·è¾“å…¥</span>        user_input <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"ç”¨æˆ·ï¼š"</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> user_input<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token string">"exit"</span><span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"é€€å‡ºå¯¹è¯"</span><span class="token punctuation">)</span>            <span class="token keyword">break</span>        <span class="token comment">#æ›´æ–°å¯¹è¯å†å²ï¼ˆæ·»åŠ ç”¨æˆ·è¾“å…¥ï¼‰</span>        chat_history<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span><span class="token string">"user"</span><span class="token punctuation">,</span><span class="token string">"content"</span><span class="token punctuation">:</span>user_input<span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token comment">#è°ƒç”¨æ¨¡å‹å›ç­”</span>        <span class="token keyword">try</span><span class="token punctuation">:</span>            chat_complition <span class="token operator">=</span> client<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span>create<span class="token punctuation">(</span>messages<span class="token operator">=</span>chat_history<span class="token punctuation">,</span>model<span class="token operator">=</span><span class="token string">"llama3.2:1b"</span><span class="token punctuation">)</span>            <span class="token comment">#è·å–æœ€æ–°å›ç­”</span>            moedl_responce <span class="token operator">=</span> chat_complition<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"AIï¼š"</span><span class="token punctuation">,</span>moedl_responce<span class="token punctuation">.</span>message<span class="token punctuation">.</span>content<span class="token punctuation">)</span>            <span class="token comment">#æ›´æ–°å¯¹è¯å†å²ï¼ˆæ·»åŠ AIæ¨¡å‹çš„å›å¤ï¼‰</span>            chat_history<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span><span class="token string">"assistant"</span><span class="token punctuation">,</span><span class="token string">"content"</span><span class="token punctuation">:</span>moedl_responce<span class="token punctuation">.</span>message<span class="token punctuation">.</span>content<span class="token punctuation">}</span><span class="token punctuation">)</span>        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"å‘ç”Ÿé”™è¯¯ï¼š"</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span>            <span class="token keyword">break</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    run_chat_session<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>æ›´å¤šå®ç”¨æ–‡ç« å’ŒAIå¤§æ¨¡å‹åº”ç”¨å¼€å‘æ–‡ç« æ¬¢è¿åˆ°æˆ‘ä¸ªäººåšå®¢æ¥è§‚çœ‹ï¼š</strong><a href="https://blog.csdn.net/etrospect/article/details/blog.ismoyu.cn">å¢¨å®‡Logic</a></p>]]></content>
      
      
      <categories>
          
          <category> AIå¤§æ¨¡å‹åº”ç”¨å¼€å‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ollama </tag>
            
            <tag> Python </tag>
            
            <tag> Linux </tag>
            
            <tag> LLaMa </tag>
            
            <tag> LoRA </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€AIå¤§æ¨¡å‹åº”ç”¨å­¦ä¹ ç¬”è®°ã€‘LLaMa3å¾®è°ƒ</title>
      <link href="/ai-da-mo-xing-ying-yong-xue-xi-bi-ji-llama3-wei-diao/"/>
      <url>/ai-da-mo-xing-ying-yong-xue-xi-bi-ji-llama3-wei-diao/</url>
      
        <content type="html"><![CDATA[<h1 id="LLaMa3å¾®è°ƒ"><a href="#LLaMa3å¾®è°ƒ" class="headerlink" title="LLaMa3å¾®è°ƒ"></a>LLaMa3å¾®è°ƒ</h1><h2 id="LoRA"><a href="#LoRA" class="headerlink" title="LoRA"></a>LoRA</h2><h3 id="åŸºæœ¬æ¦‚å¿µ"><a href="#åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h3><p>LoRAï¼ˆLow-Rank Adaptationï¼‰æ˜¯ä¸€ç§ç”¨äºå¤§æ¨¡å‹å¾®è°ƒçš„æŠ€æœ¯ï¼Œé€šè¿‡å¼•å…¥ä½ç§©çŸ©é˜µæ¥å‡å°‘å¾®è°ƒæ—¶çš„å‚æ•°é‡ã€‚åœ¨é¢„è®­ç»ƒçš„æ¨¡å‹ä¸­ï¼ŒLoRAé€šè¿‡æ·»åŠ ä¸¤ä¸ªå°çŸ©é˜µBå’ŒAæ¥è¿‘ä¼¼åŸå§‹çš„å¤§çŸ©é˜µÎ”Wï¼Œä»è€Œå‡å°‘éœ€è¦æ›´æ–°çš„å‚æ•°æ•°é‡ã€‚å…·ä½“æ¥è¯´ï¼ŒLoRAé€šè¿‡å°†å…¨å‚å¾®è°ƒçš„å¢é‡ å‚æ•°çŸ©é˜µÎ”Wè¡¨ç¤ºä¸ºä¸¤ä¸ªå‚æ•°é‡æ›´å°çš„çŸ©é˜µBå’ŒAçš„ä½ç§©è¿‘ä¼¼æ¥å®ç°ï¼š</p><p>[ W_0 + \Delta W = W_0 + BA ] </p><p>å…¶ä¸­ï¼ŒBå’ŒAçš„ç§©è¿œå°äºåŸå§‹çŸ©é˜µçš„ç§©ï¼Œä»è€Œå¤§å¤§å‡å°‘äº†éœ€è¦æ›´æ–°çš„å‚æ•°æ•°é‡ã€‚</p><h3 id="LoRAæ€æƒ³"><a href="#LoRAæ€æƒ³" class="headerlink" title="LoRAæ€æƒ³"></a>LoRAæ€æƒ³</h3><p>é¢„è®­ç»ƒæ¨¡å‹ä¸­å­˜åœ¨ä¸€ä¸ªæå°çš„å†…åœ¨ç»´åº¦ï¼Œè¿™ä¸ªå†…åœ¨ç»´åº¦æ˜¯å‘æŒ¥æ ¸å¿ƒä½œç”¨çš„åœ°æ–¹ã€‚åœ¨ç»§ç»­è®­ç»ƒçš„è¿‡ç¨‹ä¸­ï¼Œæƒé‡çš„æ›´æ–°ä¾ç„¶ä¹Ÿæœ‰å¦‚æ­¤ç‰¹ç‚¹ï¼Œå³ä¹Ÿå­˜åœ¨ä¸€ä¸ªå†…åœ¨ç»´åº¦(å†…åœ¨ç§©)</p><p>æƒé‡æ›´æ–°ï¼šW=W+^W</p><p>å› æ­¤ï¼Œå¯ä»¥é€šè¿‡çŸ©é˜µåˆ†è§£çš„æ–¹å¼ï¼Œå°†åŸæœ¬è¦æ›´æ–°çš„å¤§çš„çŸ©é˜µå˜ä¸ºä¸¤ä¸ªå°çš„çŸ©é˜µ</p><p>æƒé‡æ›´æ–°ï¼šW=W+^W=W+BA</p><p>å…·ä½“åšæ³•ï¼Œå³åœ¨çŸ©é˜µè®¡ç®—ä¸­å¢åŠ ä¸€ä¸ªæ—ç³»åˆ†æ”¯ï¼Œæ—ç³»åˆ†æ”¯ç”±ä¸¤ä¸ª ä½ç§©çŸ©é˜µAå’ŒBç»„æˆ</p><h3 id="LoRAåŸç†"><a href="#LoRAåŸç†" class="headerlink" title="LoRAåŸç†"></a>LoRAåŸç†</h3><p>è®­ç»ƒæ—¶ï¼Œè¾“å…¥åˆ†åˆ«ä¸åŸå§‹æƒé‡å’Œä¸¤ä¸ªä½ç§©çŸ©é˜µè¿›è¡Œè®¡ç®—ï¼Œå…±åŒå¾— åˆ°æœ€ç»ˆç»“æœï¼Œä¼˜åŒ–åˆ™ä»…ä¼˜åŒ–Aå’ŒBã€‚</p><p>è®­ç»ƒå®Œæˆåï¼Œå¯ä»¥å°†ä¸¤ä¸ªä½ç§©çŸ©é˜µä¸åŸå§‹æ¨¡å‹ä¸­çš„æƒé‡è¿›è¡Œåˆå¹¶ï¼Œ åˆå¹¶åçš„æ¨¡å‹ä¸åŸå§‹æ¨¡å‹æ— å¼‚</p><h2 id="æ¨¡å‹ä¸‹è½½"><a href="#æ¨¡å‹ä¸‹è½½" class="headerlink" title="æ¨¡å‹ä¸‹è½½"></a>æ¨¡å‹ä¸‹è½½</h2><p>å¯ä»¥é€šè¿‡Hugging Faceå¹³å°å’Œå›½å†…é­”å¡”ç¤¾åŒºè¿›è¡Œä¸‹è½½ï¼Œä¸‹é¢ä»¥<code>Llama-3.2-1B-Instruct</code>æ¨¡å‹ä¸ºç¤ºä¾‹ï¼š</p><p>é­”å¡”ç¤¾åŒºä¸‹è½½æ¨¡å‹ï¼Œ</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># æ¨¡å‹ä¸‹è½½</span><span class="token keyword">from</span> modelscope <span class="token keyword">import</span> snapshot_downloadmodel_dir <span class="token operator">=</span> snapshot_download<span class="token punctuation">(</span><span class="token string">'LLM-Research/Llama-3.2-1B-Instruct'</span><span class="token punctuation">,</span>cache_dir<span class="token operator">=</span><span class="token string">"/teacher_data/llm/"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="LLaMA-Factory"><a href="#LLaMA-Factory" class="headerlink" title="LLaMA-Factory"></a>LLaMA-Factory</h2><p>1.å®‰è£…</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone https://github.com/hiyouga/LLaMA-Factory.git<span class="token builtin class-name">cd</span> LLaMA-Factorypip <span class="token function">install</span> <span class="token parameter variable">-e</span> <span class="token builtin class-name">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><div style="background-color: green; padding: 10px;">  è¿™é‡Œæ‰§è¡Œå®‰è£…åŒ…å‘½ä»¤å‰ï¼Œå…ˆæ‰§è¡Œ pip install auto-gptq ä»¥åŠ pip install -e .["vllm"] å®‰è£…é‡åŒ–æ¡†æ¶</div><p>2.å‡†å¤‡è®­ç»ƒæ•°æ®</p><p>ä¾‹ï¼š</p><p>è®­ç»ƒæ•°æ®ï¼š</p><ul><li>fintech.json</li><li>identity.json</li></ul><p>å°†è®­ç»ƒæ•°æ®æ”¾åœ¨ç›®å½• LLaMA-Factory/data/fintech.json </p><p>å¹¶ä¸”ä¿®æ”¹æ•°æ®æ³¨å†Œæ–‡ä»¶ï¼šLLaMA-Factory/data/dataset_info.json ,å†…å®¹å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"fintech"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"file_name"</span><span class="token operator">:</span> <span class="token string">"fintech.json"</span><span class="token punctuation">,</span><span class="token property">"columns"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"prompt"</span><span class="token operator">:</span> <span class="token string">"instruction"</span><span class="token punctuation">,</span><span class="token property">"query"</span><span class="token operator">:</span> <span class="token string">"input"</span><span class="token punctuation">,</span><span class="token property">"response"</span><span class="token operator">:</span> <span class="token string">"output"</span><span class="token punctuation">,</span><span class="token property">"history"</span><span class="token operator">:</span> <span class="token string">"history"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="é€šè¿‡ç•Œé¢è¿›è¡Œè®­ç»ƒ"><a href="#é€šè¿‡ç•Œé¢è¿›è¡Œè®­ç»ƒ" class="headerlink" title="é€šè¿‡ç•Œé¢è¿›è¡Œè®­ç»ƒ"></a>é€šè¿‡ç•Œé¢è¿›è¡Œè®­ç»ƒ</h3><p>å¯åŠ¨Web UI</p><pre class="line-numbers language-none"><code class="language-none">cd LLaMA-Factoryllamafactory-cli webui<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>æ¨¡å‹å¾®è°ƒ</p><ul><li>ä½¿ç”¨ Web UI è®­ç»ƒ</li><li>ä½¿ç”¨å‘½ä»¤è¡Œæ‰§è¡Œ</li></ul><p>å¯åŠ¨webuiåç•Œé¢å¦‚ä¸‹ï¼š</p><p><img src="https://pic1.imgdb.cn/item/680af5b258cb8da5c8c9ce81.png" alt="LLaMa3_00"></p><h3 id="è®¾ç½®è®­ç»ƒæ¨¡å‹è·¯å¾„"><a href="#è®¾ç½®è®­ç»ƒæ¨¡å‹è·¯å¾„" class="headerlink" title="è®¾ç½®è®­ç»ƒæ¨¡å‹è·¯å¾„"></a>è®¾ç½®è®­ç»ƒæ¨¡å‹è·¯å¾„</h3><p>å°†ç•Œé¢ä¿®æ”¹ä¸ºä¸­æ–‡ï¼Œè®¾ç½®éœ€è¦è®­ç»ƒçš„æ¨¡å‹åå­—ï¼Œå¡«å…¥æ¨¡å‹è·¯å¾„</p><p><img src="https://pic1.imgdb.cn/item/680af5b258cb8da5c8c9ce7c.png" alt="LLaMa3_01"></p><p>å…¶ä»–å‚æ•°ï¼š</p><ul><li>å¾®è°ƒæ–¹æ³•é€‰æ‹© lora</li><li>æ£€æŸ¥ç‚¹è·¯å¾„ï¼šè®­ç»ƒæ¨¡å‹ä¿å­˜è·¯å¾„ï¼Œè®­ç»ƒå¥½çš„æ¨¡å‹æƒé‡è·¯å¾„ï¼Œä¸€èˆ¬é»˜è®¤</li><li>æœ€ä¸‹é¢ä¸€æ’å‚æ•°å…ˆé»˜è®¤</li></ul><h3 id="é…ç½®è®­ç»ƒå‚æ•°"><a href="#é…ç½®è®­ç»ƒå‚æ•°" class="headerlink" title="é…ç½®è®­ç»ƒå‚æ•°"></a>é…ç½®è®­ç»ƒå‚æ•°</h3><p><img src="https://pic1.imgdb.cn/item/680af5b258cb8da5c8c9ce80.png" alt="LLaMa3_02"></p><p>å‚æ•°é…ç½®ï¼š</p><ul><li>è®­ç»ƒé˜¶æ®µï¼šä¸€èˆ¬é»˜è®¤supervised Fine-Tuning</li><li>æ•°æ®è·¯å¾„ï¼šæˆ‘ä»¬è¦è®­ç»ƒçš„æ•°æ®é›†è·¯å¾„</li><li>æ•°æ®é›†ï¼šæˆ‘ä»¬è¦è®­ç»ƒçš„æ•°æ®é›†ï¼Œå¯ä»¥å¤šé€‰</li><li>å­¦ä¹ ç‡ï¼šä¸€èˆ¬é»˜è®¤</li><li>è®­ç»ƒè½®æ•°ï¼šä¸€èˆ¬è®¾ç½®å¤§ä¸€ç‚¹ï¼Œå› ä¸ºå¯ä»¥éšæ—¶ä¸­æ­¢</li><li>æœ€å¤§æ¢¯åº¦èŒƒç•´ï¼šä¸€èˆ¬é»˜è®¤</li><li>æœ€å¤§æ ·æœ¬æ•°ï¼šé»˜è®¤ï¼Œå¯ä»¥æ ¹æ®æ•°æ®é›†çš„å¤§å°æ¥å®š</li><li>è®¡ç®—ç±»å‹ï¼šbf16æ•ˆæœæœ€å¥½ï¼Œä½†è¦çœ‹è®¾å¤‡æ”¯ä¸æ”¯æŒ</li><li>æˆªæ–­é•¿åº¦ï¼šä¸€èˆ¬æ ¹æ®æ•°æ®é›†æ¥å®š</li><li>æ‰¹å¤„ç†å¤§å°ï¼šæ ¹æ®æ˜¾å¡é…ç½®æ¥çœ‹</li><li>æ¢¯åº¦ç§¯ç´¯ï¼šé»˜è®¤</li><li>éªŒè¯é›†æ¯”ä¾‹ï¼šéªŒè¯é›†æ‰€å æ ·æœ¬çš„å¤§å°</li><li>å­¦ä¹ ç‡è°ƒèŠ‚å™¨ï¼šé»˜è®¤</li></ul><h3 id="LoRAå‚æ•°è®¾ç½®"><a href="#LoRAå‚æ•°è®¾ç½®" class="headerlink" title="LoRAå‚æ•°è®¾ç½®"></a>LoRAå‚æ•°è®¾ç½®</h3><p><img src="https://pic1.imgdb.cn/item/680af5b258cb8da5c8c9ce7e.png" alt="LLaMa3_04"></p><p>å‚æ•°ï¼šä¸€èˆ¬é»˜è®¤</p><p>é…ç½®å¥½æ‰€æœ‰å‚æ•°åï¼Œå‡†å¤‡å¼€å§‹è®­ç»ƒ</p><h3 id="æµ‹è¯•æ¨¡å‹"><a href="#æµ‹è¯•æ¨¡å‹" class="headerlink" title="æµ‹è¯•æ¨¡å‹"></a>æµ‹è¯•æ¨¡å‹</h3><p>å°†è®­ç»ƒå¥½çš„æ¨¡å‹æƒé‡è¿›è¡Œæµ‹è¯•æµ‹è¯•</p><p><img src="https://pic1.imgdb.cn/item/680af5b258cb8da5c8c9ce7d.png" alt="LLaMa3_05"></p><p>ç‚¹å‡»åŠ è½½æ¨¡å‹ï¼Œä¼šåŠ è½½æ¨¡å‹å¯¹è¯æ¡†ç•Œé¢</p><p><img src="https://pic1.imgdb.cn/item/680af5b258cb8da5c8c9ce7f.png" alt="LLaMa3_06"></p><p>å’Œæ¨¡å‹å¯¹è¯çœ‹ç»™å‡ºçš„å›ç­”å‡†ç¡®åº¦é«˜ä¸é«˜</p><h3 id="åˆå¹¶LoARå’ŒåŸæ¨¡å‹"><a href="#åˆå¹¶LoARå’ŒåŸæ¨¡å‹" class="headerlink" title="åˆå¹¶LoARå’ŒåŸæ¨¡å‹"></a>åˆå¹¶LoARå’ŒåŸæ¨¡å‹</h3><p>é€‰æ‹©æ•ˆæœæœ€å¥½çš„è®­ç»ƒæƒé‡å’ŒåŸæ¨¡å‹ï¼Œç‚¹å‡»Exportæ¨¡å¼ï¼Œè®¾ç½®å¥½å‚æ•°åå°±å‡†å¤‡å¼€å§‹å¯¼å‡ºã€‚</p><p><img src="https://pic1.imgdb.cn/item/680af5bd58cb8da5c8c9ce88.png" alt="LLaMa3_07"></p><h3 id="è¯„ä¼°æ¨¡å‹"><a href="#è¯„ä¼°æ¨¡å‹" class="headerlink" title="è¯„ä¼°æ¨¡å‹"></a>è¯„ä¼°æ¨¡å‹</h3><p>å‡†å¤‡è®­ç»ƒç”¨çš„æ•°æ®é›†ï¼Œé…ç½® <code>dataset_info</code> ï¼Œå‚æ•°é…ç½®ä¸€èˆ¬å’Œè®­ç»ƒæ—¶æ•°æ®ä¿æŒä¸€è‡´</p><p>è¯„ä¼°æ¨¡å‹å‰è¿˜éœ€è¦è£…å‡ ä¸ªåŒ…</p><pre class="line-numbers language-none"><code class="language-none">pip install jiebapip install nltkpip install rouge_chinese<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p><img src="https://pic1.imgdb.cn/item/680af5be58cb8da5c8c9ce8a.png" alt="LLaMa3_08"></p><h3 id="é€šè¿‡é…ç½®æ–‡ä»¶å¼€å§‹è®­ç»ƒ"><a href="#é€šè¿‡é…ç½®æ–‡ä»¶å¼€å§‹è®­ç»ƒ" class="headerlink" title="é€šè¿‡é…ç½®æ–‡ä»¶å¼€å§‹è®­ç»ƒ"></a>é€šè¿‡é…ç½®æ–‡ä»¶å¼€å§‹è®­ç»ƒ</h3><p>é…ç½®æ–‡ä»¶ä½äºï¼š[cust/train_llama3_lora_sft.yaml] </p><p>æ„å»º cust/train_llama3_lora_sft.yaml</p><pre class="line-numbers language-none"><code class="language-none">cutoff_len: 1024 dataset: fintech,identity dataset_dir: data do_train: true finetuning_type: lora flash_attn: auto fp16: true gradient_accumulation_steps: 8 learning_rate: 0.0002 logging_steps: 5 lora_alpha: 16 lora_dropout: 0 lora_rank: 8 lora_target: q_proj,v_proj lr_scheduler_type: cosine max_grad_norm: 1.0 max_samples: 1000 model_name_or_path: /root/autodl-tmp/models/Llama3-8B-Chinese-Chat num_train_epochs: 10.0 optim: adamw_torch output_dir: saves/LLaMA3-8B-Chinese-Chat/lora/train_2024-05-25-20-27-47 packing: false per_device_train_batch_size: 2 plot_loss: true preprocessing_num_workers: 16 report_to: none save_steps: 100 stage: sft template: llama3 use_unsloth: true warmup_steps: 0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å‘½ä»¤è¡Œæ‰§è¡Œï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">llamafactory-cli train cust/train_llama3_lora_sft.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="é—®é¢˜è®°å½•ï¼š"><a href="#é—®é¢˜è®°å½•ï¼š" class="headerlink" title="é—®é¢˜è®°å½•ï¼š"></a>é—®é¢˜è®°å½•ï¼š</h3><p>æˆ‘åœ¨å®é™…å®‰è£…è¿‡ç¨‹ä¸­ç”±äºæ‡’å¾—ç§ŸæœåŠ¡å™¨å’Œå®‰è£…LinuxåŒç³»ç»Ÿï¼Œæ‰€ä»¥å°±ç›´æ¥ä½¿ç”¨Windows11ç³»ç»Ÿæ¥å®‰è£…é…ç½®LLaMA-Factoryï¼ŒæŒ‰ç…§ä¸Šé¢æ­¥éª¤é…ç½®å¥½åï¼ŒæˆåŠŸå¯åŠ¨äº†webuiç•Œé¢ï¼Œä½†æ˜¯åœ¨é…ç½®å¥½è®­ç»ƒå‚æ•°åï¼Œç‚¹å‡»å¼€å§‹è®­ç»ƒï¼Œç»“æœæŠ¥é”™ï¼šæœªæ‰¾åˆ°cudaç¯å¢ƒï¼Œéšåç¨‹åºæŠ¥é”™ä¸­æ–­æœåŠ¡äº†</p><p><img src="https://pic1.imgdb.cn/item/680af5be58cb8da5c8c9ce89.png" alt="LLaMa3_09"></p><p>åŸå› æ¨æµ‹æ˜¯æ²¡æœ‰åœ¨ä½¿ç”¨çš„pythonç¯å¢ƒä¸­å®‰è£… CUDA + pytorch ç¯å¢ƒå¯¼è‡´çš„ï¼Œæˆ–è€…å®‰è£…çš„ç¯å¢ƒç‰ˆæœ¬ä¸å¯¹ï¼Œå®‰è£… CUDA + pytorch åŒ…</p><pre class="line-numbers language-none"><code class="language-none">conda install pytorch==2.1.0 torchvision==0.16.0 torchaudio==2.1.0 pytorch-cuda=12.1 -c pytorch -c nvidia<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>åç»­æ²¡æœ‰è§£å†³ï¼Œå‡†å¤‡è¿˜æ˜¯åœ¨æœåŠ¡å™¨ä¸Šè¿›è¡Œæµ‹è¯•ã€‚</p><h2 id="æ–‡æœ¬ç”Ÿæˆæ¨¡å‹è¯„ä¼°æ–¹æ³•"><a href="#æ–‡æœ¬ç”Ÿæˆæ¨¡å‹è¯„ä¼°æ–¹æ³•" class="headerlink" title="æ–‡æœ¬ç”Ÿæˆæ¨¡å‹è¯„ä¼°æ–¹æ³•"></a>æ–‡æœ¬ç”Ÿæˆæ¨¡å‹è¯„ä¼°æ–¹æ³•</h2><p>OpenCompassé‡‡å–å®¢è§‚è¯„æµ‹ä¸ä¸»è§‚è¯„æµ‹ç›¸ç»“åˆçš„æ–¹æ³•ã€‚é’ˆå¯¹å…·æœ‰ç¡®å®šæ€§ç­”æ¡ˆçš„èƒ½åŠ›ç»´åº¦å’Œåœºæ™¯ï¼Œé€šè¿‡æ„é€ ä¸°å¯Œå®Œå–„çš„è¯„æµ‹é›†ï¼Œå¯¹æ¨¡å‹èƒ½åŠ›è¿›è¡Œç»¼åˆè¯„ä»·ã€‚é’ˆå¯¹ä½“ç°æ¨¡å‹èƒ½åŠ›çš„å¼€æ”¾å¼æˆ–åŠå¼€æ”¾å¼çš„é—®é¢˜ã€æ¨¡å‹å®‰å…¨é—®é¢˜ç­‰ï¼Œé‡‡ç”¨ä¸»å®¢è§‚ç›¸ç»“åˆçš„è¯„æµ‹æ–¹å¼ã€‚</p><p><strong>æ›´å¤šå®ç”¨æ–‡ç« å’ŒAIå¤§æ¨¡å‹åº”ç”¨å¼€å‘æ–‡ç« æ¬¢è¿åˆ°æˆ‘ä¸ªäººåšå®¢æ¥è§‚çœ‹ï¼š</strong><a href="https://blog.csdn.net/etrospect/article/details/blog.ismoyu.cn">å¢¨å®‡Logic</a></p>]]></content>
      
      
      <categories>
          
          <category> AIå¤§æ¨¡å‹åº”ç”¨å¼€å‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ollama </tag>
            
            <tag> Python </tag>
            
            <tag> Linux </tag>
            
            <tag> LLaMa </tag>
            
            <tag> LoRA </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WIN11+WSL2+Ubuntu22.04+CUDA+ANACONDA3+Pytorchå®‰è£…æ€»ç»“</title>
      <link href="/win11-wsl2-ubuntu22-04-cuda-anaconda3-pytorch-an-zhuang-zong-jie/"/>
      <url>/win11-wsl2-ubuntu22-04-cuda-anaconda3-pytorch-an-zhuang-zong-jie/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€ã€ç¬¬ä¸€æ­¥æ˜¯æ‰“å¼€win11çš„linuxå­ç³»ç»Ÿå¼€å…³å’Œè™šæ‹Ÿç¨‹åºå¼€å…³"><a href="#ä¸€ã€ç¬¬ä¸€æ­¥æ˜¯æ‰“å¼€win11çš„linuxå­ç³»ç»Ÿå¼€å…³å’Œè™šæ‹Ÿç¨‹åºå¼€å…³" class="headerlink" title="ä¸€ã€ç¬¬ä¸€æ­¥æ˜¯æ‰“å¼€win11çš„linuxå­ç³»ç»Ÿå¼€å…³å’Œè™šæ‹Ÿç¨‹åºå¼€å…³"></a>ä¸€ã€ç¬¬ä¸€æ­¥æ˜¯æ‰“å¼€win11çš„linuxå­ç³»ç»Ÿå¼€å…³å’Œè™šæ‹Ÿç¨‹åºå¼€å…³</h2><p> 1.å¯åŠ¨WINDOWSåŠŸèƒ½<br>é¦–å…ˆåœ¨æ§åˆ¶é¢æ¿ç¨‹åºä¸­æ‰¾åˆ°ï¼šå¯åŠ¨æˆ–å…³é—­WINDOWSåŠŸèƒ½<br><img src="https://pic1.imgdb.cn/item/681f430058cb8da5c8eb7485.png" alt="å¯åŠ¨WINDOWSåŠŸèƒ½"></p><p>2.ç„¶åæ‰“å¼€æ ‡çº¢çš„ä¸¤é¡¹ï¼Œæ‰“å¼€åè¦æ±‚é‡å¯ï¼Œé‡å¯å³å¯<br><img src="https://pic1.imgdb.cn/item/681f430058cb8da5c8eb7486.png" alt="æ‰“å¼€Linux Windowså­ç³»ç»Ÿ"></p><h2 id="äºŒã€å®‰è£…WSL"><a href="#äºŒã€å®‰è£…WSL" class="headerlink" title="äºŒã€å®‰è£…WSL"></a>äºŒã€å®‰è£…WSL</h2><h3 id="2-1-å®‰è£…WSLå­ç³»ç»Ÿ"><a href="#2-1-å®‰è£…WSLå­ç³»ç»Ÿ" class="headerlink" title="2.1 å®‰è£…WSLå­ç³»ç»Ÿ"></a>2.1 å®‰è£…WSLå­ç³»ç»Ÿ</h3><p>åœ¨windows store æ‰¾åˆ° Windows Subsystem for Linux, å¹¶å®‰è£…<br><img src="https://pic1.imgdb.cn/item/681f43e758cb8da5c8eb74cc.png" alt="Windows Subsystem for Linux"></p><h3 id="2-2-ä¿®æ”¹wslç‰ˆæœ¬"><a href="#2-2-ä¿®æ”¹wslç‰ˆæœ¬" class="headerlink" title="2.2 ä¿®æ”¹wslç‰ˆæœ¬"></a>2.2 ä¿®æ”¹wslç‰ˆæœ¬</h3><p>åœ¨windows power shellä¸‹è¾“å…¥å¦‚ä¸‹ä»£ç ï¼Œä¿®æ”¹wslä¸º2ç‰ˆæœ¬ï¼ˆåªæœ‰1å’Œ2ï¼Œ2 BUGå°‘ï¼Œé€‚é…æ€§é«˜ï¼‰<br>ä»£ç å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"># ä¿®æ”¹WSLé»˜è®¤ç‰ˆæœ¬ä¸º<span class="token number">2</span>wsl <span class="token operator">--</span>set<span class="token operator">-</span><span class="token keyword">default</span><span class="token operator">-</span>version <span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="2-3-å®‰è£…ubuntu-æˆ‘è¿™é‡Œæ˜¯22-04"><a href="#2-3-å®‰è£…ubuntu-æˆ‘è¿™é‡Œæ˜¯22-04" class="headerlink" title="2.3 å®‰è£…ubuntu(æˆ‘è¿™é‡Œæ˜¯22.04)"></a>2.3 å®‰è£…ubuntu(æˆ‘è¿™é‡Œæ˜¯22.04)</h3><p><img src="https://pic1.imgdb.cn/item/681f43e758cb8da5c8eb74cb.png" alt="å®‰è£…ubuntu"></p><p>å®‰è£…å¥½ubuntuåæ‰“å¼€ubuntuï¼Œç­‰å¾…å®‰è£…ï¼Œå®‰è£…å®Œæˆåè¾“å…¥ä¸€ä¸ªæ–°å»ºçš„è´¦æˆ·åå’Œå¯†ç ï¼Œç„¶åç›´æ¥å…³é—­å³å¯</p><h3 id="2-3-å¯é€‰-ï¼Œç§»åŠ¨WSLå®‰è£…ä½ç½®"><a href="#2-3-å¯é€‰-ï¼Œç§»åŠ¨WSLå®‰è£…ä½ç½®" class="headerlink" title="2.3 (å¯é€‰)ï¼Œç§»åŠ¨WSLå®‰è£…ä½ç½®"></a>2.3 (å¯é€‰)ï¼Œç§»åŠ¨WSLå®‰è£…ä½ç½®</h3><p>é¦–å…ˆï¼š æŸ¥çœ‹wslä¸‹çš„Linuxæ˜¯å¦ä¸ºå…³é—­çŠ¶æ€ï¼Œå½“wslä¸ºStoppedæ‰èƒ½è¿›è¡Œä¸‹ä¸€æ­¥ã€‚<br>åœ¨powershell ä¸‹</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># å…ˆæŸ¥çœ‹WSLçŠ¶æ€ï¼Œæ˜¯å¦æ˜¯stoped</span>wsl <span class="token parameter variable">-l</span> <span class="token parameter variable">-v</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>å¦‚æœçŠ¶æ€ä¸æ˜¯stopæ‰§è¡Œä¸‹é¢æ“ä½œï¼Œå¦‚æœæ˜¯stopè·³è¿‡æ­¤æ­¥</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># å…³é—­å­ç³»ç»Ÿ</span>wsl <span class="token parameter variable">--shutdown</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>çŠ¶æ€ä¸ºstop,åˆ™æ˜¾ç¤ºç•Œé¢ä¸ºï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">C:<span class="token punctuation">\</span>Users<span class="token punctuation">\</span>xxx<span class="token punctuation">\</span>Desktop<span class="token operator">&gt;</span>wsl <span class="token parameter variable">-l</span> <span class="token parameter variable">-v</span>  NAME      STATE           VERSION* Ubuntu-22.04    Stopped         <span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>å¼€å§‹ç§»åŠ¨ï¼Œå…ˆå°†ubuntuä»¥å‹ç¼©åŒ…å½¢å¼å¯¼å‡º</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">wsl <span class="token parameter variable">--export</span> Ubuntu-22.04 E:<span class="token punctuation">\</span>wsl2_ubuntu22<span class="token punctuation">\</span>Ubuntu-22.04.tar<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ³¨é”€åŸæœ‰å­ç³»ç»Ÿ</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">wsl <span class="token parameter variable">--unregister</span> Ubuntu-22.04<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å°†æ‰“åŒ…çš„ç³»ç»Ÿå¯¼å‡º</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">wsl <span class="token parameter variable">--import</span> Ubuntu-22.04 E:<span class="token punctuation">\</span>wsl2_ubuntu22<span class="token punctuation">\</span> E:<span class="token punctuation">\</span>wsl2_ubuntu22<span class="token punctuation">\</span>Ubuntu-22.04.tar <span class="token parameter variable">--version</span> <span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å¯¼å‡ºåï¼Œubuntuç™»å½•ä¼šé»˜è®¤é¦–é€‰rootç”¨æˆ·ï¼Œå¯ä»¥ä¿®æ”¹ä¸ºç™»å½•é¦–é€‰ä¸ºå­ç”¨æˆ·</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># æ­¤å‘½ä»¤åªé€‚ç”¨äº ubuntu22.04ç‰ˆæœ¬  å…¶ä»–ç‰ˆæœ¬éœ€è¦ä¿®æ”¹exeå‰é¢çš„å­—ç¬¦ä¸²</span>ubuntu2204.exe config --default-user ismoyu<span class="token punctuation">(</span>è¿™è¡¨ç¤ºä½ çš„å­ç”¨æˆ·å<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="2-4-æ›´æ–°Ubuntuè½¯ä»¶æº"><a href="#2-4-æ›´æ–°Ubuntuè½¯ä»¶æº" class="headerlink" title="2.4 æ›´æ–°Ubuntuè½¯ä»¶æº"></a>2.4 æ›´æ–°Ubuntuè½¯ä»¶æº</h3><p>å®‰è£…å‰å…ˆæ‰“å¼€ubuntuç•Œé¢ï¼Œä¿®æ”¹ä¸€ä¸‹ä¸‹è½½é•œåƒæºï¼ŒåŠ å¿«ä¸‹è½½é€Ÿåº¦</p><p>å¤‡ä»½åŸå…ˆå®˜æ–¹æºï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">cp</span> /etc/apt/sources.list /etc/apt/sources.list.backup<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>vim æ‰“å¼€<code>/etc/apt/sources.list</code>æ–‡ä»¶ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">vim</span> /etc/apt/sources.list<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ‰“å¼€åæ·»åŠ ä»¥ä¸‹å†…å®¹ï¼šï¼ˆé˜¿é‡Œäº‘æºï¼‰</p><pre class="line-numbers language-none"><code class="language-none">deb http://mirrors.aliyun.com/ubuntu/ jammy main restricted universe multiversedeb-src http://mirrors.aliyun.com/ubuntu/ jammy main restricted universe multiversedeb http://mirrors.aliyun.com/ubuntu/ jammy-security main restricted universe multiversedeb-src http://mirrors.aliyun.com/ubuntu/ jammy-security main restricted universe multiversedeb http://mirrors.aliyun.com/ubuntu/ jammy-updates main restricted universe multiversedeb-src http://mirrors.aliyun.com/ubuntu/ jammy-updates main restricted universe multiversedeb http://mirrors.aliyun.com/ubuntu/ jammy-proposed main restricted universe multiversedeb-src http://mirrors.aliyun.com/ubuntu/ jammy-proposed main restricted universe multiversedeb http://mirrors.aliyun.com/ubuntu/ jammy-backports main restricted universe multiversedeb-src http://mirrors.aliyun.com/ubuntu/ jammy-backports main restricted universe multiverse<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶åå†æ‰§è¡Œæ›´æ–°æºå‘½ä»¤ apt update å³å¯ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> update <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> <span class="token function">apt</span> upgrade<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="2-5-Windowså’ŒWSL2æ–‡ä»¶äº’æ¢"><a href="#2-5-Windowså’ŒWSL2æ–‡ä»¶äº’æ¢" class="headerlink" title="2.5 Windowså’ŒWSL2æ–‡ä»¶äº’æ¢"></a>2.5 Windowså’ŒWSL2æ–‡ä»¶äº’æ¢</h3><p>ä½ å¯ä»¥ç›´æ¥åœ¨ Windows æ–‡ä»¶èµ„æºç®¡ç†å™¨ä¸­æ‰“å¼€ WSL&nbsp;<a href="https://so.csdn.net/so/search?q=%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F&amp;spm=1001.2101.3001.7020">æ–‡ä»¶ç³»ç»Ÿ</a>ã€‚WSL çš„æ–‡ä»¶ç³»ç»Ÿé€šå¸¸ä½äº&nbsp;<code>\\wsl$\&lt;DistroName&gt;\</code>&nbsp;è·¯å¾„ä¸‹ï¼Œå…¶ä¸­&nbsp;<code>&lt;DistroName&gt;</code>&nbsp;æ˜¯ä½ çš„ WSL å‘è¡Œç‰ˆçš„åç§°ã€‚</p><p>ä¾‹å¦‚ï¼Œå¦‚æœä½ çš„ WSL å‘è¡Œç‰ˆæ˜¯&nbsp;Ubuntuï¼Œä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹è·¯å¾„è®¿é—® WSL æ–‡ä»¶ç³»ç»Ÿï¼š</p><pre class="line-numbers language-none"><code class="language-none">\\wsl$\Ubuntu\<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="ä¸‰ã€å®‰è£…è½¯ä»¶ç¯å¢ƒ"><a href="#ä¸‰ã€å®‰è£…è½¯ä»¶ç¯å¢ƒ" class="headerlink" title="ä¸‰ã€å®‰è£…è½¯ä»¶ç¯å¢ƒ"></a>ä¸‰ã€å®‰è£…è½¯ä»¶ç¯å¢ƒ</h2><h3 id="3-1-å®‰è£…CUDA"><a href="#3-1-å®‰è£…CUDA" class="headerlink" title="3.1 å®‰è£…CUDA"></a>3.1 å®‰è£…CUDA</h3><p>æ‰“å¼€ä¸‹è¾¹é“¾æ¥<br><a href="https://developer.nvidia.com/cuda-12-1-0-download-archive?target_os=Linux&amp;target_arch=x86_64&amp;Distribution=WSL-Ubuntu&amp;target_version=2.0&amp;target_type=deb_local">CUDA on Windows Subsystem for Linux (WSL)</a><br>æˆ‘ä»¬å®‰è£…CUDA12.1ç‰ˆæœ¬ï¼Œè¿›å»æ˜¾ç¤ºæœ€æ–°çš„ï¼ˆcuda12.2è¿™å¤ªé«˜äº†torchéƒ½æ²¡æ”¯æŒå‘¢ï¼‰ï¼Œæ‰¾åˆ°è‡ªå·±éœ€è¦çš„ç‰ˆæœ¬<br><img src="https://pic1.imgdb.cn/item/681f43e758cb8da5c8eb74ca.png" alt="å®‰è£…CUDA12.1"><br>ç›´æ¥æŒ‰ç…§ç»™å®šçš„å‘½ä»¤è¾“å…¥åˆ°<a href="https://so.csdn.net/so/search?q=ubuntu%E5%91%BD%E4%BB%A4&amp;spm=1001.2101.3001.7020">ubuntuå‘½ä»¤</a>è¡Œä¸­<br><img src="https://pic1.imgdb.cn/item/681f43e758cb8da5c8eb74cd.png" alt="å®‰è£…CUDA12.1"><br>ç›´æ¥å¤åˆ¶ä¸Šè¿°å‘½ä»¤è¾“å…¥å³å¯:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> https://developer.download.nvidia.com/compute/cuda/repos/wsl-ubuntu/x86_64/cuda-wsl-ubuntu.pin<span class="token function">sudo</span> <span class="token function">mv</span> cuda-wsl-ubuntu.pin /etc/apt/preferences.d/cuda-repository-pin-600<span class="token function">wget</span> https://developer.download.nvidia.com/compute/cuda/12.1.0/local_installers/cuda-repo-wsl-ubuntu-12-1-local_12.1.0-1_amd64.deb<span class="token function">sudo</span> dpkg <span class="token parameter variable">-i</span> cuda-repo-wsl-ubuntu-12-1-local_12.1.0-1_amd64.deb<span class="token function">sudo</span> <span class="token function">cp</span> /var/cuda-repo-wsl-ubuntu-12-1-local/cuda-*-keyring.gpg /usr/share/keyrings/<span class="token function">sudo</span> <span class="token function">apt-get</span> update<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token parameter variable">-y</span> <span class="token function">install</span> cuda<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…¨éƒ¨æ‰§è¡Œå®Œæˆåï¼Œæ‰“å¼€æ–‡ä»¶ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">vim</span> ~/.bashrc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æœ«å°¾æ·»åŠ ä»¥ä¸‹å†…å®¹</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># config cuda</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">CUDA_HOME</span><span class="token operator">=</span>/usr/local/cuda-12.1<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$PATH</span><span class="token builtin class-name">:</span><span class="token variable">$CUDA_HOME</span>/bin       <span class="token builtin class-name">export</span> <span class="token assign-left variable">LD_LIBRARY_PATH</span><span class="token operator">=</span><span class="token variable">$LD_LIBRARY_PATH</span><span class="token builtin class-name">:</span><span class="token variable">$CUDA_HOME</span>/lib64<span class="token builtin class-name">export</span> <span class="token assign-left variable">LD_LIBRARY_PATH</span><span class="token operator">=</span><span class="token variable">$LD_LIBRARY_PATH</span><span class="token builtin class-name">:</span><span class="token variable">$CUDA_HOME</span>/extras/CUPTI/lib64<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å®Œæˆååˆ·æ–°ä¸€ä¸‹ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">source</span> ~/.bashrc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ç„¶åå°±èƒ½nvcc -V å°±èƒ½æŸ¥çœ‹CUDAç‰ˆæœ¬äº†</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">nvcc <span class="token parameter variable">-V</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="3-1-å®‰è£…anaconda3"><a href="#3-1-å®‰è£…anaconda3" class="headerlink" title="3.1 å®‰è£…anaconda3"></a>3.1 å®‰è£…anaconda3</h3><h4 id="1-å®‰è£…è½¯ä»¶ä¾èµ–åŒ…ï¼š"><a href="#1-å®‰è£…è½¯ä»¶ä¾èµ–åŒ…ï¼š" class="headerlink" title="1. å®‰è£…è½¯ä»¶ä¾èµ–åŒ…ï¼š"></a>1. å®‰è£…è½¯ä»¶ä¾èµ–åŒ…ï¼š</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt</span> <span class="token parameter variable">-y</span> <span class="token function">install</span> libgl1-mesa-glx libegl1-mesa libxrandr2 libxrandr2 libxss1 libxcursor1 libxcomposite1 libasound2 libxi6 libxtst6<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="2-ä¸‹è½½Anacondaå®‰è£…åŒ…"><a href="#2-ä¸‹è½½Anacondaå®‰è£…åŒ…" class="headerlink" title="2. ä¸‹è½½Anacondaå®‰è£…åŒ…"></a>2. ä¸‹è½½Anacondaå®‰è£…åŒ…</h4><p>å®‰è£…Anacondaçš„æœ€ä½³æ–¹æ³•æ˜¯ä¸‹è½½æœ€æ–°çš„Anacondaå®‰è£…ç¨‹åºbashè„šæœ¬, ç„¶åè¿è¡Œå®ƒã€‚</p><p>åœ¨<a href="https://www.anaconda.com/products/distribution#Downloads">Anacondaä¸‹è½½é¡µé¢</a>ä¸Šæ‰¾åˆ°é€‚ç”¨äºPython 3çš„æœ€æ–°ç‰ˆæœ¬çš„Anacodaã€‚</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> https://repo.anaconda.com/archive/Anaconda3-2024.10-1-Linux-x86_64.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ä¸‹è½½å®Œæˆè¿è¡Œè„šæœ¬:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">bash</span> Anaconda3-2024.10-1-Linux-x86_64.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å®‰è£…è¿‡ç¨‹åŸºæœ¬ä¸Šä¸€è·¯å›è½¦å°±å¯ä»¥äº†ï¼Œæˆ–è€…yeså³å¯ã€‚</p><p>åŠ å…¥åé‡è½½ç¯å¢ƒå˜é‡ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">source</span> ~/.bashrc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æˆ‘ä»¬åœ¨å®‰è£…å®Œæˆåï¼Œä»¥åæ¯æ¬¡æ‰“å¼€ç»ˆç«¯éƒ½ä¼šè‡ªåŠ¨è¿›å…¥condaçš„bashç¯å¢ƒï¼Œå¦‚æœä¸éœ€è¦å¯ä»¥è¿è¡Œä¸‹é¢å‘½ä»¤æ¥ç¦ç”¨ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">conda config <span class="token parameter variable">--set</span> auto_activate_base <span class="token boolean">false</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="3-2-å®‰è£…PyTorch"><a href="#3-2-å®‰è£…PyTorch" class="headerlink" title="3.2 å®‰è£…PyTorch"></a>3.2 å®‰è£…PyTorch</h3><p>æœ€å¥½æˆ‘ä»¬ç”¨condaæ–°å»ºä¸€ä¸ªè™šæ‹Ÿç¯å¢ƒæ¥å®‰è£…ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">conda create <span class="token parameter variable">-n</span> llm-learn <span class="token assign-left variable">python</span><span class="token operator">=</span><span class="token number">3.10</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>åˆ‡æ¢åˆ°ç¯å¢ƒï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">conda activate llm-learn<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ä¸ºäº†ä¸æ±¡æŸ“bashç¯å¢ƒï¼Œæˆ‘ä»¬å°†æˆ‘ä»¬åˆ›å»ºçš„ç¯å¢ƒæ¨èåˆ°ç³»ç»Ÿç¯å¢ƒä¸­ï¼Œæ‰“å¼€ç³»ç»Ÿç¯å¢ƒï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">vim</span> ~/.bashrc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å®‰è£…PyTorchï¼Œå› ä¸ºæˆ‘ä»¬CODAå®‰è£…çš„æ˜¯12.1ç‰ˆæœ¬çš„ï¼Œæ‰€ä»¥PyTorchæˆ‘ä»¬å®‰è£…2.3.0ç‰ˆæœ¬çš„</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># CUDA 12.1</span>conda <span class="token function">install</span> <span class="token assign-left variable">pytorch</span><span class="token operator">==</span><span class="token number">2.3</span>.0 <span class="token assign-left variable">torchvision</span><span class="token operator">==</span><span class="token number">0.18</span>.0 <span class="token assign-left variable">torchaudio</span><span class="token operator">==</span><span class="token number">2.3</span>.0 pytorch-cuda<span class="token operator">=</span><span class="token number">12.1</span> <span class="token parameter variable">-c</span> pytorch <span class="token parameter variable">-c</span> nvidia<span class="token comment"># å®‰è£…PyTorch 2.3.0 + CUDA 12.1</span>pip <span class="token function">install</span> <span class="token assign-left variable">torch</span><span class="token operator">==</span><span class="token number">2.3</span>.0+cu121 <span class="token assign-left variable">torchvision</span><span class="token operator">==</span><span class="token number">0.18</span>.0+cu121 --extra-index-url https://download.pytorch.org/whl/cu121<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>æ›´å¤šå®ç”¨æ–‡ç« å’ŒAIå¤§æ¨¡å‹åº”ç”¨å¼€å‘æ–‡ç« æ¬¢è¿åˆ°æˆ‘ä¸ªäººåšå®¢æ¥è§‚çœ‹ï¼š</strong><a href="https://blog.csdn.net/etrospect/article/details/blog.ismoyu.cn">å¢¨å®‡Logic</a></p>]]></content>
      
      
      <categories>
          
          <category> å®ç”¨æ•™ç¨‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Markdown </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€AIå¤§æ¨¡å‹åº”ç”¨å­¦ä¹ ç¬”è®°ã€‘å­¦ä¹ LangChainå¤§æ¨¡å‹èƒ½åŠ›å°è£…å·¥å…·æ¡†æ¶</title>
      <link href="/ai-da-mo-xing-ying-yong-xue-xi-bi-ji-xue-xi-langchain-da-mo-xing-feng-zhuang-gong-ju-kuang-jia/"/>
      <url>/ai-da-mo-xing-ying-yong-xue-xi-bi-ji-xue-xi-langchain-da-mo-xing-feng-zhuang-gong-ju-kuang-jia/</url>
      
        <content type="html"><![CDATA[<h1 id="LangChain"><a href="#LangChain" class="headerlink" title="LangChain"></a>LangChain</h1><p>ğŸ’¡ è¿™ç¯‡æ–‡ç« ä¼šå¸¦ç»™ä½ </p><ol><li>å¦‚ä½•ä½¿ç”¨ LangChainï¼šä¸€å¥—åœ¨å¤§æ¨¡å‹èƒ½åŠ›ä¸Šå°è£…çš„å·¥å…·æ¡†æ¶</li><li>å¦‚ä½•ç”¨å‡ è¡Œä»£ç å®ç°ä¸€ä¸ªå¤æ‚çš„ AI åº”ç”¨</li><li>é¢å‘å¤§æ¨¡å‹çš„æµç¨‹å¼€å‘çš„è¿‡ç¨‹æŠ½è±¡</li></ol><h2 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h2><p>å®˜ç½‘ï¼š<a href="https://www.langchain.com/">https://www.langchain.com/</a></p><ul><li>LangChain ä¹Ÿæ˜¯ä¸€å¥—é¢å‘å¤§æ¨¡å‹çš„å¼€å‘æ¡†æ¶ï¼ˆSDKï¼‰</li><li>LangChain æ˜¯ AGI æ—¶ä»£è½¯ä»¶å·¥ç¨‹çš„ä¸€ä¸ªæ¢ç´¢å’ŒåŸå‹</li><li>å­¦ä¹  LangChain è¦å…³æ³¨æ¥å£å˜æ›´</li></ul><h2 id="LangChain-çš„æ ¸å¿ƒç»„ä»¶"><a href="#LangChain-çš„æ ¸å¿ƒç»„ä»¶" class="headerlink" title="LangChain çš„æ ¸å¿ƒç»„ä»¶"></a>LangChain çš„æ ¸å¿ƒç»„ä»¶</h2><ol><li>æ¨¡å‹ I/O å°è£…<ul><li>LLMsï¼šå¤§è¯­è¨€æ¨¡å‹</li><li>Chat Modelsï¼šä¸€èˆ¬åŸºäº LLMsï¼Œä½†æŒ‰å¯¹è¯ç»“æ„é‡æ–°å°è£…</li><li>PromptTempleï¼šæç¤ºè¯æ¨¡æ¿</li><li>OutputParserï¼šè§£æè¾“å‡º</li></ul></li><li>æ•°æ®è¿æ¥å°è£…<ul><li>Document Loadersï¼šå„ç§æ ¼å¼æ–‡ä»¶çš„åŠ è½½å™¨</li><li>Document Transformersï¼šå¯¹æ–‡æ¡£çš„å¸¸ç”¨æ“ä½œï¼Œå¦‚ï¼šsplit, filter, translate, extract metadata, etc</li><li>Text Embedding Modelsï¼šæ–‡æœ¬å‘é‡åŒ–è¡¨ç¤ºï¼Œç”¨äºæ£€ç´¢ç­‰æ“ä½œï¼ˆå•¥æ„æ€ï¼Ÿåˆ«æ€¥ï¼Œåé¢è¯¦ç»†è®²ï¼‰</li><li>Verctorstores: ï¼ˆé¢å‘æ£€ç´¢çš„ï¼‰å‘é‡çš„å­˜å‚¨</li><li>Retrievers: å‘é‡çš„æ£€ç´¢</li></ul></li><li>å¯¹è¯å†å²ç®¡ç†<ul><li>å¯¹è¯å†å²çš„å­˜å‚¨ã€åŠ è½½ä¸å‰ªè£</li></ul></li><li>æ¶æ„å°è£…<ul><li>Chainï¼šå®ç°ä¸€ä¸ªåŠŸèƒ½æˆ–è€…ä¸€ç³»åˆ—é¡ºåºåŠŸèƒ½ç»„åˆ</li><li>Agentï¼šæ ¹æ®ç”¨æˆ·è¾“å…¥ï¼Œè‡ªåŠ¨è§„åˆ’æ‰§è¡Œæ­¥éª¤ï¼Œè‡ªåŠ¨é€‰æ‹©æ¯æ­¥éœ€è¦çš„å·¥å…·ï¼Œæœ€ç»ˆå®Œæˆç”¨æˆ·æŒ‡å®šçš„åŠŸèƒ½<ul><li>Toolsï¼šè°ƒç”¨å¤–éƒ¨åŠŸèƒ½çš„å‡½æ•°ï¼Œä¾‹å¦‚ï¼šè°ƒ google æœç´¢ã€æ–‡ä»¶ I/Oã€Linux Shell ç­‰ç­‰</li><li>Toolkitsï¼šæ“ä½œæŸè½¯ä»¶çš„ä¸€ç»„å·¥å…·é›†ï¼Œä¾‹å¦‚ï¼šæ“ä½œ DBã€æ“ä½œ Gmail ç­‰ç­‰</li></ul></li></ul></li><li>Callbacks</li></ol><h3 id="æ–‡æ¡£ï¼ˆä»¥-Python-ç‰ˆä¸ºä¾‹ï¼‰"><a href="#æ–‡æ¡£ï¼ˆä»¥-Python-ç‰ˆä¸ºä¾‹ï¼‰" class="headerlink" title="æ–‡æ¡£ï¼ˆä»¥ Python ç‰ˆä¸ºä¾‹ï¼‰"></a>æ–‡æ¡£ï¼ˆä»¥ Python ç‰ˆä¸ºä¾‹ï¼‰</h3><ul><li>åŠŸèƒ½æ¨¡å—ï¼š<a href="https://python.langchain.com/docs/get_started/introduction">https://python.langchain.com/docs/get_started/introduction</a></li><li>API æ–‡æ¡£ï¼š<a href="https://api.python.langchain.com/en/latest/langchain_api_reference.html">https://api.python.langchain.com/en/latest/langchain_api_reference.html</a></li><li>ä¸‰æ–¹ç»„ä»¶é›†æˆï¼š<a href="https://python.langchain.com/docs/integrations/platforms/">https://python.langchain.com/docs/integrations/platforms/</a></li><li>å®˜æ–¹åº”ç”¨æ¡ˆä¾‹ï¼š<a href="https://python.langchain.com/docs/use_cases">https://python.langchain.com/docs/use_cases</a></li><li>è°ƒè¯•éƒ¨ç½²ç­‰æŒ‡å¯¼ï¼š<a href="https://python.langchain.com/docs/guides/debugging">https://python.langchain.com/docs/guides/debugging</a></li></ul><div class="alert alert-success"><b>åˆ’é‡ç‚¹ï¼š</b> åˆ›å»ºä¸€ä¸ªæ–°çš„ conda ç¯å¢ƒï¼Œ<b>langchain-learn</b>ï¼Œå†å¼€å§‹ä¸‹é¢çš„å­¦ä¹ ï¼</div><pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell">conda create <span class="token operator">-</span>n langchain-learn python=3<span class="token punctuation">.</span>10<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>## ä¸€ã€ æ¨¡å‹ I/O å°è£…<p>æŠŠä¸åŒçš„æ¨¡å‹ï¼Œç»Ÿä¸€è£…æˆä¸€ä¸ªæ¥å£ï¼Œæ–¹ä¾¿æ›´æ¢æ¨¡å‹è€Œä¸ç”¨é‡æ„ä»£ç ã€‚</p><h3 id="1-1-æ¨¡å‹-API-LLM-vs-ChatModel"><a href="#1-1-æ¨¡å‹-API-LLM-vs-ChatModel" class="headerlink" title="1.1 æ¨¡å‹ API: LLM vs. ChatModel"></a>1.1 æ¨¡å‹ API: LLM vs. ChatModel</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip <span class="token function">install</span> <span class="token parameter variable">--upgrade</span> langchainpip <span class="token function">install</span> <span class="token parameter variable">--upgrade</span> langchain-openaipip <span class="token function">install</span> <span class="token parameter variable">--upgrade</span> langchain-community<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h4 id="1-1-1-OpenAI-æ¨¡å‹å°è£…"><a href="#1-1-1-OpenAI-æ¨¡å‹å°è£…" class="headerlink" title="1.1.1 OpenAI æ¨¡å‹å°è£…"></a>1.1.1 OpenAI æ¨¡å‹å°è£…</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> langchain_openai <span class="token keyword">import</span> ChatOpenAIllm <span class="token operator">=</span> ChatOpenAI<span class="token punctuation">(</span>model<span class="token operator">=</span><span class="token string">"gpt-4o-mini"</span><span class="token punctuation">)</span>  <span class="token comment"># é»˜è®¤æ˜¯gpt-3.5-turbo</span>response <span class="token operator">=</span> llm<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span><span class="token string">"ä½ æ˜¯è°"</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="1-1-2-å¤šè½®å¯¹è¯-Session-å°è£…"><a href="#1-1-2-å¤šè½®å¯¹è¯-Session-å°è£…" class="headerlink" title="1.1.2 å¤šè½®å¯¹è¯ Session å°è£…"></a>1.1.2 å¤šè½®å¯¹è¯ Session å°è£…</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> langchain<span class="token punctuation">.</span>schema <span class="token keyword">import</span> <span class="token punctuation">(</span>    AIMessage<span class="token punctuation">,</span>      <span class="token comment"># ç­‰ä»·äºOpenAIæ¥å£ä¸­çš„Assistant role</span>    HumanMessage<span class="token punctuation">,</span>   <span class="token comment"># ç­‰ä»·äºOpenAIæ¥å£ä¸­çš„User role</span>    SystemMessage<span class="token punctuation">,</span>  <span class="token comment"># ç­‰ä»·äºOpenAIæ¥å£ä¸­çš„System role</span><span class="token punctuation">)</span>messages <span class="token operator">=</span> <span class="token punctuation">[</span>    SystemMessage<span class="token punctuation">(</span>content<span class="token operator">=</span><span class="token string">"ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„ç¼–ç¨‹å­¦ä¹ æ™ºèƒ½åŠ©æ‰‹"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    HumanMessage<span class="token punctuation">(</span>content<span class="token operator">=</span><span class="token string">"æˆ‘æ˜¯ä¸€åæ­£åœ¨è‡ªå­¦ç¼–ç¨‹çš„å­¦ç”Ÿï¼Œæˆ‘å«å¢¨æ™ºLogic"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    AIMessage<span class="token punctuation">(</span>content<span class="token operator">=</span><span class="token string">"æ¬¢è¿ï¼Œå¢¨æ™ºLogicï¼æˆ‘å¾ˆé«˜å…´èƒ½å¸®åŠ©ä½ å­¦ä¹ ç¼–ç¨‹ã€‚"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    HumanMessage<span class="token punctuation">(</span>content<span class="token operator">=</span><span class="token string">"æˆ‘æ˜¯è°ï¼Ÿ"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span>ret <span class="token operator">=</span> llm<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span>messages<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>ret<span class="token punctuation">.</span>content<span class="token punctuation">)</span>  <span class="token comment"># è¿”å›çš„å†…å®¹æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><b>åˆ’é‡ç‚¹ï¼š</b>é€šè¿‡æ¨¡å‹å°è£…ï¼Œå®ç°ä¸åŒæ¨¡å‹çš„ç»Ÿä¸€æ¥å£è°ƒç”¨</p></blockquote><h3 id="1-2-æ¨¡å‹çš„è¾“å…¥ä¸è¾“å‡º"><a href="#1-2-æ¨¡å‹çš„è¾“å…¥ä¸è¾“å‡º" class="headerlink" title="1.2 æ¨¡å‹çš„è¾“å…¥ä¸è¾“å‡º"></a>1.2 æ¨¡å‹çš„è¾“å…¥ä¸è¾“å‡º</h3><h4 id="1-2-1-Prompt-æ¨¡æ¿å°è£…"><a href="#1-2-1-Prompt-æ¨¡æ¿å°è£…" class="headerlink" title="1.2.1 Prompt æ¨¡æ¿å°è£…"></a>1.2.1 Prompt æ¨¡æ¿å°è£…</h4><ol><li>PromptTemplate å¯ä»¥åœ¨æ¨¡æ¿ä¸­è‡ªå®šä¹‰å˜é‡</li></ol><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> langchain<span class="token punctuation">.</span>prompts <span class="token keyword">import</span> PromptTemplatetemplate <span class="token operator">=</span> PromptTemplate<span class="token punctuation">.</span>from_template<span class="token punctuation">(</span><span class="token string">"ç»™æˆ‘è®²ä¸€ä¸ªå…³äº{topic}çš„ç¬‘è¯"</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"===Template==="</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"===Prompt==="</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>topic<span class="token operator">=</span><span class="token string">"å‰å°¼å¤ªç¾"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># ç›´æ¥ä½¿ç”¨æ¨¡æ¿ç”Ÿæˆ</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python">Prompt<span class="token keyword">from</span> langchain_openai <span class="token keyword">import</span> ChatOpenAIllm <span class="token operator">=</span> ChatOpenAI<span class="token punctuation">(</span>model<span class="token operator">=</span><span class="token string">"gpt-4o-mini"</span><span class="token punctuation">)</span>  <span class="token comment"># é»˜è®¤æ˜¯gpt-3.5-turbo</span>response <span class="token operator">=</span> llm<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>topic<span class="token operator">=</span><span class="token string">"å‰å°¼å¤ªç¾"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># æ‰“å°è¾“å‡º</span><span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>content<span class="token punctuation">)</span>  <span class="token comment"># è¿”å›çš„å†…å®¹æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>ChatPromptTemplate ç”¨æ¨¡æ¿è¡¨ç¤ºçš„å¯¹è¯ä¸Šä¸‹æ–‡</li></ol><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> langchain<span class="token punctuation">.</span>prompts <span class="token keyword">import</span> <span class="token punctuation">(</span>    ChatPromptTemplate<span class="token punctuation">,</span>    HumanMessagePromptTemplate<span class="token punctuation">,</span>    SystemMessagePromptTemplate<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token keyword">from</span> langchain_openai <span class="token keyword">import</span> ChatOpenAItemplate <span class="token operator">=</span> ChatPromptTemplate<span class="token punctuation">.</span>from_messages<span class="token punctuation">(</span>    <span class="token punctuation">[</span>        SystemMessagePromptTemplate<span class="token punctuation">.</span>from_template<span class="token punctuation">(</span><span class="token string">"ä½ æ˜¯ä¸€ä¸ª{product}çš„æ™ºèƒ½åŠ©æ‰‹ï¼Œä½ çš„åå­—å«{name}"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        HumanMessagePromptTemplate<span class="token punctuation">.</span>from_template<span class="token punctuation">(</span><span class="token string">"{query}"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">]</span><span class="token punctuation">)</span>llm <span class="token operator">=</span> ChatOpenAI<span class="token punctuation">(</span>model<span class="token operator">=</span><span class="token string">"gpt-4o-mini"</span><span class="token punctuation">)</span>  <span class="token comment"># é»˜è®¤æ˜¯gpt-3.5-turbo</span>prompt <span class="token operator">=</span> template<span class="token punctuation">.</span>format_messages<span class="token punctuation">(</span>    product<span class="token operator">=</span><span class="token string">"ç¼–ç¨‹å­¦ä¹ "</span><span class="token punctuation">,</span>    name<span class="token operator">=</span><span class="token string">"å¢¨æ™ºLogic"</span><span class="token punctuation">,</span>    query<span class="token operator">=</span><span class="token string">"ä½ æ˜¯è°ï¼Ÿ"</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>prompt<span class="token punctuation">)</span>  <span class="token comment"># æ‰“å°Prompt</span>ret <span class="token operator">=</span> llm<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span>prompt<span class="token punctuation">)</span>  <span class="token comment"># è°ƒç”¨LLM</span><span class="token keyword">print</span><span class="token punctuation">(</span>ret<span class="token punctuation">.</span>content<span class="token punctuation">)</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="3"><li>MessagesPlaceholder æŠŠå¤šè½®å¯¹è¯å˜æˆæ¨¡æ¿</li></ol><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> langchain<span class="token punctuation">.</span>prompts <span class="token keyword">import</span> <span class="token punctuation">(</span>    ChatPromptTemplate<span class="token punctuation">,</span>    HumanMessagePromptTemplate<span class="token punctuation">,</span>    MessagesPlaceholder<span class="token punctuation">,</span><span class="token punctuation">)</span>human_prompt <span class="token operator">=</span> <span class="token string">"Translate your answer to {language}."</span>human_message_template <span class="token operator">=</span> HumanMessagePromptTemplate<span class="token punctuation">.</span>from_template<span class="token punctuation">(</span>human_prompt<span class="token punctuation">)</span>chat_prompt <span class="token operator">=</span> ChatPromptTemplate<span class="token punctuation">.</span>from_messages<span class="token punctuation">(</span>    <span class="token comment"># variable_name æ˜¯ message placeholder åœ¨æ¨¡æ¿ä¸­çš„å˜é‡å</span>    <span class="token comment"># ç”¨äºåœ¨èµ‹å€¼æ—¶ä½¿ç”¨</span>    <span class="token punctuation">[</span>MessagesPlaceholder<span class="token punctuation">(</span><span class="token string">"history"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> human_message_template<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">from</span> langchain_core<span class="token punctuation">.</span>messages <span class="token keyword">import</span> AIMessage<span class="token punctuation">,</span> HumanMessagehuman_message <span class="token operator">=</span> HumanMessage<span class="token punctuation">(</span>content<span class="token operator">=</span><span class="token string">"Who is Elon Musk?"</span><span class="token punctuation">)</span>ai_message <span class="token operator">=</span> AIMessage<span class="token punctuation">(</span>    content<span class="token operator">=</span><span class="token string">"Elon Musk is a billionaire entrepreneur, inventor, and industrial designer."</span><span class="token punctuation">)</span>messages <span class="token operator">=</span> chat_prompt<span class="token punctuation">.</span>format_prompt<span class="token punctuation">(</span>    <span class="token comment"># å¯¹ "history" å˜é‡èµ‹å€¼ å’Œ "language" å˜é‡èµ‹å€¼</span>    history<span class="token operator">=</span><span class="token punctuation">[</span>human_message<span class="token punctuation">,</span> ai_message<span class="token punctuation">]</span><span class="token punctuation">,</span> language<span class="token operator">=</span><span class="token string">"ä¸­æ–‡"</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>messages<span class="token punctuation">.</span>to_messages<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># æ‰“å°æ¶ˆæ¯åˆ—è¡¨</span>result <span class="token operator">=</span> llm<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span>messages<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>content<span class="token punctuation">)</span>  <span class="token comment"># æ‰“å°ç»“æœ</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><b>åˆ’é‡ç‚¹ï¼š</b>æŠŠPromptæ¨¡æ¿çœ‹ä½œå¸¦æœ‰å‚æ•°çš„å‡½æ•°</p></blockquote><h4 id="1-2-2-ä»æ–‡ä»¶åŠ è½½-Prompt-æ¨¡æ¿"><a href="#1-2-2-ä»æ–‡ä»¶åŠ è½½-Prompt-æ¨¡æ¿" class="headerlink" title="1.2.2 ä»æ–‡ä»¶åŠ è½½ Prompt æ¨¡æ¿"></a>1.2.2 ä»æ–‡ä»¶åŠ è½½ Prompt æ¨¡æ¿</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> langchain<span class="token punctuation">.</span>prompts <span class="token keyword">import</span> PromptTemplatetemplate <span class="token operator">=</span> PromptTemplate<span class="token punctuation">.</span>from_file<span class="token punctuation">(</span><span class="token string">"example_prompt_template.txt"</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"===Template==="</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"===Prompt==="</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>topic<span class="token operator">=</span><span class="token string">'é»‘è‰²å¹½é»˜'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="1-3-ç»“æ„åŒ–è¾“å‡º"><a href="#1-3-ç»“æ„åŒ–è¾“å‡º" class="headerlink" title="1.3 ç»“æ„åŒ–è¾“å‡º"></a>1.3 ç»“æ„åŒ–è¾“å‡º</h3><h4 id="1-3-1-ç›´æ¥è¾“å‡º-Pydantic-å¯¹è±¡"><a href="#1-3-1-ç›´æ¥è¾“å‡º-Pydantic-å¯¹è±¡" class="headerlink" title="1.3.1 ç›´æ¥è¾“å‡º Pydantic å¯¹è±¡"></a>1.3.1 ç›´æ¥è¾“å‡º Pydantic å¯¹è±¡</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pydantic <span class="token keyword">import</span> BaseModel<span class="token punctuation">,</span> Field<span class="token comment"># å®šä¹‰ä½ çš„è¾“å‡ºå¯¹è±¡</span><span class="token keyword">class</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>    year<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">"Year"</span><span class="token punctuation">)</span>    month<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">"Month"</span><span class="token punctuation">)</span>    day<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">"Day"</span><span class="token punctuation">)</span>    era<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">"BC or AD"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> langchain<span class="token punctuation">.</span>prompts <span class="token keyword">import</span> PromptTemplate<span class="token punctuation">,</span> ChatPromptTemplate<span class="token punctuation">,</span> HumanMessagePromptTemplate<span class="token keyword">from</span> langchain_openai <span class="token keyword">import</span> ChatOpenAI<span class="token keyword">from</span> langchain_core<span class="token punctuation">.</span>output_parsers <span class="token keyword">import</span> PydanticOutputParsermodel_name <span class="token operator">=</span> <span class="token string">'gpt-4o-mini'</span>temperature <span class="token operator">=</span> <span class="token number">0</span>llm <span class="token operator">=</span> ChatOpenAI<span class="token punctuation">(</span>model_name<span class="token operator">=</span>model_name<span class="token punctuation">,</span> temperature<span class="token operator">=</span>temperature<span class="token punctuation">)</span><span class="token comment"># å®šä¹‰ç»“æ„åŒ–è¾“å‡ºçš„æ¨¡å‹</span>structured_llm <span class="token operator">=</span> llm<span class="token punctuation">.</span>with_structured_output<span class="token punctuation">(</span>Date<span class="token punctuation">)</span>template <span class="token operator">=</span> <span class="token triple-quoted-string string">"""æå–ç”¨æˆ·è¾“å…¥ä¸­çš„æ—¥æœŸã€‚ç”¨æˆ·è¾“å…¥:{query}"""</span>prompt <span class="token operator">=</span> PromptTemplate<span class="token punctuation">(</span>    template<span class="token operator">=</span>template<span class="token punctuation">,</span><span class="token punctuation">)</span>query <span class="token operator">=</span> <span class="token string">"2025å¹´å››æœˆ16æ—¥å¤©æ°”é˜´..."</span>input_prompt <span class="token operator">=</span> prompt<span class="token punctuation">.</span>format_prompt<span class="token punctuation">(</span>query<span class="token operator">=</span>query<span class="token punctuation">)</span>structured_llm<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span>input_prompt<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="1-3-2-è¾“å‡ºæŒ‡å®šæ ¼å¼çš„-JSON"><a href="#1-3-2-è¾“å‡ºæŒ‡å®šæ ¼å¼çš„-JSON" class="headerlink" title="1.3.2 è¾“å‡ºæŒ‡å®šæ ¼å¼çš„ JSON"></a>1.3.2 è¾“å‡ºæŒ‡å®šæ ¼å¼çš„ JSON</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python">json_schema <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string">"Date"</span><span class="token punctuation">,</span>    <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"Formated date expression"</span><span class="token punctuation">,</span>    <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"object"</span><span class="token punctuation">,</span>    <span class="token string">"properties"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>        <span class="token string">"year"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>            <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"integer"</span><span class="token punctuation">,</span>            <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"year, YYYY"</span><span class="token punctuation">,</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token string">"month"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>            <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"integer"</span><span class="token punctuation">,</span>            <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"month, MM"</span><span class="token punctuation">,</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token string">"day"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>            <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"integer"</span><span class="token punctuation">,</span>            <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"day, DD"</span><span class="token punctuation">,</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token string">"era"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>            <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>            <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"BC or AD"</span><span class="token punctuation">,</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span>structured_llm <span class="token operator">=</span> llm<span class="token punctuation">.</span>with_structured_output<span class="token punctuation">(</span>json_schema<span class="token punctuation">)</span>structured_llm<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span>input_prompt<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="1-3-3-ä½¿ç”¨-JsonOutputParser"><a href="#1-3-3-ä½¿ç”¨-JsonOutputParser" class="headerlink" title="1.3.3 ä½¿ç”¨ JsonOutputParser"></a>1.3.3 ä½¿ç”¨ JsonOutputParser</h4><p><a href="https://python.langchain.com/v0.2/docs/concepts/#output-parsers"><code>OutputParser</code></a> å¯ä»¥æŒ‰æŒ‡å®šæ ¼å¼è§£ææ¨¡å‹çš„è¾“å‡º</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> langchain_core<span class="token punctuation">.</span>output_parsers <span class="token keyword">import</span> JsonOutputParserparser <span class="token operator">=</span> JsonOutputParser<span class="token punctuation">(</span>pydantic_object<span class="token operator">=</span>Date<span class="token punctuation">)</span>prompt <span class="token operator">=</span> PromptTemplate<span class="token punctuation">(</span>    template<span class="token operator">=</span><span class="token string">"æå–ç”¨æˆ·è¾“å…¥ä¸­çš„æ—¥æœŸã€‚\nç”¨æˆ·è¾“å…¥:{query}\n{format_instructions}"</span><span class="token punctuation">,</span>    input_variables<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"query"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    partial_variables<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"format_instructions"</span><span class="token punctuation">:</span> parser<span class="token punctuation">.</span>get_format_instructions<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">)</span>input_prompt <span class="token operator">=</span> prompt<span class="token punctuation">.</span>format_prompt<span class="token punctuation">(</span>query<span class="token operator">=</span>query<span class="token punctuation">)</span>output <span class="token operator">=</span> llm<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span>input_prompt<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"åŸå§‹è¾“å‡º:\n"</span><span class="token operator">+</span>output<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\nè§£æå:"</span><span class="token punctuation">)</span>parser<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span>output<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¹Ÿå¯ä»¥ç”¨ <code>PydanticOutputParser</code></p><blockquote><p><b>è¿™é‡Œåœ¨Pycharmä¸­éœ€è¦ç”¨å‚æ•°æ¥æ”¶parser.invoke(output)çš„å€¼ï¼Œç„¶åç”¨printæ‰“å°å‡ºæ¥æ‰èƒ½åœ¨ç»ˆç«¯æ˜¾ç¤ºç»“æœå†…å®¹ï¼Œå¦åˆ™æ˜¯ç©ºç™½ã€‚åç»­çš„åœ°æ–¹éƒ½ç±»ä¼¼</b></p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> langchain_core<span class="token punctuation">.</span>output_parsers <span class="token keyword">import</span> PydanticOutputParserparser <span class="token operator">=</span> PydanticOutputParser<span class="token punctuation">(</span>pydantic_object<span class="token operator">=</span>Date<span class="token punctuation">)</span>input_prompt <span class="token operator">=</span> prompt<span class="token punctuation">.</span>format_prompt<span class="token punctuation">(</span>query<span class="token operator">=</span>query<span class="token punctuation">)</span>output <span class="token operator">=</span> llm<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span>input_prompt<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"åŸå§‹è¾“å‡º:\n"</span><span class="token operator">+</span>output<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\nè§£æå:"</span><span class="token punctuation">)</span>parser<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span>output<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>OutputFixingParser</code> åˆ©ç”¨å¤§æ¨¡å‹åšæ ¼å¼è‡ªåŠ¨çº é”™</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> langchain<span class="token punctuation">.</span>output_parsers <span class="token keyword">import</span> OutputFixingParsernew_parser <span class="token operator">=</span> OutputFixingParser<span class="token punctuation">.</span>from_llm<span class="token punctuation">(</span>parser<span class="token operator">=</span>parser<span class="token punctuation">,</span> llm<span class="token operator">=</span>ChatOpenAI<span class="token punctuation">(</span>model<span class="token operator">=</span><span class="token string">"gpt-4o"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>bad_output <span class="token operator">=</span> output<span class="token punctuation">.</span>content<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"5"</span><span class="token punctuation">,</span><span class="token string">"äº”"</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"PydanticOutputParser:"</span><span class="token punctuation">)</span><span class="token keyword">try</span><span class="token punctuation">:</span>    parser<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span>bad_output<span class="token punctuation">)</span><span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"OutputFixingParser:"</span><span class="token punctuation">)</span>new_parser<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span>bad_output<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="1-4-Function-Calling"><a href="#1-4-Function-Calling" class="headerlink" title="1.4 Function Calling"></a>1.4 Function Calling</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> langchain_core<span class="token punctuation">.</span>tools <span class="token keyword">import</span> tool<span class="token decorator annotation punctuation">@tool</span><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>a<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> b<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">int</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""Add two integers.    Args:        a: First integer        b: Second integer    """</span>    <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token decorator annotation punctuation">@tool</span><span class="token keyword">def</span> <span class="token function">multiply</span><span class="token punctuation">(</span>a<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> b<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">int</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""Multiply two integers.    Args:        a: First integer        b: Second integer    """</span>    <span class="token keyword">return</span> a <span class="token operator">*</span> b<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> jsonllm_with_tools <span class="token operator">=</span> llm<span class="token punctuation">.</span>bind_tools<span class="token punctuation">(</span><span class="token punctuation">[</span>add<span class="token punctuation">,</span> multiply<span class="token punctuation">]</span><span class="token punctuation">)</span>query <span class="token operator">=</span> <span class="token string">"3çš„4å€æ˜¯å¤šå°‘?"</span>messages <span class="token operator">=</span> <span class="token punctuation">[</span>HumanMessage<span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">]</span>output <span class="token operator">=</span> llm_with_tools<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span>messages<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>output<span class="token punctuation">.</span>tool_calls<span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å›ä¼  Funtion Call çš„ç»“æœ</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span>output<span class="token punctuation">)</span>available_tools <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"add"</span><span class="token punctuation">:</span> add<span class="token punctuation">,</span> <span class="token string">"multiply"</span><span class="token punctuation">:</span> multiply<span class="token punctuation">}</span><span class="token keyword">for</span> tool_call <span class="token keyword">in</span> output<span class="token punctuation">.</span>tool_calls<span class="token punctuation">:</span>    selected_tool <span class="token operator">=</span> available_tools<span class="token punctuation">[</span>tool_call<span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>    tool_msg <span class="token operator">=</span> selected_tool<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span>tool_call<span class="token punctuation">)</span>    messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span>tool_msg<span class="token punctuation">)</span>new_output <span class="token operator">=</span> llm_with_tools<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span>messages<span class="token punctuation">)</span><span class="token keyword">for</span> message <span class="token keyword">in</span> messages<span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>new_output<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="1-5-å°ç»“"><a href="#1-5-å°ç»“" class="headerlink" title="1.5 å°ç»“"></a>1.5 å°ç»“</h3><ol><li>LangChain ç»Ÿä¸€å°è£…äº†å„ç§æ¨¡å‹çš„è°ƒç”¨æ¥å£ï¼ŒåŒ…æ‹¬è¡¥å…¨å‹å’Œå¯¹è¯å‹ä¸¤ç§</li><li>LangChain æä¾›äº† PromptTemplate ç±»ï¼Œå¯ä»¥è‡ªå®šä¹‰å¸¦å˜é‡çš„æ¨¡æ¿</li><li>LangChain æä¾›äº†ä¸€äº›åˆ—è¾“å‡ºè§£æå™¨ï¼Œç”¨äºå°†å¤§æ¨¡å‹çš„è¾“å‡ºè§£ææˆç»“æ„åŒ–å¯¹è±¡</li><li>LangChain æä¾›äº† Function Calling çš„å°è£…</li><li>ä¸Šè¿°æ¨¡å‹å±äº LangChain ä¸­è¾ƒä¸ºå®ç”¨çš„éƒ¨åˆ†</li></ol><h2 id="äºŒã€æ•°æ®è¿æ¥å°è£…"><a href="#äºŒã€æ•°æ®è¿æ¥å°è£…" class="headerlink" title="äºŒã€æ•°æ®è¿æ¥å°è£…"></a>äºŒã€æ•°æ®è¿æ¥å°è£…</h2><h3 id="2-1-æ–‡æ¡£åŠ è½½å™¨ï¼šDocument-Loaders"><a href="#2-1-æ–‡æ¡£åŠ è½½å™¨ï¼šDocument-Loaders" class="headerlink" title="2.1 æ–‡æ¡£åŠ è½½å™¨ï¼šDocument Loaders"></a>2.1 æ–‡æ¡£åŠ è½½å™¨ï¼šDocument Loaders</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip <span class="token function">install</span> pymupdf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>document_loaders <span class="token keyword">import</span> PyMuPDFLoaderloader <span class="token operator">=</span> PyMuPDFLoader<span class="token punctuation">(</span><span class="token string">"llama2.pdf"</span><span class="token punctuation">)</span>pages <span class="token operator">=</span> loader<span class="token punctuation">.</span>load_and_split<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>pages<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>page_content<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-2-æ–‡æ¡£å¤„ç†å™¨"><a href="#2-2-æ–‡æ¡£å¤„ç†å™¨" class="headerlink" title="2.2 æ–‡æ¡£å¤„ç†å™¨"></a>2.2 æ–‡æ¡£å¤„ç†å™¨</h3><h4 id="2-2-1-TextSplitter"><a href="#2-2-1-TextSplitter" class="headerlink" title="2.2.1 TextSplitter"></a>2.2.1 TextSplitter</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python">pip install <span class="token operator">-</span><span class="token operator">-</span>upgrade langchain<span class="token operator">-</span>text<span class="token operator">-</span>splitters<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> langchain_text_splitters <span class="token keyword">import</span> RecursiveCharacterTextSplitter<span class="token comment"># ç®€å•çš„æ–‡æœ¬å†…å®¹åˆ‡å‰²</span>text_splitter <span class="token operator">=</span> RecursiveCharacterTextSplitter<span class="token punctuation">(</span>    chunk_size<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">,</span>    chunk_overlap<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span>     length_function<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">,</span>    add_start_index<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span><span class="token punctuation">)</span>paragraphs <span class="token operator">=</span> text_splitter<span class="token punctuation">.</span>create_documents<span class="token punctuation">(</span><span class="token punctuation">[</span>pages<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>page_content<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">for</span> para <span class="token keyword">in</span> paragraphs<span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>para<span class="token punctuation">.</span>page_content<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'-------'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="alert alert-info">ç±»ä¼¼ LlamaIndexï¼ŒLangChain ä¹Ÿæä¾›äº†ä¸°å¯Œçš„ <code><a href="https://python.langchain.com/v0.2/docs/how_to/#document-loaders">Document Loaders</a></code> å’Œ <code><a href="https://python.langchain.com/v0.2/docs/how_to/#text-splitters">Text Splitters</a></code>ã€‚</div><h3 id="2-3-å‘é‡æ•°æ®åº“ä¸å‘é‡æ£€ç´¢"><a href="#2-3-å‘é‡æ•°æ®åº“ä¸å‘é‡æ£€ç´¢" class="headerlink" title="2.3 å‘é‡æ•°æ®åº“ä¸å‘é‡æ£€ç´¢"></a>2.3 å‘é‡æ•°æ®åº“ä¸å‘é‡æ£€ç´¢</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">conda <span class="token function">install</span> <span class="token parameter variable">-c</span> pytorch faiss-cpu<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> langchain_openai <span class="token keyword">import</span> OpenAIEmbeddings<span class="token punctuation">,</span> ChatOpenAI<span class="token keyword">from</span> langchain_text_splitters <span class="token keyword">import</span> RecursiveCharacterTextSplitter<span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>vectorstores <span class="token keyword">import</span> FAISS<span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>document_loaders <span class="token keyword">import</span> PyMuPDFLoader<span class="token comment"># åŠ è½½æ–‡æ¡£</span>loader <span class="token operator">=</span> PyMuPDFLoader<span class="token punctuation">(</span><span class="token string">"llama2.pdf"</span><span class="token punctuation">)</span>pages <span class="token operator">=</span> loader<span class="token punctuation">.</span>load_and_split<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># æ–‡æ¡£åˆ‡åˆ†</span>text_splitter <span class="token operator">=</span> RecursiveCharacterTextSplitter<span class="token punctuation">(</span>    chunk_size<span class="token operator">=</span><span class="token number">300</span><span class="token punctuation">,</span>    chunk_overlap<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span>    length_function<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">,</span>    add_start_index<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span><span class="token punctuation">)</span>texts <span class="token operator">=</span> text_splitter<span class="token punctuation">.</span>create_documents<span class="token punctuation">(</span>    <span class="token punctuation">[</span>page<span class="token punctuation">.</span>page_content <span class="token keyword">for</span> page <span class="token keyword">in</span> pages<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment"># çŒåº“</span>embeddings <span class="token operator">=</span> OpenAIEmbeddings<span class="token punctuation">(</span>model<span class="token operator">=</span><span class="token string">"text-embedding-ada-002"</span><span class="token punctuation">)</span>db <span class="token operator">=</span> FAISS<span class="token punctuation">.</span>from_documents<span class="token punctuation">(</span>texts<span class="token punctuation">,</span> embeddings<span class="token punctuation">)</span><span class="token comment"># æ£€ç´¢ top-3 ç»“æœ</span>retriever <span class="token operator">=</span> db<span class="token punctuation">.</span>as_retriever<span class="token punctuation">(</span>search_kwargs<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"k"</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">)</span>docs <span class="token operator">=</span> retriever<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span><span class="token string">"llama2æœ‰å¤šå°‘å‚æ•°"</span><span class="token punctuation">)</span><span class="token comment"># æ‰“å°æ£€ç´¢åˆ°çš„æ–‡æ¡£</span><span class="token keyword">for</span> doc <span class="token keyword">in</span> docs<span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>doc<span class="token punctuation">.</span>page_content<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"----"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ›´å¤šçš„ä¸‰æ–¹æ£€ç´¢ç»„ä»¶é“¾æ¥ï¼Œå‚è€ƒï¼š<a href="https://python.langchain.com/v0.3/docs/integrations/vectorstores/">https://python.langchain.com/v0.3/docs/integrations/vectorstores/</a></p><h3 id="2-4ã€å°ç»“"><a href="#2-4ã€å°ç»“" class="headerlink" title="2.4ã€å°ç»“"></a>2.4ã€å°ç»“</h3><ol><li>æ–‡æ¡£å¤„ç†éƒ¨åˆ†ï¼Œå»ºè®®åœ¨å®é™…åº”ç”¨ä¸­è¯¦ç»†æµ‹è¯•åä½¿ç”¨</li><li>ä¸å‘é‡æ•°æ®åº“çš„é“¾æ¥éƒ¨åˆ†æœ¬è´¨æ˜¯æ¥å£å°è£…ï¼Œå‘é‡æ•°æ®åº“éœ€è¦è‡ªå·±é€‰å‹</li></ol><h2 id="ä¸‰ã€å¯¹è¯å†å²ç®¡ç†"><a href="#ä¸‰ã€å¯¹è¯å†å²ç®¡ç†" class="headerlink" title="ä¸‰ã€å¯¹è¯å†å²ç®¡ç†"></a>ä¸‰ã€å¯¹è¯å†å²ç®¡ç†</h2><h3 id="3-1ã€å†å²è®°å½•çš„å‰ªè£"><a href="#3-1ã€å†å²è®°å½•çš„å‰ªè£" class="headerlink" title="3.1ã€å†å²è®°å½•çš„å‰ªè£"></a>3.1ã€å†å²è®°å½•çš„å‰ªè£</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> langchain_core<span class="token punctuation">.</span>messages <span class="token keyword">import</span> <span class="token punctuation">(</span>    AIMessage<span class="token punctuation">,</span>    HumanMessage<span class="token punctuation">,</span>    SystemMessage<span class="token punctuation">,</span>    trim_messages<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token keyword">from</span> langchain_openai <span class="token keyword">import</span> ChatOpenAImessages <span class="token operator">=</span> <span class="token punctuation">[</span>    SystemMessage<span class="token punctuation">(</span><span class="token string">"you're a good assistant, you always respond with a joke."</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    HumanMessage<span class="token punctuation">(</span><span class="token string">"i wonder why it's called langchain"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    AIMessage<span class="token punctuation">(</span>        <span class="token string">'Well, I guess they thought "WordRope" and "SentenceString" just didn\'t have the same ring to it!'</span>    <span class="token punctuation">)</span><span class="token punctuation">,</span>    HumanMessage<span class="token punctuation">(</span><span class="token string">"and who is harrison chasing anyways"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    AIMessage<span class="token punctuation">(</span>        <span class="token string">"Hmmm let me think.\n\nWhy, he's probably chasing after the last cup of coffee in the office!"</span>    <span class="token punctuation">)</span><span class="token punctuation">,</span>    HumanMessage<span class="token punctuation">(</span><span class="token string">"what do you call a speechless parrot"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span>trim_messages<span class="token punctuation">(</span>    messages<span class="token punctuation">,</span>    max_tokens<span class="token operator">=</span><span class="token number">45</span><span class="token punctuation">,</span>    strategy<span class="token operator">=</span><span class="token string">"last"</span><span class="token punctuation">,</span>    token_counter<span class="token operator">=</span>ChatOpenAI<span class="token punctuation">(</span>model<span class="token operator">=</span><span class="token string">"gpt-4o-mini"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># ä¿ç•™ system prompt</span>trim_messages<span class="token punctuation">(</span>    messages<span class="token punctuation">,</span>    max_tokens<span class="token operator">=</span><span class="token number">45</span><span class="token punctuation">,</span>    strategy<span class="token operator">=</span><span class="token string">"last"</span><span class="token punctuation">,</span>    token_counter<span class="token operator">=</span>ChatOpenAI<span class="token punctuation">(</span>model<span class="token operator">=</span><span class="token string">"gpt-4o-mini"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    include_system<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>    allow_partial<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-2ã€è¿‡æ»¤å¸¦æ ‡è¯†çš„å†å²è®°å½•"><a href="#3-2ã€è¿‡æ»¤å¸¦æ ‡è¯†çš„å†å²è®°å½•" class="headerlink" title="3.2ã€è¿‡æ»¤å¸¦æ ‡è¯†çš„å†å²è®°å½•"></a>3.2ã€è¿‡æ»¤å¸¦æ ‡è¯†çš„å†å²è®°å½•</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> langchain_core<span class="token punctuation">.</span>messages <span class="token keyword">import</span> <span class="token punctuation">(</span>    AIMessage<span class="token punctuation">,</span>    HumanMessage<span class="token punctuation">,</span>    SystemMessage<span class="token punctuation">,</span>    filter_messages<span class="token punctuation">,</span><span class="token punctuation">)</span>messages <span class="token operator">=</span> <span class="token punctuation">[</span>    SystemMessage<span class="token punctuation">(</span><span class="token string">"you are a good assistant"</span><span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token operator">=</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    HumanMessage<span class="token punctuation">(</span><span class="token string">"example input"</span><span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token operator">=</span><span class="token string">"2"</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"example_user"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    AIMessage<span class="token punctuation">(</span><span class="token string">"example output"</span><span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token operator">=</span><span class="token string">"3"</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"example_assistant"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    HumanMessage<span class="token punctuation">(</span><span class="token string">"real input"</span><span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token operator">=</span><span class="token string">"4"</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"bob"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    AIMessage<span class="token punctuation">(</span><span class="token string">"real output"</span><span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token operator">=</span><span class="token string">"5"</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"alice"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token comment"># ä¿ç•™åŒ…å«çš„æ¶ˆæ¯</span>filter_messages<span class="token punctuation">(</span>messages<span class="token punctuation">,</span> include_types<span class="token operator">=</span><span class="token string">"human"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># ä¿ç•™ä¸åŒ…å«çš„ä¿¡æ¯</span>filter_messages<span class="token punctuation">(</span>messages<span class="token punctuation">,</span> exclude_names<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"example_user"</span><span class="token punctuation">,</span> <span class="token string">"example_assistant"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># ä¿ç•™åŒ…å«çš„æ¶ˆæ¯å’Œä¸åŒ…å«çš„ä¿¡æ¯</span>filter_messages<span class="token punctuation">(</span>messages<span class="token punctuation">,</span> include_types<span class="token operator">=</span><span class="token punctuation">[</span>HumanMessage<span class="token punctuation">,</span> AIMessage<span class="token punctuation">]</span><span class="token punctuation">,</span> exclude_ids<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"3"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="å››ã€Chain-å’Œ-LangChain-Expression-Language-LCEL"><a href="#å››ã€Chain-å’Œ-LangChain-Expression-Language-LCEL" class="headerlink" title="å››ã€Chain å’Œ LangChain Expression Language (LCEL)"></a>å››ã€Chain å’Œ LangChain Expression Language (LCEL)</h2><p>LangChain Expression Languageï¼ˆLCELï¼‰æ˜¯ä¸€ç§å£°æ˜å¼è¯­è¨€ï¼Œå¯è½»æ¾ç»„åˆä¸åŒçš„è°ƒç”¨é¡ºåºæ„æˆ Chainã€‚LCEL è‡ªåˆ›ç«‹ä¹‹åˆå°±è¢«è®¾è®¡ä¸ºèƒ½å¤Ÿæ”¯æŒå°†åŸå‹æŠ•å…¥ç”Ÿäº§ç¯å¢ƒï¼Œ<strong>æ— éœ€ä»£ç æ›´æ”¹</strong>ï¼Œä»æœ€ç®€å•çš„â€œæç¤º+LLMâ€é“¾åˆ°æœ€å¤æ‚çš„é“¾ï¼ˆå·²æœ‰ç”¨æˆ·æˆåŠŸåœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¿è¡ŒåŒ…å«æ•°ç™¾ä¸ªæ­¥éª¤çš„ LCEL Chainï¼‰ã€‚</p><p>LCEL çš„ä¸€äº›äº®ç‚¹åŒ…æ‹¬ï¼š</p><ol><li><p><strong>æµæ”¯æŒ</strong>ï¼šä½¿ç”¨ LCEL æ„å»º Chain æ—¶ï¼Œä½ å¯ä»¥è·å¾—æœ€ä½³çš„é¦–ä¸ªä»¤ç‰Œæ—¶é—´ï¼ˆå³ä»è¾“å‡ºå¼€å§‹åˆ°é¦–æ‰¹è¾“å‡ºç”Ÿæˆçš„æ—¶é—´ï¼‰ã€‚å¯¹äºæŸäº› Chainï¼Œè¿™æ„å‘³ç€å¯ä»¥ç›´æ¥ä» LLM æµå¼ä¼ è¾“ä»¤ç‰Œåˆ°æµè¾“å‡ºè§£æå™¨ï¼Œä»è€Œä»¥ä¸ LLM æä¾›å•†è¾“å‡ºåŸå§‹ä»¤ç‰Œç›¸åŒçš„é€Ÿç‡è·å¾—è§£æåçš„ã€å¢é‡çš„è¾“å‡ºã€‚</p></li><li><p><strong>å¼‚æ­¥æ”¯æŒ</strong>ï¼šä»»ä½•ä½¿ç”¨ LCEL æ„å»ºçš„é“¾æ¡éƒ½å¯ä»¥é€šè¿‡åŒæ­¥ APIï¼ˆä¾‹å¦‚ï¼Œåœ¨ Jupyter ç¬”è®°æœ¬ä¸­è¿›è¡ŒåŸå‹è®¾è®¡æ—¶ï¼‰å’Œå¼‚æ­¥ APIï¼ˆä¾‹å¦‚ï¼Œåœ¨ LangServe æœåŠ¡å™¨ä¸­ï¼‰è°ƒç”¨ã€‚è¿™ä½¿å¾—ç›¸åŒçš„ä»£ç å¯ç”¨äºåŸå‹è®¾è®¡å’Œç”Ÿäº§ç¯å¢ƒï¼Œå…·æœ‰å‡ºè‰²çš„æ€§èƒ½ï¼Œå¹¶èƒ½å¤Ÿåœ¨åŒä¸€æœåŠ¡å™¨ä¸­å¤„ç†å¤šä¸ªå¹¶å‘è¯·æ±‚ã€‚</p></li><li><p><strong>ä¼˜åŒ–çš„å¹¶è¡Œæ‰§è¡Œ</strong>ï¼šå½“ä½ çš„ LCEL é“¾æ¡æœ‰å¯ä»¥å¹¶è¡Œæ‰§è¡Œçš„æ­¥éª¤æ—¶ï¼ˆä¾‹å¦‚ï¼Œä»å¤šä¸ªæ£€ç´¢å™¨ä¸­è·å–æ–‡æ¡£ï¼‰ï¼Œæˆ‘ä»¬ä¼šè‡ªåŠ¨æ‰§è¡Œï¼Œæ— è®ºæ˜¯åœ¨åŒæ­¥è¿˜æ˜¯å¼‚æ­¥æ¥å£ä¸­ï¼Œä»¥å®ç°æœ€å°çš„å»¶è¿Ÿã€‚</p></li><li><p><strong>é‡è¯•å’Œå›é€€</strong>ï¼šä¸º LCEL é“¾çš„ä»»ä½•éƒ¨åˆ†é…ç½®é‡è¯•å’Œå›é€€ã€‚è¿™æ˜¯ä½¿é“¾åœ¨è§„æ¨¡ä¸Šæ›´å¯é çš„ç»ä½³æ–¹å¼ã€‚ç›®å‰æˆ‘ä»¬æ­£åœ¨æ·»åŠ é‡è¯•/å›é€€çš„æµåª’ä½“æ”¯æŒï¼Œå› æ­¤ä½ å¯ä»¥åœ¨ä¸å¢åŠ ä»»ä½•å»¶è¿Ÿæˆæœ¬çš„æƒ…å†µä¸‹è·å¾—å¢åŠ çš„å¯é æ€§ã€‚</p></li><li><p><strong>è®¿é—®ä¸­é—´ç»“æœ</strong>ï¼šå¯¹äºæ›´å¤æ‚çš„é“¾æ¡ï¼Œè®¿é—®åœ¨æœ€ç»ˆè¾“å‡ºäº§ç”Ÿä¹‹å‰çš„ä¸­é—´æ­¥éª¤çš„ç»“æœé€šå¸¸éå¸¸æœ‰ç”¨ã€‚è¿™å¯ä»¥ç”¨äºè®©æœ€ç»ˆç”¨æˆ·çŸ¥é“æ­£åœ¨å‘ç”Ÿä¸€äº›äº‹æƒ…ï¼Œç”šè‡³ä»…ç”¨äºè°ƒè¯•é“¾æ¡ã€‚ä½ å¯ä»¥æµå¼ä¼ è¾“ä¸­é—´ç»“æœï¼Œå¹¶ä¸”åœ¨æ¯ä¸ª LangServe æœåŠ¡å™¨ä¸Šéƒ½å¯ç”¨ã€‚</p></li><li><p><strong>è¾“å…¥å’Œè¾“å‡ºæ¨¡å¼</strong>ï¼šè¾“å…¥å’Œè¾“å‡ºæ¨¡å¼ä¸ºæ¯ä¸ª LCEL é“¾æä¾›äº†ä»é“¾çš„ç»“æ„æ¨æ–­å‡ºçš„ Pydantic å’Œ JSONSchema æ¨¡å¼ã€‚è¿™å¯ä»¥ç”¨äºè¾“å…¥å’Œè¾“å‡ºçš„éªŒè¯ï¼Œæ˜¯ LangServe çš„ä¸€ä¸ªç»„æˆéƒ¨åˆ†ã€‚</p></li><li><p><strong>æ— ç¼ LangSmith è·Ÿè¸ªé›†æˆ</strong>ï¼šéšç€é“¾æ¡å˜å¾—è¶Šæ¥è¶Šå¤æ‚ï¼Œç†è§£æ¯ä¸€æ­¥å‘ç”Ÿäº†ä»€ä¹ˆå˜å¾—è¶Šæ¥è¶Šé‡è¦ã€‚é€šè¿‡ LCELï¼Œæ‰€æœ‰æ­¥éª¤éƒ½è‡ªåŠ¨è®°å½•åˆ° LangSmithï¼Œä»¥å®ç°æœ€å¤§çš„å¯è§‚å¯Ÿæ€§å’Œå¯è°ƒè¯•æ€§ã€‚</p></li><li><p><strong>æ— ç¼ LangServe éƒ¨ç½²é›†æˆ</strong>ï¼šä»»ä½•ä½¿ç”¨ LCEL åˆ›å»ºçš„é“¾éƒ½å¯ä»¥è½»æ¾åœ°ä½¿ç”¨ LangServe è¿›è¡Œéƒ¨ç½²ã€‚</p></li></ol><p>åŸæ–‡ï¼š<a href="https://python.langchain.com/docs/expression_language/">https://python.langchain.com/docs/expression_language/</a></p><h3 id="4-1-Pipeline-å¼è°ƒç”¨-PromptTemplate-LLM-å’Œ-OutputParser"><a href="#4-1-Pipeline-å¼è°ƒç”¨-PromptTemplate-LLM-å’Œ-OutputParser" class="headerlink" title="4.1 Pipeline å¼è°ƒç”¨ PromptTemplate, LLM å’Œ OutputParser"></a>4.1 Pipeline å¼è°ƒç”¨ PromptTemplate, LLM å’Œ OutputParser</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> langchain_openai <span class="token keyword">import</span> ChatOpenAI<span class="token keyword">from</span> langchain<span class="token punctuation">.</span>prompts <span class="token keyword">import</span> PromptTemplate<span class="token punctuation">,</span> ChatPromptTemplate<span class="token keyword">from</span> langchain_core<span class="token punctuation">.</span>output_parsers <span class="token keyword">import</span> StrOutputParser<span class="token keyword">from</span> langchain_core<span class="token punctuation">.</span>runnables <span class="token keyword">import</span> RunnablePassthrough<span class="token keyword">from</span> pydantic <span class="token keyword">import</span> BaseModel<span class="token punctuation">,</span> Field<span class="token punctuation">,</span> validator<span class="token keyword">from</span> typing <span class="token keyword">import</span> List<span class="token punctuation">,</span> Dict<span class="token punctuation">,</span> Optional<span class="token keyword">from</span> enum <span class="token keyword">import</span> Enum<span class="token keyword">import</span> json<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># è¾“å‡ºç»“æ„</span><span class="token keyword">class</span> <span class="token class-name">SortEnum</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">,</span> Enum<span class="token punctuation">)</span><span class="token punctuation">:</span>    data <span class="token operator">=</span> <span class="token string">'data'</span>    price <span class="token operator">=</span> <span class="token string">'price'</span><span class="token keyword">class</span> <span class="token class-name">OrderingEnum</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">,</span> Enum<span class="token punctuation">)</span><span class="token punctuation">:</span>    ascend <span class="token operator">=</span> <span class="token string">'ascend'</span>    descend <span class="token operator">=</span> <span class="token string">'descend'</span><span class="token keyword">class</span> <span class="token class-name">Semantics</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>    name<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">"æµé‡åŒ…åç§°"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>    price_lower<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">"ä»·æ ¼ä¸‹é™"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>    price_upper<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">"ä»·æ ¼ä¸Šé™"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>    data_lower<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">"æµé‡ä¸‹é™"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>    data_upper<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">"æµé‡ä¸Šé™"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>    sort_by<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>SortEnum<span class="token punctuation">]</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">"æŒ‰ä»·æ ¼æˆ–æµé‡æ’åº"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>    ordering<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>OrderingEnum<span class="token punctuation">]</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">"å‡åºæˆ–é™åºæ’åˆ—"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token comment"># Prompt æ¨¡æ¿</span>prompt <span class="token operator">=</span> ChatPromptTemplate<span class="token punctuation">.</span>from_messages<span class="token punctuation">(</span>    <span class="token punctuation">[</span>        <span class="token punctuation">(</span><span class="token string">"system"</span><span class="token punctuation">,</span> <span class="token string">"ä½ æ˜¯ä¸€ä¸ªè¯­ä¹‰è§£æå™¨ã€‚ä½ çš„ä»»åŠ¡æ˜¯å°†ç”¨æˆ·çš„è¾“å…¥è§£ææˆJSONè¡¨ç¤ºã€‚ä¸è¦å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">(</span><span class="token string">"human"</span><span class="token punctuation">,</span> <span class="token string">"{text}"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment"># æ¨¡å‹</span>llm <span class="token operator">=</span> ChatOpenAI<span class="token punctuation">(</span>model<span class="token operator">=</span><span class="token string">"gpt-4o"</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>structured_llm <span class="token operator">=</span> llm<span class="token punctuation">.</span>with_structured_output<span class="token punctuation">(</span>Semantics<span class="token punctuation">)</span><span class="token comment"># LCEL è¡¨è¾¾å¼</span>runnable <span class="token operator">=</span> <span class="token punctuation">(</span>    <span class="token punctuation">{</span><span class="token string">"text"</span><span class="token punctuation">:</span> RunnablePassthrough<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token operator">|</span> prompt <span class="token operator">|</span> structured_llm<span class="token punctuation">)</span><span class="token comment"># ç›´æ¥è¿è¡Œ</span>ret <span class="token operator">=</span> runnable<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span><span class="token string">"ä¸è¶…è¿‡100å…ƒçš„æµé‡å¤§çš„å¥—é¤æœ‰å“ªäº›"</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>    json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>        ret<span class="token punctuation">.</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        indent <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span>        ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span>    <span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="æµå¼è¾“å‡º"><a href="#æµå¼è¾“å‡º" class="headerlink" title="æµå¼è¾“å‡º"></a>æµå¼è¾“å‡º</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python">prompt <span class="token operator">=</span> PromptTemplate<span class="token punctuation">.</span>from_template<span class="token punctuation">(</span><span class="token string">"è®²ä¸ªå…³äº{topic}çš„ç¬‘è¯"</span><span class="token punctuation">)</span>runnable <span class="token operator">=</span> <span class="token punctuation">(</span>    <span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token punctuation">:</span> RunnablePassthrough<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token operator">|</span> prompt <span class="token operator">|</span> llm <span class="token operator">|</span> StrOutputParser<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#### æµå¼è¾“å‡º</span><span class="token keyword">for</span> s <span class="token keyword">in</span> runnable<span class="token punctuation">.</span>stream<span class="token punctuation">(</span><span class="token string">"å°æ˜"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">,</span> flush<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><b>æ³¨æ„:</b> åœ¨å½“å‰çš„æ–‡æ¡£ä¸­ LCEL äº§ç”Ÿçš„å¯¹è±¡ï¼Œè¢«å«åš runnable æˆ– chainï¼Œç»å¸¸ä¸¤ç§å«æ³•æ··ç”¨ã€‚æœ¬è´¨å°±æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰è°ƒç”¨æµç¨‹ã€‚</p></blockquote><blockquote><p><b>ä½¿ç”¨ LCEL çš„ä»·å€¼ï¼Œä¹Ÿå°±æ˜¯ LangChain çš„æ ¸å¿ƒä»·å€¼ã€‚</b><br>å®˜æ–¹ä»ä¸åŒè§’åº¦ç»™å‡ºäº†ä¸¾ä¾‹è¯´æ˜ï¼š<a href="https://python.langchain.com/v0.1/docs/expression_language/why/">https://python.langchain.com/v0.1/docs/expression_language/why/</a></p></blockquote><h3 id="4-2-ç”¨-LCEL-å®ç°-RAG"><a href="#4-2-ç”¨-LCEL-å®ç°-RAG" class="headerlink" title="4.2 ç”¨ LCEL å®ç° RAG"></a>4.2 ç”¨ LCEL å®ç° RAG</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> langchain_openai <span class="token keyword">import</span> OpenAIEmbeddings<span class="token keyword">from</span> langchain_text_splitters <span class="token keyword">import</span> RecursiveCharacterTextSplitter<span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>vectorstores <span class="token keyword">import</span> FAISS<span class="token keyword">from</span> langchain_openai <span class="token keyword">import</span> ChatOpenAI<span class="token keyword">from</span> langchain<span class="token punctuation">.</span>chains <span class="token keyword">import</span> RetrievalQA<span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>document_loaders <span class="token keyword">import</span> PyMuPDFLoader<span class="token comment"># åŠ è½½æ–‡æ¡£</span>loader <span class="token operator">=</span> PyMuPDFLoader<span class="token punctuation">(</span><span class="token string">"llama2.pdf"</span><span class="token punctuation">)</span>pages <span class="token operator">=</span> loader<span class="token punctuation">.</span>load_and_split<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># æ–‡æ¡£åˆ‡åˆ†</span>text_splitter <span class="token operator">=</span> RecursiveCharacterTextSplitter<span class="token punctuation">(</span>    chunk_size<span class="token operator">=</span><span class="token number">300</span><span class="token punctuation">,</span>    chunk_overlap<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span>    length_function<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">,</span>    add_start_index<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span><span class="token punctuation">)</span>texts <span class="token operator">=</span> text_splitter<span class="token punctuation">.</span>create_documents<span class="token punctuation">(</span>    <span class="token punctuation">[</span>page<span class="token punctuation">.</span>page_content <span class="token keyword">for</span> page <span class="token keyword">in</span> pages<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment"># çŒåº“</span>embeddings <span class="token operator">=</span> OpenAIEmbeddings<span class="token punctuation">(</span>model<span class="token operator">=</span><span class="token string">"text-embedding-ada-002"</span><span class="token punctuation">)</span>db <span class="token operator">=</span> FAISS<span class="token punctuation">.</span>from_documents<span class="token punctuation">(</span>texts<span class="token punctuation">,</span> embeddings<span class="token punctuation">)</span><span class="token comment"># æ£€ç´¢ top-2 ç»“æœ</span>retriever <span class="token operator">=</span> db<span class="token punctuation">.</span>as_retriever<span class="token punctuation">(</span>search_kwargs<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"k"</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> langchain<span class="token punctuation">.</span>schema<span class="token punctuation">.</span>output_parser <span class="token keyword">import</span> StrOutputParser<span class="token keyword">from</span> langchain<span class="token punctuation">.</span>schema<span class="token punctuation">.</span>runnable <span class="token keyword">import</span> RunnablePassthrough<span class="token comment"># Promptæ¨¡æ¿</span>template <span class="token operator">=</span> <span class="token triple-quoted-string string">"""Answer the question based only on the following context:{context}Question: {question}"""</span>prompt <span class="token operator">=</span> ChatPromptTemplate<span class="token punctuation">.</span>from_template<span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token comment"># Chain</span>rag_chain <span class="token operator">=</span> <span class="token punctuation">(</span>    <span class="token punctuation">{</span><span class="token string">"question"</span><span class="token punctuation">:</span> RunnablePassthrough<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"context"</span><span class="token punctuation">:</span> retriever<span class="token punctuation">}</span>    <span class="token operator">|</span> prompt    <span class="token operator">|</span> llm    <span class="token operator">|</span> StrOutputParser<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>rag_chain<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span><span class="token string">"Llama 2æœ‰å¤šå°‘å‚æ•°"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="4-3-ç”¨-LCEL-å®ç°å·¥å‚æ¨¡å¼ï¼ˆé€‰ï¼‰"><a href="#4-3-ç”¨-LCEL-å®ç°å·¥å‚æ¨¡å¼ï¼ˆé€‰ï¼‰" class="headerlink" title="4.3 ç”¨ LCEL å®ç°å·¥å‚æ¨¡å¼ï¼ˆé€‰ï¼‰"></a>4.3 ç”¨ LCEL å®ç°å·¥å‚æ¨¡å¼ï¼ˆé€‰ï¼‰</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> langchain_core<span class="token punctuation">.</span>runnables<span class="token punctuation">.</span>utils <span class="token keyword">import</span> ConfigurableField<span class="token keyword">from</span> langchain_openai <span class="token keyword">import</span> ChatOpenAI<span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>chat_models <span class="token keyword">import</span> QianfanChatEndpoint<span class="token keyword">from</span> langchain<span class="token punctuation">.</span>prompts <span class="token keyword">import</span> <span class="token punctuation">(</span>    ChatPromptTemplate<span class="token punctuation">,</span>    HumanMessagePromptTemplate<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token keyword">from</span> langchain<span class="token punctuation">.</span>schema <span class="token keyword">import</span> HumanMessage<span class="token keyword">import</span> os<span class="token comment"># æ¨¡å‹1</span>ernie_model <span class="token operator">=</span> QianfanChatEndpoint<span class="token punctuation">(</span>    qianfan_ak<span class="token operator">=</span>os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">'ERNIE_CLIENT_ID'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    qianfan_sk<span class="token operator">=</span>os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">'ERNIE_CLIENT_SECRET'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># æ¨¡å‹2</span>gpt_model <span class="token operator">=</span> ChatOpenAI<span class="token punctuation">(</span>model<span class="token operator">=</span><span class="token string">"gpt-4o-mini"</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment"># é€šè¿‡ configurable_alternatives æŒ‰æŒ‡å®šå­—æ®µé€‰æ‹©æ¨¡å‹</span>model <span class="token operator">=</span> gpt_model<span class="token punctuation">.</span>configurable_alternatives<span class="token punctuation">(</span>    ConfigurableField<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token string">"llm"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     default_key<span class="token operator">=</span><span class="token string">"gpt"</span><span class="token punctuation">,</span>     ernie<span class="token operator">=</span>ernie_model<span class="token punctuation">,</span>    <span class="token comment"># claude=claude_model,</span><span class="token punctuation">)</span><span class="token comment"># Prompt æ¨¡æ¿</span>prompt <span class="token operator">=</span> ChatPromptTemplate<span class="token punctuation">.</span>from_messages<span class="token punctuation">(</span>    <span class="token punctuation">[</span>        HumanMessagePromptTemplate<span class="token punctuation">.</span>from_template<span class="token punctuation">(</span><span class="token string">"{query}"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment"># LCEL</span>chain <span class="token operator">=</span> <span class="token punctuation">(</span>    <span class="token punctuation">{</span><span class="token string">"query"</span><span class="token punctuation">:</span> RunnablePassthrough<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>     <span class="token operator">|</span> prompt    <span class="token operator">|</span> model     <span class="token operator">|</span> StrOutputParser<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># è¿è¡Œæ—¶æŒ‡å®šæ¨¡å‹ "gpt" or "ernie"</span>ret <span class="token operator">=</span> chain<span class="token punctuation">.</span>with_config<span class="token punctuation">(</span>configurable<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"llm"</span><span class="token punctuation">:</span> <span class="token string">"gpt"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>invoke<span class="token punctuation">(</span><span class="token string">"è¯·è‡ªæˆ‘ä»‹ç»"</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰©å±•é˜…è¯»ï¼šä»€ä¹ˆæ˜¯<a href="https://www.runoob.com/design-pattern/factory-pattern.html"><strong>å·¥å‚æ¨¡å¼</strong></a>ï¼›<a href="https://www.runoob.com/design-pattern/design-pattern-intro.html"><strong>è®¾è®¡æ¨¡å¼</strong></a>æ¦‚è§ˆã€‚</p><blockquote><p><b>æ€è€ƒï¼š</b>ä»æ¨¡å—é—´è§£ä¾èµ–è§’åº¦ï¼ŒLCELçš„æ„ä¹‰æ˜¯ä»€ä¹ˆï¼Ÿ</p></blockquote><h3 id="4-4-å­˜å‚¨ä¸ç®¡ç†å¯¹è¯å†å²"><a href="#4-4-å­˜å‚¨ä¸ç®¡ç†å¯¹è¯å†å²" class="headerlink" title="4.4 å­˜å‚¨ä¸ç®¡ç†å¯¹è¯å†å²"></a>4.4 å­˜å‚¨ä¸ç®¡ç†å¯¹è¯å†å²</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> langchain_community<span class="token punctuation">.</span>chat_message_histories <span class="token keyword">import</span> SQLChatMessageHistory<span class="token keyword">def</span> <span class="token function">get_session_history</span><span class="token punctuation">(</span>session_id<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># é€šè¿‡ session_id åŒºåˆ†å¯¹è¯å†å²ï¼Œå¹¶å­˜å‚¨åœ¨ sqlite æ•°æ®åº“ä¸­</span>    <span class="token keyword">return</span> SQLChatMessageHistory<span class="token punctuation">(</span>session_id<span class="token punctuation">,</span> <span class="token string">"sqlite:///memory.db"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> langchain_core<span class="token punctuation">.</span>messages <span class="token keyword">import</span> HumanMessage<span class="token keyword">from</span> langchain_core<span class="token punctuation">.</span>runnables<span class="token punctuation">.</span>history <span class="token keyword">import</span> RunnableWithMessageHistory<span class="token keyword">from</span> langchain_openai <span class="token keyword">import</span> ChatOpenAI<span class="token keyword">from</span> langchain<span class="token punctuation">.</span>schema<span class="token punctuation">.</span>output_parser <span class="token keyword">import</span> StrOutputParsermodel <span class="token operator">=</span> ChatOpenAI<span class="token punctuation">(</span>model<span class="token operator">=</span><span class="token string">"gpt-4o-mini"</span><span class="token punctuation">,</span> temperature<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>runnable <span class="token operator">=</span> model <span class="token operator">|</span> StrOutputParser<span class="token punctuation">(</span><span class="token punctuation">)</span>runnable_with_history <span class="token operator">=</span> RunnableWithMessageHistory<span class="token punctuation">(</span>    runnable<span class="token punctuation">,</span> <span class="token comment"># æŒ‡å®š runnable</span>    get_session_history<span class="token punctuation">,</span> <span class="token comment"># æŒ‡å®šè‡ªå®šä¹‰çš„å†å²ç®¡ç†æ–¹æ³•</span><span class="token punctuation">)</span>runnable_with_history<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span>    <span class="token punctuation">[</span>HumanMessage<span class="token punctuation">(</span>content<span class="token operator">=</span><span class="token string">"ä½ å¥½ï¼Œæˆ‘å«å¢¨å±¿"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    config<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"configurable"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"session_id"</span><span class="token punctuation">:</span> <span class="token string">"Moyu"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç¬¬äºŒè½®å¯¹è¯ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">runnable_with_history<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span>    <span class="token punctuation">[</span>HumanMessage<span class="token punctuation">(</span>content<span class="token operator">=</span><span class="token string">"ä½ çŸ¥é“æˆ‘å«ä»€ä¹ˆåå­—"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    config<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"configurable"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"session_id"</span><span class="token punctuation">:</span> <span class="token string">"Moyu"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="é€šè¿‡-LCELï¼Œè¿˜å¯ä»¥å®ç°"><a href="#é€šè¿‡-LCELï¼Œè¿˜å¯ä»¥å®ç°" class="headerlink" title="é€šè¿‡ LCELï¼Œè¿˜å¯ä»¥å®ç°"></a>é€šè¿‡ LCELï¼Œè¿˜å¯ä»¥å®ç°</h3><ol><li>é…ç½®è¿è¡Œæ—¶å˜é‡ï¼š<a href="https://python.langchain.com/v0.3/docs/how_to/configure/">https://python.langchain.com/v0.3/docs/how_to/configure/</a></li><li>æ•…éšœå›é€€ï¼š<a href="">https://python.langchain.com/v0.3/docs/how_to/fallbacks</a></li><li>æ•…éšœå›é€€ï¼š<a href="">https://python.langchain.com/v0.3/docs/how_to/fallbacks</a></li><li>å¹¶è¡Œè°ƒç”¨ï¼š<a href="https://python.langchain.com/v0.3/docs/how_to/parallel/">https://python.langchain.com/v0.3/docs/how_to/parallel/</a></li><li>é€»è¾‘åˆ†æ”¯ï¼š<a href="https://python.langchain.com/v0.3/docs/how_to/routing/">https://python.langchain.com/v0.3/docs/how_to/routing/</a></li><li>åŠ¨æ€åˆ›å»º Chain: <a href="https://python.langchain.com/v0.3/docs/how_to/dynamic_chain/">https://python.langchain.com/v0.3/docs/how_to/dynamic_chain/</a></li></ol><p>æ›´å¤šä¾‹å­ï¼š<a href="https://python.langchain.com/v0.3/docs/how_to/lcel_cheatsheet/">https://python.langchain.com/v0.3/docs/how_to/lcel_cheatsheet/</a></p><h2 id="äº”ã€LangServe"><a href="#äº”ã€LangServe" class="headerlink" title="äº”ã€LangServe"></a>äº”ã€LangServe</h2><p>LangServe ç”¨äºå°† Chain æˆ–è€… Runnable éƒ¨ç½²æˆä¸€ä¸ª REST API æœåŠ¡ã€‚</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># å®‰è£… LangServe</span>pip install <span class="token operator">-</span><span class="token operator">-</span>upgrade <span class="token string">"langserve[all]"</span><span class="token comment"># ä¹Ÿå¯ä»¥åªå®‰è£…ä¸€ç«¯</span>pip install <span class="token string">"langserve[client]"</span>pip install <span class="token string">"langserve[server]"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5-1ã€Server-ç«¯"><a href="#5-1ã€Server-ç«¯" class="headerlink" title="5.1ã€Server ç«¯"></a>5.1ã€Server ç«¯</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#!/usr/bin/env python</span><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI<span class="token keyword">from</span> langchain<span class="token punctuation">.</span>prompts <span class="token keyword">import</span> ChatPromptTemplate<span class="token keyword">from</span> langchain_openai <span class="token keyword">import</span> ChatOpenAI<span class="token keyword">from</span> langserve <span class="token keyword">import</span> add_routes<span class="token keyword">import</span> uvicornapp <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span>  title<span class="token operator">=</span><span class="token string">"LangChain Server"</span><span class="token punctuation">,</span>  version<span class="token operator">=</span><span class="token string">"1.0"</span><span class="token punctuation">,</span>  description<span class="token operator">=</span><span class="token string">"A simple api server using Langchain's Runnable interfaces"</span><span class="token punctuation">,</span><span class="token punctuation">)</span>model <span class="token operator">=</span> ChatOpenAI<span class="token punctuation">(</span>model<span class="token operator">=</span><span class="token string">"gpt-4o-mini"</span><span class="token punctuation">)</span>prompt <span class="token operator">=</span> ChatPromptTemplate<span class="token punctuation">.</span>from_template<span class="token punctuation">(</span><span class="token string">"è®²ä¸€ä¸ªå…³äº{topic}çš„ç¬‘è¯"</span><span class="token punctuation">)</span>add_routes<span class="token punctuation">(</span>    app<span class="token punctuation">,</span>    prompt <span class="token operator">|</span> model<span class="token punctuation">,</span>    path<span class="token operator">=</span><span class="token string">"/joke"</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>    uvicorn<span class="token punctuation">.</span>run<span class="token punctuation">(</span>app<span class="token punctuation">,</span> host<span class="token operator">=</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">9999</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5-2ã€Client-ç«¯"><a href="#5-2ã€Client-ç«¯" class="headerlink" title="5.2ã€Client ç«¯"></a>5.2ã€Client ç«¯</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> requestsresponse <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>    <span class="token string">"http://localhost:9999/joke/invoke"</span><span class="token punctuation">,</span>    json<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'input'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">'topic'</span><span class="token punctuation">:</span> <span class="token string">'å°æ˜'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="LangChain-ä¸-LlamaIndex-çš„é”™ä½ç«äº‰"><a href="#LangChain-ä¸-LlamaIndex-çš„é”™ä½ç«äº‰" class="headerlink" title="LangChain ä¸ LlamaIndex çš„é”™ä½ç«äº‰"></a>LangChain ä¸ LlamaIndex çš„é”™ä½ç«äº‰</h2><ul><li>LangChain ä¾§é‡ä¸ LLM æœ¬èº«äº¤äº’çš„å°è£…<ul><li>Promptã€LLMã€Messageã€OutputParser ç­‰å·¥å…·ä¸°å¯Œ</li><li>åœ¨æ•°æ®å¤„ç†å’Œ RAG æ–¹é¢æä¾›çš„å·¥å…·ç›¸å¯¹ç²—ç³™</li><li>ä¸»æ‰“ LCEL æµç¨‹å°è£…</li><li>é…å¥— Agentã€LangGraph ç­‰æ™ºèƒ½ä½“ä¸å·¥ä½œæµå·¥å…·</li><li>å¦æœ‰ LangServe éƒ¨ç½²å·¥å…·å’Œ LangSmith ç›‘æ§è°ƒè¯•å·¥å…·</li></ul></li><li>LlamaIndex ä¾§é‡ä¸æ•°æ®äº¤äº’çš„å°è£…<ul><li>æ•°æ®åŠ è½½ã€åˆ‡å‰²ã€ç´¢å¼•ã€æ£€ç´¢ã€æ’åºç­‰ç›¸å…³å·¥å…·ä¸°å¯Œ</li><li>Promptã€LLM ç­‰åº•å±‚å°è£…ç›¸å¯¹å•è–„</li><li>é…å¥—å®ç° RAG ç›¸å…³å·¥å…·</li><li>æœ‰ Agent ç›¸å…³å·¥å…·ï¼Œä¸çªå‡º</li></ul></li><li>LlamaIndex ä¸º LangChain æä¾›äº†é›†æˆ<ul><li>åœ¨ LlamaIndex ä¸­è°ƒç”¨ LangChain å°è£…çš„ LLM æ¥å£ï¼š<a href="https://docs.llamaindex.ai/en/stable/api_reference/llms/langchain/">https://docs.llamaindex.ai/en/stable/api_reference/llms/langchain/</a></li><li>å°† LlamaIndex çš„ Query Engine ä½œä¸º LangChain Agent çš„å·¥å…·ï¼š<a href="https://docs.llamaindex.ai/en/v0.10.17/community/integrations/using_with_langchain.html">https://docs.llamaindex.ai/en/v0.10.17/community/integrations/using_with_langchain.html</a></li><li>LangChain ä¹Ÿ <em>æ›¾ç»</em> é›†æˆè¿‡ LlamaIndexï¼Œç›®å‰ç›¸å…³æ¥å£ä»åœ¨ï¼š<a href="https://api.python.langchain.com/en/latest/retrievers/langchain_community.retrievers.llama_index.LlamaIndexRetriever.html">https://api.python.langchain.com/en/latest/retrievers/langchain_community.retrievers.llama_index.LlamaIndexRetriever.html</a></li></ul></li></ul><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ol><li>LangChain éšç€ç‰ˆæœ¬è¿­ä»£å¯ç”¨æ€§æœ‰æ˜æ˜¾æå‡</li><li>ä½¿ç”¨ LangChain è¦æ³¨æ„ç»´æŠ¤è‡ªå·±çš„ Promptï¼Œå°½é‡ Prompt ä¸ä»£ç é€»è¾‘è§£ä¾èµ–</li><li>å®ƒçš„å†…ç½®åŸºç¡€å·¥å…·ï¼Œå»ºè®®å……åˆ†æµ‹è¯•æ•ˆæœåå†å†³å®šæ˜¯å¦ä½¿ç”¨</li></ol>]]></content>
      
      
      <categories>
          
          <category> AIå¤§æ¨¡å‹åº”ç”¨å¼€å‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> RAG </tag>
            
            <tag> Agent </tag>
            
            <tag> AI </tag>
            
            <tag> Embeddings </tag>
            
            <tag> LangChain </tag>
            
            <tag> LLM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€AIå¤§æ¨¡å‹åº”ç”¨å­¦ä¹ ç¬”è®°ã€‘RAG-Embedding-VectorçŸ¥è¯†ç‚¹å­¦ä¹ </title>
      <link href="/ai-da-mo-xing-ying-yong-xue-xi-bi-ji-rag-embedding-vector-zhi-shi-dian-xue-xi/"/>
      <url>/ai-da-mo-xing-ying-yong-xue-xi-bi-ji-rag-embedding-vector-zhi-shi-dian-xue-xi/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€ã€ä»€ä¹ˆæ˜¯æ£€ç´¢å¢å¼ºçš„ç”Ÿæˆæ¨¡å‹ï¼ˆRAGï¼‰"><a href="#ä¸€ã€ä»€ä¹ˆæ˜¯æ£€ç´¢å¢å¼ºçš„ç”Ÿæˆæ¨¡å‹ï¼ˆRAGï¼‰" class="headerlink" title="ä¸€ã€ä»€ä¹ˆæ˜¯æ£€ç´¢å¢å¼ºçš„ç”Ÿæˆæ¨¡å‹ï¼ˆRAGï¼‰"></a>ä¸€ã€ä»€ä¹ˆæ˜¯æ£€ç´¢å¢å¼ºçš„ç”Ÿæˆæ¨¡å‹ï¼ˆRAGï¼‰</h2><p>  <strong>RAGï¼ˆRetrieval-Augmented Generationï¼Œæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰ æ˜¯ä¸€ç§ç»“åˆäº†ä¿¡æ¯æ£€ç´¢æŠ€æœ¯ä¸è¯­è¨€ç”Ÿæˆæ¨¡å‹çš„äººå·¥æ™ºèƒ½æŠ€æœ¯ã€‚è¯¥æŠ€æœ¯é€šè¿‡ä»å¤–éƒ¨çŸ¥è¯†åº“ä¸­æ£€ç´¢ç›¸å…³ä¿¡æ¯ï¼Œå¹¶å°†å…¶ä½œä¸ºæç¤ºï¼ˆPromptï¼‰è¾“å…¥ç»™å¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆLLMsï¼‰ï¼Œä»¥å¢å¼ºæ¨¡å‹å¤„ç†çŸ¥è¯†å¯†é›†å‹ä»»åŠ¡çš„èƒ½åŠ›ï¼Œå¦‚é—®ç­”ã€æ–‡æœ¬æ‘˜è¦ã€å†…å®¹ç”Ÿæˆç­‰ã€‚RAGæ¨¡å‹ç”±Facebook AI Researchï¼ˆFAIRï¼‰å›¢é˜Ÿäº2020å¹´é¦–æ¬¡æå‡ºï¼Œå¹¶è¿…é€Ÿæˆä¸ºå¤§æ¨¡å‹åº”ç”¨ä¸­çš„çƒ­é—¨æ–¹æ¡ˆã€‚</strong></p><h3 id="1-1-å¤§æ¨¡å‹ç›®å‰å›ºæœ‰çš„å±€é™æ€§"><a href="#1-1-å¤§æ¨¡å‹ç›®å‰å›ºæœ‰çš„å±€é™æ€§" class="headerlink" title="1.1 å¤§æ¨¡å‹ç›®å‰å›ºæœ‰çš„å±€é™æ€§"></a><strong>1.1 å¤§æ¨¡å‹ç›®å‰å›ºæœ‰çš„å±€é™æ€§</strong></h3><ul><li>1.LMMçš„çŸ¥è¯†ä¸æ˜¯å®æ—¶çš„</li><li>2.LMMå¯èƒ½ä¸çŸ¥é“ä½ ç§æœ‰çš„é¢†åŸŸ/ä¸šåŠ¡çŸ¥è¯†</li></ul><div class="alert alert-success"><b>ç±»æ¯”ï¼š</b>ä½ å¯ä»¥æŠŠè¿™ä¸ªè¿‡ç¨‹æƒ³è±¡æˆå¼€å·è€ƒè¯•ã€‚è®© LLM å…ˆç¿»ä¹¦ï¼Œå†å›ç­”é—®é¢˜ã€‚</div><h3 id="1-2-æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRAGï¼‰"><a href="#1-2-æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRAGï¼‰" class="headerlink" title="1.2 æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRAGï¼‰"></a><strong>1.2 æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRAGï¼‰</strong></h3><h4 id="ä»€ä¹ˆæ˜¯RAGï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯RAGï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯RAGï¼Ÿ"></a><strong>ä»€ä¹ˆæ˜¯RAGï¼Ÿ</strong></h4><p><strong>RAGï¼ˆRetrieval-Augmented Generationï¼Œæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰ï¼ŒRAG</strong>æ˜¯ä¸€ç§&nbsp;AI&nbsp;æ¡†æ¶ï¼Œå®ƒå°†ä¼ ç»Ÿä¿¡æ¯æ£€ç´¢ç³»ç»Ÿï¼ˆä¾‹å¦‚æ•°æ®åº“ï¼‰çš„ä¼˜åŠ¿ä¸ç”Ÿæˆå¼å¤§è¯­è¨€æ¨¡å‹ (LLM) çš„åŠŸèƒ½ç»“åˆåœ¨ä¸€èµ·ã€‚</p><p><strong>LLMé€šè¿‡å°†è¿™äº›é¢å¤–çš„çŸ¥è¯†ä¸è‡ªå·±çš„è¯­è¨€æŠ€èƒ½ç›¸ç»“åˆï¼Œå¯ä»¥æ’°å†™æ›´å‡†ç¡®ã€æ›´å…·æ—¶æ•ˆæ€§ä¸”æ›´è´´åˆå…·ä½“éœ€æ±‚çš„æ–‡å­—ã€‚</strong></p><p><img src="https://pic1.imgdb.cn/item/681b64a758cb8da5c8e3d68d.png" alt="ä»€ä¹ˆæ˜¯RAG?"></p><h4 id="å¦‚ä½•ç†è§£RAGï¼Ÿ"><a href="#å¦‚ä½•ç†è§£RAGï¼Ÿ" class="headerlink" title="å¦‚ä½•ç†è§£RAGï¼Ÿ"></a><strong>å¦‚ä½•ç†è§£RAGï¼Ÿ</strong></h4><p><strong>é€šè¿‡ä¸Šä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬çŸ¥é“äº†ä»€ä¹ˆæ˜¯RAGï¼Ÿäº†è§£åˆ°RAGæ˜¯ä¸€ç§ç»“åˆäº†ä¿¡æ¯æ£€ç´¢ã€æ–‡æœ¬å¢å¼ºå’Œæ–‡æœ¬ç”Ÿæˆçš„è‡ªç„¶è¯­è¨€å¤„ç†ï¼ˆNLPï¼‰çš„æŠ€æœ¯ã€‚</strong></p><p><strong>RAGçš„ç›®çš„æ˜¯é€šè¿‡ä»å¤–éƒ¨çŸ¥è¯†åº“æ£€ç´¢ç›¸å…³ä¿¡æ¯æ¥è¾…åŠ©å¤§è¯­è¨€æ¨¡å‹ç”Ÿæˆæ›´å‡†ç¡®ã€æ›´ä¸°å¯Œçš„æ–‡æœ¬å†…å®¹ã€‚é‚£æˆ‘ä»¬å¦‚ä½•ç†è§£RAGçš„æ£€ç´¢ã€å¢å¼ºå’Œç”Ÿæˆå‘¢ï¼Ÿ</strong></p><ol><li><strong>æ£€ç´¢</strong>ï¼šæ£€ç´¢æ˜¯RAGæµç¨‹çš„ç¬¬ä¸€æ­¥ï¼Œä»é¢„å…ˆå»ºç«‹çš„çŸ¥è¯†åº“ä¸­æ£€ç´¢ä¸é—®é¢˜ç›¸å…³çš„ä¿¡æ¯ã€‚è¿™ä¸€æ­¥çš„ç›®çš„æ˜¯ä¸ºåç»­çš„ç”Ÿæˆè¿‡ç¨‹æä¾›æœ‰ç”¨çš„ä¸Šä¸‹æ–‡ä¿¡æ¯å’ŒçŸ¥è¯†æ”¯æ’‘ã€‚</li><li><strong>å¢å¼º</strong>ï¼šRAGä¸­å¢å¼ºæ˜¯å°†æ£€ç´¢åˆ°çš„ä¿¡æ¯ç”¨ä½œç”Ÿæˆæ¨¡å‹ï¼ˆå³å¤§è¯­è¨€æ¨¡å‹ï¼‰çš„ä¸Šä¸‹æ–‡è¾“å…¥ï¼Œä»¥å¢å¼ºæ¨¡å‹å¯¹ç‰¹å®šé—®é¢˜çš„ç†è§£å’Œå›ç­”èƒ½åŠ›ã€‚è¿™ä¸€æ­¥çš„ç›®çš„æ˜¯å°†å¤–éƒ¨çŸ¥è¯†èå…¥ç”Ÿæˆè¿‡ç¨‹ä¸­ï¼Œä½¿ç”Ÿæˆçš„æ–‡æœ¬å†…å®¹æ›´åŠ ä¸°å¯Œã€å‡†ç¡®å’Œç¬¦åˆç”¨æˆ·éœ€æ±‚ã€‚<strong>é€šè¿‡å¢å¼ºæ­¥éª¤ï¼ŒLLMæ¨¡å‹èƒ½å¤Ÿå……åˆ†åˆ©ç”¨å¤–éƒ¨çŸ¥è¯†åº“ä¸­çš„ä¿¡æ¯ã€‚</strong></li><li>ç”Ÿæˆï¼šç”Ÿæˆæ˜¯RAGæµç¨‹çš„æœ€åä¸€æ­¥ã€‚è¿™ä¸€æ­¥çš„ç›®çš„æ˜¯ç»“åˆLLMç”Ÿæˆç¬¦åˆç”¨æˆ·éœ€æ±‚çš„å›ç­”ã€‚ç”Ÿæˆå™¨ä¼šåˆ©ç”¨æ£€ç´¢åˆ°çš„ä¿¡æ¯ä½œä¸ºä¸Šä¸‹æ–‡è¾“å…¥ï¼Œå¹¶ç»“åˆå¤§è¯­è¨€æ¨¡å‹æ¥ç”Ÿæˆæ–‡æœ¬å†…å®¹ã€‚</li></ol><p><strong>RAGçš„â€œæ£€ç´¢ã€å¢å¼ºã€ç”Ÿæˆâ€ï¼Œè°å¢å¼ºäº†è°ï¼Œè°ç”Ÿæˆäº†ç­”æ¡ˆï¼Œä¸»è¯­å¾ˆé‡è¦ã€‚æ˜¯ä»çŸ¥è¯†åº“ä¸­æ£€ç´¢åˆ°çš„é—®ç­”å¯¹ï¼Œå¢å¼ºäº†LLMçš„æç¤ºè¯ï¼ˆpromptï¼‰ï¼ŒLLMæ‹¿ç€å¢å¼ºåçš„Promptç”Ÿæˆäº†é—®é¢˜ç­”æ¡ˆã€‚</strong></p><h4 id="å¦‚ä½•ä½¿ç”¨RAG"><a href="#å¦‚ä½•ä½¿ç”¨RAG" class="headerlink" title="å¦‚ä½•ä½¿ç”¨RAG?"></a>å¦‚ä½•ä½¿ç”¨RAG?</h4><p><strong>æˆ‘ä»¬å¦‚ä½•ä½¿ç”¨RAGï¼Ÿæ¥ä¸‹æ¥ä»¥RAGæ­å»ºçŸ¥è¯†é—®ç­”ç³»ç»Ÿå…·ä½“æ­¥éª¤ä¸ºä¾‹ï¼Œæ¥è®²è§£å¦‚ä½•ä½¿ç”¨RAGï¼Ÿ</strong></p><ol><li><strong>æ•°æ®å‡†å¤‡ä¸çŸ¥è¯†åº“æ„å»º</strong>ï¼š</li></ol><ul><li><strong>æ”¶é›†æ•°æ®ï¼š</strong>&nbsp;é¦–å…ˆï¼Œéœ€è¦æ”¶é›†ä¸é—®ç­”ç³»ç»Ÿç›¸å…³çš„å„ç§æ•°æ®ï¼Œè¿™äº›æ•°æ®å¯ä»¥æ¥è‡ªæ–‡æ¡£ã€ç½‘é¡µã€æ•°æ®åº“ç­‰å¤šç§æ¥æºã€‚</li><li><strong>æ•°æ®æ¸…æ´—ï¼š</strong>&nbsp;å¯¹æ”¶é›†åˆ°çš„æ•°æ®è¿›è¡Œæ¸…æ´—ï¼Œå»é™¤å™ªå£°ã€é‡å¤é¡¹å’Œæ— å…³ä¿¡æ¯ï¼Œç¡®ä¿æ•°æ®çš„è´¨é‡å’Œå‡†ç¡®æ€§ã€‚</li><li><strong>çŸ¥è¯†åº“æ„å»ºï¼š</strong>&nbsp;å°†æ¸…æ´—åçš„æ•°æ®æ„å»ºæˆçŸ¥è¯†åº“ã€‚è¿™é€šå¸¸åŒ…æ‹¬å°†æ–‡æœ¬åˆ†å‰²æˆè¾ƒå°çš„ç‰‡æ®µï¼ˆchunksï¼‰ï¼Œä½¿ç”¨æ–‡æœ¬åµŒå…¥æ¨¡å‹ï¼ˆå¦‚GLMï¼‰å°†è¿™äº›ç‰‡æ®µè½¬æ¢æˆå‘é‡ï¼Œå¹¶å°†è¿™äº›å‘é‡å­˜å‚¨åœ¨å‘é‡æ•°æ®åº“ï¼ˆå¦‚FAISSã€Milvusç­‰ï¼‰ä¸­ã€‚</li></ul><ol start="2"><li><strong>æ£€ç´¢æ¨¡å—è®¾è®¡ï¼š</strong></li></ol><ul><li><strong>é—®é¢˜å‘é‡åŒ–ï¼š</strong>&nbsp;å½“ç”¨æˆ·è¾“å…¥æŸ¥è¯¢é—®é¢˜æ—¶ï¼Œä½¿ç”¨ç›¸åŒçš„æ–‡æœ¬åµŒå…¥æ¨¡å‹å°†é—®é¢˜è½¬æ¢æˆå‘é‡ã€‚</li><li><strong>ç›¸ä¼¼åº¦æ£€ç´¢ï¼š</strong>&nbsp;åœ¨å‘é‡æ•°æ®åº“ä¸­æ£€ç´¢ä¸é—®é¢˜å‘é‡æœ€ç›¸ä¼¼çš„çŸ¥è¯†åº“ç‰‡æ®µï¼ˆchunksï¼‰ã€‚è¿™é€šå¸¸é€šè¿‡è®¡ç®—å‘é‡ä¹‹é—´çš„ç›¸ä¼¼åº¦ï¼ˆå¦‚ä½™å¼¦ç›¸ä¼¼åº¦ï¼‰æ¥å®ç°ã€‚</li><li><strong>ç»“æœæ’åºï¼š</strong>&nbsp;æ ¹æ®ç›¸ä¼¼åº¦å¾—åˆ†å¯¹æ£€ç´¢åˆ°çš„ç»“æœè¿›è¡Œæ’åºï¼Œé€‰æ‹©æœ€ç›¸å…³çš„ç‰‡æ®µä½œä¸ºåç»­ç”Ÿæˆçš„è¾“å…¥ã€‚</li></ul><ol start="3"><li><strong>ç”Ÿæˆæ¨¡å—è®¾è®¡ï¼š</strong></li></ol><ul><li><strong>ä¸Šä¸‹æ–‡èåˆ</strong>ï¼šå°†æ£€ç´¢åˆ°çš„ç›¸å…³ç‰‡æ®µä¸åŸå§‹é—®é¢˜åˆå¹¶ï¼Œå½¢æˆæ›´ä¸°å¯Œçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</li><li><strong>å¤§è¯­è¨€æ¨¡å‹ç”Ÿæˆ</strong>ï¼šä½¿ç”¨å¤§è¯­è¨€æ¨¡å‹ï¼ˆå¦‚GLMï¼‰åŸºäºä¸Šè¿°ä¸Šä¸‹æ–‡ä¿¡æ¯ç”Ÿæˆå›ç­”ã€‚å¤§è¯­è¨€æ¨¡å‹ä¼šå­¦ä¹ å¦‚ä½•æ ¹æ®æ£€ç´¢åˆ°çš„ä¿¡æ¯æ¥ç”Ÿæˆå‡†ç¡®ã€æœ‰ç”¨çš„å›ç­”ã€‚</li></ul><p><strong>å¤§å®¶å¯ä»¥ç»“åˆè‡ªå·±çš„ä¸šåŠ¡é¢†åŸŸçŸ¥è¯†ï¼Œå¼€å§‹æ­å»ºåŒ»ç–—ã€æ³•å¾‹ã€äº§å“çŸ¥è¯†é—®ç­”ã€‚å…ˆæ­å»ºDemoï¼Œç„¶åå·¥ä½œä¸­ä¸æ–­å®Œå–„çŸ¥è¯†åº“é—®ç­”å¯¹ã€‚</strong></p><h3 id="1-3-RAGå·¥ä½œåŸç†æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#1-3-RAGå·¥ä½œåŸç†æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="1.3 RAGå·¥ä½œåŸç†æ˜¯ä»€ä¹ˆï¼Ÿ"></a><strong>1.3 RAGå·¥ä½œåŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</strong></h3><p>&nbsp;<strong>å¤§å‹è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰é¢ä¸´ä¸¤ä¸ªé—®é¢˜ï¼Œç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯LLMä¼šäº§ç”Ÿå¹»è§‰ï¼Œç¬¬äºŒä¸ªæ˜¯LLMçš„çŸ¥è¯†ä¸­æ–­ã€‚</strong></p><ol><li>å¹»è§‰ï¼šå½“æ¨¡å‹æ‰€è®­ç»ƒçš„æ•°æ®æ²¡æœ‰é—®é¢˜çš„ç­”æ¡ˆæ—¶ï¼Œå®ƒä¼šè‡ªä¿¡åœ°åšå‡ºé”™è¯¯ååº”ï¼Œå°±ä¼šå‘ç”Ÿå¹»è§‰ã€‚</li><li>çŸ¥è¯†æˆªæ­¢ï¼šå½“ LLM è¿”å›çš„ä¿¡æ¯ä¸æ¨¡å‹çš„è®­ç»ƒæ•°æ®ç›¸æ¯”è¿‡æ—¶æ—¶ã€‚æ¯ä¸ªåŸºç¡€æ¨¡å‹éƒ½æœ‰çŸ¥è¯†æˆªæ­¢ï¼Œè¿™æ„å‘³ç€å…¶çŸ¥è¯†ä»…é™äºè®­ç»ƒæ—¶å¯ç”¨çš„æ•°æ®ã€‚</li></ol><p><strong>æ£€ç´¢å¢å¼ºç”Ÿæˆ (RAG) æ‘†è„±äº†çŸ¥è¯†é™åˆ¶ï¼Œæ•´åˆäº†å¤–éƒ¨æ•°æ®ï¼Œä»å¤–éƒ¨çŸ¥è¯†åº“ä¸­æ£€ç´¢ç›¸å…³ä¿¡æ¯ï¼Œå¢å¼ºæ¨¡å‹çš„ç”Ÿæˆèƒ½åŠ›ã€‚</strong></p><p><img src="https://pic1.imgdb.cn/item/681b64a758cb8da5c8e3d68a.png" alt="RAGçš„å·¥ä½œåŸç†"></p><h3 id="1-4-RAGåŸºæœ¬æ­å»ºæµç¨‹"><a href="#1-4-RAGåŸºæœ¬æ­å»ºæµç¨‹" class="headerlink" title="1.4 RAGåŸºæœ¬æ­å»ºæµç¨‹"></a><strong>1.4 RAGåŸºæœ¬æ­å»ºæµç¨‹</strong></h3><p><strong>é€šè¿‡æ£€ç´¢å¢å¼ºæŠ€æœ¯ï¼Œå°†ç”¨æˆ·æŸ¥è¯¢ä¸ç´¢å¼•çŸ¥è¯†èåˆï¼Œåˆ©ç”¨å¤§è¯­è¨€æ¨¡å‹ç”Ÿæˆå‡†ç¡®å›ç­”ã€‚</strong></p><ol><li>çŸ¥è¯†å‡†å¤‡ï¼šæ”¶é›†å¹¶è½¬æ¢çŸ¥è¯†æ–‡æ¡£ä¸ºæ–‡æœ¬æ•°æ®ï¼Œè¿›è¡Œé¢„å¤„ç†å’Œç´¢å¼•ã€‚</li><li>åµŒå…¥ä¸ç´¢å¼•ï¼šä½¿ç”¨åµŒå…¥æ¨¡å‹å°†æ–‡æœ¬è½¬æ¢ä¸ºå‘é‡ï¼Œå¹¶å­˜å‚¨åœ¨å‘é‡æ•°æ®åº“ä¸­ã€‚</li><li>æŸ¥è¯¢æ£€ç´¢ï¼šç”¨æˆ·æŸ¥è¯¢è½¬æ¢ä¸ºå‘é‡ï¼Œä»æ•°æ®åº“ä¸­æ£€ç´¢ç›¸å…³çŸ¥è¯†ã€‚</li><li>æç¤ºå¢å¼ºï¼šç»“åˆæ£€ç´¢ç»“æœæ„å»ºå¢å¼ºæç¤ºæ¨¡ç‰ˆã€‚</li><li>ç”Ÿæˆå›ç­”ï¼šå¤§è¯­è¨€æ¨¡å‹æ ¹æ®å¢å¼ºæ¨¡ç‰ˆç”Ÿæˆå‡†ç¡®å›ç­”ã€‚</li></ol><h3 id="1-5-RAGæŠ€æœ¯æ¶æ„"><a href="#1-5-RAGæŠ€æœ¯æ¶æ„" class="headerlink" title="1.5 RAGæŠ€æœ¯æ¶æ„"></a><strong>1.5 RAGæŠ€æœ¯æ¶æ„</strong></h3><p><strong>RAGæŠ€æœ¯æ¶æ„ä¸»è¦ç”±ä¸¤ä¸ªæ ¸å¿ƒæ¨¡å—ç»„æˆï¼Œæ£€ç´¢æ¨¡å—ï¼ˆRetrieverï¼‰å’Œç”Ÿæˆæ¨¡å—ï¼ˆGeneratorï¼‰ã€‚</strong></p><ol><li><strong>æ£€ç´¢æ¨¡å—ï¼ˆRetrieverï¼‰ï¼š</strong></li></ol><ul><li>æ–‡æœ¬åµŒå…¥ï¼šä½¿ç”¨é¢„è®­ç»ƒçš„æ–‡æœ¬åµŒå…¥æ¨¡å‹ï¼ˆå¦‚GLMï¼‰å°†æŸ¥è¯¢å’Œæ–‡æ¡£è½¬æ¢æˆå‘é‡è¡¨ç¤ºï¼Œä»¥ä¾¿åœ¨å‘é‡ç©ºé—´ä¸­è¿›è¡Œç›¸ä¼¼åº¦è®¡ç®—ã€‚</li><li>å‘é‡æœç´¢ï¼šåˆ©ç”¨é«˜æ•ˆçš„å‘é‡æœç´¢æŠ€æœ¯ï¼ˆå¦‚FAISSã€Milvusç­‰å‘é‡æ•°æ®åº“ï¼‰åœ¨å‘é‡ç©ºé—´ä¸­æ£€ç´¢ä¸æŸ¥è¯¢å‘é‡æœ€ç›¸ä¼¼çš„æ–‡æ¡£æˆ–æ®µè½ã€‚</li><li>åŒå¡”æ¨¡å‹ï¼šæ£€ç´¢æ¨¡å—å¸¸é‡‡ç”¨åŒå¡”æ¨¡å‹ï¼ˆDual-Encoderï¼‰è¿›è¡Œé«˜æ•ˆçš„å‘é‡åŒ–æ£€ç´¢ã€‚åŒå¡”æ¨¡å‹ç”±ä¸¤ä¸ªç‹¬ç«‹çš„ç¼–ç å™¨ç»„æˆï¼Œä¸€ä¸ªç”¨äºç¼–ç æŸ¥è¯¢ï¼Œå¦ä¸€ä¸ªç”¨äºç¼–ç æ–‡æ¡£ã€‚è¿™ä¸¤ä¸ªç¼–ç å™¨å°†æŸ¥è¯¢å’Œæ–‡æ¡£æ˜ å°„åˆ°ç›¸åŒçš„å‘é‡ç©ºé—´ä¸­ï¼Œä»¥ä¾¿è¿›è¡Œç›¸ä¼¼åº¦è®¡ç®—ã€‚</li></ul><ol start="2"><li><strong>ç”Ÿæˆæ¨¡å—ï¼ˆGeneratorï¼‰ï¼š</strong></li></ol><ul><li>å¼ºå¤§çš„ç”Ÿæˆæ¨¡å‹ï¼šç”Ÿæˆæ¨¡å—é€šå¸¸ä½¿ç”¨åœ¨å¤§è§„æ¨¡æ•°æ®ä¸Šé¢„è®­ç»ƒçš„ç”Ÿæˆæ¨¡å‹ï¼ˆå¦‚GLMï¼‰ï¼Œè¿™äº›æ¨¡å‹åœ¨ç”Ÿæˆè‡ªç„¶è¯­è¨€æ–‡æœ¬æ–¹é¢è¡¨ç°å‡ºè‰²ã€‚</li><li>ä¸Šä¸‹æ–‡èåˆï¼šç”Ÿæˆæ¨¡å—å°†æ£€ç´¢åˆ°çš„ç›¸å…³æ–‡æ¡£ä¸åŸå§‹æŸ¥è¯¢åˆå¹¶ï¼Œå½¢æˆæ›´ä¸°å¯Œçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œä½œä¸ºç”Ÿæˆæ¨¡å‹çš„è¾“å…¥ã€‚</li><li>ç”Ÿæˆè¿‡ç¨‹ï¼šç”Ÿæˆæ¨¡å‹æ ¹æ®è¾“å…¥çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œç”Ÿæˆè¿è´¯ã€å‡†ç¡®ä¸”ä¿¡æ¯ä¸°å¯Œçš„å›ç­”æˆ–æ–‡æœ¬ã€‚</li></ul><p><strong>ç»“åˆé«˜æ•ˆçš„æ£€ç´¢æ¨¡å—ï¼ˆRetrieverï¼‰ä¸å¼ºå¤§çš„ç”Ÿæˆæ¨¡å‹ï¼ˆGeneratorï¼‰ï¼Œå®ç°åŸºäºå¤–éƒ¨çŸ¥è¯†å¢å¼ºçš„è‡ªç„¶è¯­è¨€ç”Ÿæˆèƒ½åŠ›ã€‚</strong></p><h2 id="äºŒã€RAGçš„å·¥ä½œåŸç†å’ŒåŸºæœ¬æ­å»ºæµç¨‹"><a href="#äºŒã€RAGçš„å·¥ä½œåŸç†å’ŒåŸºæœ¬æ­å»ºæµç¨‹" class="headerlink" title="äºŒã€RAGçš„å·¥ä½œåŸç†å’ŒåŸºæœ¬æ­å»ºæµç¨‹"></a>äºŒã€RAGçš„å·¥ä½œåŸç†å’ŒåŸºæœ¬æ­å»ºæµç¨‹</h2><p><img src="https://pic1.imgdb.cn/item/681b64a758cb8da5c8e3d68c.png" alt="RAGåŸºæœ¬æ­å»ºæµç¨‹"></p><p>RAGæ­å»ºè¿‡ç¨‹</p><ul><li>1.æ–‡æ¡£åŠ è½½ï¼Œå¹¶æŒ‰ä¸€å®šæ¡ä»¶åˆ‡å‰²æˆç‰‡</li><li>2.å°†åˆ‡å‰²çš„æ–‡æœ¬ç‰‡æ®µçŒäººæ£€ç´¢å¼•æ“</li><li>3.å°è£…æ£€ç´¢æ¥å£</li><li>4.æ„å»ºè°ƒç”¨æµç¨‹ï¼šQuery -&gt; æ£€ç´¢ -&gt; Prompt -&gt; LLM -&gt; å›å¤</li></ul><h3 id="2-1-æ–‡æ¡£çš„åŠ è½½ä¸åˆ‡å‰²"><a href="#2-1-æ–‡æ¡£çš„åŠ è½½ä¸åˆ‡å‰²" class="headerlink" title="2.1 æ–‡æ¡£çš„åŠ è½½ä¸åˆ‡å‰²"></a><strong>2.1 æ–‡æ¡£çš„åŠ è½½ä¸åˆ‡å‰²</strong></h3><p>å®‰è£… pdf è§£æåº“</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip <span class="token function">install</span> pdfminer.six<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ„å»ºæ–‡æ¡£æå–æ–‡å­—æ–¹æ³•</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pdfminer<span class="token punctuation">.</span>high_level <span class="token keyword">import</span> extract_pages<span class="token keyword">from</span> pdfminer<span class="token punctuation">.</span>layout <span class="token keyword">import</span> LTTextContainer<span class="token keyword">def</span> <span class="token function">extract_text_from_pdf</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> page_numbers<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> min_line_length<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">'''ä» PDF æ–‡ä»¶ä¸­ï¼ˆæŒ‰æŒ‡å®šé¡µç ï¼‰æå–æ–‡å­—'''</span>        paragraphs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token builtin">buffer</span> <span class="token operator">=</span> <span class="token string">''</span>    full_text <span class="token operator">=</span> <span class="token string">''</span>    <span class="token comment"># æå–å…¨éƒ¨æ–‡æœ¬</span>    <span class="token keyword">for</span> i<span class="token punctuation">,</span> page_layout <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>extract_pages<span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># å¦‚æœæŒ‡å®šäº†é¡µç èŒƒå›´ï¼Œè·³è¿‡èŒƒå›´å¤–çš„é¡µ</span>        <span class="token keyword">if</span> page_numbers <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">and</span> i <span class="token keyword">not</span> <span class="token keyword">in</span> page_numbers<span class="token punctuation">:</span>            <span class="token keyword">continue</span>        <span class="token keyword">for</span> element <span class="token keyword">in</span> page_layout<span class="token punctuation">:</span>            <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> LTTextContainer<span class="token punctuation">)</span><span class="token punctuation">:</span>                full_text <span class="token operator">+=</span> element<span class="token punctuation">.</span>get_text<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\n'</span>    <span class="token comment"># æŒ‰ç©ºè¡Œåˆ†éš”ï¼Œå°†æ–‡æœ¬é‡æ–°ç»„ç»‡æˆæ®µè½</span>    lines <span class="token operator">=</span> full_text<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> text <span class="token keyword">in</span> lines<span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> min_line_length<span class="token punctuation">:</span>            <span class="token builtin">buffer</span> <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token string">' '</span><span class="token operator">+</span>text<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token keyword">not</span> text<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span> <span class="token keyword">else</span> text<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span>        <span class="token keyword">elif</span> <span class="token builtin">buffer</span><span class="token punctuation">:</span>            paragraphs<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">buffer</span><span class="token punctuation">)</span>            <span class="token builtin">buffer</span> <span class="token operator">=</span> <span class="token string">''</span>    <span class="token keyword">if</span> <span class="token builtin">buffer</span><span class="token punctuation">:</span>        paragraphs<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">buffer</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> paragraphs<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è°ƒç”¨æ–¹æ³•åŠ è½½æœ¬åœ°æ–‡æ¡£</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">paragraphs <span class="token operator">=</span> extract_text_from_pdf<span class="token punctuation">(</span><span class="token string">"llama2.pdf"</span><span class="token punctuation">,</span> min_line_length<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token comment"># æ‰“å°æ–‡æ¡£å‰4æ®µå†…å®¹</span><span class="token keyword">for</span> para <span class="token keyword">in</span> paragraphs<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>para<span class="token operator">+</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-2-LLMæ¥å£å°è£…"><a href="#2-2-LLMæ¥å£å°è£…" class="headerlink" title="2.2 LLMæ¥å£å°è£…"></a><strong>2.2 LLMæ¥å£å°è£…</strong></h3><p>å®‰è£…openaiåº“å’Œç¯å¢ƒå˜é‡åº“</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip <span class="token function">install</span> <span class="token parameter variable">--upgrade</span> openaipip <span class="token function">install</span> <span class="token parameter variable">-U</span> python-dotenv<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>åŠ è½½ç¯å¢ƒå˜é‡ï¼Œå°†æˆ‘ä»¬çš„OpenAI Key åŠ è½½è¿›æ¥ï¼Œåœ¨æ ¹ç›®å½•å»ºä¸€ä¸ª <code>.env</code>  æ–‡ä»¶ï¼ŒæŠŠæˆ‘ä»¬ç”³è¯·çš„<code>OPENAI_API_KEY</code> å¡«å†™è¿›å»ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-none"><code class="language-none">OPENAI_API_KEY=Bearer hk-xxxxxxxxxxxxxxxOPENAI_BASE_URL=https://api.openai-hk.com/v1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>ç¼–å†™ä»£ç åŠ è½½ç¯å¢ƒå˜é‡</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> os<span class="token keyword">from</span> openai <span class="token keyword">import</span> OpenAI<span class="token comment"># åŠ è½½ç¯å¢ƒå˜é‡</span><span class="token keyword">from</span> dotenv <span class="token keyword">import</span> load_dotenv<span class="token punctuation">,</span> find_dotenv_ <span class="token operator">=</span> load_dotenv<span class="token punctuation">(</span>find_dotenv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># è¯»å–æœ¬åœ° .env æ–‡ä»¶ï¼Œé‡Œé¢å®šä¹‰äº† OPENAI_API_KEY</span>client <span class="token operator">=</span> OpenAI<span class="token punctuation">(</span>api_key<span class="token operator">=</span>os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">"OPENAI_API_KEY"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>base_url<span class="token operator">=</span><span class="token string">"https://api.openai-hk.com/v1"</span><span class="token punctuation">,</span> <span class="token punctuation">)</span>  <span class="token comment"># ä½¿ç”¨é¦™æ¸¯çš„ API æœåŠ¡å™¨</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å®‰è£…<code>requests</code>åŒ…</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip <span class="token function">install</span> requests<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å°è£… openai æ¥å£</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_completion</span><span class="token punctuation">(</span>prompt<span class="token punctuation">,</span> model<span class="token operator">=</span><span class="token string">"gpt-4o"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">'''å°è£… openai æ¥å£'''</span>    messages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> prompt<span class="token punctuation">}</span><span class="token punctuation">]</span>    response <span class="token operator">=</span> client<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span>create<span class="token punctuation">(</span>        model<span class="token operator">=</span>model<span class="token punctuation">,</span>        messages<span class="token operator">=</span>messages<span class="token punctuation">,</span>        temperature<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">,</span>   <span class="token comment"># æ§åˆ¶è¾“å‡ºçš„éšæœºæ€§ï¼Œ0.0-1.0ä¹‹é—´ï¼Œè¶Šå°è¶Šç¡®å®š</span>    <span class="token punctuation">)</span>    <span class="token keyword">return</span> response<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message<span class="token punctuation">.</span>content<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2-3-Prompt-æ¨¡æ¿"><a href="#2-3-Prompt-æ¨¡æ¿" class="headerlink" title="2.3 Prompt æ¨¡æ¿"></a><strong>2.3 Prompt æ¨¡æ¿</strong></h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">build_prompt</span><span class="token punctuation">(</span>prompt_template<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">'''å°† Prompt æ¨¡æ¿èµ‹å€¼'''</span>        inputs <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> kwargs<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token builtin">all</span><span class="token punctuation">(</span><span class="token builtin">isinstance</span><span class="token punctuation">(</span>elem<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token keyword">for</span> elem <span class="token keyword">in</span> v<span class="token punctuation">)</span><span class="token punctuation">:</span>            val <span class="token operator">=</span> <span class="token string">'\n\n'</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>v<span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            val <span class="token operator">=</span> v        inputs<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> val    <span class="token keyword">return</span> prompt_template<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token operator">**</span>inputs<span class="token punctuation">)</span>prompt_template <span class="token operator">=</span> <span class="token triple-quoted-string string">"""ä½ æ˜¯ä¸€ä¸ªé—®ç­”æœºå™¨äººã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ä¸‹è¿°ç»™å®šçš„å·²çŸ¥ä¿¡æ¯ï¼Œå›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚  å·²çŸ¥ä¿¡æ¯ï¼š{context} # ä»å‘é‡æ•°æ®åº“æ£€ç´¢å‡ºåŸå§‹æ–‡æ¡£ç”¨æˆ·é—®ï¼š{query} # ç”¨æˆ·çš„æé—®å¦‚æœå·²çŸ¥ä¿¡æ¯ä¸­ä¸åŒ…å«ç”¨æˆ·é—®é¢˜çš„ç­”æ¡ˆï¼Œæˆ–è€…å·²çŸ¥ä¿¡æ¯ä¸è¶³ä»¥å›ç­”ç”¨æˆ·é—®é¢˜ï¼Œè¯·å›ç­”â€œæˆ‘æ— æ³•å›ç­”æ‚¨çš„é—®é¢˜â€ã€‚è¯·ä¸è¦è¾“å‡ºå·²çŸ¥ä¿¡æ¯ä¸­ä¸åŒ…å«çš„ä¿¡æ¯æˆ–ç­”æ¡ˆã€‚è¯·ç”¨ä¸­æ–‡å›ç­”ç”¨æˆ·é—®é¢˜ã€‚"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="ä¸‰ã€å‘é‡æ£€ç´¢"><a href="#ä¸‰ã€å‘é‡æ£€ç´¢" class="headerlink" title="ä¸‰ã€å‘é‡æ£€ç´¢"></a>ä¸‰ã€å‘é‡æ£€ç´¢</h2><h3 id="3-1-ä»€ä¹ˆæ˜¯å‘é‡"><a href="#3-1-ä»€ä¹ˆæ˜¯å‘é‡" class="headerlink" title="3.1 ä»€ä¹ˆæ˜¯å‘é‡"></a><strong>3.1 ä»€ä¹ˆæ˜¯å‘é‡</strong></h3><p>å‘é‡æ˜¯ä¸€ç§æœ‰å¤§å°å’Œæ–¹å‘çš„æ•°å­¦å¯¹è±¡ã€‚å®ƒå¯ä»¥è¡¨ç¤ºä¸ºä»ä¸€ä¸ªç‚¹åˆ°å¦ä¸€ä¸ªç‚¹çš„æœ‰å‘çº¿æ®µã€‚ä¾‹å¦‚ï¼ŒäºŒç»´ç©ºé—´ä¸­çš„å‘é‡å¯ä»¥è¡¨ç¤ºä¸º $(x,y)$, è¡¨ç¤ºä»åŸç‚¹ $(0,0)$ åˆ°ç‚¹ $(x,y)$ çš„æœ‰å‘çº¿æ®µã€‚</p><p><img src="https://pic1.imgdb.cn/item/681b6be158cb8da5c8e3d9ad.png" alt="å‘é‡åæ ‡å›¾"></p><p>ä»¥æ­¤ç±»æ¨ï¼Œæˆ‘å¯ä»¥ç”¨ä¸€ç»„åæ ‡ $(x_0, x_1, \ldots, x_{N-1})$ è¡¨ç¤ºä¸€ä¸ª $N$ ç»´ç©ºé—´ä¸­çš„å‘é‡, $N$ å«å‘é‡çš„ç»´åº¦ã€‚</p><h4 id="3-1-1-æ–‡æœ¬å‘é‡ï¼ˆText-Embeddingsï¼‰"><a href="#3-1-1-æ–‡æœ¬å‘é‡ï¼ˆText-Embeddingsï¼‰" class="headerlink" title="3.1.1 æ–‡æœ¬å‘é‡ï¼ˆText Embeddingsï¼‰"></a><strong>3.1.1 æ–‡æœ¬å‘é‡ï¼ˆText Embeddingsï¼‰</strong></h4><ol><li>å°†æ–‡æœ¬è½¬æ¢æˆä¸€ç»„ $N$ ç»´æµ®ç‚¹æ•°ï¼Œå³<strong>æ–‡æœ¬å‘é‡</strong>åˆå« Embeddings</li><li>å‘é‡ä¹‹é—´å¯ä»¥è®¡ç®—è·ç¦»ï¼Œè·ç¦»è¿œè¿‘å¯¹åº”<strong>è¯­ä¹‰ç›¸ä¼¼åº¦</strong>å¤§å°</li></ol><p><img src="https://pic1.imgdb.cn/item/681b6c4e58cb8da5c8e3d9e9.png" alt="embeddings"></p><h4 id="3-1-2-æ–‡æœ¬å‘é‡æ˜¯æ€æ ·å¾—åˆ°çš„"><a href="#3-1-2-æ–‡æœ¬å‘é‡æ˜¯æ€æ ·å¾—åˆ°çš„" class="headerlink" title="3.1.2 æ–‡æœ¬å‘é‡æ˜¯æ€æ ·å¾—åˆ°çš„"></a><strong>3.1.2 æ–‡æœ¬å‘é‡æ˜¯æ€æ ·å¾—åˆ°çš„</strong></h4><ol><li>æ„å»ºç›¸å…³ï¼ˆæ­£ä¾‹ï¼‰ä¸ä¸ç›¸å…³ï¼ˆè´Ÿä¾‹ï¼‰çš„å¥å­å¯¹æ ·æœ¬</li><li>è®­ç»ƒåŒå¡”æ¨¡å‹ï¼Œè®©æ­£ä¾‹é—´çš„è·ç¦»å°ï¼Œè´Ÿä¾‹é—´çš„è·ç¦»å¤§</li></ol><p>ä¾‹å¦‚ï¼š<br><img src="https://pic1.imgdb.cn/item/681b6c4e58cb8da5c8e3d9e7.png" alt="sbert"></p><div class="alert alert-info"><b>æ‰©å±•é˜…è¯»ï¼šhttps://www.sbert.net</b></div><h3 id="3-2-å‘é‡é—´çš„ç›¸ä¼¼åº¦è®¡ç®—"><a href="#3-2-å‘é‡é—´çš„ç›¸ä¼¼åº¦è®¡ç®—" class="headerlink" title="3.2 å‘é‡é—´çš„ç›¸ä¼¼åº¦è®¡ç®—"></a><strong>3.2 å‘é‡é—´çš„ç›¸ä¼¼åº¦è®¡ç®—</strong></h3><p>å‘é‡é—´çš„ç›¸ä¼¼åº¦è®¡ç®—åœ¨æ•°å­¦ä¸Šæœ‰æ¬§æ°è·ç¦»å’Œä½™å¼¦è·ç¦»ä¸¤ç§ã€‚<br><img src="https://pic1.imgdb.cn/item/681b6be158cb8da5c8e3d9ac.png" alt="å‘é‡ç›¸ä¼¼åº¦è®¡ç®—"></p><p>å®‰è£…<code>numpy</code>åº“</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip <span class="token function">install</span> numpy<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ„å»ºç›¸ä¼¼åº¦è®¡ç®—å…¬å¼ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np<span class="token keyword">from</span> numpy <span class="token keyword">import</span> dot<span class="token keyword">from</span> numpy<span class="token punctuation">.</span>linalg <span class="token keyword">import</span> norm<span class="token keyword">def</span> <span class="token function">cos_sim</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">'''ä½™å¼¦è·ç¦» -- è¶Šå¤§è¶Šç›¸ä¼¼'''</span>    <span class="token keyword">return</span> dot<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span>norm<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token operator">*</span>norm<span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">l2</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">'''æ¬§æ°è·ç¦» -- è¶Šå°è¶Šç›¸ä¼¼'''</span>    x <span class="token operator">=</span> np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token operator">-</span>np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>b<span class="token punctuation">)</span>    <span class="token keyword">return</span> norm<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å°è£… openai çš„ Embeddings æ¨¡å‹æ¥å£</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_embeddings</span><span class="token punctuation">(</span>texts<span class="token punctuation">,</span> model<span class="token operator">=</span><span class="token string">"text-embedding-ada-002"</span><span class="token punctuation">,</span> dimensions<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">'''å°è£… OpenAI çš„ Embedding æ¨¡å‹æ¥å£'''</span>    <span class="token keyword">if</span> model <span class="token operator">==</span> <span class="token string">"text-embedding-ada-002"</span><span class="token punctuation">:</span>        dimensions <span class="token operator">=</span> <span class="token boolean">None</span>            <span class="token keyword">if</span> dimensions<span class="token punctuation">:</span>        data <span class="token operator">=</span> client<span class="token punctuation">.</span>embeddings<span class="token punctuation">.</span>create<span class="token punctuation">(</span>            <span class="token builtin">input</span><span class="token operator">=</span>texts<span class="token punctuation">,</span> model<span class="token operator">=</span>model<span class="token punctuation">,</span> dimensions<span class="token operator">=</span>dimensions<span class="token punctuation">)</span><span class="token punctuation">.</span>data    <span class="token keyword">else</span><span class="token punctuation">:</span>        data <span class="token operator">=</span> client<span class="token punctuation">.</span>embeddings<span class="token punctuation">.</span>create<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token operator">=</span>texts<span class="token punctuation">,</span> model<span class="token operator">=</span>model<span class="token punctuation">)</span><span class="token punctuation">.</span>data    <span class="token keyword">return</span> <span class="token punctuation">[</span>x<span class="token punctuation">.</span>embedding <span class="token keyword">for</span> x <span class="token keyword">in</span> data<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="alert alert-info"><b>Embeddingæ¨¡å‹çš„é€‰æ‹©æ ‡å‡†ï¼šæ‰¾éœ€æ±‚ç›¸å…³çš„è¯­æ–™åº“æ¥è¿›è¡Œæ–‡æœ¬å‘é‡è½¬æ¢æµ‹è¯•ï¼Œè¿›è¡Œè¯„ä¼°ã€‚<br>å¤§å¤šæ•°åœºæ™¯ä¸‹ï¼Œå¼€æºçš„åµŒå…¥æ¨¡å‹ä½¿ç”¨éƒ½å¾ˆä¸€èˆ¬ï¼Œè¦æå‡æ£€ç´¢å¬å›ç‡ï¼Œå»ºè®®å¯¹æ¨¡å‹è¿›è¡Œå¾®è°ƒã€‚</b></div><p>è¿›è¡Œæµ‹è¯•</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">test_query <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"æµ‹è¯•æ–‡æœ¬"</span><span class="token punctuation">]</span>vec <span class="token operator">=</span> get_embeddings<span class="token punctuation">(</span>test_query<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Total dimension: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>vec<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"First 10 elements: </span><span class="token interpolation"><span class="token punctuation">{</span>vec<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token format-spec">10]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>è¾“å‡ºçš„ç»“æœå¦‚ä¸‹ï¼š</p><pre class="line-numbers language-none"><code class="language-none">Total dimension: 1536First 10 elements: [-0.007280503865331411, -0.006169671658426523, -0.010576579719781876, 0.001448634546250105, -0.010707695037126541, 0.02919485792517662, -0.019725468009710312, 0.0053902678191661835, -0.016957491636276245, -0.01203340943902731]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>æˆ‘ä»¬æ¥ç”¨ä¸€äº›æ–‡æœ¬ä¾‹å­ï¼Œè®¡ç®—æ¯”è¾ƒå®ƒä»¬çš„å‘é‡ç›¸ä¼¼åº¦</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">query <span class="token operator">=</span> <span class="token string">"å›½é™…äº‰ç«¯"</span>documents <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token string">"è”åˆå›½å°±è‹ä¸¹è¾¾å°”å¯Œå°”åœ°åŒºå¤§è§„æ¨¡æš´åŠ›äº‹ä»¶å‘å‡ºè­¦å‘Š"</span><span class="token punctuation">,</span>    <span class="token string">"åœŸè€³å…¶ã€èŠ¬å…°ã€ç‘å…¸ä¸åŒ—çº¦ä»£è¡¨å°†ç»§ç»­å°±ç‘å…¸â€œå…¥çº¦â€é—®é¢˜è¿›è¡Œè°ˆåˆ¤"</span><span class="token punctuation">,</span>    <span class="token string">"æ—¥æœ¬å²é˜œå¸‚é™†ä¸Šè‡ªå«é˜Ÿå°„å‡»åœºå†…å‘ç”Ÿæªå‡»äº‹ä»¶ 3äººå—ä¼¤"</span><span class="token punctuation">,</span>    <span class="token string">"å›½å®¶æ¸¸æ³³ä¸­å¿ƒï¼ˆæ°´ç«‹æ–¹ï¼‰ï¼šæ¢å¤æ¸¸æ³³ã€å¬‰æ°´ä¹å›­ç­‰æ°´ä¸Šé¡¹ç›®è¿è¥"</span><span class="token punctuation">,</span>    <span class="token string">"æˆ‘å›½é¦–æ¬¡åœ¨ç©ºé—´ç«™å¼€å±•èˆ±å¤–è¾å°„ç”Ÿç‰©å­¦æš´éœ²å®éªŒ"</span><span class="token punctuation">,</span><span class="token punctuation">]</span>query_vec <span class="token operator">=</span> get_embeddings<span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>doc_vecs <span class="token operator">=</span> get_embeddings<span class="token punctuation">(</span>documents<span class="token punctuation">)</span><span class="token comment"># è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Queryä¸è‡ªå·±çš„ä½™å¼¦ç›¸ä¼¼åº¦ï¼š{:.2f}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>cos_sim<span class="token punctuation">(</span>query_vec<span class="token punctuation">,</span> query_vec<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># è®¡ç®—Queryä¸Documentsçš„ä½™å¼¦ç›¸ä¼¼åº¦</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Queryä¸Documentsçš„ä½™å¼¦ç›¸ä¼¼åº¦ï¼š"</span><span class="token punctuation">)</span><span class="token keyword">for</span> vec <span class="token keyword">in</span> doc_vecs<span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>cos_sim<span class="token punctuation">(</span>query_vec<span class="token punctuation">,</span> vec<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># è®¡ç®—æ¬§æ°è·ç¦»</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Queryä¸è‡ªå·±çš„æ¬§æ°è·ç¦»ï¼š{:.2f}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>l2<span class="token punctuation">(</span>query_vec<span class="token punctuation">,</span> query_vec<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># è®¡ç®—Queryä¸Documentsçš„æ¬§æ°è·ç¦»</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Queryä¸Documentsçš„æ¬§æ°è·ç¦»ï¼š"</span><span class="token punctuation">)</span><span class="token keyword">for</span> vec <span class="token keyword">in</span> doc_vecs<span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>l2<span class="token punctuation">(</span>query_vec<span class="token punctuation">,</span> vec<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿è¡Œçš„ç»“æœå¦‚ä¸‹ï¼š</p><pre class="line-numbers language-none"><code class="language-none">Queryä¸è‡ªå·±çš„ä½™å¼¦ç›¸ä¼¼åº¦ï¼š1.00Queryä¸Documentsçš„ä½™å¼¦ç›¸ä¼¼åº¦ï¼š0.82187066204548860.82935716838328580.79770473361543210.7669801767537340.7930490196304245Queryä¸è‡ªå·±çš„æ¬§æ°è·ç¦»ï¼š0.00Queryä¸Documentsçš„æ¬§æ°è·ç¦»ï¼š0.59687410717183940.58419660593308320.63607431665981110.68267094129920980.6433521233350966<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="3-3-å‘é‡æ•°æ®åº“"><a href="#3-3-å‘é‡æ•°æ®åº“" class="headerlink" title="3.3 å‘é‡æ•°æ®åº“"></a><strong>3.3 å‘é‡æ•°æ®åº“</strong></h3><p>å‘é‡æ•°æ®åº“æ˜¯ä¸“é—¨ä¸ºå‘é‡æ£€ç´¢è®¾è®¡çš„ä¸­é—´ä»¶</p><p>å®‰è£…<code>chromadb</code>å‘é‡åº“åŒ…</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip <span class="token function">install</span> chromadb<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è§£ææ–‡æ¡£</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># ä¸ºäº†æ¼”ç¤ºæ–¹ä¾¿ï¼Œæˆ‘ä»¬åªå–ä¸¤é¡µï¼ˆç¬¬ä¸€ç« ï¼‰</span>paragraphs <span class="token operator">=</span> extract_text_from_pdf<span class="token punctuation">(</span>    <span class="token string">"llama2.pdf"</span><span class="token punctuation">,</span>    page_numbers<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    min_line_length<span class="token operator">=</span><span class="token number">10</span>    <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åˆ›å»ºMyVectorDBConnectorç±»</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> chromadb<span class="token keyword">from</span> chromadb<span class="token punctuation">.</span>config <span class="token keyword">import</span> Settings<span class="token comment"># åˆ›å»ºMyVectorDBConnectorç±»</span><span class="token keyword">class</span> <span class="token class-name">MyVectorDBConnector</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> collection_name<span class="token punctuation">,</span> embedding_fn<span class="token punctuation">)</span><span class="token punctuation">:</span>        chroma_client <span class="token operator">=</span> chromadb<span class="token punctuation">.</span>Client<span class="token punctuation">(</span>Settings<span class="token punctuation">(</span>allow_reset<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token comment"># ä¸ºäº†æ¼”ç¤ºï¼Œå®é™…ä¸éœ€è¦æ¯æ¬¡ reset()</span>        chroma_client<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment"># åˆ›å»ºä¸€ä¸ª collection</span>        self<span class="token punctuation">.</span>collection <span class="token operator">=</span> chroma_client<span class="token punctuation">.</span>get_or_create_collection<span class="token punctuation">(</span>name<span class="token operator">=</span>collection_name<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>embedding_fn <span class="token operator">=</span> embedding_fn      <span class="token keyword">def</span> <span class="token function">add_documents</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> documents<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">'''å‘ collection ä¸­æ·»åŠ æ–‡æ¡£ä¸å‘é‡'''</span>        self<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>add<span class="token punctuation">(</span>            embeddings<span class="token operator">=</span>self<span class="token punctuation">.</span>embedding_fn<span class="token punctuation">(</span>documents<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># æ¯ä¸ªæ–‡æ¡£çš„å‘é‡</span>            documents<span class="token operator">=</span>documents<span class="token punctuation">,</span>  <span class="token comment"># æ–‡æ¡£çš„åŸæ–‡</span>            ids<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f"id</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">"</span></span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>documents<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment"># æ¯ä¸ªæ–‡æ¡£çš„ id</span>        <span class="token punctuation">)</span>            <span class="token keyword">def</span> <span class="token function">search</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> query<span class="token punctuation">,</span> top_n<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">'''æ£€ç´¢å‘é‡æ•°æ®åº“'''</span>        results <span class="token operator">=</span> self<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>query<span class="token punctuation">(</span>            query_embeddings<span class="token operator">=</span>self<span class="token punctuation">.</span>embedding_fn<span class="token punctuation">(</span><span class="token punctuation">[</span>query<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            n_results<span class="token operator">=</span>top_n        <span class="token punctuation">)</span>        <span class="token keyword">return</span> results<span class="token comment"># åˆ›å»ºä¸€ä¸ªå‘é‡æ•°æ®åº“å¯¹è±¡</span>vector_db <span class="token operator">=</span> MyVectorDBConnector<span class="token punctuation">(</span><span class="token string">"demo"</span><span class="token punctuation">,</span> get_embeddings<span class="token punctuation">)</span><span class="token comment"># å‘é‡æ•°æ®åº“ä¸­æ·»åŠ æ–‡æ¡£</span>vector_db<span class="token punctuation">.</span>add_documents<span class="token punctuation">(</span>paragraphs<span class="token punctuation">)</span>user_query <span class="token operator">=</span> <span class="token string">"Llama 2æœ‰å¤šå°‘å‚æ•°ï¼Ÿ"</span><span class="token comment"># user_query = "Does Llama 2 have a conversational variant"</span>results <span class="token operator">=</span> vector_db<span class="token punctuation">.</span>search<span class="token punctuation">(</span>user_query<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token keyword">for</span> para <span class="token keyword">in</span> results<span class="token punctuation">[</span><span class="token string">'documents'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>para<span class="token operator">+</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š</p><pre class="line-numbers language-none"><code class="language-none">1. Llama 2, an updated version of Llama 1, trained on a new mix of publicly available data. We also increased the size of the pretraining corpus by 40%, doubled the context length of the model, and adopted grouped-query attention (Ainslie et al., 2023). We are releasing variants of Llama 2 with 7B, 13B, and 70B parameters. We have also trained 34B variants, which we report on in this paper but are not releasing.Â§ In this work, we develop and release Llama 2, a family of pretrained and ï¬ne-tuned LLMs, Llama 2 and Llama 2-Chat, at scales up to 70B parameters. On the series of helpfulness and safety benchmarks we tested, Llama 2-Chat models generally perform better than existing open-source models. They also appear to be on par with some of the closed-source models, at least on the human evaluations we performed (see Figures 1 and 3). We have taken measures to increase the safety of these models, using safety-speciï¬c data annotation and tuning, as well as conducting red-teaming and employing iterative evaluations. Additionally, this paper contributes a thorough description of our ï¬ne-tuning methodology and approach to improving LLM safety. We hope that this openness will enable the community to reproduce ï¬ne-tuned LLMs and continue to improve the safety of those models, paving the way for more responsible development of LLMs. We also share novel observations we made during the development of Llama 2 and Llama 2-Chat, such as the emergence of tool usage and temporal organization of knowledge.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><div class="alert alert-success"><b>æ¾„æ¸…å‡ ä¸ªå…³é”®æ¦‚å¿µï¼š</b><ul>&nbsp; &nbsp; <li>å‘é‡æ•°æ®åº“çš„æ„ä¹‰æ˜¯å¿«é€Ÿçš„æ£€ç´¢ï¼›</li>&nbsp; &nbsp; <li>å‘é‡æ•°æ®åº“æœ¬èº«ä¸ç”Ÿæˆå‘é‡ï¼Œå‘é‡æ˜¯ç”± Embedding æ¨¡å‹äº§ç”Ÿçš„ï¼›</li>&nbsp; &nbsp; <li>å‘é‡æ•°æ®åº“ä¸ä¼ ç»Ÿçš„å…³ç³»å‹æ•°æ®åº“æ˜¯äº’è¡¥çš„ï¼Œä¸æ˜¯æ›¿ä»£å…³ç³»ï¼Œåœ¨å®é™…åº”ç”¨ä¸­æ ¹æ®å®é™…éœ€æ±‚ç»å¸¸åŒæ—¶ä½¿ç”¨ã€‚</li></ul></div><h4 id="3-3-1-å‘é‡æ•°æ®åº“æœåŠ¡"><a href="#3-3-1-å‘é‡æ•°æ®åº“æœåŠ¡" class="headerlink" title="3.3.1 å‘é‡æ•°æ®åº“æœåŠ¡"></a><strong>3.3.1 å‘é‡æ•°æ®åº“æœåŠ¡</strong></h4><p>Server ç«¯</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">chroma run <span class="token parameter variable">--path</span> /db_path<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>Client ç«¯</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> chromadbchroma_client <span class="token operator">=</span> chromadb<span class="token punctuation">.</span>HttpClient<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'localhost'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">8000</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h4 id="3-3-2-ä¸»æµå‘é‡æ•°æ®åº“åŠŸèƒ½å¯¹æ¯”"><a href="#3-3-2-ä¸»æµå‘é‡æ•°æ®åº“åŠŸèƒ½å¯¹æ¯”" class="headerlink" title="3.3.2 ä¸»æµå‘é‡æ•°æ®åº“åŠŸèƒ½å¯¹æ¯”"></a><strong>3.3.2 ä¸»æµå‘é‡æ•°æ®åº“åŠŸèƒ½å¯¹æ¯”</strong></h4><p><img src="https://pic1.imgdb.cn/item/681b6be158cb8da5c8e3d9ab.png" alt="ä¸»æµå‘é‡æ•°æ®åº“åŠŸèƒ½å¯¹æ¯”"></p><ul><li>FAISS: Meta å¼€æºçš„å‘é‡æ£€ç´¢å¼•æ“ <a href="https://github.com/facebookresearch/faiss">https://github.com/facebookresearch/faiss</a></li><li>Pinecone: å•†ç”¨å‘é‡æ•°æ®åº“ï¼Œåªæœ‰äº‘æœåŠ¡ <a href="https://www.pinecone.io/">https://www.pinecone.io/</a></li><li><strong>Milvus</strong>: å¼€æºå‘é‡æ•°æ®åº“ï¼ŒåŒæ—¶æœ‰äº‘æœåŠ¡ <a href="https://milvus.io/">https://milvus.io/</a></li><li>Weaviate: å¼€æºå‘é‡æ•°æ®åº“ï¼ŒåŒæ—¶æœ‰äº‘æœåŠ¡ <a href="https://weaviate.io/">https://weaviate.io/</a></li><li><strong>Qdrant</strong>: å¼€æºå‘é‡æ•°æ®åº“ï¼ŒåŒæ—¶æœ‰äº‘æœåŠ¡ <a href="https://qdrant.tech/">https://qdrant.tech/</a></li><li>PGVector: Postgres çš„å¼€æºå‘é‡æ£€ç´¢å¼•æ“ <a href="https://github.com/pgvector/pgvector">https://github.com/pgvector/pgvector</a></li><li>RediSearch: Redis çš„å¼€æºå‘é‡æ£€ç´¢å¼•æ“ <a href="https://github.com/RediSearch/RediSearch">https://github.com/RediSearch/RediSearch</a></li><li>ElasticSearch ä¹Ÿæ”¯æŒå‘é‡æ£€ç´¢ <a href="https://www.elastic.co/enterprise-search/vector-search">https://www.elastic.co/enterprise-search/vector-search</a></li></ul><div class="alert alert-info"><b>æ‰©å±•é˜…è¯»ï¼šhttps://guangzhengli.com/blog/zh/vector-database</b></div><h3 id="3-4-åŸºäºå‘é‡æ£€ç´¢çš„RAG"><a href="#3-4-åŸºäºå‘é‡æ£€ç´¢çš„RAG" class="headerlink" title="3.4 åŸºäºå‘é‡æ£€ç´¢çš„RAG"></a><strong>3.4 åŸºäºå‘é‡æ£€ç´¢çš„RAG</strong></h3><p>æ„å»ºRAG_Botç±»</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">RAG_Bot</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> vector_db<span class="token punctuation">,</span> llm_api<span class="token punctuation">,</span> n_results<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>vector_db <span class="token operator">=</span> vector_db        self<span class="token punctuation">.</span>llm_api <span class="token operator">=</span>  llm_api        self<span class="token punctuation">.</span>n_results <span class="token operator">=</span> n_results    <span class="token keyword">def</span> <span class="token function">chat</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_query<span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token comment"># 1. æ£€ç´¢</span>        search_results <span class="token operator">=</span> self<span class="token punctuation">.</span>vector_db<span class="token punctuation">.</span>search<span class="token punctuation">(</span>user_query<span class="token punctuation">,</span> self<span class="token punctuation">.</span>n_results<span class="token punctuation">)</span>        <span class="token comment"># 2. æ„å»º Prompt</span>        prompt <span class="token operator">=</span> build_prompt<span class="token punctuation">(</span>            prompt_template<span class="token punctuation">,</span> context<span class="token operator">=</span>search_results<span class="token punctuation">[</span><span class="token string">'documents'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> query<span class="token operator">=</span>user_query<span class="token punctuation">)</span>                    <span class="token comment"># 3. è°ƒç”¨ LLM</span>        response <span class="token operator">=</span> self<span class="token punctuation">.</span>llm_api<span class="token punctuation">(</span>prompt<span class="token punctuation">)</span>        <span class="token keyword">return</span> response<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åˆ›å»ºä¸€ä¸ªRAGæœºå™¨äººå¯¹è±¡</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># åˆ›å»ºä¸€ä¸ªRAGæœºå™¨äºº</span>bot <span class="token operator">=</span> RAG_Bot<span class="token punctuation">(</span>    vector_db<span class="token punctuation">,</span>    llm_api<span class="token operator">=</span>get_completion<span class="token punctuation">)</span>user_query <span class="token operator">=</span> <span class="token string">"llama 2æœ‰å¤šå°‘å‚æ•°?"</span>response <span class="token operator">=</span> bot<span class="token punctuation">.</span>chat<span class="token punctuation">(</span>user_query<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œè¾“å‡ºå†…å®¹å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-none"><code class="language-none">Llama 2æœ‰7Bã€13Bå’Œ70Bå‚æ•°çš„å˜ä½“ã€‚<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="3-5-OpenAI-æ–°å‘å¸ƒçš„ä¸¤ä¸ªEmbeddingæ¨¡å‹"><a href="#3-5-OpenAI-æ–°å‘å¸ƒçš„ä¸¤ä¸ªEmbeddingæ¨¡å‹" class="headerlink" title="3.5 OpenAI æ–°å‘å¸ƒçš„ä¸¤ä¸ªEmbeddingæ¨¡å‹"></a>3.5 OpenAI æ–°å‘å¸ƒçš„ä¸¤ä¸ªEmbeddingæ¨¡å‹</h2><p>2024 å¹´ 1 æœˆ 25 æ—¥ï¼ŒOpenAI æ–°å‘å¸ƒäº†ä¸¤ä¸ª Embedding æ¨¡å‹</p><ul><li>text-embedding-3-large</li><li>text-embedding-3-small</li></ul><p>å…¶æœ€å¤§ç‰¹ç‚¹æ˜¯ï¼Œæ”¯æŒè‡ªå®šä¹‰çš„ç¼©çŸ­å‘é‡ç»´åº¦ï¼Œä»è€Œåœ¨å‡ ä¹ä¸å½±å“æœ€ç»ˆæ•ˆæœçš„æƒ…å†µä¸‹é™ä½å‘é‡æ£€ç´¢ä¸ç›¸ä¼¼åº¦è®¡ç®—çš„å¤æ‚åº¦ã€‚</p><p>é€šä¿—çš„è¯´ï¼š<strong>è¶Šå¤§è¶Šå‡†ã€è¶Šå°è¶Šå¿«ã€‚</strong> å®˜æ–¹å…¬å¸ƒçš„è¯„æµ‹ç»“æœ:</p><p><img src="https://pic1.imgdb.cn/item/681b6c4e58cb8da5c8e3d9e8.png" alt="å®˜æ–¹æµ‹è¯„ç»“æœ"></p><p>æ³¨ï¼š<a href="https://huggingface.co/blog/mteb">MTEB</a> æ˜¯ä¸€ä¸ªå¤§è§„æ¨¡å¤šä»»åŠ¡çš„ Embedding æ¨¡å‹å…¬å¼€è¯„æµ‹é›†</p><div class="alert alert-info"><b>RAGç³»ç»ŸåŸºæœ¬éœ€è¦ç”¨åˆ° ä¸¤ä¸ªæ¨¡å‹<br>embeddedæ¨¡å‹ï¼šé‡‡ç”¨open ai çš„çº¿ä¸Šæ¨¡å‹ï¼Œå‘é‡æ¨¡å‹çš„ç²¾ç¡®åº¦ç›´æ¥å½±å“query ç›¸ä¼¼åº¦æ£€ç´¢çš„æ–‡æ¡£å¬å›ç‡<br>æ–‡æœ¬ç”Ÿæˆæ¨¡å‹ï¼ˆå¯¹è¯æ¨¡å‹ï¼‰ï¼šé‡‡ç”¨æœ¬åœ°ç§æœ‰åŒ–éƒ¨ç½²æ¨¡å‹</b></div><p>æµ‹è¯• <code>text-embedding-3-large</code> Embeddingæ¨¡å‹æ•ˆæœ</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">model <span class="token operator">=</span> <span class="token string">"text-embedding-3-large"</span>dimensions <span class="token operator">=</span> <span class="token number">128</span><span class="token comment"># query = "å›½é™…äº‰ç«¯"</span><span class="token comment"># ä¸”èƒ½æ”¯æŒè·¨è¯­è¨€</span>query <span class="token operator">=</span> <span class="token string">"global conflicts"</span>documents <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token string">"è”åˆå›½å°±è‹ä¸¹è¾¾å°”å¯Œå°”åœ°åŒºå¤§è§„æ¨¡æš´åŠ›äº‹ä»¶å‘å‡ºè­¦å‘Š"</span><span class="token punctuation">,</span>    <span class="token string">"åœŸè€³å…¶ã€èŠ¬å…°ã€ç‘å…¸ä¸åŒ—çº¦ä»£è¡¨å°†ç»§ç»­å°±ç‘å…¸â€œå…¥çº¦â€é—®é¢˜è¿›è¡Œè°ˆåˆ¤"</span><span class="token punctuation">,</span>    <span class="token string">"æ—¥æœ¬å²é˜œå¸‚é™†ä¸Šè‡ªå«é˜Ÿå°„å‡»åœºå†…å‘ç”Ÿæªå‡»äº‹ä»¶ 3äººå—ä¼¤"</span><span class="token punctuation">,</span>    <span class="token string">"å›½å®¶æ¸¸æ³³ä¸­å¿ƒï¼ˆæ°´ç«‹æ–¹ï¼‰ï¼šæ¢å¤æ¸¸æ³³ã€å¬‰æ°´ä¹å›­ç­‰æ°´ä¸Šé¡¹ç›®è¿è¥"</span><span class="token punctuation">,</span>    <span class="token string">"æˆ‘å›½é¦–æ¬¡åœ¨ç©ºé—´ç«™å¼€å±•èˆ±å¤–è¾å°„ç”Ÿç‰©å­¦æš´éœ²å®éªŒ"</span><span class="token punctuation">,</span><span class="token punctuation">]</span>query_vec <span class="token operator">=</span> get_embeddings<span class="token punctuation">(</span><span class="token punctuation">[</span>query<span class="token punctuation">]</span><span class="token punctuation">,</span> model<span class="token operator">=</span>model<span class="token punctuation">,</span> dimensions<span class="token operator">=</span>dimensions<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>doc_vecs <span class="token operator">=</span> get_embeddings<span class="token punctuation">(</span>documents<span class="token punctuation">,</span> model<span class="token operator">=</span>model<span class="token punctuation">,</span> dimensions<span class="token operator">=</span>dimensions<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"å‘é‡ç»´åº¦: {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>query_vec<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Queryä¸Documentsçš„ä½™å¼¦è·ç¦»:"</span><span class="token punctuation">)</span><span class="token keyword">for</span> vec <span class="token keyword">in</span> doc_vecs<span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>cos_sim<span class="token punctuation">(</span>query_vec<span class="token punctuation">,</span> vec<span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Queryä¸Documentsçš„æ¬§æ°è·ç¦»:"</span><span class="token punctuation">)</span><span class="token keyword">for</span> vec <span class="token keyword">in</span> doc_vecs<span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>l2<span class="token punctuation">(</span>query_vec<span class="token punctuation">,</span> vec<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¾“å‡ºå†…å®¹å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-none"><code class="language-none">å‘é‡ç»´åº¦: 128Queryä¸Documentsçš„ä½™å¼¦è·ç¦»:0.334187961723793340.354629772522801260.313645991288170170.224224483912154550.12849126788491727Queryä¸Documentsçš„æ¬§æ°è·ç¦»:1.15396015653256321.13610757183249671.17162626179870681.24561272431458341.320233859479998<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="alert alert-info"><b>æ‰©å±•é˜…è¯»ï¼šè¿™ç§å¯å˜é•¿åº¦çš„ Embedding æŠ€æœ¯èƒŒåçš„åŸç†å«åš <a href="https://arxiv.org/abs/2205.13147">Matryoshka Representation Learning</a> </b></div><h2 id="å››ã€-å®æˆ˜-RAG-ç³»ç»Ÿçš„è¿›é˜¶çŸ¥è¯†"><a href="#å››ã€-å®æˆ˜-RAG-ç³»ç»Ÿçš„è¿›é˜¶çŸ¥è¯†" class="headerlink" title="å››ã€ å®æˆ˜ RAG ç³»ç»Ÿçš„è¿›é˜¶çŸ¥è¯†"></a>å››ã€ å®æˆ˜ RAG ç³»ç»Ÿçš„è¿›é˜¶çŸ¥è¯†</h2><h3 id="4-1-æ–‡æœ¬åˆ†å‰²çš„ç²’åº¦"><a href="#4-1-æ–‡æœ¬åˆ†å‰²çš„ç²’åº¦" class="headerlink" title="4.1 æ–‡æœ¬åˆ†å‰²çš„ç²’åº¦"></a>4.1 æ–‡æœ¬åˆ†å‰²çš„ç²’åº¦</h3><p><strong>ç¼ºé™·</strong></p><ol><li>ç²’åº¦å¤ªå¤§å¯èƒ½å¯¼è‡´æ£€ç´¢ä¸ç²¾å‡†ï¼Œç²’åº¦å¤ªå°å¯èƒ½å¯¼è‡´ä¿¡æ¯ä¸å…¨é¢</li><li>é—®é¢˜çš„ç­”æ¡ˆå¯èƒ½è·¨è¶Šä¸¤ä¸ªç‰‡æ®µ</li></ol><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># åˆ›å»ºä¸€ä¸ªå‘é‡æ•°æ®åº“å¯¹è±¡</span>vector_db <span class="token operator">=</span> MyVectorDBConnector<span class="token punctuation">(</span><span class="token string">"demo_text_split"</span><span class="token punctuation">,</span> get_embeddings<span class="token punctuation">)</span><span class="token comment"># å‘å‘é‡æ•°æ®åº“ä¸­æ·»åŠ æ–‡æ¡£</span>vector_db<span class="token punctuation">.</span>add_documents<span class="token punctuation">(</span>paragraphs<span class="token punctuation">)</span><span class="token comment"># åˆ›å»ºä¸€ä¸ªRAGæœºå™¨äºº</span>bot <span class="token operator">=</span> RAG_Bot<span class="token punctuation">(</span>    vector_db<span class="token punctuation">,</span>    llm_api<span class="token operator">=</span>get_completion<span class="token punctuation">)</span><span class="token comment"># user_query = "llama 2æœ‰å•†ç”¨è®¸å¯åè®®å—?"</span>user_query<span class="token operator">=</span><span class="token string">"llama 2 chatæœ‰å¤šå°‘å‚æ•°?"</span>search_results <span class="token operator">=</span> vector_db<span class="token punctuation">.</span>search<span class="token punctuation">(</span>user_query<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token keyword">for</span> doc <span class="token keyword">in</span> search_results<span class="token punctuation">[</span><span class="token string">'documents'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>doc<span class="token operator">+</span><span class="token string">"\n"</span><span class="token punctuation">)</span>response <span class="token operator">=</span> bot<span class="token punctuation">.</span>chat<span class="token punctuation">(</span>user_query<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"====å›å¤===="</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"=============================="</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token keyword">for</span> p <span class="token keyword">in</span> paragraphs<span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"=========="</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>p<span class="token operator">+</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¾“å‡ºå†…å®¹å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-none"><code class="language-none">In this work, we develop and release Llama 2, a family of pretrained and ï¬ne-tuned LLMs, Llama 2 and Llama 2-Chat, at scales up to 70B parameters. On the series of helpfulness and safety benchmarks we tested, Llama 2-Chat models generally perform better than existing open-source models. They also appear to be on par with some of the closed-source models, at least on the human evaluations we performed (see Figures 1 and 3). We have taken measures to increase the safety of these models, using safety-speciï¬c data annotation and tuning, as well as conducting red-teaming and employing iterative evaluations. Additionally, this paper contributes a thorough description of our ï¬ne-tuning methodology and approach to improving LLM safety. We hope that this openness will enable the community to reproduce ï¬ne-tuned LLMs and continue to improve the safety of those models, paving the way for more responsible development of LLMs. We also share novel observations we made during the development of Llama 2 and Llama 2-Chat, such as the emergence of tool usage and temporal organization of knowledge. 2. Llama 2-Chat, a ï¬ne-tuned version of Llama 2 that is optimized for dialogue use cases. We release====å›å¤====Llama 2-Chatçš„å‚æ•°è§„æ¨¡å¯ä»¥è¾¾åˆ°70Bã€‚<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>æ”¹è¿›</strong>: æŒ‰ä¸€å®šç²’åº¦ï¼Œéƒ¨åˆ†é‡å å¼çš„åˆ‡å‰²æ–‡æœ¬ï¼Œä½¿ä¸Šä¸‹æ–‡æ›´å®Œæ•´</p><p>å®‰è£…<code>nltk</code>åŒ…</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip <span class="token function">install</span> nltk<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>é‡æ–°æŒ‰ç…§ä¸€å®šæ¡ä»¶æ¥åˆ‡å‰²æ–‡æ¡£</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> nltk<span class="token punctuation">.</span>tokenize <span class="token keyword">import</span> sent_tokenize<span class="token keyword">import</span> json<span class="token comment"># chunk_size ä¸€èˆ¬æ ¹æ®æ–‡æ¡£å†…å®¹æˆ–å¤§å°æ¥è®¾ç½®</span><span class="token comment"># overlap_size ä¸€èˆ¬è®¾ç½® chunk_size å¤§å°çš„10%-20%ä¹‹é—´</span><span class="token keyword">def</span> <span class="token function">split_text</span><span class="token punctuation">(</span>paragraphs<span class="token punctuation">,</span> chunk_size<span class="token operator">=</span><span class="token number">300</span><span class="token punctuation">,</span> overlap_size<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">'''æŒ‰æŒ‡å®š chunk_size å’Œ overlap_size äº¤å å‰²æ–‡æœ¬'''</span>        sentences <span class="token operator">=</span> <span class="token punctuation">[</span>s<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> p <span class="token keyword">in</span> paragraphs <span class="token keyword">for</span> s <span class="token keyword">in</span> sent_tokenize<span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">]</span>    <span class="token comment"># sentences = [s.strip() for p in paragraphs for s in sent_tokenize(p, language='chinese')]</span>    chunks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    i <span class="token operator">=</span> <span class="token number">0</span>    <span class="token keyword">while</span> i <span class="token operator">&lt;</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sentences<span class="token punctuation">)</span><span class="token punctuation">:</span>        chunk <span class="token operator">=</span> sentences<span class="token punctuation">[</span>i<span class="token punctuation">]</span>        overlap <span class="token operator">=</span> <span class="token string">''</span>        prev_len <span class="token operator">=</span> <span class="token number">0</span>        prev <span class="token operator">=</span> i <span class="token operator">-</span> <span class="token number">1</span>        <span class="token comment"># å‘å‰è®¡ç®—é‡å éƒ¨åˆ†</span>        <span class="token keyword">while</span> prev <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token keyword">and</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sentences<span class="token punctuation">[</span>prev<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token builtin">len</span><span class="token punctuation">(</span>overlap<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> overlap_size<span class="token punctuation">:</span>            overlap <span class="token operator">=</span> sentences<span class="token punctuation">[</span>prev<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> overlap            prev <span class="token operator">-=</span> <span class="token number">1</span>        chunk <span class="token operator">=</span> overlap<span class="token operator">+</span>chunk        <span class="token builtin">next</span> <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span>        <span class="token comment"># å‘åè®¡ç®—å½“å‰chunk</span>        <span class="token keyword">while</span> <span class="token builtin">next</span> <span class="token operator">&lt;</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sentences<span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sentences<span class="token punctuation">[</span><span class="token builtin">next</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token builtin">len</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> chunk_size<span class="token punctuation">:</span>            chunk <span class="token operator">=</span> chunk <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> sentences<span class="token punctuation">[</span><span class="token builtin">next</span><span class="token punctuation">]</span>            <span class="token builtin">next</span> <span class="token operator">+=</span> <span class="token number">1</span>        chunks<span class="token punctuation">.</span>append<span class="token punctuation">(</span>chunk<span class="token punctuation">)</span>        i <span class="token operator">=</span> <span class="token builtin">next</span>    <span class="token keyword">return</span> chunkschunks <span class="token operator">=</span> split_text<span class="token punctuation">(</span>paragraphs<span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="alert alert-info">æ­¤å¤„ sent_tokenize ä¸ºé’ˆå¯¹è‹±æ–‡çš„å®ç°ï¼Œé’ˆå¯¹ä¸­æ–‡çš„å®ç°è¯·å‚è€ƒ chinese_utils.py</div><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># åˆ›å»ºä¸€ä¸ªå‘é‡æ•°æ®åº“å¯¹è±¡</span>vector_db <span class="token operator">=</span> MyVectorDBConnector<span class="token punctuation">(</span><span class="token string">"demo_text_split"</span><span class="token punctuation">,</span> get_embeddings<span class="token punctuation">)</span><span class="token comment"># å‘å‘é‡æ•°æ®åº“ä¸­æ·»åŠ æ–‡æ¡£</span>vector_db<span class="token punctuation">.</span>add_documents<span class="token punctuation">(</span>chunks<span class="token punctuation">)</span><span class="token comment"># åˆ›å»ºä¸€ä¸ªRAGæœºå™¨äºº</span>bot <span class="token operator">=</span> RAG_Bot<span class="token punctuation">(</span>     vector_db<span class="token punctuation">,</span>     llm_api<span class="token operator">=</span>get_completion<span class="token punctuation">)</span><span class="token comment"># user_query = "llama 2æœ‰å•†ç”¨è®¸å¯åè®®å—"</span>user_query<span class="token operator">=</span><span class="token string">"llama 2 chatæœ‰å¤šå°‘å‚æ•°"</span>search_results <span class="token operator">=</span> vector_db<span class="token punctuation">.</span>search<span class="token punctuation">(</span>user_query<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token keyword">for</span> doc <span class="token keyword">in</span> search_results<span class="token punctuation">[</span><span class="token string">'documents'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>doc<span class="token operator">+</span><span class="token string">"\n"</span><span class="token punctuation">)</span>response <span class="token operator">=</span> bot<span class="token punctuation">.</span>chat<span class="token punctuation">(</span>user_query<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"====å›å¤===="</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç»“æœè¾“å‡ºå¦‚ä¸‹ï¼š</p><pre class="line-numbers language-none"><code class="language-none">2. Llama 2-Chat, a ï¬ne-tuned version of Llama 2 that is optimized for dialogue use cases. We release variants of this model with 7B, 13B, and 70B parameters as well. We believe that the open release of LLMs, when done safely, will be a net beneï¬t to society.In this work, we develop and release Llama 2, a family of pretrained and ï¬ne-tuned LLMs, Llama 2 and Llama 2-Chat, at scales up to 70B parameters. On the series of helpfulness and safety benchmarks we tested, Llama 2-Chat models generally perform better than existing open-source models.====å›å¤====Llama 2-Chat å…·æœ‰ 7Bã€13B å’Œ 70B ä¸‰ç§ä¸åŒçš„å‚æ•°è§„æ¨¡ã€‚<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ–‡æœ¬åˆ‡å‰²</p><ul><li>chunksize å’Œ overlap æ¥é‡å åˆ‡å‰²<br>&nbsp; &nbsp; - \n \n\n åŸºäºæŸäº›è§„åˆ™æ¥åˆ‡åˆ†çš„</li><li>å¯¹äºå¤æ‚çš„æ–‡æœ¬çš„åˆ‡åˆ†<br>&nbsp; &nbsp; - NSPä»»åŠ¡æ¥è¿›è¡Œå¾®è°ƒè®­ç»ƒï¼ˆæ‹¿è‡ªå·±çš„ä¸šåŠ¡æ•°æ®æ¥å–‚æŠ•ï¼‰<br>&nbsp; &nbsp; &nbsp; &nbsp; - Aå’ŒBä¸¤ä¸ªå¥å­ï¼ˆæ®µè½ï¼‰æ˜¯å¦æœ‰å…³ç³»<br>&nbsp; &nbsp; &nbsp; &nbsp; è‹¥æœ‰å…³ç³»åˆ™è¿›è¡Œåˆå¹¶</li></ul><h3 id="4-2-æ£€ç´¢åæ’åº"><a href="#4-2-æ£€ç´¢åæ’åº" class="headerlink" title="4.2 æ£€ç´¢åæ’åº"></a>4.2 æ£€ç´¢åæ’åº</h3><p>é—®é¢˜ï¼šæœ‰æ—¶ï¼Œæœ€åˆé€‚çš„ç­”æ¡ˆä¸ä¸€å®šæ’åœ¨æ£€ç´¢çš„æœ€å‰é¢ï¼Œä¾‹å¦‚ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">user_query <span class="token operator">=</span> <span class="token string">"how safe is llama 2"</span>search_results <span class="token operator">=</span> vector_db<span class="token punctuation">.</span>search<span class="token punctuation">(</span>user_query<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token keyword">for</span> doc <span class="token keyword">in</span> search_results<span class="token punctuation">[</span><span class="token string">'documents'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>doc<span class="token operator">+</span><span class="token string">"\n"</span><span class="token punctuation">)</span>response <span class="token operator">=</span> bot<span class="token punctuation">.</span>chat<span class="token punctuation">(</span>user_query<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"====å›å¤===="</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç»“æœè¾“å‡ºå¦‚ä¸‹ï¼š</p><pre class="line-numbers language-none"><code class="language-none">We believe that the open release of LLMs, when done safely, will be a net beneï¬t to society. Like all LLMs, Llama 2 is a new technology that carries potential risks with use (Bender et al., 2021b; Weidinger et al., 2021; Solaiman et al., 2023).We also share novel observations we made during the development of Llama 2 and Llama 2-Chat, such as the emergence of tool usage and temporal organization of knowledge. Figure 3: Safety human evaluation results for Llama 2-Chat compared to other open-source and closed source models.In this work, we develop and release Llama 2, a family of pretrained and ï¬ne-tuned LLMs, Llama 2 and Llama 2-Chat, at scales up to 70B parameters. On the series of helpfulness and safety benchmarks we tested, Llama 2-Chat models generally perform better than existing open-source models.Additionally, these safety evaluations are performed using content standards that are likely to be biased towards the Llama 2-Chat models. We are releasing the following models to the general public for research and commercial useâ€¡: 1.We provide a responsible use guideÂ¶ and code examplesâ€– to facilitate the safe deployment of Llama 2 and Llama 2-Chat. More details of our responsible release strategy can be found in Section 5.3.====å›å¤====æˆ‘æ— æ³•å›ç­”æ‚¨çš„é—®é¢˜ã€‚<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>æ–¹æ¡ˆ</strong>:</p><ol><li>æ£€ç´¢æ—¶é€šè¿‡æ‹›å›ä¸€éƒ¨åˆ†æ–‡æœ¬</li><li>é€šè¿‡ä¸€ä¸ªæ’åºæ¨¡å‹å¯¹ query å’Œ document é‡æ–°æ‰“åˆ†æ’åº</li></ol><p><img src="https://pic1.imgdb.cn/item/681b6be158cb8da5c8e3d9ae.png" alt="æ£€ç´¢å¬å›"></p><div class="alert alert-danger">ä»¥ä¸‹ä»£ç è¿è¡Œå‰æˆ‘ä»¬è¦ç¡®ä¿èƒ½è®¿é—® Hugging Faceï¼</div>å®‰è£…`sentence_transformers`åº“<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip <span class="token function">install</span> sentence_transformers<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> sentence_transformers <span class="token keyword">import</span> CrossEncoder<span class="token comment"># è®¿é—®è°ƒç”¨Hugging Faceæ¨¡å‹</span>model <span class="token operator">=</span> CrossEncoder<span class="token punctuation">(</span><span class="token string">'cross-encoder/ms-marco-MiniLM-L-6-v2'</span><span class="token punctuation">,</span> max_length<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">)</span> <span class="token comment"># è‹±æ–‡ï¼Œæ¨¡å‹è¾ƒå°</span><span class="token comment"># model = CrossEncoder('BAAI/bge-reranker-large', max_length=512) # å¤šè¯­è¨€ï¼Œå›½äº§ï¼Œæ¨¡å‹è¾ƒå¤§</span>user_query <span class="token operator">=</span> <span class="token string">"how safe is llama 2"</span><span class="token comment"># user_query = "llama 2å®‰å…¨æ€§å¦‚ä½•"</span>scores <span class="token operator">=</span> model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span>user_query<span class="token punctuation">,</span> doc<span class="token punctuation">)</span> <span class="token keyword">for</span> doc <span class="token keyword">in</span> search_results<span class="token punctuation">[</span><span class="token string">'documents'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment"># æŒ‰å¾—åˆ†æ’åº</span>sorted_list <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span>scores<span class="token punctuation">,</span> search_results<span class="token punctuation">[</span><span class="token string">'documents'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token keyword">for</span> score<span class="token punctuation">,</span> doc <span class="token keyword">in</span> sorted_list<span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>score<span class="token punctuation">}</span></span><span class="token string">\t</span><span class="token interpolation"><span class="token punctuation">{</span>doc<span class="token punctuation">}</span></span><span class="token string">\n"</span></span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¾“å‡ºç»“æœå¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°ä¸‹é¢å†…å®¹æ˜¯æŒ‰å¾—åˆ†ç„¶åé‡æ–°æ’åºå¾—åˆ°çš„ï¼š</p><pre class="line-numbers language-none"><code class="language-none">6.613734722137451We believe that the open release of LLMs, when done safely, will be a net beneï¬t to society. Like all LLMs, Llama 2 is a new technology that carries potential risks with use (Bender et al., 2021b; Weidinger et al., 2021; Solaiman et al., 2023).5.310717582702637In this work, we develop and release Llama 2, a family of pretrained and ï¬ne-tuned LLMs, Llama 2 and Llama 2-Chat, at scales up to 70B parameters. On the series of helpfulness and safety benchmarks we tested, Llama 2-Chat models generally perform better than existing open-source models.4.709955215454102We provide a responsible use guideÂ¶ and code examplesâ€– to facilitate the safe deployment of Llama 2 and Llama 2-Chat. More details of our responsible release strategy can be found in Section 5.3.4.5439653396606445We also share novel observations we made during the development of Llama 2 and Llama 2-Chat, such as the emergence of tool usage and temporal organization of knowledge. Figure 3: Safety human evaluation results for Llama 2-Chat compared to other open-source and closed source models.4.0338897705078125Additionally, these safety evaluations are performed using content standards that are likely to be biased towards the Llama 2-Chat models. We are releasing the following models to the general public for research and commercial useâ€¡: 1.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><div class="alert alert-danger">ï¼æ‰€ä»¥åˆ‡å‰²ä¹Ÿæ¯”è¾ƒé‡è¦ï¼Œè¿™é‡Œæˆ‘å› ä¸ºå‰é¢æ–°åˆ‡å‰²æ–¹æ³•æŠ¥é”™æ‰€ä»¥æ²¡æœ‰ä½¿ç”¨æ–°çš„åˆ‡å‰²åçš„æ–‡æœ¬ï¼Œè¿™é‡Œè¾“å‡ºçš„ç­”æ¡ˆæœ‰äº›æ˜¯ä¸åŒçš„</div><h4 id="ä¸€äº›-Rerank-çš„-API-æœåŠ¡"><a href="#ä¸€äº›-Rerank-çš„-API-æœåŠ¡" class="headerlink" title="ä¸€äº› Rerank çš„ API æœåŠ¡"></a>ä¸€äº› Rerank çš„ API æœåŠ¡</h4><ul><li><a href="https://cohere.com/rerank">Cohere Rerank</a>ï¼šæ”¯æŒå¤šè¯­è¨€</li><li><a href="https://jina.ai/reranker/">Jina Rerank</a>ï¼šç›®å‰åªæ”¯æŒè‹±æ–‡</li></ul><h3 id="4-3-æ··åˆæ£€ç´¢ï¼ˆHybrid-Searchï¼‰"><a href="#4-3-æ··åˆæ£€ç´¢ï¼ˆHybrid-Searchï¼‰" class="headerlink" title="4.3 æ··åˆæ£€ç´¢ï¼ˆHybrid Searchï¼‰"></a><strong>4.3 æ··åˆæ£€ç´¢ï¼ˆHybrid Searchï¼‰</strong></h3><p>åœ¨<strong>å®é™…ç”Ÿäº§</strong>ä¸­ï¼Œä¼ ç»Ÿçš„å…³é”®å­—æ£€ç´¢ï¼ˆç¨€ç–è¡¨ç¤ºï¼‰ä¸å‘é‡æ£€ç´¢ï¼ˆç¨ å¯†è¡¨ç¤ºï¼‰å„æœ‰ä¼˜åŠ£ã€‚</p><p>ä¸¾ä¸ªå…·ä½“ä¾‹å­ï¼Œæ¯”å¦‚æ–‡æ¡£ä¸­åŒ…å«å¾ˆé•¿çš„ä¸“æœ‰åè¯ï¼Œå…³é”®å­—æ£€ç´¢å¾€å¾€æ›´ç²¾å‡†è€Œå‘é‡æ£€ç´¢å®¹æ˜“å¼•å…¥æ¦‚å¿µæ··æ·†ã€‚</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># èƒŒæ™¯è¯´æ˜ï¼šåœ¨åŒ»å­¦ä¸­â€œå°ç»†èƒè‚ºç™Œâ€å’Œâ€œéå°ç»†èƒè‚ºç™Œâ€æ˜¯ä¸¤ç§ä¸åŒçš„ç™Œç—‡</span>query <span class="token operator">=</span> <span class="token string">"éå°ç»†èƒè‚ºç™Œçš„æ‚£è€…"</span>documents <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token string">"ç›ä¸½æ‚£æœ‰è‚ºç™Œï¼Œç™Œç»†èƒå·²è½¬ç§»"</span><span class="token punctuation">,</span>    <span class="token string">"åˆ˜æŸè‚ºç™ŒIæœŸ"</span><span class="token punctuation">,</span>    <span class="token string">"å¼ æŸç»è¯Šæ–­ä¸ºéå°ç»†èƒè‚ºç™ŒIIIæœŸ"</span><span class="token punctuation">,</span>    <span class="token string">"å°ç»†èƒè‚ºç™Œæ˜¯è‚ºç™Œçš„ä¸€ç§"</span><span class="token punctuation">]</span>query_vec <span class="token operator">=</span> get_embeddings<span class="token punctuation">(</span><span class="token punctuation">[</span>query<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>doc_vecs <span class="token operator">=</span> get_embeddings<span class="token punctuation">(</span>documents<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Cosine distance:"</span><span class="token punctuation">)</span><span class="token keyword">for</span> vec <span class="token keyword">in</span> doc_vecs<span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>cos_sim<span class="token punctuation">(</span>query_vec<span class="token punctuation">,</span> vec<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¾“å‡ºçš„ç»“æœå¦‚ä¸‹ï¼š</p><pre class="line-numbers language-none"><code class="language-none">Cosine distance:0.89128713111663220.88961358836605530.90398946691422090.9131454293290566<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰€ä»¥ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦ç»“åˆä¸åŒçš„æ£€ç´¢ç®—æ³•ï¼Œæ¥è¾¾åˆ°æ¯”å•ä¸€æ£€ç´¢ç®—æ³•æ›´ä¼˜çš„æ•ˆæœã€‚è¿™å°±æ˜¯<strong>æ··åˆæ£€ç´¢</strong>ã€‚<br>æ··åˆæ£€ç´¢çš„æ ¸å¿ƒæ˜¯ï¼Œç»¼åˆæ–‡æ¡£ $d$ åœ¨ä¸åŒæ£€ç´¢ç®—æ³•ä¸‹çš„æ’åºåæ¬¡ï¼ˆrankï¼‰ï¼Œä¸ºå…¶ç”Ÿæˆæœ€ç»ˆæ’åºã€‚<br>ä¸€ä¸ªæœ€å¸¸ç”¨çš„ç®—æ³•å« <strong>Reciprocal Rank Fusionï¼ˆRRFï¼‰</strong><br>$rrf(d)=\sum_{a\in A}\frac{1}{k+rank_a(d)}$<br>å…¶ä¸­ $A$ è¡¨ç¤ºæ‰€æœ‰ä½¿ç”¨çš„æ£€ç´¢ç®—æ³•çš„é›†åˆï¼Œ$rank_a(d)$ è¡¨ç¤ºä½¿ç”¨ç®—æ³• $a$ æ£€ç´¢æ—¶ï¼Œæ–‡æ¡£ $d$ çš„æ’åºï¼Œ$k$ æ˜¯ä¸ªå¸¸æ•°ã€‚<br>å¾ˆå¤šå‘é‡æ•°æ®åº“éƒ½æ”¯æŒæ··åˆæ£€ç´¢ï¼Œæ¯”å¦‚ <a href="https://weaviate.io/blog/hybrid-search-explained">Weaviate</a>ã€<a href="https://www.pinecone.io/learn/hybrid-search-intro/">Pinecone</a> ç­‰ã€‚ä¹Ÿå¯ä»¥æ ¹æ®ä¸Šè¿°åŸç†è‡ªå·±å®ç°ã€‚</p><h4 id="4-3-1-æ‰‹å†™ä¸ªç®€å•çš„ä¾‹å­"><a href="#4-3-1-æ‰‹å†™ä¸ªç®€å•çš„ä¾‹å­" class="headerlink" title="4.3.1 æ‰‹å†™ä¸ªç®€å•çš„ä¾‹å­"></a>4.3.1 æ‰‹å†™ä¸ªç®€å•çš„ä¾‹å­</h4><div class="alert alert-danger">æ³¨æ„ï¼šéœ€è¦å®‰è£…å¥½ Elastic Search Serverï¼Œå¹¶å¯åŠ¨ï¼</div><p>1.åŸºäºå…³é”®å­—æ£€ç´¢çš„æ’åº</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip <span class="token function">install</span> elasticsearch7<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> time<span class="token keyword">class</span> <span class="token class-name">MyEsConnector</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> es_client<span class="token punctuation">,</span> index_name<span class="token punctuation">,</span> keyword_fn<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>es_client <span class="token operator">=</span> es_client        self<span class="token punctuation">.</span>index_name <span class="token operator">=</span> index_name        self<span class="token punctuation">.</span>keyword_fn <span class="token operator">=</span> keyword_fn    <span class="token keyword">def</span> <span class="token function">add_documents</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> documents<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">'''æ–‡æ¡£çŒåº“'''</span>        <span class="token keyword">if</span> self<span class="token punctuation">.</span>es_client<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>index<span class="token operator">=</span>self<span class="token punctuation">.</span>index_name<span class="token punctuation">)</span><span class="token punctuation">:</span>            self<span class="token punctuation">.</span>es_client<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>delete<span class="token punctuation">(</span>index<span class="token operator">=</span>self<span class="token punctuation">.</span>index_name<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>es_client<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>create<span class="token punctuation">(</span>index<span class="token operator">=</span>self<span class="token punctuation">.</span>index_name<span class="token punctuation">)</span>        actions <span class="token operator">=</span> <span class="token punctuation">[</span>            <span class="token punctuation">{</span>                <span class="token string">"_index"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>index_name<span class="token punctuation">,</span>                <span class="token string">"_source"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>                    <span class="token string">"keywords"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>keyword_fn<span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span class="token punctuation">,</span>                    <span class="token string">"text"</span><span class="token punctuation">:</span> doc<span class="token punctuation">,</span>                    <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"doc_</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">"</span></span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token keyword">for</span> i<span class="token punctuation">,</span> doc <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>documents<span class="token punctuation">)</span>        <span class="token punctuation">]</span>        helpers<span class="token punctuation">.</span>bulk<span class="token punctuation">(</span>self<span class="token punctuation">.</span>es_client<span class="token punctuation">,</span> actions<span class="token punctuation">)</span>        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">search</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> query_string<span class="token punctuation">,</span> top_n<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">'''æ£€ç´¢'''</span>        search_query <span class="token operator">=</span> <span class="token punctuation">{</span>            <span class="token string">"match"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>                <span class="token string">"keywords"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>keyword_fn<span class="token punctuation">(</span>query_string<span class="token punctuation">)</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        res <span class="token operator">=</span> self<span class="token punctuation">.</span>es_client<span class="token punctuation">.</span>search<span class="token punctuation">(</span>            index<span class="token operator">=</span>self<span class="token punctuation">.</span>index_name<span class="token punctuation">,</span> query<span class="token operator">=</span>search_query<span class="token punctuation">,</span> size<span class="token operator">=</span>top_n<span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token punctuation">{</span>            hit<span class="token punctuation">[</span><span class="token string">"_source"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>                <span class="token string">"text"</span><span class="token punctuation">:</span> hit<span class="token punctuation">[</span><span class="token string">"_source"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"text"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                <span class="token string">"rank"</span><span class="token punctuation">:</span> i<span class="token punctuation">,</span>            <span class="token punctuation">}</span>            <span class="token keyword">for</span> i<span class="token punctuation">,</span> hit <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>res<span class="token punctuation">[</span><span class="token string">"hits"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"hits"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> chinese_utils <span class="token keyword">import</span> to_keywords  <span class="token comment"># ä½¿ç”¨ä¸­æ–‡çš„å…³é”®å­—æå–å‡½æ•°</span><span class="token comment"># å¼•å…¥é…ç½®æ–‡ä»¶</span>ELASTICSEARCH_BASE_URL <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">'ELASTICSEARCH_BASE_URL'</span><span class="token punctuation">)</span>ELASTICSEARCH_PASSWORD <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">'ELASTICSEARCH_PASSWORD'</span><span class="token punctuation">)</span>ELASTICSEARCH_NAME<span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">'ELASTICSEARCH_NAME'</span><span class="token punctuation">)</span>es <span class="token operator">=</span> Elasticsearch<span class="token punctuation">(</span>    hosts<span class="token operator">=</span><span class="token punctuation">[</span>ELASTICSEARCH_BASE_URL<span class="token punctuation">]</span><span class="token punctuation">,</span>    http_auth<span class="token operator">=</span><span class="token punctuation">(</span>ELASTICSEARCH_NAME<span class="token punctuation">,</span> ELASTICSEARCH_PASSWORD<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># ç”¨æˆ·åï¼Œå¯†ç </span><span class="token punctuation">)</span><span class="token comment"># åˆ›å»º ES è¿æ¥å™¨</span>es_connector <span class="token operator">=</span> MyEsConnector<span class="token punctuation">(</span>es<span class="token punctuation">,</span> <span class="token string">"demo_es_rrf"</span><span class="token punctuation">,</span> to_keywords<span class="token punctuation">)</span><span class="token comment"># æ–‡æ¡£çŒåº“</span>es_connector<span class="token punctuation">.</span>add_documents<span class="token punctuation">(</span>documents<span class="token punctuation">)</span><span class="token comment"># å…³é”®å­—æ£€ç´¢</span>keyword_search_results <span class="token operator">=</span> es_connector<span class="token punctuation">.</span>search<span class="token punctuation">(</span>query<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>keyword_search_results<span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>2.åŸºäºå‘é‡æ£€ç´¢çš„æ’åº</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># åˆ›å»ºå‘é‡æ•°æ®åº“è¿æ¥å™¨</span>vecdb_connector <span class="token operator">=</span> MyVectorDBConnector<span class="token punctuation">(</span><span class="token string">"demo_vec_rrf"</span><span class="token punctuation">,</span> get_embeddings<span class="token punctuation">)</span><span class="token comment"># æ–‡æ¡£çŒåº“</span>vecdb_connector<span class="token punctuation">.</span>add_documents<span class="token punctuation">(</span>documents<span class="token punctuation">)</span><span class="token comment"># å‘é‡æ£€ç´¢</span>vector_search_results <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token string">"doc_"</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>documents<span class="token punctuation">.</span>index<span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>        <span class="token string">"text"</span><span class="token punctuation">:</span> doc<span class="token punctuation">,</span>        <span class="token string">"rank"</span><span class="token punctuation">:</span> i    <span class="token punctuation">}</span>    <span class="token keyword">for</span> i<span class="token punctuation">,</span> doc <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>        vecdb_connector<span class="token punctuation">.</span>search<span class="token punctuation">(</span>query<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"documents"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    <span class="token punctuation">)</span><span class="token punctuation">}</span>  <span class="token comment"># æŠŠç»“æœè½¬æˆè·Ÿä¸Šé¢å…³é”®å­—æ£€ç´¢ç»“æœä¸€æ ·çš„æ ¼å¼</span><span class="token keyword">print</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>vector_search_results<span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>3.åŸºäº RRF çš„èåˆæ’åº</p><p>å‚è€ƒèµ„æ–™ï¼š<a href="https://learn.microsoft.com/zh-cn/azure/search/hybrid-search-ranking">https://learn.microsoft.com/zh-cn/azure/search/hybrid-search-ranking</a></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> json<span class="token keyword">def</span> <span class="token function">rrf</span><span class="token punctuation">(</span>ranks<span class="token punctuation">,</span> k<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    ret <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token comment"># éå†æ¯æ¬¡çš„æ’åºç»“æœ</span>    <span class="token keyword">for</span> rank <span class="token keyword">in</span> ranks<span class="token punctuation">:</span>        <span class="token comment"># éå†æ’åºä¸­æ¯ä¸ªå…ƒç´ </span>        <span class="token keyword">for</span> <span class="token builtin">id</span><span class="token punctuation">,</span> val <span class="token keyword">in</span> rank<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">if</span> <span class="token builtin">id</span> <span class="token keyword">not</span> <span class="token keyword">in</span> ret<span class="token punctuation">:</span>                ret<span class="token punctuation">[</span><span class="token builtin">id</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"score"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"text"</span><span class="token punctuation">:</span> val<span class="token punctuation">[</span><span class="token string">"text"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>            <span class="token comment"># è®¡ç®— RRF å¾—åˆ†</span>            ret<span class="token punctuation">[</span><span class="token builtin">id</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"score"</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1.0</span><span class="token operator">/</span><span class="token punctuation">(</span>k<span class="token operator">+</span>val<span class="token punctuation">[</span><span class="token string">"rank"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token comment"># æŒ‰ RRF å¾—åˆ†æ’åºï¼Œå¹¶è¿”å›</span>    <span class="token keyword">return</span> <span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token builtin">sorted</span><span class="token punctuation">(</span>ret<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> item<span class="token punctuation">:</span> item<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"score"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># èåˆä¸¤æ¬¡æ£€ç´¢çš„æ’åºç»“æœ</span>reranked <span class="token operator">=</span> rrf<span class="token punctuation">(</span><span class="token punctuation">[</span>keyword_search_results<span class="token punctuation">,</span> vector_search_results<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>reranked<span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="äº”ã€PDFæ–‡æ¡£ä¸­çš„è¡¨æ ¼æ€æ ·å¤„ç†"><a href="#äº”ã€PDFæ–‡æ¡£ä¸­çš„è¡¨æ ¼æ€æ ·å¤„ç†" class="headerlink" title="äº”ã€PDFæ–‡æ¡£ä¸­çš„è¡¨æ ¼æ€æ ·å¤„ç†"></a>äº”ã€PDFæ–‡æ¡£ä¸­çš„è¡¨æ ¼æ€æ ·å¤„ç†</h2><p><img src="https://pic1.imgdb.cn/item/681b6be158cb8da5c8e3d9af.png" alt="PDFä¸­è¡¨æ ¼å¤„ç†"></p><h3 id="5-1-å°†æ¯é¡µ-PDF-è½¬æˆå›¾ç‰‡"><a href="#5-1-å°†æ¯é¡µ-PDF-è½¬æˆå›¾ç‰‡" class="headerlink" title="5.1 å°†æ¯é¡µ PDF è½¬æˆå›¾ç‰‡"></a><strong>5.1 å°†æ¯é¡µ PDF è½¬æˆå›¾ç‰‡</strong></h3><p>å®‰è£… <code>PyMuPDF</code> å’Œ <code>matplotlib</code> åº“</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip <span class="token function">install</span> PyMuPDFpip <span class="token function">install</span> matplotlib<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> os<span class="token keyword">import</span> fitz<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image<span class="token keyword">def</span> <span class="token function">pdf2images</span><span class="token punctuation">(</span>pdf_file<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">'''å°† PDF æ¯é¡µè½¬æˆä¸€ä¸ª PNG å›¾åƒ'''</span>    <span class="token comment"># ä¿å­˜è·¯å¾„ä¸ºåŸ PDF æ–‡ä»¶åï¼ˆä¸å«æ‰©å±•åï¼‰</span>    output_directory_path<span class="token punctuation">,</span> _ <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>splitext<span class="token punctuation">(</span>pdf_file<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>output_directory_path<span class="token punctuation">)</span><span class="token punctuation">:</span>        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>output_directory_path<span class="token punctuation">)</span>    <span class="token comment"># åŠ è½½ PDF æ–‡ä»¶</span>    pdf_document <span class="token operator">=</span> fitz<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>pdf_file<span class="token punctuation">)</span>    <span class="token comment"># æ¯é¡µè½¬ä¸€å¼ å›¾</span>    <span class="token keyword">for</span> page_number <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>pdf_document<span class="token punctuation">.</span>page_count<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># å–ä¸€é¡µ</span>        page <span class="token operator">=</span> pdf_document<span class="token punctuation">[</span>page_number<span class="token punctuation">]</span>        <span class="token comment"># è½¬å›¾åƒ</span>        pix <span class="token operator">=</span> page<span class="token punctuation">.</span>get_pixmap<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment"># ä»ä½å›¾åˆ›å»º PNG å¯¹è±¡</span>        image <span class="token operator">=</span> Image<span class="token punctuation">.</span>frombytes<span class="token punctuation">(</span><span class="token string">"RGB"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>pix<span class="token punctuation">.</span>width<span class="token punctuation">,</span> pix<span class="token punctuation">.</span>height<span class="token punctuation">]</span><span class="token punctuation">,</span> pix<span class="token punctuation">.</span>samples<span class="token punctuation">)</span>        <span class="token comment"># ä¿å­˜ PNG æ–‡ä»¶</span>        image<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"./</span><span class="token interpolation"><span class="token punctuation">{</span>output_directory_path<span class="token punctuation">}</span></span><span class="token string">/page_</span><span class="token interpolation"><span class="token punctuation">{</span>page_number <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">.png"</span></span><span class="token punctuation">)</span>    <span class="token comment"># å…³é—­ PDF æ–‡ä»¶</span>    pdf_document<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image<span class="token keyword">import</span> os<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt<span class="token keyword">def</span> <span class="token function">show_images</span><span class="token punctuation">(</span>dir_path<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">'''æ˜¾ç¤ºç›®å½•ä¸‹çš„ PNG å›¾åƒ'''</span>    <span class="token keyword">for</span> <span class="token builtin">file</span> <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>dir_path<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> <span class="token builtin">file</span><span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">'.png'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token comment"># æ‰“å¼€å›¾åƒ</span>            img <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>dir_path<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token comment"># æ˜¾ç¤ºå›¾åƒ</span>            plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>img<span class="token punctuation">)</span>            plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>  <span class="token comment"># ä¸æ˜¾ç¤ºåæ ‡è½´</span>            plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python">pdf2images<span class="token punctuation">(</span><span class="token string">"llama2_page8.pdf"</span><span class="token punctuation">)</span>show_images<span class="token punctuation">(</span><span class="token string">"llama2_page8"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>ç»“æœè¾“å‡ºå¦‚ä¸‹ï¼š</p><p><img src="https://pic1.imgdb.cn/item/681bf96d58cb8da5c8e3e89a.png" alt="PDFè¡¨æ ¼è½¬å›¾ç‰‡"></p><h3 id="5-2-è¯†åˆ«æ–‡æ¡£ï¼ˆå›¾ç‰‡ï¼‰ä¸­çš„è¡¨æ ¼"><a href="#5-2-è¯†åˆ«æ–‡æ¡£ï¼ˆå›¾ç‰‡ï¼‰ä¸­çš„è¡¨æ ¼" class="headerlink" title="5.2 è¯†åˆ«æ–‡æ¡£ï¼ˆå›¾ç‰‡ï¼‰ä¸­çš„è¡¨æ ¼"></a><strong>5.2 è¯†åˆ«æ–‡æ¡£ï¼ˆå›¾ç‰‡ï¼‰ä¸­çš„è¡¨æ ¼</strong></h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">MaxResize</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">'''ç¼©æ”¾å›¾åƒ'''</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> max_size<span class="token operator">=</span><span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>max_size <span class="token operator">=</span> max_size    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> image<span class="token punctuation">)</span><span class="token punctuation">:</span>        width<span class="token punctuation">,</span> height <span class="token operator">=</span> image<span class="token punctuation">.</span>size        current_max_size <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span>        scale <span class="token operator">=</span> self<span class="token punctuation">.</span>max_size <span class="token operator">/</span> current_max_size        resized_image <span class="token operator">=</span> image<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>            <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>scale <span class="token operator">*</span> width<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>scale <span class="token operator">*</span> height<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">)</span>        <span class="token keyword">return</span> resized_image<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å®‰è£…ä¸‰ä¸ªç¯å¢ƒåŒ…ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">pip <span class="token function">install</span> torchvisionpip <span class="token function">install</span> transformerspip <span class="token function">install</span> timm<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> torchvision<span class="token punctuation">.</span>transforms <span class="token keyword">as</span> transforms<span class="token comment"># å›¾åƒé¢„å¤„ç†</span>detection_transform <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span>    <span class="token punctuation">[</span>        MaxResize<span class="token punctuation">(</span><span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token comment"># å°†åŸå§‹çš„PILImageæ ¼å¼çš„æ•°æ®æ ¼å¼åŒ–ä¸ºå¯è¢«pytorchå¿«é€Ÿå¤„ç†çš„å¼ é‡ç±»å‹</span>        transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">from</span> transformers <span class="token keyword">import</span> AutoModelForObjectDetection<span class="token comment"># åŠ è½½ TableTransformer æ¨¡å‹</span>model <span class="token operator">=</span> AutoModelForObjectDetection<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span>    <span class="token string">"microsoft/table-transformer-detection"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¯†åˆ«åçš„åæ ‡æ¢ç®—å’Œåå¤„ç†</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># è¯†åˆ«åçš„åæ ‡æ¢ç®—ä¸åå¤„ç†</span><span class="token keyword">def</span> <span class="token function">box_cxcywh_to_xyxy</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">'''åæ ‡è½¬æ¢'''</span>    x_c<span class="token punctuation">,</span> y_c<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h <span class="token operator">=</span> x<span class="token punctuation">.</span>unbind<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    b <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>x_c <span class="token operator">-</span> <span class="token number">0.5</span> <span class="token operator">*</span> w<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>y_c <span class="token operator">-</span> <span class="token number">0.5</span> <span class="token operator">*</span> h<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>x_c <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> w<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>y_c <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> h<span class="token punctuation">)</span><span class="token punctuation">]</span>    <span class="token keyword">return</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>b<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">rescale_bboxes</span><span class="token punctuation">(</span>out_bbox<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">'''åŒºåŸŸç¼©æ”¾'''</span>    width<span class="token punctuation">,</span> height <span class="token operator">=</span> size    boxes <span class="token operator">=</span> box_cxcywh_to_xyxy<span class="token punctuation">(</span>out_bbox<span class="token punctuation">)</span>    boxes <span class="token operator">=</span> boxes <span class="token operator">*</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>        <span class="token punctuation">[</span>width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32    <span class="token punctuation">)</span>    <span class="token keyword">return</span> boxes<span class="token keyword">def</span> <span class="token function">outputs_to_objects</span><span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> img_size<span class="token punctuation">,</span> id2label<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">'''ä»æ¨¡å‹è¾“å‡ºä¸­å–å®šä½æ¡†åæ ‡'''</span>    m <span class="token operator">=</span> outputs<span class="token punctuation">.</span>logits<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>    pred_labels <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>indices<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    pred_scores <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>values<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    pred_bboxes <span class="token operator">=</span> outputs<span class="token punctuation">[</span><span class="token string">"pred_boxes"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>    pred_bboxes <span class="token operator">=</span> <span class="token punctuation">[</span>        elem<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> elem <span class="token keyword">in</span> rescale_bboxes<span class="token punctuation">(</span>pred_bboxes<span class="token punctuation">,</span> img_size<span class="token punctuation">)</span>    <span class="token punctuation">]</span>    objects <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">for</span> label<span class="token punctuation">,</span> score<span class="token punctuation">,</span> bbox <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>pred_labels<span class="token punctuation">,</span> pred_scores<span class="token punctuation">,</span> pred_bboxes<span class="token punctuation">)</span><span class="token punctuation">:</span>        class_label <span class="token operator">=</span> id2label<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>label<span class="token punctuation">)</span><span class="token punctuation">]</span>        <span class="token keyword">if</span> <span class="token keyword">not</span> class_label <span class="token operator">==</span> <span class="token string">"no object"</span><span class="token punctuation">:</span>            objects<span class="token punctuation">.</span>append<span class="token punctuation">(</span>                <span class="token punctuation">{</span>                    <span class="token string">"label"</span><span class="token punctuation">:</span> class_label<span class="token punctuation">,</span>                    <span class="token string">"score"</span><span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">(</span>score<span class="token punctuation">)</span><span class="token punctuation">,</span>                    <span class="token string">"bbox"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">(</span>elem<span class="token punctuation">)</span> <span class="token keyword">for</span> elem <span class="token keyword">in</span> bbox<span class="token punctuation">]</span><span class="token punctuation">,</span>                <span class="token punctuation">}</span>            <span class="token punctuation">)</span>    <span class="token keyword">return</span> objects<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¯†åˆ«è¡¨æ ¼ï¼Œå¹¶å°†è¡¨æ ¼éƒ¨åˆ†å•ç‹¬å­˜ä¸ºå›¾åƒæ–‡ä»¶</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> torch<span class="token comment"># è¯†åˆ«è¡¨æ ¼ï¼Œå¹¶å°†è¡¨æ ¼éƒ¨åˆ†å•ç‹¬å­˜ä¸ºå›¾åƒæ–‡ä»¶</span><span class="token keyword">def</span> <span class="token function">detect_and_crop_save_table</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># åŠ è½½å›¾åƒï¼ˆPDFé¡µï¼‰    </span>    image <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span>    filename<span class="token punctuation">,</span> _ <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>splitext<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>basename<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment"># è¾“å‡ºè·¯å¾„</span>    cropped_table_directory <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"table_images"</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>cropped_table_directory<span class="token punctuation">)</span><span class="token punctuation">:</span>        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>cropped_table_directory<span class="token punctuation">)</span>    <span class="token comment"># é¢„å¤„ç†</span>    pixel_values <span class="token operator">=</span> detection_transform<span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>    <span class="token comment"># è¯†åˆ«è¡¨æ ¼</span>    <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        outputs <span class="token operator">=</span> model<span class="token punctuation">(</span>pixel_values<span class="token punctuation">)</span>    <span class="token comment"># åå¤„ç†ï¼Œå¾—åˆ°è¡¨æ ¼å­åŒºåŸŸ</span>    id2label <span class="token operator">=</span> model<span class="token punctuation">.</span>config<span class="token punctuation">.</span>id2label    id2label<span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>config<span class="token punctuation">.</span>id2label<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"no object"</span>    detected_tables <span class="token operator">=</span> outputs_to_objects<span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> image<span class="token punctuation">.</span>size<span class="token punctuation">,</span> id2label<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"number of tables detected </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>detected_tables<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>    <span class="token keyword">for</span> idx <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>detected_tables<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># å°†è¯†åˆ«ä»çš„è¡¨æ ¼åŒºåŸŸå•ç‹¬å­˜ä¸ºå›¾åƒ</span>        cropped_table <span class="token operator">=</span> image<span class="token punctuation">.</span>crop<span class="token punctuation">(</span>detected_tables<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"bbox"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        cropped_table<span class="token punctuation">.</span>save<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>cropped_table_directory<span class="token punctuation">,</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>filename<span class="token punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token punctuation">{</span>idx<span class="token punctuation">}</span></span><span class="token string">.png"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ€åç»“æœè¾“å‡ºå¦‚ä¸‹ï¼š<br><img src="https://pic1.imgdb.cn/item/681bfaca58cb8da5c8e3e8a9.png" alt="è¡¨æ ¼è½¬å›¾ç‰‡"></p><p><img src="https://pic1.imgdb.cn/item/681bfaca58cb8da5c8e3e8a8.png" alt="è¡¨æ ¼è½¬å›¾ç‰‡"></p><h3 id="5-3-åŸºäº-GPT-4-Vision-API-åšè¡¨æ ¼å›ç­”"><a href="#5-3-åŸºäº-GPT-4-Vision-API-åšè¡¨æ ¼å›ç­”" class="headerlink" title="5.3 åŸºäº GPT-4 Vision API åšè¡¨æ ¼å›ç­”"></a><strong>5.3 åŸºäº GPT-4 Vision API åšè¡¨æ ¼å›ç­”</strong></h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> base64<span class="token keyword">from</span> openai <span class="token keyword">import</span> OpenAIclient <span class="token operator">=</span> OpenAI<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">encode_image</span><span class="token punctuation">(</span>image_path<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>image_path<span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> image_file<span class="token punctuation">:</span>    <span class="token keyword">return</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>image_file<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">image_qa</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> image_path<span class="token punctuation">)</span><span class="token punctuation">:</span>    base64_image <span class="token operator">=</span> encode_image<span class="token punctuation">(</span>image_path<span class="token punctuation">)</span>    response <span class="token operator">=</span> client<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span>create<span class="token punctuation">(</span>        model<span class="token operator">=</span><span class="token string">"gpt-4o"</span><span class="token punctuation">,</span>        temperature<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>        seed<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">,</span>        messages<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{</span>            <span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span>              <span class="token string">"content"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>                  <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span> <span class="token string">"text"</span><span class="token punctuation">:</span> query<span class="token punctuation">}</span><span class="token punctuation">,</span>                  <span class="token punctuation">{</span>                      <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"image_url"</span><span class="token punctuation">,</span>                      <span class="token string">"image_url"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>                          <span class="token string">"url"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"data:image/jpeg;base64,</span><span class="token interpolation"><span class="token punctuation">{</span>base64_image<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>                      <span class="token punctuation">}</span><span class="token punctuation">,</span>                  <span class="token punctuation">}</span><span class="token punctuation">,</span>              <span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token punctuation">)</span>    <span class="token keyword">return</span> response<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message<span class="token punctuation">.</span>contentresponse <span class="token operator">=</span> image_qa<span class="token punctuation">(</span><span class="token string">"å“ªä¸ªæ¨¡å‹åœ¨AGI Evalæ•°æ®é›†ä¸Šè¡¨ç°æœ€å¥½ã€‚å¾—åˆ†å¤šå°‘"</span><span class="token punctuation">,</span><span class="token string">"llama2_page8/table_images/page_1_0.png"</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç»“æœè¾“å‡ºå¦‚ä¸‹ï¼š</p><pre class="line-numbers language-none"><code class="language-none">åœ¨AGI Evalæ•°æ®é›†ä¸Šè¡¨ç°æœ€å¥½çš„æ¨¡å‹æ˜¯ **Llama 2 70B**ï¼Œå¾—åˆ†ä¸º **54.2**ã€‚<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å¯ä»¥çœ‹åˆ°ï¼Œå¤§æ¨¡å‹çš„å›ç­”å°±æ˜¯æ ¹æ®æˆ‘ä»¬ä¸Šé¢çš„å›¾ç‰‡å†…å®¹å›ç­”çš„ã€‚</p><h3 id="5-4-ç”¨GPT-4-Vision-ç”Ÿæˆè¡¨æ ¼-å›¾ç‰‡-æè¿°-å¹¶å‘é‡åŒ–ç”¨äºæ£€ç´¢"><a href="#5-4-ç”¨GPT-4-Vision-ç”Ÿæˆè¡¨æ ¼-å›¾ç‰‡-æè¿°-å¹¶å‘é‡åŒ–ç”¨äºæ£€ç´¢" class="headerlink" title="5.4 ç”¨GPT-4 Vision ç”Ÿæˆè¡¨æ ¼(å›¾ç‰‡)æè¿°,å¹¶å‘é‡åŒ–ç”¨äºæ£€ç´¢"></a><strong>5.4 ç”¨GPT-4 Vision ç”Ÿæˆè¡¨æ ¼(å›¾ç‰‡)æè¿°,å¹¶å‘é‡åŒ–ç”¨äºæ£€ç´¢</strong></h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> chromadb<span class="token keyword">from</span> chromadb<span class="token punctuation">.</span>config <span class="token keyword">import</span> Settings<span class="token keyword">class</span> <span class="token class-name">NewVectorDBConnector</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> collection_name<span class="token punctuation">,</span> embedding_fn<span class="token punctuation">)</span><span class="token punctuation">:</span>        chroma_client <span class="token operator">=</span> chromadb<span class="token punctuation">.</span>Client<span class="token punctuation">(</span>Settings<span class="token punctuation">(</span>allow_reset<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token comment"># ä¸ºäº†æ¼”ç¤ºï¼Œå®é™…ä¸éœ€è¦æ¯æ¬¡ reset()</span>        chroma_client<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment"># åˆ›å»ºä¸€ä¸ª collection</span>        self<span class="token punctuation">.</span>collection <span class="token operator">=</span> chroma_client<span class="token punctuation">.</span>get_or_create_collection<span class="token punctuation">(</span>            name<span class="token operator">=</span>collection_name<span class="token punctuation">)</span>        self<span class="token punctuation">.</span>embedding_fn <span class="token operator">=</span> embedding_fn    <span class="token keyword">def</span> <span class="token function">add_documents</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> documents<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">'''å‘ collection ä¸­æ·»åŠ æ–‡æ¡£ä¸å‘é‡'''</span>        self<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>add<span class="token punctuation">(</span>            embeddings<span class="token operator">=</span>self<span class="token punctuation">.</span>embedding_fn<span class="token punctuation">(</span>documents<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># æ¯ä¸ªæ–‡æ¡£çš„å‘é‡</span>            documents<span class="token operator">=</span>documents<span class="token punctuation">,</span>  <span class="token comment"># æ–‡æ¡£çš„åŸæ–‡</span>            ids<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f"id</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">"</span></span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>documents<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment"># æ¯ä¸ªæ–‡æ¡£çš„ id</span>        <span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">add_images</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> image_paths<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">'''å‘ collection ä¸­æ·»åŠ å›¾åƒ'''</span>        documents <span class="token operator">=</span> <span class="token punctuation">[</span>            image_qa<span class="token punctuation">(</span><span class="token string">"è¯·ç®€è¦æè¿°å›¾ç‰‡ä¸­çš„ä¿¡æ¯"</span><span class="token punctuation">,</span>image<span class="token punctuation">)</span>            <span class="token keyword">for</span> image <span class="token keyword">in</span> image_paths        <span class="token punctuation">]</span>        self<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>add<span class="token punctuation">(</span>            embeddings<span class="token operator">=</span>self<span class="token punctuation">.</span>embedding_fn<span class="token punctuation">(</span>documents<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># æ¯ä¸ªæ–‡æ¡£çš„å‘é‡</span>            documents<span class="token operator">=</span>documents<span class="token punctuation">,</span>  <span class="token comment"># æ–‡æ¡£çš„åŸæ–‡</span>            ids<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f"id</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">"</span></span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>documents<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># æ¯ä¸ªæ–‡æ¡£çš„ id</span>            metadatas<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"image"</span><span class="token punctuation">:</span> image<span class="token punctuation">}</span> <span class="token keyword">for</span> image <span class="token keyword">in</span> image_paths<span class="token punctuation">]</span> <span class="token comment"># ç”¨ metadata æ ‡è®°æºå›¾åƒè·¯å¾„</span>        <span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">search</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> query<span class="token punctuation">,</span> top_n<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">'''æ£€ç´¢å‘é‡æ•°æ®åº“'''</span>        results <span class="token operator">=</span> self<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>query<span class="token punctuation">(</span>            query_embeddings<span class="token operator">=</span>self<span class="token punctuation">.</span>embedding_fn<span class="token punctuation">(</span><span class="token punctuation">[</span>query<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            n_results<span class="token operator">=</span>top_n        <span class="token punctuation">)</span>        <span class="token keyword">return</span> resultsimages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>dir_path <span class="token operator">=</span> <span class="token string">"llama2_page8/table_images"</span><span class="token keyword">for</span> <span class="token builtin">file</span> <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>dir_path<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> <span class="token builtin">file</span><span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">'.png'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment"># æ‰“å¼€å›¾åƒ</span>        images<span class="token punctuation">.</span>append<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>dir_path<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token punctuation">)</span><span class="token punctuation">)</span>new_db_connector <span class="token operator">=</span> NewVectorDBConnector<span class="token punctuation">(</span><span class="token string">"table_demo"</span><span class="token punctuation">,</span>get_embeddings<span class="token punctuation">)</span>new_db_connector<span class="token punctuation">.</span>add_images<span class="token punctuation">(</span>images<span class="token punctuation">)</span>query  <span class="token operator">=</span> <span class="token string">"å“ªä¸ªæ¨¡å‹åœ¨AGI Evalæ•°æ®é›†ä¸Šè¡¨ç°æœ€å·®ã€‚å¾—åˆ†å¤šå°‘"</span>results <span class="token operator">=</span> new_db_connector<span class="token punctuation">.</span>search<span class="token punctuation">(</span>query<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>metadata <span class="token operator">=</span> results<span class="token punctuation">[</span><span class="token string">"metadatas"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"====æ£€ç´¢ç»“æœ===="</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>metadata<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"====å›å¤===="</span><span class="token punctuation">)</span>response <span class="token operator">=</span> image_qa<span class="token punctuation">(</span>query<span class="token punctuation">,</span>metadata<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"image"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token operator">==</span><span class="token operator">==</span>æ£€ç´¢ç»“æœ<span class="token operator">==</span><span class="token operator">==</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">'image'</span><span class="token punctuation">:</span> <span class="token string">'llama2_page8/table_images\\page_1_0.png'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token operator">==</span>å›å¤<span class="token operator">==</span><span class="token operator">==</span>åœ¨AGI Evalæ•°æ®é›†ä¸Šè¡¨ç°æœ€å·®çš„æ¨¡å‹æ˜¯Falcon 7Bï¼Œå¾—åˆ†ä¸º<span class="token number">21.2</span>ã€‚<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ä¸€äº›é¢å‘-RAG-çš„æ–‡æ¡£è§£æè¾…åŠ©å·¥å…·"><a href="#ä¸€äº›é¢å‘-RAG-çš„æ–‡æ¡£è§£æè¾…åŠ©å·¥å…·" class="headerlink" title="ä¸€äº›é¢å‘ RAG çš„æ–‡æ¡£è§£æè¾…åŠ©å·¥å…·"></a>ä¸€äº›é¢å‘ RAG çš„æ–‡æ¡£è§£æè¾…åŠ©å·¥å…·</h3><ul><li><a href="https://pymupdf.readthedocs.io/en/latest/">PyMuPDF</a>: PDF æ–‡ä»¶å¤„ç†åŸºç¡€åº“ï¼Œå¸¦æœ‰åŸºäºè§„åˆ™çš„è¡¨æ ¼ä¸å›¾åƒæŠ½å–ï¼ˆä¸å‡†ï¼‰</li><li><a href="https://github.com/infiniflow/ragflow">RAGFlow</a>: ä¸€æ¬¾åŸºäºæ·±åº¦æ–‡æ¡£ç†è§£æ„å»ºçš„å¼€æº RAG å¼•æ“ï¼Œæ”¯æŒå¤šç§æ–‡æ¡£æ ¼å¼ï¼ˆç«çˆ†ï¼‰ï¼ˆé‡è¦ï¼‰</li><li><a href="https://unstructured.io/">Unstructured.io</a>: ä¸€ä¸ªå¼€æº+SaaSå½¢å¼çš„æ–‡æ¡£è§£æåº“ï¼Œæ”¯æŒå¤šç§æ–‡æ¡£æ ¼å¼</li><li><a href="https://docs.llamaindex.ai/en/stable/llama_cloud/llama_parse/">LlamaParse</a>ï¼šä»˜è´¹ API æœåŠ¡ï¼Œç”± LlamaIndex å®˜æ–¹æä¾›ï¼Œè§£æä¸ä¿è¯100%å‡†ç¡®ï¼Œå®æµ‹å¶æœ‰æ–‡å­—ä¸¢å¤±æˆ–é”™ä½å‘ç”Ÿ</li><li><a href="https://mathpix.com/">Mathpix</a>ï¼šä»˜è´¹ API æœåŠ¡ï¼Œæ•ˆæœè¾ƒå¥½ï¼Œå¯è§£ææ®µè½ç»“æ„ã€è¡¨æ ¼ã€å…¬å¼ç­‰ï¼Œè´µï¼</li></ul><p>åœ¨å·¥ç¨‹ä¸Šï¼ŒPDF è§£ææœ¬èº«æ˜¯ä¸ªå¤æ‚ä¸”çç¢çš„å·¥ä½œã€‚ä»¥ä¸Šå·¥å…·éƒ½ä¸å®Œç¾ï¼Œå»ºè®®åœ¨è‡ªå·±å®é™…åœºæ™¯æµ‹è¯•åé€‰æ‹©ä½¿ç”¨ã€‚</p><h2 id="å…­ã€è¯´è¯´-GraphRAG"><a href="#å…­ã€è¯´è¯´-GraphRAG" class="headerlink" title="å…­ã€è¯´è¯´ GraphRAG"></a>å…­ã€è¯´è¯´ GraphRAG</h2><p><img src="https://pic1.imgdb.cn/item/681b6c4e58cb8da5c8e3d9ea.png" alt="GraphRAG"></p><ol><li><strong>ä»€ä¹ˆæ˜¯ GraphRAG</strong>ï¼šæ ¸å¿ƒæ€æƒ³æ˜¯å°†çŸ¥è¯†é¢„å…ˆå¤„ç†æˆçŸ¥è¯†å›¾è°±</li><li><strong>ä¼˜ç‚¹</strong>ï¼šé€‚åˆå¤æ‚é—®é¢˜ï¼Œå°¤å…¶æ˜¯ä»¥æŸ¥è¯¢ä¸ºä¸­å¿ƒçš„æ€»ç»“ï¼Œä¾‹å¦‚ï¼šâ€œXXXå›¢é˜Ÿå»å¹´æœ‰å“ªäº›è´¡çŒ®â€</li><li><strong>ç¼ºç‚¹</strong>ï¼šçŸ¥è¯†å›¾è°±çš„æ„å»ºã€æ¸…æ´—ã€ç»´æŠ¤æ›´æ–°ç­‰éƒ½æœ‰å¯è§‚çš„æˆæœ¬</li><li><strong>å»ºè®®</strong>ï¼š<br>&nbsp; &nbsp;- GraphRAG ä¸æ˜¯ä¸‡èƒ½è‰¯è¯<br>&nbsp; &nbsp;- é¢†ä¼šå…¶æ ¸å¿ƒæ€æƒ³<br>&nbsp; &nbsp;- é‡åˆ°ä¼ ç»Ÿ RAG æ— è®ºå¦‚ä½•ä¼˜åŒ–éƒ½ä¸å¥½è§£å†³çš„é—®é¢˜æ—¶ï¼Œé…Œæƒ…ä½¿ç”¨</li></ol><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><h3 id="RAG-çš„æµç¨‹"><a href="#RAG-çš„æµç¨‹" class="headerlink" title="RAG çš„æµç¨‹"></a>RAG çš„æµç¨‹</h3><ul><li>ç¦»çº¿æ­¥éª¤ï¼š</li></ul><ol><li>æ–‡æ¡£åŠ è½½</li><li>æ–‡æ¡£åˆ‡åˆ†</li><li>å‘é‡åŒ–</li><li>çŒå…¥å‘é‡æ•°æ®åº“</li></ol><ul><li>åœ¨çº¿æ­¥éª¤</li></ul><ol><li>è·å–ç”¨æˆ·é—®é¢˜</li><li>ç”¨æˆ·é—®é¢˜å‘é‡åŒ–</li><li>æ£€ç´¢å‘é‡æ•°æ®åº“</li><li>å°†æ£€ç´¢ç»“æœå’Œç”¨æˆ·é—®é¢˜å¡«å…¥ Prompt æ¨¡æ¿</li><li>ç”¨æœ€ç»ˆè·å¾—çš„ Prompt è°ƒç”¨ LLM</li><li>ç”¨ LLM ç”Ÿæˆå›å¤</li></ol><h3 id="å¦‚æœä½¿ç”¨äº†å¼€æº-RAGï¼Œä½†æ˜¯ä¸å¥½ç”¨æ€ä¹ˆåŠï¼Ÿ"><a href="#å¦‚æœä½¿ç”¨äº†å¼€æº-RAGï¼Œä½†æ˜¯ä¸å¥½ç”¨æ€ä¹ˆåŠï¼Ÿ" class="headerlink" title="å¦‚æœä½¿ç”¨äº†å¼€æº RAGï¼Œä½†æ˜¯ä¸å¥½ç”¨æ€ä¹ˆåŠï¼Ÿ"></a>å¦‚æœä½¿ç”¨äº†å¼€æº RAGï¼Œä½†æ˜¯ä¸å¥½ç”¨æ€ä¹ˆåŠï¼Ÿ</h3><ol><li>æ£€æŸ¥é¢„å¤„ç†æ•ˆæœï¼šæ–‡æ¡£åŠ è½½æ˜¯å¦æ­£ç¡®ï¼Œåˆ‡å‰²çš„æ˜¯å¦åˆç†</li><li>æµ‹è¯•æ£€éªŒæ•ˆæœï¼šé—®é¢˜æ£€ç´¢å›æ¥çš„æ–‡æœ¬ç‰‡æ®µæ˜¯å¦åŒ…å«ç­”æ¡ˆ</li><li>æµ‹è¯•å¤§æ¨¡å‹èƒ½åŠ›ï¼šç»™å®šé—®é¢˜å’ŒåŒ…å«ç­”æ¡ˆæ–‡æœ¬ç‰‡æ®µçš„å‰æä¸‹ï¼Œå¤§æ¨¡å‹èƒ½ä¸èƒ½æ­£ç¡®å›ç­”é—®é¢˜</li></ol><h2 id="é—®é¢˜è®°å½•"><a href="#é—®é¢˜è®°å½•" class="headerlink" title="é—®é¢˜è®°å½•"></a>é—®é¢˜è®°å½•</h2><h3 id="ä¸€ã€åœ¨æµ‹è¯•Embeddingsæ¨¡å‹æ—¶æŠ¥é”™"><a href="#ä¸€ã€åœ¨æµ‹è¯•Embeddingsæ¨¡å‹æ—¶æŠ¥é”™" class="headerlink" title="ä¸€ã€åœ¨æµ‹è¯•Embeddingsæ¨¡å‹æ—¶æŠ¥é”™"></a>ä¸€ã€åœ¨æµ‹è¯•Embeddingsæ¨¡å‹æ—¶æŠ¥é”™</h3><h4 id="æŠ¥é”™ä»£ç ï¼š"><a href="#æŠ¥é”™ä»£ç ï¼š" class="headerlink" title="æŠ¥é”™ä»£ç ï¼š"></a>æŠ¥é”™ä»£ç ï¼š</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python">test_query <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"æµ‹è¯•æ–‡æœ¬"</span><span class="token punctuation">]</span>vec <span class="token operator">=</span> get_embeddings<span class="token punctuation">(</span>test_query<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Total dimension: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>vec<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"First 10 elements: </span><span class="token interpolation"><span class="token punctuation">{</span>vec<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token format-spec">10]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h4 id="æŠ¥é”™å†…å®¹ï¼š"><a href="#æŠ¥é”™å†…å®¹ï¼š" class="headerlink" title="æŠ¥é”™å†…å®¹ï¼š"></a>æŠ¥é”™å†…å®¹ï¼š</h4><pre class="line-numbers language-none"><code class="language-none">---------------------------------------------------------------------------BadRequestError &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Traceback (most recent call last)Cell In[11], line 2&nbsp; &nbsp; &nbsp; 1 test_query = ["æµ‹è¯•æ–‡æœ¬"]----&gt; 2 vec = get_embeddings(test_query)[0]&nbsp; &nbsp; &nbsp; 3 print(f"Total dimension: {len(vec)}")&nbsp; &nbsp; &nbsp; 4 print(f"First 10 elements: {vec[:10]}")Cell In[10], line 9, in get_embeddings(texts, model, dimensions)&nbsp; &nbsp; &nbsp; 6 &nbsp; &nbsp; data = client.embeddings.create(&nbsp; &nbsp; &nbsp; 7 &nbsp; &nbsp; &nbsp; &nbsp; input=texts, model=model, dimensions=dimensions).data&nbsp; &nbsp; &nbsp; 8 else:----&gt; 9 &nbsp; &nbsp; data = client.embeddings.create(input=texts, model=model).data&nbsp; &nbsp; &nbsp;10 return [x.embedding for x in data]File d:\Soft\Dev_Soft\anaconda3\envs\rag-learn\lib\site-packages\openai\resources\embeddings.py:128, in Embeddings.create(self, input, model, dimensions, encoding_format, user, extra_headers, extra_query, extra_body, timeout)&nbsp; &nbsp; 122 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; embedding.embedding = np.frombuffer( &nbsp;# type: ignore[no-untyped-call]&nbsp; &nbsp; 123 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; base64.b64decode(data), dtype="float32"&nbsp; &nbsp; 124 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ).tolist()&nbsp; &nbsp; 126 &nbsp; &nbsp; return obj--&gt; 128 return self._post(&nbsp; &nbsp; 129 &nbsp; &nbsp; "/embeddings",&nbsp; &nbsp; 130 &nbsp; &nbsp; body=maybe_transform(params, embedding_create_params.EmbeddingCreateParams),&nbsp; &nbsp; 131 &nbsp; &nbsp; options=make_request_options(&nbsp; &nbsp; 132 &nbsp; &nbsp; &nbsp; &nbsp; extra_headers=extra_headers,&nbsp; &nbsp; 133 &nbsp; &nbsp; &nbsp; &nbsp; extra_query=extra_query,&nbsp; &nbsp; 134 &nbsp; &nbsp; &nbsp; &nbsp; extra_body=extra_body,&nbsp; &nbsp; 135 &nbsp; &nbsp; &nbsp; &nbsp; timeout=timeout,&nbsp; &nbsp; 136 &nbsp; &nbsp; &nbsp; &nbsp; post_parser=parser,&nbsp; &nbsp; 137 &nbsp; &nbsp; ),&nbsp; &nbsp; 138 &nbsp; &nbsp; cast_to=CreateEmbeddingResponse,&nbsp; &nbsp; 139 )File d:\Soft\Dev_Soft\anaconda3\envs\rag-learn\lib\site-packages\openai\_base_client.py:1242, in SyncAPIClient.post(self, path, cast_to, body, options, files, stream, stream_cls)&nbsp; &nbsp;1228 def post(&nbsp; &nbsp;1229 &nbsp; &nbsp; self,&nbsp; &nbsp;1230 &nbsp; &nbsp; path: str,&nbsp; &nbsp;(...)&nbsp; &nbsp;1237 &nbsp; &nbsp; stream_cls: type[_StreamT] | None = None,&nbsp; &nbsp;1238 ) -&gt; ResponseT | _StreamT:&nbsp; &nbsp;1239 &nbsp; &nbsp; opts = FinalRequestOptions.construct(&nbsp; &nbsp;1240 &nbsp; &nbsp; &nbsp; &nbsp; method="post", url=path, json_data=body, files=to_httpx_files(files), **options&nbsp; &nbsp;1241 &nbsp; &nbsp; )-&gt; 1242 &nbsp; &nbsp; return cast(ResponseT, self.request(cast_to, opts, stream=stream, stream_cls=stream_cls))File d:\Soft\Dev_Soft\anaconda3\envs\rag-learn\lib\site-packages\openai\_base_client.py:919, in SyncAPIClient.request(self, cast_to, options, remaining_retries, stream, stream_cls)&nbsp; &nbsp; 916 else:&nbsp; &nbsp; 917 &nbsp; &nbsp; retries_taken = 0--&gt; 919 return self._request(&nbsp; &nbsp; 920 &nbsp; &nbsp; cast_to=cast_to,&nbsp; &nbsp; 921 &nbsp; &nbsp; options=options,&nbsp; &nbsp; 922 &nbsp; &nbsp; stream=stream,&nbsp; &nbsp; 923 &nbsp; &nbsp; stream_cls=stream_cls,&nbsp; &nbsp; 924 &nbsp; &nbsp; retries_taken=retries_taken,&nbsp; &nbsp; 925 )File d:\Soft\Dev_Soft\anaconda3\envs\rag-learn\lib\site-packages\openai\_base_client.py:1023, in SyncAPIClient._request(self, cast_to, options, retries_taken, stream, stream_cls)&nbsp; &nbsp;1020 &nbsp; &nbsp; &nbsp; &nbsp; err.response.read()&nbsp; &nbsp;1022 &nbsp; &nbsp; log.debug("Re-raising status error")-&gt; 1023 &nbsp; &nbsp; raise self._make_status_error_from_response(err.response) from None&nbsp; &nbsp;1025 return self._process_response(&nbsp; &nbsp;1026 &nbsp; &nbsp; cast_to=cast_to,&nbsp; &nbsp;1027 &nbsp; &nbsp; options=options,&nbsp; &nbsp;(...)&nbsp; &nbsp;1031 &nbsp; &nbsp; retries_taken=retries_taken,&nbsp; &nbsp;1032 )BadRequestError: Error code: 400 - {'error': {'message': 'Unknown model: text-embedding-ada-002 (request id: 2025050722295246817707943411229) (request id: 2025050722295245370563533xRaOCs)', 'type': '', 'param': '', 'code': 'unknown_model'}}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="é”™è¯¯è®°å½•ï¼š"><a href="#é”™è¯¯è®°å½•ï¼š" class="headerlink" title="é”™è¯¯è®°å½•ï¼š"></a>é”™è¯¯è®°å½•ï¼š</h4><p>è¿™é‡Œé¢‘ç¹æŠ¥é”™çš„åŸå› æ˜¯ä½¿ç”¨dotenvå’Œ.envæ–‡ä»¶è°ƒç”¨apiä¸æˆåŠŸè€Œå¯¼è‡´çš„é”™è¯¯ï¼Œåç»­åœ¨ç”³è¯·è°ƒç”¨OpenAI APIçš„ç¨‹åºå¤„ï¼Œé€šè¿‡åœ¨client.OpenAI()å‡½æ•°é‡Œé¢ç›´æ¥è°ƒç”¨å¡«å†™api keyå’Œè¯·æ±‚åœ°å€è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚è‡³äºä¸ºä»€ä¹ˆä¼šå¯¼è‡´è¿™ä¸ªé”™è¯¯ç›®å‰è¿˜ä¸æ¸…æ¥šï¼Œç­‰åç»­åœ¨ç ”ç©¶çœ‹çœ‹ã€‚</p><p><strong>æ›´å¤šå®ç”¨æ–‡ç« å’ŒAIå¤§æ¨¡å‹åº”ç”¨å¼€å‘æ–‡ç« æ¬¢è¿åˆ°æˆ‘ä¸ªäººåšå®¢æ¥è§‚çœ‹ï¼š</strong><a href="https://blog.csdn.net/etrospect/article/details/blog.ismoyu.cn">å¢¨å®‡Logic</a></p>]]></content>
      
      
      <categories>
          
          <category> AIå¤§æ¨¡å‹åº”ç”¨å¼€å‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Markdown </tag>
            
            <tag> RAG </tag>
            
            <tag> Embeddings </tag>
            
            <tag> OpenAI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hexo+github+Netlify+ClouldFlareæ­å»ºä¸ªäººåšå®¢</title>
      <link href="/hexo-github-netlify-clouldflare-da-jian-ge-ren-bo-ke/"/>
      <url>/hexo-github-netlify-clouldflare-da-jian-ge-ren-bo-ke/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€ã€å‡†å¤‡å·¥ä½œ"><a href="#ä¸€ã€å‡†å¤‡å·¥ä½œ" class="headerlink" title="ä¸€ã€å‡†å¤‡å·¥ä½œ"></a>ä¸€ã€å‡†å¤‡å·¥ä½œ</h2><p>è¿™ä¸ªæ•™ç¨‹ä½¿ç”¨çš„ä¸ªäººåšå®¢æ¡†æ¶æ˜¯hexoï¼Œåšå®¢æ–‡ä»¶æ‹–ç®¡äºgithubï¼Œåšå®¢ç½‘ç«™ç”¨netlifyç”Ÿæˆï¼Œå›½å†…è®¿é—®é‡‡ç”¨Cloudflareè¿›è¡ŒCDNåŠ é€Ÿã€‚</p><h3 id="1-1-åˆ›å»ºGitHubä»“åº“"><a href="#1-1-åˆ›å»ºGitHubä»“åº“" class="headerlink" title="1.1 åˆ›å»ºGitHubä»“åº“"></a>1.1 åˆ›å»ºGitHubä»“åº“</h3><p>è¿›å…¥GitHubç½‘ç«™ï¼Œåœ¨ç½‘ç«™ä¸Šæ–°å»ºä¸€ä¸ªä»£ç ä»“åº“ç”¨äºä¿å­˜æˆ‘ä»¬çš„ç½‘é¡µ</p><p>ç‚¹å‡»<code>Your repositories</code>ï¼Œè¿›å…¥ä»“åº“é¡µé¢ã€‚</p><p><img src="https://pic1.imgdb.cn/item/680aeb6b58cb8da5c8c97cee.png" alt="0"></p><p>ç‚¹å‡»<code>New</code>æŒ‰é’®ï¼Œè¿›å…¥ä»“åº“åˆ›å»ºé¡µé¢ã€‚</p><p><img src="https://pic1.imgdb.cn/item/680aeb6b58cb8da5c8c97cec.png" alt="01"></p><p>å¡«å†™<strong>Repository name</strong>ä»“åº“åï¼Œæ ¼å¼å¿…é¡»ä¸º<code>&lt;ç”¨æˆ·å&gt;.github.io</code>ï¼Œæˆ‘è®¾ç½®çš„ç”¨æˆ·åä¸º<code>ismoyuai.github.io</code> ç„¶åç‚¹å‡» <code>Create repository</code>ã€‚</p><p><img src="https://pic1.imgdb.cn/item/680aeb6b58cb8da5c8c97ceb.png" alt="02"></p><p>è¿™æ ·æˆ‘ä»¬ä»“åº“åˆæ­¥å‡†å¤‡å·²ç»å¥½äº†ï¼Œä¸‹é¢å®‰è£…Node.js</p><h3 id="1-2-å®‰è£…Node-jsä»¥åŠnpm"><a href="#1-2-å®‰è£…Node-jsä»¥åŠnpm" class="headerlink" title="1.2 å®‰è£…Node.jsä»¥åŠnpm"></a>1.2 å®‰è£…Node.jsä»¥åŠnpm</h3><p>è¿›å…¥<a href="https://nodejs.org/en/download/">node.jså®˜ç½‘</a>ä¸‹è½½ç›¸åº”çš„ç‰ˆæœ¬ï¼Œåœ¨Windowsä¸Šå®‰è£…ä¸€èˆ¬æŒ‰ä¸‹å›¾é€‰æ‹©ï¼Œæœ€åç‚¹å‡»ä¸‹è½½</p><p><img src="https://pic1.imgdb.cn/item/680aeb6b58cb8da5c8c97ced.png" alt="03"></p><p>å®‰è£…ä¼šè¿åŒåŒ…å«çš„ç¯å¢ƒå˜é‡å’Œ<code>npm</code>ä¸€èµ·å®‰è£…ï¼Œå®‰è£…åï¼Œæˆ‘ä»¬æ£€æµ‹<code>Node.js</code>æ˜¯å¦å®‰è£…æˆåŠŸï¼Œæ‰“å¼€ç»ˆç«¯ï¼Œè¾“å…¥å‘½ä»¤ï¼š</p><p>ç¬¬ä¸€ä¸ªï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">node</span> <span class="token parameter variable">-v</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ‰§è¡Œå‘½ä»¤åï¼Œå¦‚æœå®‰è£…æˆåŠŸä¼šæ˜¾ç¤º<code>nodejs</code>ç‰ˆæœ¬å·ã€‚</p><p>ç¬¬äºŒä¸ªï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token parameter variable">-v</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>æ‰§è¡ŒæˆåŠŸåï¼Œå¦‚æœå®‰è£…æˆåŠŸä¼šæ˜¾ç¤º<code>npm</code>ç‰ˆæœ¬å·ã€‚</p><h3 id="1-3-å®‰è£…Git"><a href="#1-3-å®‰è£…Git" class="headerlink" title="1.3 å®‰è£…Git"></a>1.3 å®‰è£…Git</h3><p>åˆ°<a href="https://git-scm.com/downloads/win">Gitå®˜ç½‘</a>ä¸‹è½½æœ€æ–°ç‰ˆæœ¬ï¼Œè¿™é‡Œæˆ‘ä¸‹è½½çš„æ˜¯64ä¸ºçš„å®‰è£…ç‰ˆæœ¬ï¼Œä¸‹è½½å®Œæˆåæ‰“å¼€ï¼Œç„¶åæŒ‰æ­¥éª¤é»˜è®¤å®‰è£…å³å¯ã€‚</p><p><img src="https://pic1.imgdb.cn/item/680aeb6b58cb8da5c8c97cef.png" alt="05"></p><h3 id="1-4-å®‰è£…Hexoä¸»é¢˜æ¡†æ¶"><a href="#1-4-å®‰è£…Hexoä¸»é¢˜æ¡†æ¶" class="headerlink" title="1.4 å®‰è£…Hexoä¸»é¢˜æ¡†æ¶"></a>1.4 å®‰è£…Hexoä¸»é¢˜æ¡†æ¶</h3><p>å®‰è£…Hexoæ¡†æ¶éœ€è¦å€ŸåŠ©<code>npm</code>åŒ…ç®¡ç†å™¨å®‰è£…ï¼Œæ‰“å¼€ç»ˆç«¯æ‰§è¡Œå‘½ä»¤ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> <span class="token parameter variable">-g</span> hexo-cli <span class="token comment"># å…¨å±€å®‰è£…hexoå‘½ä»¤è¡Œå·¥å…·</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>å…¶ä¸­<code>-g</code>å‚æ•°è¡¨ç¤ºå…¨å±€å®‰è£…ï¼Œæ²¡æœ‰è¿™ä¸ªå‚æ•°å°±åªåœ¨å½“å‰ç›®å½•ä¸‹å®‰è£…ï¼Œå»ºè®®å…¨å±€å®‰è£…ã€‚</p><p>å®‰è£…å®Œæˆåï¼Œæ‰§è¡Œå‘½ä»¤ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hexo <span class="token parameter variable">-v</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è¿™ä¸ªå‘½ä»¤å¯ä»¥çœ‹å®‰è£…hexoç‰ˆæœ¬å·</p><h2 id="äºŒã€æ­å»ºåšå®¢"><a href="#äºŒã€æ­å»ºåšå®¢" class="headerlink" title="äºŒã€æ­å»ºåšå®¢"></a>äºŒã€æ­å»ºåšå®¢</h2><h3 id="2-1-æœ¬åœ°åˆ›å»º"><a href="#2-1-æœ¬åœ°åˆ›å»º" class="headerlink" title="2.1 æœ¬åœ°åˆ›å»º"></a>2.1 æœ¬åœ°åˆ›å»º</h3><p>é€‰ä¸€ä¸ªä½ å­˜æ”¾æ•°æ®çš„ç›˜ï¼Œåˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ã€‚è¿™ä¸ªæ–‡ä»¶å¤¹ç”¨æ¥å­˜æ”¾æˆ‘ä»¬æ‰€æœ‰åšå®¢å†…å®¹å’Œç´ æï¼Œåç»­çš„æ“ä½œéƒ½åœ¨è¿™ä¸ªæ–‡ä»¶å¤¹ä¸­è¿›è¡Œï¼Œæ¯”å¦‚æˆ‘åœ¨<strong>Dç›˜</strong>åˆ›å»ºä¸€ä¸ª<strong>MYBLOG</strong>æ–‡ä»¶å¤¹ï¼Œåœ¨<strong>Dç›˜</strong>å³é”®ç‚¹å‡»<code>Open Git Bash here</code>è¾“å…¥å‘½ä»¤ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hexo init MYBLOG<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è¿™ä¸ªå‘½ä»¤ç”¨æ¥åˆå§‹åŒ–æˆ‘ä»¬åšå®¢æ¡†æ¶ï¼Œéœ€è¦ç­‰å¾…ä¸€æ®µæ—¶é—´è®©å®ƒè¿›è¡Œä¸‹è½½ã€‚ä¸‹è½½å®Œæˆåæ–‡ä»¶å¤¹å†…å®¹å¦‚ä¸‹ï¼š</p><p><img src="https://pic1.imgdb.cn/item/680aeb6a58cb8da5c8c97cea.png" alt="06"></p><p>è¿›å…¥<strong>MYBLOG</strong>æ–‡ä»¶å¤¹</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> MYBLOG<span class="token function">npm</span> <span class="token function">install</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>æœ¬åœ°éƒ¨ç½²å¯åŠ¨</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hexo ghexo s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>å®Œæˆåä¼šåœ¨æœ¬åœ°åœ°å€å¯åŠ¨ä½ çš„æœ¬åœ°åšå®¢ã€‚æµè§ˆå™¨è®¿é—® <a href="http://localhost:4000ï¼Œé¡µé¢é»˜è®¤ä¸»å›¾é£æ ¼å¦‚ä¸‹">http://localhost:4000ï¼Œé¡µé¢é»˜è®¤ä¸»å›¾é£æ ¼å¦‚ä¸‹</a><br><img src="https://pic1.imgdb.cn/item/680aeb9658cb8da5c8c97cfa.png" alt="07"></p><h3 id="2-2-éƒ¨ç½²åˆ°GitHubä»“åº“"><a href="#2-2-éƒ¨ç½²åˆ°GitHubä»“åº“" class="headerlink" title="2.2 éƒ¨ç½²åˆ°GitHubä»“åº“"></a>2.2 éƒ¨ç½²åˆ°GitHubä»“åº“</h3><p>ä¹‹å‰çš„æ­¥éª¤ä¸­ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†å¯¹Githubè´¦æˆ·çš„æ³¨å†Œä»¥åŠGithub Pagesçš„åˆ›å»ºï¼Œæ¥ä¸‹æ¥æ˜¯å°†æœ¬åœ°åšå®¢å‘å¸ƒè‡³Github Pagesã€‚</p><p>ï¼ˆ1ï¼‰å®‰è£…å‘å¸ƒæ’ä»¶ï¼Œåœ¨ç«™ç‚¹ç›®å½•ä¸‹æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼Œä¹Ÿå°±æ˜¯åˆ›å»ºçš„åšå®¢ç›®å½•ä¸‹ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> hexo-deployer-git <span class="token parameter variable">--save</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ï¼ˆ2ï¼‰gité…ç½®GitHubé‚®ç®±ç”¨æˆ·å</p><pre class="line-numbers language-none"><code class="language-none">git config --global user.email "xxx" //è®¾ç½®é‚®ç®± ä½ çš„Githubé‚®ç®±git config --global user.name "xxx" //è®¾ç½®ç”¨æˆ·å ä½ çš„Githubåç§°<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>ï¼ˆ3ï¼‰å°†æœ¬åœ°ç›®å½•å’ŒGitHubå…³è”èµ·æ¥ï¼Œè¾“å…¥ä¸‹é¢å‘½ä»¤è¡Œï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ssh-keygen <span class="token parameter variable">-t</span> rsa <span class="token parameter variable">-C</span> <span class="token string">"ä½ çš„é‚®ç®±åœ°å€"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è¾“å…¥åä¸€ç›´å›è½¦ï¼Œç„¶ååœ¨<code>C:/Users/[username]</code>ç›®å½•ä¸‹æ‰¾åˆ°åä¸º<code>.ssh</code>çš„æ–‡ä»¶å¤¹ï¼Œ æ–‡ä»¶å¤¹å†…ä¼šæœ‰ä¸¤ä¸ªæ–‡ä»¶ï¼Œä¸€ä¸ª<code>id_rsa.pub</code>ä¸€ä¸ª<code>id_rsa</code>ï¼Œç”¨æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€<code>id_rsa.pub</code>ï¼Œå¤åˆ¶é‡Œé¢çš„çš„å†…å®¹ã€‚ ç„¶åæ‰“å¼€Githubï¼Œç‚¹å‡»å³ä¸Šè§’çš„å¤´åƒ <strong>Settings</strong> é€‰æ‹©<strong>SSH and GPG keys</strong></p><p><img src="https://pic1.imgdb.cn/item/680aeb9658cb8da5c8c97cf8.png" alt="08"></p><p>ï¼ˆ4ï¼‰ç‚¹å‡»<strong>New SSH key</strong> å°†ä¹‹å‰å¤åˆ¶çš„å†…å®¹ç²˜å¸–åˆ°Keyçš„æ¡†ä¸­ã€‚ ä¸Šé¢çš„<strong>Title</strong>å¯ä»¥éšæ„ï¼Œç‚¹å‡»<strong>Add SSH key</strong> å®Œæˆæ·»åŠ ã€‚</p><p><img src="https://pic1.imgdb.cn/item/680aeb9658cb8da5c8c97cf7.png" alt="09"></p><p>ï¼ˆ5ï¼‰ç„¶åå›åˆ°Gitçš„å‘½ä»¤è¡Œç•Œé¢ï¼Œæµ‹è¯•ä¸€ä¸‹æ˜¯å¦ä¸GitHubè¿æ¥æˆåŠŸã€‚è¾“å…¥ä¸‹é¢çš„å‘½ä»¤è¡Œï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ssh</span> <span class="token parameter variable">-T</span> git@github.com<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ç‚¹å‡»å›è½¦ï¼Œç„¶åä¼šå‡ºç°ä¸€ä¸ªè¯¢é—®å†…å®¹ï¼Œè¾“å…¥<code>yes</code>ï¼Œå›è½¦ï¼Œä¼šå‡ºç°ä¸€æ®µå†…å®¹ï¼Œ<code>Hi &lt;account name&gt;! You've successfully authenticated, but GitHub doesnot provide shell access.</code>ã€‚ è¯´æ˜è¿æ¥æˆåŠŸã€‚æ­¤å¤„è¿™ä¸ª<code>&lt;account name&gt;</code>åº”è¯¥æ˜¯ä½ Githubçš„ç”¨æˆ·åã€‚</p><p>ï¼ˆ6ï¼‰è¿›å…¥åšå®¢ç«™ç‚¹ç›®å½•ï¼Œç”¨æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€<code>_config.yml</code>ï¼Œè¿™ä¸ª<code>_config.yml</code>æ˜¯åšå®¢çš„é…ç½®æ–‡ä»¶ï¼Œåœ¨ä»¥åçš„åšå®¢ä¿®æ”¹ï¼Œå¦‚ä¸ªæ€§åŒ–ä¿®æ”¹ï¼Œåšå®¢SEOä¼˜åŒ–ç­‰éƒ½ä¼šä½¿ç”¨åˆ°ï¼Œä¿®æ”¹å¦‚ä¸‹å›¾çš„å‡ ä¸ªåœ°æ–¹ï¼š</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">title</span><span class="token punctuation">:</span> ä½ çš„åšå®¢å<span class="token key atrule">subtitle</span><span class="token punctuation">:</span> åšå®¢çš„å‰¯æ ‡é¢˜ï¼Œæœ‰äº›ä¸»é¢˜æ”¯æŒ<span class="token key atrule">description</span><span class="token punctuation">:</span> åšå®¢æè¿°<span class="token key atrule">keywords</span><span class="token punctuation">:</span> åšå®¢å…³é”®è¯<span class="token key atrule">author</span><span class="token punctuation">:</span> ä½œè€…ï¼Œåœ¨æ–‡ç« ä¸­æ˜¾ç¤º<span class="token key atrule">language</span><span class="token punctuation">:</span> åšå®¢è¯­è¨€è¯­ç§   <span class="token key atrule">timezone</span><span class="token punctuation">:</span> æ—¶åŒº<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img src="https://pic1.imgdb.cn/item/680aeb9658cb8da5c8c97cf6.png" alt="10"></p><p>ï¼ˆ7ï¼‰åœ¨æ–‡ä»¶æœ€åº•éƒ¨ï¼Œæœ‰ä¸€ä¸ªdeployï¼Œåœ¨deployä¸‹é¢æ·»åŠ æˆ‘ä»¬çš„GitHubç«™ç‚¹ä»“åº“ä¿¡æ¯ã€‚å¡«å…¥å¦‚ä¸‹ä»£ç ï¼Œå¹¶å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">deploy</span><span class="token punctuation">:</span>  <span class="token key atrule">type</span><span class="token punctuation">:</span> git  <span class="token key atrule">repo</span><span class="token punctuation">:</span> git@github.com<span class="token punctuation">:</span>Githubç”¨æˆ·å/githubç”¨æˆ·å.github.io.git   <span class="token key atrule">branch</span><span class="token punctuation">:</span> master<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>repoï¼šä¹Ÿå¯ä½¿ç”¨httpsåœ°å€ï¼Œå¦‚ï¼š<code>https://github.com/Githubç”¨æˆ·å/Githubç”¨æˆ·å.github.io.git</code></p><p><img src="https://pic1.imgdb.cn/item/680aeb9658cb8da5c8c97cf5.png" alt="11"></p><p>ï¼ˆ8ï¼‰æœ€åå›åˆ°ç»ˆç«¯æ‰§è¡Œä¸‹é¢å‘½ä»¤ï¼Œå‡†å¤‡å°†é¡µé¢å‘å¸ƒåˆ°GitHub</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># æ¸…é™¤ä¹‹å‰ç”Ÿæˆé™æ€é¡µé¢</span>hexo clean<span class="token comment"># æ ¹æ®é…ç½®æ–‡ä»¶æ¸²æŸ“å‡ºä¸€å¥—é™æ€é¡µé¢</span>hexo g<span class="token comment"># å°†ä¸Šä¸€æ­¥æ¸²æŸ“å‡ºçš„ä¸€ç³»åˆ—æ–‡ä»¶ä¸Šä¼ è‡³è‡³Github Pages</span>hexo d<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šä¼ å®Œæˆåï¼Œåœ¨æµè§ˆå™¨ä¸­æ‰“å¼€<strong>https://&lt;ç”¨æˆ·å&gt;.github.io</strong>ï¼ŒæŸ¥çœ‹ä¸Šä¼ çš„ç½‘é¡µã€‚å¦‚æœé¡µé¢å˜æˆäº†ä¹‹å‰æœ¬åœ°è°ƒè¯•æ—¶çš„æ ·å­ï¼Œè¯´æ˜ä¸Šä¼ å·²ç»å®Œæˆäº†ã€‚</p><h2 id="ä¸‰ã€Netlifyå»ºç«™"><a href="#ä¸‰ã€Netlifyå»ºç«™" class="headerlink" title="ä¸‰ã€Netlifyå»ºç«™"></a>ä¸‰ã€Netlifyå»ºç«™</h2><h3 id="3-1-ä»‹ç»"><a href="#3-1-ä»‹ç»" class="headerlink" title="3.1 ä»‹ç»"></a>3.1 ä»‹ç»</h3><p>Netlifyæ˜¯ä¸€ä¸ªå›½å¤–çš„å…è´¹çš„æä¾›é™æ€ç½‘ç«™éƒ¨ç½²æœåŠ¡çš„å¹³å°ï¼Œèƒ½å¤Ÿå°†æ‰˜ç®¡ GitHubï¼ŒGitLab ç­‰ä¸Šçš„é™æ€ç½‘ç«™éƒ¨ç½²ä¸Šçº¿ã€‚è‡³äºæˆ‘ä»¬ä¸ºä»€ä¹ˆä¸ä½¿ç”¨<code>github</code>è‡ªå¸¦çš„<code>gitpage</code>ï¼ŒåŸå› å¾ˆç®€å•ï¼Œè®¿é—®é€Ÿåº¦æ…¢ã€‚æ­¤å¤–ï¼ŒNetlifyè¿˜æœ‰å¾ˆå¤šåˆ«çš„åŠŸèƒ½æ”¯æŒã€‚</p><h3 id="3-2-å»ºç«™æ­¥éª¤"><a href="#3-2-å»ºç«™æ­¥éª¤" class="headerlink" title="3.2 å»ºç«™æ­¥éª¤"></a>3.2 å»ºç«™æ­¥éª¤</h3><ol><li><p>é¦–å…ˆæ³¨å†Œå¹¶ç™»é™† <a href="https://app.netlify.com/">Netlify</a></p><ul><li>è¿™ä¸€æ­¥éœ€è¦èƒ½å¤Ÿç§‘å­¦ä¸Šç½‘ï¼Œå› ä¸ºè¿™æ˜¯ä¸€ä¸ªå›½å¤–çš„ç½‘ç«™</li><li>æˆ‘ä»¬çš„åšå®¢åœ¨å¼€å¯cloundflareçš„CDNåŠ é€Ÿä¹‹å‰ï¼Œä¹Ÿåªèƒ½é€šè¿‡ç§‘å­¦ä¸Šç½‘çš„æ–¹å¼è®¿é—®</li></ul></li><li><p>æ–°å»ºç«™ç‚¹ï¼š</p><p>ç‚¹å‡»<code>Import an existing project</code>æ–°å»ºç«™ç‚¹</p></li></ol><p><img src="https://pic1.imgdb.cn/item/680aeb9658cb8da5c8c97cf9.png" alt="12"></p><ol start="3"><li>è¿æ¥GitHub</li></ol><p><img src="https://pic1.imgdb.cn/item/680aebad58cb8da5c8c97d05.png" alt="13"></p><ol start="4"><li>é€‰æ‹©æˆ‘ä»¬çš„åšå®¢é¡¹ç›®ä»“åº“</li></ol><p><img src="https://pic1.imgdb.cn/item/680aebad58cb8da5c8c97d06.png" alt="14"></p><ol start="5"><li>ä¸€åˆ‡é»˜è®¤ï¼Œæœ€åç‚¹å‡»å¦‚ä¸‹æŒ‰é’®å®Œæˆå¯¼å…¥</li></ol><p><img src="https://pic1.imgdb.cn/item/680aebad58cb8da5c8c97d03.png" alt="15"></p><ol start="6"><li>å®Œæˆåä¼šå¾—åˆ°ä¸€ä¸ªURLï¼Œæ‰“å¼€è¿™ä¸ªç½‘å€å°±æ˜¯æˆ‘ä»¬çš„ä¸ªäººåšå®¢äº†</li></ol><p><img src="https://pic1.imgdb.cn/item/680aebad58cb8da5c8c97d04.png" alt="16"></p><p>æ¥ä¸‹æ¥å…ˆé…ç½®åŸŸå</p><h3 id="3-3-é…ç½®åŸŸå"><a href="#3-3-é…ç½®åŸŸå" class="headerlink" title="3.3 é…ç½®åŸŸå"></a>3.3 é…ç½®åŸŸå</h3><p>é…ç½®åŸŸåçš„å‰æè‡ªç„¶æ˜¯è¦è´­ä¹°åŸŸåäº†ï¼Œä»ä»»æ„åŸŸåæœåŠ¡å•†å¤„è´­ä¹°ä¸€ä¸ªåŸŸåã€‚</p><p><img src="https://pic1.imgdb.cn/item/680aebad58cb8da5c8c97d07.png" alt="17"></p><p>ç„¶åè®¾ç½®åŸŸåè§£æï¼Œç±»å‹ä¸º<code>CNAME</code>ï¼Œå†…å®¹ä¸º<code>xxxxx.netlify.app</code>ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åˆšåˆšå»ºç«™ç»™çš„åŸŸåã€‚</p><p><img src="https://pic1.imgdb.cn/item/680aebad58cb8da5c8c97d08.png" alt="18"></p><p>è®¾ç½®å®Œæ¯•ä¹‹åéœ€è¦ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œå› ä¸ºDNSæœåŠ¡å™¨éœ€è¦ä¸€æ®µæ—¶é—´æ¥è¿›è¡ŒåŒæ­¥ã€‚</p><p>ç„¶åï¼Œæˆ‘ä»¬è¿˜éœ€è¦å›åˆ°netlifyä¸­é…ç½®ä¸€ä¸‹è‡ªå·±çš„ç”¨æˆ·åŸŸåï¼Œè¿™æ ·çš„è¯å¯ä»¥åœ¨å›½å¤–è·å¾—netlifyæœ¬èº«çš„CDNæ”¯æŒã€‚</p><p><img src="https://pic1.imgdb.cn/item/680aebc058cb8da5c8c97d10.png" alt="19"></p><p>è¾“å…¥æˆ‘ä»¬é…ç½®çš„åŸŸååï¼Œè¿›è¡Œç›¸å…³çš„é…ç½®ï¼Œç”±äºæˆ‘ä»¬çš„åŸŸåæœ¬èº«å·²ç»é…ç½®äº†è§£æï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºå‡ºæ¥ï¼Œä¸ç”¨å†é¢å¤–æ·»åŠ è®°å½•ï¼Œåªéœ€è¦ä¸€è·¯é»˜è®¤å³å¯ã€‚æœ€åç‚¹å‡»Doneå³å¯</p><p>æˆ‘ä»¬ä¸‹é¢è®¾ç½®ä¸€ä¸‹netlifyæœ¬èº«çš„å¯¹äºå›½å¤–CDNçš„æ”¯æŒã€‚ä¸‹é¢ç®­å¤´ä½ç½®å‡ºç‚¹å‡»<code>Set up Netlify DNS</code>ï¼Œè¿™é‡Œæˆ‘å·²ç»è®¾ç½®è¿‡äº†æ‰€ä»¥æ˜¾ç¤ºçš„æŒ‰é’®ä¸æ˜¯è¿™ä¸ªã€‚</p><p><img src="https://pic1.imgdb.cn/item/680aebc058cb8da5c8c97d12.png" alt="20"></p><p>ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è‡ªå·±é…ç½®çš„åŸŸåè®¿é—®è‡ªå·±çš„ä¸ªäººåšå®¢ï¼Œæ¯”å¦‚è¯´æˆ‘çš„åšå®¢åœ°å€æ˜¯ï¼š<a href="https://blog.ismoyu.cn/">https://blog.ismoyu.cn</a></p><p>ä½†æ˜¯ï¼Œæ­¤åˆ»æˆ‘ä»¬çš„åšå®¢è®¿é—®ä¾ç„¶éœ€è¦ç§‘å­¦ä¸Šç½‘ï¼Œå› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰å›½å†…çš„CDNçš„æ”¯æŒï¼Œä¸‹é¢ï¼Œæˆ‘ä»¬æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><h2 id="å››ã€ClouldFlareåŠ é€Ÿ-è§£å†³å›½å†…åŠ é€Ÿé—®é¢˜"><a href="#å››ã€ClouldFlareåŠ é€Ÿ-è§£å†³å›½å†…åŠ é€Ÿé—®é¢˜" class="headerlink" title="å››ã€ClouldFlareåŠ é€Ÿ(è§£å†³å›½å†…åŠ é€Ÿé—®é¢˜)"></a>å››ã€ClouldFlareåŠ é€Ÿ(è§£å†³å›½å†…åŠ é€Ÿé—®é¢˜)</h2><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>Netlify è™½ç„¶å·²ç»æä¾›äº† CDN åŠ é€Ÿï¼Œä½†åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­å‘ç°å›½å†…è®¿é—®è¿˜æ˜¯æ¯”è¾ƒæ…¢ï¼ŒCloudflare ç›¸å¯¹äºå›½å†…çš„ä¸ƒç‰›äº‘ã€é˜¿é‡Œäº‘ç­‰äº‘æœåŠ¡å•†çš„ CDN é€Ÿåº¦ä¼šæ…¢ä¸€äº›ï¼Œä½†æ˜¯å®ƒæœ‰å…è´¹ç‰ˆæœ¬ï¼Œè€Œä¸”æœ€é‡è¦çš„æ˜¯åŸŸåä¸ç”¨å¤‡æ¡ˆã€‚</p><h3 id="åŠ é€Ÿæ­¥éª¤"><a href="#åŠ é€Ÿæ­¥éª¤" class="headerlink" title="åŠ é€Ÿæ­¥éª¤"></a>åŠ é€Ÿæ­¥éª¤</h3><ol><li>æ³¨å†Œ<a href="https://www.cloudflare.com/zh-cn/">Clouldflare</a>å¹¶ç™»é™†</li><li>æ·»åŠ ç«™ç‚¹</li></ol><p>è¿›å…¥ä¸»é¡µï¼Œç‚¹å‡»æ·»åŠ åŸŸ</p><p><img src="https://pic1.imgdb.cn/item/680aebc058cb8da5c8c97d0f.png" alt="21"></p><p><img src="https://pic1.imgdb.cn/item/680aebc058cb8da5c8c97d11.png" alt="22"></p><ol start="3"><li><p>é€‰æ‹©å…è´¹å¥—é¤</p></li><li><p>æ·»åŠ DNSè®°å½•</p></li></ol><p>å’Œä¸Šé¢é…ç½®é˜¿é‡Œäº‘åŸŸåä¸€æ ·</p><p><img src="https://pic1.imgdb.cn/item/680aebc058cb8da5c8c97d14.png" alt="23"></p><p><img src="https://pic1.imgdb.cn/item/680aebc058cb8da5c8c97d13.png" alt="24"></p><ol start="5"><li>æ›´æ”¹åç§°æœåŠ¡å™¨</li></ol><ul><li>ä¸»è¦æ­¥éª¤æ˜¯åœ¨ä½ çš„åŸŸåæœåŠ¡å•†é‚£é‡Œä¿®æ”¹ dns è§£ææœåŠ¡å™¨ä¸º cloudflare æä¾›çš„åœ°å€ï¼Œä¿®æ”¹å®Œæˆåç‚¹å‡»å®Œæˆã€‚</li></ul><p><img src="https://pic1.imgdb.cn/item/680aebd658cb8da5c8c97d19.png" alt="25"></p><ul><li><p>ä»¥é˜¿é‡Œäº‘ä¸ºä¾‹</p><ol><li><p>è¿›å…¥åŸŸåç®¡ç†é…ç½®ç•Œé¢</p><p><img src="https://pic1.imgdb.cn/item/680aebd658cb8da5c8c97d1b.png" alt="26"></p></li><li><p>å°†åŸŸåæœåŠ¡å™¨ä»é˜¿é‡Œäº‘çš„é»˜è®¤æœåŠ¡å™¨æ”¹æˆclouldflareçš„æœåŠ¡å™¨</p><p><img src="https://pic1.imgdb.cn/item/680aebd658cb8da5c8c97d16.png" alt="27"></p></li></ol></li></ul><p>é…ç½®å®Œæˆåç­‰å¾…ä¸€æ®µæ—¶é—´å³å¯</p><h3 id="é…ç½®https"><a href="#é…ç½®https" class="headerlink" title="é…ç½®https"></a>é…ç½®https</h3><p>åœ¨clouldflareé…ç½®å®Œæˆä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥å›åˆ°netlifyå»é…ç½®ä¸€ä¸‹httpsè®¿é—®ã€‚</p><ol><li><p>å…ˆç¡®è®¤ä¸€ä¸‹dnsè§£æ:</p><p><img src="https://pic1.imgdb.cn/item/680aebd658cb8da5c8c97d17.png" alt="28"></p></li><li><p>è‡ªåŠ¨å®‰è£…è¯ä¹¦</p></li></ol><p>   <img src="https://pic1.imgdb.cn/item/680aebd658cb8da5c8c97d1a.png" alt="29"></p><ol start="3"><li><p>æœ€åçœ‹åˆ°å¦‚ä¸‹çš„ç•Œé¢ï¼Œå°±è¯´æ˜httpsé…ç½®å®Œæˆäº†:</p><p><img src="https://pic1.imgdb.cn/item/680aebd658cb8da5c8c97d18.png" alt="30"></p></li></ol><p>æœ€åæµ‹è¯•ç«™ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥è¯•ç€ç”¨è‡ªå·±çš„æµè§ˆå™¨å»è®¿é—®è‡ªå·±é…ç½®çš„åŸŸååœ°å€ï¼Œå¦‚æœåœ¨ä¸ç§‘å­¦ä¸Šç½‘çš„æƒ…å†µä¸‹èƒ½å¤Ÿæ­£å¸¸çœ‹åˆ°æˆ‘ä»¬è‡ªå·±çš„åšå®¢ç•Œé¢ï¼Œé‚£å°±è¯æ˜æˆ‘ä»¬çš„ä¸ªäººåšå®¢å°±é…ç½®æˆåŠŸäº†ã€‚</p><p>æ¥ä¸‹æ¥å°±æ˜¯å…³äºåšå®¢ä¸»é¢˜çš„è®¾ç½®å’Œä¸€äº›ä¸ªæ€§åŒ–ä¿®æ”¹éƒ¨åˆ†ã€‚</p><h2 id="äº”ã€åšå®¢ä¸»é¢˜å®‰è£…ä»¥åŠä¸€äº›ä¸ªæ€§åŒ–ä¿®æ”¹"><a href="#äº”ã€åšå®¢ä¸»é¢˜å®‰è£…ä»¥åŠä¸€äº›ä¸ªæ€§åŒ–ä¿®æ”¹" class="headerlink" title="äº”ã€åšå®¢ä¸»é¢˜å®‰è£…ä»¥åŠä¸€äº›ä¸ªæ€§åŒ–ä¿®æ”¹"></a>äº”ã€åšå®¢ä¸»é¢˜å®‰è£…ä»¥åŠä¸€äº›ä¸ªæ€§åŒ–ä¿®æ”¹</h2><p>å®˜æ–¹é»˜è®¤ä¸»é¢˜å¾ˆä¸‘ï¼Œé‚£æˆ‘ä»¬åˆ«çš„ä¸åšï¼Œé¦–å…ˆæ¥æ›¿æ¢ä¸€ä¸ªå¥½çœ‹ç‚¹çš„ä¸»é¢˜ã€‚</p><blockquote><p><a href="https://hexo.io/themes/">å®˜æ–¹ä¸»é¢˜</a>ï¼šå®˜æ–¹æä¾›çš„å„ç§ä¸»é¢˜</p></blockquote><p>Githubã€<a href="http://jekyllthemes.org/page3/">Jekyll Themes</a>ä¸Šéƒ½èƒ½æ‰¾åˆ°å„ç§ä¸»é¢˜ï¼Œæˆ‘ç”¨çš„æ˜¯<a href="https://github.com/blinkfox/hexo-theme-matery">Hexo matery</a>ï¼Œå°±ä»¥æ­¤ä½œä¸ºä¾‹å­ã€‚</p><h3 id="5-1-ä¸»é¢˜ä¸‹è½½å’Œå®‰è£…"><a href="#5-1-ä¸»é¢˜ä¸‹è½½å’Œå®‰è£…" class="headerlink" title="5.1 ä¸»é¢˜ä¸‹è½½å’Œå®‰è£…"></a>5.1 ä¸»é¢˜ä¸‹è½½å’Œå®‰è£…</h3><p>è¿›å…¥æˆ‘ä»¬åšå®¢æ ¹ç›®å½•ï¼Œåœ¨ <code>git bash</code> è¾“å…¥ä»¥ä¸‹å‘½ä»¤ä¸‹è½½ä¸»é¢˜ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone https://github.com/blinkfox/hexo-theme-matery.git themes/matery<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ä¸‹è½½å®Œæˆåï¼Œä¿®æ”¹ Hexo æ ¹ç›®å½•ä¸‹çš„ <code>_config.yml</code> çš„ <code>theme</code> çš„å€¼ï¼š<code>theme: matery</code></p><h4 id="config-yml-æ–‡ä»¶çš„å…¶å®ƒä¿®æ”¹å»ºè®®"><a href="#config-yml-æ–‡ä»¶çš„å…¶å®ƒä¿®æ”¹å»ºè®®" class="headerlink" title="_config.yml æ–‡ä»¶çš„å…¶å®ƒä¿®æ”¹å»ºè®®:"></a><code>_config.yml</code> æ–‡ä»¶çš„å…¶å®ƒä¿®æ”¹å»ºè®®:</h4><ul><li>è¯·ä¿®æ”¹ <code>_config.yml</code> çš„ <code>url</code> çš„å€¼ä¸ºä½ çš„ç½‘ç«™ä¸» <code>URL</code>ï¼ˆå¦‚ï¼š<code>http://xxx.github.io</code>ï¼‰ã€‚</li><li>å»ºè®®ä¿®æ”¹ä¸¤ä¸ª <code>per_page</code> çš„åˆ†é¡µæ¡æ•°å€¼ä¸º <code>6</code> çš„å€æ•°ï¼Œå¦‚ï¼š<code>12</code>ã€<code>18</code> ç­‰ï¼Œè¿™æ ·æ–‡ç« åˆ—è¡¨åœ¨å„ä¸ªå±å¹•ä¸‹éƒ½èƒ½è¾ƒå¥½çš„æ˜¾ç¤ºã€‚</li><li>å¦‚æœä½ æ˜¯ä¸­æ–‡ç”¨æˆ·ï¼Œåˆ™å»ºè®®ä¿®æ”¹ <code>language</code> çš„å€¼ä¸º <code>zh-CN</code>ã€‚</li></ul><h3 id="5-2-æ–°å»ºåˆ†ç±»-categories-é¡µ"><a href="#5-2-æ–°å»ºåˆ†ç±»-categories-é¡µ" class="headerlink" title="5.2 æ–°å»ºåˆ†ç±» categories é¡µ"></a>5.2 æ–°å»ºåˆ†ç±» categories é¡µ</h3><p><code>categories</code> é¡µæ˜¯ç”¨æ¥å±•ç¤ºæ‰€æœ‰åˆ†ç±»çš„é¡µé¢ï¼Œå¦‚æœåœ¨ä½ çš„åšå®¢ <code>source</code> ç›®å½•ä¸‹è¿˜æ²¡æœ‰ <code>categories/index.md</code> æ–‡ä»¶ï¼Œé‚£ä¹ˆä½ å°±éœ€è¦æ–°å»ºä¸€ä¸ªï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hexo new page <span class="token string">"categories"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ç¼–è¾‘ä½ åˆšåˆšæ–°å»ºçš„é¡µé¢æ–‡ä»¶ <code>/source/categories/index.md</code>ï¼Œè‡³å°‘éœ€è¦ä»¥ä¸‹å†…å®¹ï¼š</p><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token front-matter-block"><span class="token punctuation">---</span><span class="token front-matter yaml language-yaml"><span class="token key atrule">title</span><span class="token punctuation">:</span> categories<span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token datetime number">2025-04-22 17:25:30</span><span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token string">"categories"</span><span class="token key atrule">layout</span><span class="token punctuation">:</span> <span class="token string">"categories"</span></span><span class="token punctuation">---</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5-3-æ–°å»ºæ ‡ç­¾-tags-é¡µ"><a href="#5-3-æ–°å»ºæ ‡ç­¾-tags-é¡µ" class="headerlink" title="5.3 æ–°å»ºæ ‡ç­¾ tags é¡µ"></a>5.3 æ–°å»ºæ ‡ç­¾ tags é¡µ</h3><p><code>tags</code> é¡µæ˜¯ç”¨æ¥å±•ç¤ºæ‰€æœ‰æ ‡ç­¾çš„é¡µé¢ï¼Œå¦‚æœåœ¨ä½ çš„åšå®¢ <code>source</code> ç›®å½•ä¸‹è¿˜æ²¡æœ‰ <code>tags/index.md</code> æ–‡ä»¶ï¼Œé‚£ä¹ˆä½ å°±éœ€è¦æ–°å»ºä¸€ä¸ªï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hexo new page <span class="token string">"tags"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ç¼–è¾‘ä½ åˆšåˆšæ–°å»ºçš„é¡µé¢æ–‡ä»¶ <code>/source/tags/index.md</code>ï¼Œè‡³å°‘éœ€è¦ä»¥ä¸‹å†…å®¹ï¼š</p><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token front-matter-block"><span class="token punctuation">---</span><span class="token front-matter yaml language-yaml"><span class="token key atrule">title</span><span class="token punctuation">:</span> tags<span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token datetime number">2025-04-22 17:25:40</span><span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token string">"tags"</span><span class="token key atrule">layout</span><span class="token punctuation">:</span> <span class="token string">"tags"</span></span><span class="token punctuation">---</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5-4-æ–°å»ºå…³äºæˆ‘-about-é¡µ"><a href="#5-4-æ–°å»ºå…³äºæˆ‘-about-é¡µ" class="headerlink" title="5.4 æ–°å»ºå…³äºæˆ‘ about é¡µ"></a>5.4 æ–°å»ºå…³äºæˆ‘ about é¡µ</h3><p><code>about</code> é¡µæ˜¯ç”¨æ¥å±•ç¤º<strong>å…³äºæˆ‘å’Œæˆ‘çš„åšå®¢</strong>ä¿¡æ¯çš„é¡µé¢ï¼Œå¦‚æœåœ¨ä½ çš„åšå®¢ <code>source</code> ç›®å½•ä¸‹è¿˜æ²¡æœ‰ <code>about/index.md</code> æ–‡ä»¶ï¼Œé‚£ä¹ˆä½ å°±éœ€è¦æ–°å»ºä¸€ä¸ªï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hexo new page <span class="token string">"about"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ç¼–è¾‘ä½ åˆšåˆšæ–°å»ºçš„é¡µé¢æ–‡ä»¶ <code>/source/about/index.md</code>ï¼Œè‡³å°‘éœ€è¦ä»¥ä¸‹å†…å®¹ï¼š</p><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token front-matter-block"><span class="token punctuation">---</span><span class="token front-matter yaml language-yaml"><span class="token key atrule">title</span><span class="token punctuation">:</span> about<span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token datetime number">2025-04-22 17:25:40</span><span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token string">"about"</span><span class="token key atrule">layout</span><span class="token punctuation">:</span> <span class="token string">"about"</span></span><span class="token punctuation">---</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5-5-æ–°å»ºç•™è¨€æ¿-contact-é¡µï¼ˆå¯é€‰çš„ï¼‰"><a href="#5-5-æ–°å»ºç•™è¨€æ¿-contact-é¡µï¼ˆå¯é€‰çš„ï¼‰" class="headerlink" title="5.5 æ–°å»ºç•™è¨€æ¿ contact é¡µï¼ˆå¯é€‰çš„ï¼‰"></a>5.5 æ–°å»ºç•™è¨€æ¿ contact é¡µï¼ˆå¯é€‰çš„ï¼‰</h3><p><code>contact</code> é¡µæ˜¯ç”¨æ¥å±•ç¤º<strong>ç•™è¨€æ¿</strong>ä¿¡æ¯çš„é¡µé¢ï¼Œå¦‚æœåœ¨ä½ çš„åšå®¢ <code>source</code> ç›®å½•ä¸‹è¿˜æ²¡æœ‰ <code>contact/index.md</code> æ–‡ä»¶ï¼Œé‚£ä¹ˆä½ å°±éœ€è¦æ–°å»ºä¸€ä¸ªï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hexo new page <span class="token string">"contact"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ç¼–è¾‘ä½ åˆšåˆšæ–°å»ºçš„é¡µé¢æ–‡ä»¶ <code>/source/contact/index.md</code>ï¼Œè‡³å°‘éœ€è¦ä»¥ä¸‹å†…å®¹ï¼š</p><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token front-matter-block"><span class="token punctuation">---</span><span class="token front-matter yaml language-yaml"><span class="token key atrule">title</span><span class="token punctuation">:</span> contact<span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token datetime number">2025-04-22 17:25:30</span><span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token string">"contact"</span><span class="token key atrule">layout</span><span class="token punctuation">:</span> <span class="token string">"contact"</span></span><span class="token punctuation">---</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><strong>æ³¨</strong>ï¼šæœ¬ç•™è¨€æ¿åŠŸèƒ½ä¾èµ–äºç¬¬ä¸‰æ–¹è¯„è®ºç³»ç»Ÿï¼Œè¯·<strong>æ¿€æ´»</strong>ä½ çš„è¯„è®ºç³»ç»Ÿæ‰æœ‰æ•ˆæœã€‚å¹¶ä¸”åœ¨ä¸»é¢˜çš„ <code>_config.yml</code> æ–‡ä»¶ä¸­ï¼Œç¬¬ <code>19</code> è‡³ <code>21</code> è¡Œçš„â€œ<strong>èœå•</strong>â€é…ç½®ï¼Œå–æ¶ˆå…³äºç•™è¨€æ¿çš„æ³¨é‡Šå³å¯ã€‚</p></blockquote><h3 id="5-6-æ–°å»ºå‹æƒ…é“¾æ¥-friends-é¡µï¼ˆå¯é€‰çš„ï¼‰"><a href="#5-6-æ–°å»ºå‹æƒ…é“¾æ¥-friends-é¡µï¼ˆå¯é€‰çš„ï¼‰" class="headerlink" title="5.6 æ–°å»ºå‹æƒ…é“¾æ¥ friends é¡µï¼ˆå¯é€‰çš„ï¼‰"></a>5.6 æ–°å»ºå‹æƒ…é“¾æ¥ friends é¡µï¼ˆå¯é€‰çš„ï¼‰</h3><p><code>friends</code> é¡µæ˜¯ç”¨æ¥å±•ç¤º<strong>å‹æƒ…é“¾æ¥</strong>ä¿¡æ¯çš„é¡µé¢ï¼Œå¦‚æœåœ¨ä½ çš„åšå®¢ <code>source</code> ç›®å½•ä¸‹è¿˜æ²¡æœ‰ <code>friends/index.md</code> æ–‡ä»¶ï¼Œé‚£ä¹ˆä½ å°±éœ€è¦æ–°å»ºä¸€ä¸ªï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hexo new page <span class="token string">"friends"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ç¼–è¾‘ä½ åˆšåˆšæ–°å»ºçš„é¡µé¢æ–‡ä»¶ <code>/source/friends/index.md</code>ï¼Œè‡³å°‘éœ€è¦ä»¥ä¸‹å†…å®¹ï¼š</p><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token front-matter-block"><span class="token punctuation">---</span><span class="token front-matter yaml language-yaml"><span class="token key atrule">title</span><span class="token punctuation">:</span> friends<span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token datetime number">2025-04-22 17:25:30</span><span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token string">"friends"</span><span class="token key atrule">layout</span><span class="token punctuation">:</span> <span class="token string">"friends"</span></span><span class="token punctuation">---</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åŒæ—¶ï¼Œåœ¨ä½ çš„åšå®¢ <code>source</code> ç›®å½•ä¸‹æ–°å»º <code>_data</code> ç›®å½•ï¼Œåœ¨ <code>_data</code> ç›®å½•ä¸­æ–°å»º <code>friends.json</code> æ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">[</span><span class="token punctuation">{</span>    <span class="token property">"avatar"</span><span class="token operator">:</span> <span class="token string">"http://image.luokangyuan.com/1_qq_27922023.jpg"</span><span class="token punctuation">,</span>    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"ç é…±"</span><span class="token punctuation">,</span>    <span class="token property">"introduction"</span><span class="token operator">:</span> <span class="token string">"æˆ‘ä¸æ˜¯å¤§ä½¬ï¼Œåªæ˜¯åœ¨è¿½å¯»å¤§ä½¬çš„è„šæ­¥"</span><span class="token punctuation">,</span>    <span class="token property">"url"</span><span class="token operator">:</span> <span class="token string">"http://luokangyuan.com/"</span><span class="token punctuation">,</span>    <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"å‰å»å­¦ä¹ "</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>    <span class="token property">"avatar"</span><span class="token operator">:</span> <span class="token string">"http://image.luokangyuan.com/4027734.jpeg"</span><span class="token punctuation">,</span>    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"é—ªçƒä¹‹ç‹"</span><span class="token punctuation">,</span>    <span class="token property">"introduction"</span><span class="token operator">:</span> <span class="token string">"ç¼–ç¨‹ç•Œå¤§ä½¬ï¼ŒæŠ€æœ¯ç‰›ï¼Œäººè¿˜ç‰¹åˆ«å¥½ï¼Œä¸æ‡‚çš„éƒ½å¯ä»¥è¯·æ•™å¤§ä½¬"</span><span class="token punctuation">,</span>    <span class="token property">"url"</span><span class="token operator">:</span> <span class="token string">"https://blinkfox.github.io/"</span><span class="token punctuation">,</span>    <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"å‰å»å­¦ä¹ "</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>    <span class="token property">"avatar"</span><span class="token operator">:</span> <span class="token string">"http://image.luokangyuan.com/avatar.jpg"</span><span class="token punctuation">,</span>    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"ja_rome"</span><span class="token punctuation">,</span>    <span class="token property">"introduction"</span><span class="token operator">:</span> <span class="token string">"å¹³å‡¡çš„è„šæ­¥ä¹Ÿå¯ä»¥èµ°å‡ºä¼Ÿå¤§çš„è¡Œç¨‹"</span><span class="token punctuation">,</span>    <span class="token property">"url"</span><span class="token operator">:</span> <span class="token string">"https://me.csdn.net/jlh912008548"</span><span class="token punctuation">,</span>    <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"å‰å»å­¦ä¹ "</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5-7-æ–°å»º-404-é¡µ"><a href="#5-7-æ–°å»º-404-é¡µ" class="headerlink" title="5.7 æ–°å»º 404 é¡µ"></a>5.7 æ–°å»º 404 é¡µ</h3><p>å¦‚æœåœ¨ä½ çš„åšå®¢ <code>source</code> ç›®å½•ä¸‹è¿˜æ²¡æœ‰ <code>404.md</code> æ–‡ä»¶ï¼Œé‚£ä¹ˆä½ å°±éœ€è¦æ–°å»ºä¸€ä¸ªã€‚ç¼–è¾‘ä½ åˆšåˆšæ–°å»ºçš„é¡µé¢æ–‡ä»¶ <code>/source/404.md</code>ï¼Œè‡³å°‘éœ€è¦ä»¥ä¸‹å†…å®¹ï¼š</p><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token front-matter-block"><span class="token punctuation">---</span><span class="token front-matter yaml language-yaml"><span class="token key atrule">title</span><span class="token punctuation">:</span> <span class="token number">404</span><span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token datetime number">2018-09-30 17:25:30</span><span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token string">"404"</span><span class="token key atrule">layout</span><span class="token punctuation">:</span> <span class="token string">"404"</span><span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">"Oopsï½ï¼Œæˆ‘å´©æºƒäº†ï¼æ‰¾ä¸åˆ°ä½ æƒ³è¦çš„é¡µé¢ :("</span></span><span class="token punctuation">---</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5-8-èœå•å¯¼èˆªé…ç½®"><a href="#5-8-èœå•å¯¼èˆªé…ç½®" class="headerlink" title="5.8 èœå•å¯¼èˆªé…ç½®"></a>5.8 èœå•å¯¼èˆªé…ç½®</h3><h4 id="5-8-1-é…ç½®åŸºæœ¬èœå•å¯¼èˆªçš„åç§°ã€è·¯å¾„urlå’Œå›¾æ ‡icon"><a href="#5-8-1-é…ç½®åŸºæœ¬èœå•å¯¼èˆªçš„åç§°ã€è·¯å¾„urlå’Œå›¾æ ‡icon" class="headerlink" title="5.8.1 é…ç½®åŸºæœ¬èœå•å¯¼èˆªçš„åç§°ã€è·¯å¾„urlå’Œå›¾æ ‡icon."></a>5.8.1 é…ç½®åŸºæœ¬èœå•å¯¼èˆªçš„åç§°ã€è·¯å¾„urlå’Œå›¾æ ‡icon.</h4><p>1.èœå•å¯¼èˆªåç§°å¯ä»¥æ˜¯ä¸­æ–‡ä¹Ÿå¯ä»¥æ˜¯è‹±æ–‡(å¦‚ï¼š<code>Index</code>æˆ–<code>ä¸»é¡µ</code>) </p><p>2.å›¾æ ‡icon å¯ä»¥åœ¨<a href="https://fontawesome.com/icons">Font Awesome</a> ä¸­æŸ¥æ‰¾</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">menu</span><span class="token punctuation">:</span>  <span class="token key atrule">Index</span><span class="token punctuation">:</span>    <span class="token key atrule">url</span><span class="token punctuation">:</span> /    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>home  <span class="token key atrule">Tags</span><span class="token punctuation">:</span>    <span class="token key atrule">url</span><span class="token punctuation">:</span> /tags    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>tags  <span class="token key atrule">Categories</span><span class="token punctuation">:</span>    <span class="token key atrule">url</span><span class="token punctuation">:</span> /categories    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>bookmark  <span class="token key atrule">Archives</span><span class="token punctuation">:</span>    <span class="token key atrule">url</span><span class="token punctuation">:</span> /archives    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>archive  <span class="token key atrule">About</span><span class="token punctuation">:</span>    <span class="token key atrule">url</span><span class="token punctuation">:</span> /about    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>user<span class="token punctuation">-</span>circle  <span class="token key atrule">Friends</span><span class="token punctuation">:</span>    <span class="token key atrule">url</span><span class="token punctuation">:</span> /friends    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>address<span class="token punctuation">-</span>book<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="5-8-2-äºŒçº§èœå•é…ç½®æ–¹æ³•"><a href="#5-8-2-äºŒçº§èœå•é…ç½®æ–¹æ³•" class="headerlink" title="5.8.2 äºŒçº§èœå•é…ç½®æ–¹æ³•"></a>5.8.2 äºŒçº§èœå•é…ç½®æ–¹æ³•</h4><p>å¦‚æœä½ éœ€è¦äºŒçº§èœå•åˆ™å¯ä»¥åœ¨åŸåŸºæœ¬èœå•å¯¼èˆªçš„åŸºç¡€ä¸Šå¦‚ä¸‹æ“ä½œ</p><ol><li>åœ¨éœ€è¦æ·»åŠ äºŒçº§èœå•çš„ä¸€çº§èœå•ä¸‹æ·»åŠ <code>children</code>å…³é”®å­—(å¦‚:<code>About</code>èœå•ä¸‹æ·»åŠ <code>children</code>)</li><li>åœ¨<code>children</code>ä¸‹åˆ›å»ºäºŒçº§èœå•çš„ åç§°name,è·¯å¾„urlå’Œå›¾æ ‡icon.</li><li>æ³¨æ„æ¯ä¸ªäºŒçº§èœå•æ¨¡å—å‰è¦åŠ  <code>-</code>.</li><li>æ³¨æ„ç¼©è¿›æ ¼å¼</li></ol><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">menu</span><span class="token punctuation">:</span>  <span class="token key atrule">Index</span><span class="token punctuation">:</span>    <span class="token key atrule">url</span><span class="token punctuation">:</span> /    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>home  <span class="token key atrule">Tags</span><span class="token punctuation">:</span>    <span class="token key atrule">url</span><span class="token punctuation">:</span> /tags    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>tags  <span class="token key atrule">Categories</span><span class="token punctuation">:</span>    <span class="token key atrule">url</span><span class="token punctuation">:</span> /categories    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>bookmark  <span class="token key atrule">Archives</span><span class="token punctuation">:</span>    <span class="token key atrule">url</span><span class="token punctuation">:</span> /archives    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>archive  <span class="token key atrule">About</span><span class="token punctuation">:</span>    <span class="token key atrule">url</span><span class="token punctuation">:</span> /about    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>user<span class="token punctuation">-</span>circle<span class="token punctuation">-</span>o  <span class="token key atrule">Friends</span><span class="token punctuation">:</span>    <span class="token key atrule">url</span><span class="token punctuation">:</span> /friends    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>address<span class="token punctuation">-</span>book  <span class="token key atrule">Medias</span><span class="token punctuation">:</span>    <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>list    <span class="token key atrule">children</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Music        <span class="token key atrule">url</span><span class="token punctuation">:</span> /music        <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>music      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Movies        <span class="token key atrule">url</span><span class="token punctuation">:</span> /movies        <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>film      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Books        <span class="token key atrule">url</span><span class="token punctuation">:</span> /books        <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>book      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Galleries        <span class="token key atrule">url</span><span class="token punctuation">:</span> /galleries        <span class="token key atrule">icon</span><span class="token punctuation">:</span> fas fa<span class="token punctuation">-</span>image<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5-9-ä»£ç é«˜äº®"><a href="#5-9-ä»£ç é«˜äº®" class="headerlink" title="5.9 ä»£ç é«˜äº®"></a>5.9 ä»£ç é«˜äº®</h3><p>ä» Hexo5.0 ç‰ˆæœ¬å¼€å§‹è‡ªå¸¦äº† <code>prismjs</code> ä»£ç è¯­æ³•é«˜äº®çš„æ”¯æŒï¼ŒMateryä¸»é¢˜å¯¹æ­¤è¿›è¡Œäº†æ”¹é€ æ”¯æŒã€‚</p><p>å¦‚æœä½ çš„åšå®¢ä¸­æ›¾ç»å®‰è£…è¿‡ <code>hexo-prism-plugin</code> çš„æ’ä»¶ï¼Œé‚£ä¹ˆä½ é¡»è¦æ‰§è¡Œ <code>npm uninstall hexo-prism-plugin</code> æ¥å¸è½½æ‰å®ƒï¼Œå¦åˆ™ç”Ÿæˆçš„ä»£ç ä¸­ä¼šæœ‰ <code>{</code> å’Œ <code>}</code> çš„è½¬ä¹‰å­—ç¬¦ã€‚</p><p>ç„¶åï¼Œä¿®æ”¹ä½ åšå®¢æ ¹ç›®å½•ä¸‹ <code>_config.yml</code> æ–‡ä»¶ä¸­ <code>highlight.enable</code> çš„å€¼ä¸º <code>false</code>ï¼Œå¹¶å°† <code>prismjs.enable</code> çš„å€¼è®¾ç½®ä¸º <code>true</code>ï¼Œä¸»è¦é…ç½®å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">highlight</span><span class="token punctuation">:</span>  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">line_number</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">auto_detect</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">tab_replace</span><span class="token punctuation">:</span> <span class="token string">''</span>  <span class="token key atrule">wrap</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">hljs</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">prismjs</span><span class="token punctuation">:</span>  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">preprocess</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">line_number</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">tab_replace</span><span class="token punctuation">:</span> <span class="token string">''</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸»é¢˜ä¸­é»˜è®¤çš„ <code>prismjs</code> ä¸»é¢˜æ˜¯ <code>Tomorrow Night</code>ï¼Œå¦‚æœä½ æƒ³å®šåˆ¶è‡ªå·±çš„ä¸»é¢˜ï¼Œå¯ä»¥å‰å¾€ <a href="https://prismjs.com/download.html">prismjs ä¸‹è½½é¡µé¢</a> å®šåˆ¶ä¸‹è½½è‡ªå·±å–œæ¬¢çš„ä¸»é¢˜ <code>css</code> æ–‡ä»¶ï¼Œç„¶åå°†æ­¤ css ä¸»é¢˜æ–‡ä»¶å–åä¸º <code>prism.css</code>ï¼Œæ›¿æ¢æ‰ <code>matery</code> ä¸»é¢˜æ–‡ä»¶å¤¹ä¸­çš„ <code>source/libs/prism/prism.css</code> æ–‡ä»¶å³å¯ã€‚</p><h3 id="5-10-æœç´¢"><a href="#5-10-æœç´¢" class="headerlink" title="5.10 æœç´¢"></a>5.10 æœç´¢</h3><p>materyä¸»é¢˜ä¸­è¿˜ä½¿ç”¨åˆ°äº† <a href="https://github.com/wzpan/hexo-generator-search">hexo-generator-search</a> çš„ Hexo æ’ä»¶æ¥åšå†…å®¹æœç´¢ï¼Œå®‰è£…å‘½ä»¤å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> hexo-generator-search <span class="token parameter variable">--save</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>åœ¨ä½ åšå®¢ç›®å½•ä¸‹çš„ <code>_config.yml</code> æ–‡ä»¶ä¸­ï¼Œæ–°å¢ä»¥ä¸‹çš„é…ç½®é¡¹ï¼š</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">search</span><span class="token punctuation">:</span>  <span class="token key atrule">path</span><span class="token punctuation">:</span> search.xml  <span class="token key atrule">field</span><span class="token punctuation">:</span> post<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="5-11-ä¸­æ–‡é“¾æ¥è½¬æ‹¼éŸ³ï¼ˆå»ºè®®å®‰è£…ï¼‰"><a href="#5-11-ä¸­æ–‡é“¾æ¥è½¬æ‹¼éŸ³ï¼ˆå»ºè®®å®‰è£…ï¼‰" class="headerlink" title="5.11 ä¸­æ–‡é“¾æ¥è½¬æ‹¼éŸ³ï¼ˆå»ºè®®å®‰è£…ï¼‰"></a>5.11 ä¸­æ–‡é“¾æ¥è½¬æ‹¼éŸ³ï¼ˆå»ºè®®å®‰è£…ï¼‰</h3><p>å¦‚æœä½ çš„æ–‡ç« åç§°æ˜¯ä¸­æ–‡çš„ï¼Œé‚£ä¹ˆ Hexo é»˜è®¤ç”Ÿæˆçš„æ°¸ä¹…é“¾æ¥ä¹Ÿä¼šæœ‰ä¸­æ–‡ï¼Œè¿™æ ·ä¸åˆ©äº <code>SEO</code>ï¼Œä¸” <code>gitment</code> è¯„è®ºå¯¹ä¸­æ–‡é“¾æ¥ä¹Ÿä¸æ”¯æŒã€‚æˆ‘ä»¬å¯ä»¥ç”¨ <a href="https://github.com/viko16/hexo-permalink-pinyin">hexo-permalink-pinyin</a> Hexo æ’ä»¶ä½¿åœ¨ç”Ÿæˆæ–‡ç« æ—¶ç”Ÿæˆä¸­æ–‡æ‹¼éŸ³çš„æ°¸ä¹…é“¾æ¥ã€‚</p><p>å®‰è£…å‘½ä»¤å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> i hexo-permalink-pinyin <span class="token parameter variable">--save</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>åœ¨ä½ åšå®¢æ ¹ç›®å½•ä¸‹çš„ <code>_config.yml</code> æ–‡ä»¶ä¸­ï¼Œæ–°å¢ä»¥ä¸‹çš„é…ç½®é¡¹ï¼š</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">permalink_pinyin</span><span class="token punctuation">:</span>  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">separator</span><span class="token punctuation">:</span> <span class="token string">'-'</span> <span class="token comment"># default: '-'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><blockquote><p><strong>æ³¨</strong>ï¼šé™¤äº†æ­¤æ’ä»¶å¤–ï¼Œ<a href="https://github.com/rozbo/hexo-abbrlink">hexo-abbrlink</a> æ’ä»¶ä¹Ÿå¯ä»¥ç”Ÿæˆéä¸­æ–‡çš„é“¾æ¥ã€‚</p></blockquote><h3 id="5-12-æ–‡ç« å­—æ•°ç»Ÿè®¡æ’ä»¶ï¼ˆå»ºè®®å®‰è£…ï¼‰"><a href="#5-12-æ–‡ç« å­—æ•°ç»Ÿè®¡æ’ä»¶ï¼ˆå»ºè®®å®‰è£…ï¼‰" class="headerlink" title="5.12 æ–‡ç« å­—æ•°ç»Ÿè®¡æ’ä»¶ï¼ˆå»ºè®®å®‰è£…ï¼‰"></a>5.12 æ–‡ç« å­—æ•°ç»Ÿè®¡æ’ä»¶ï¼ˆå»ºè®®å®‰è£…ï¼‰</h3><p>å¦‚æœä½ æƒ³è¦åœ¨æ–‡ç« ä¸­æ˜¾ç¤ºæ–‡ç« å­—æ•°ã€é˜…è¯»æ—¶é•¿ä¿¡æ¯ï¼Œå¯ä»¥å®‰è£… <a href="https://github.com/willin/hexo-wordcount">hexo-wordcount</a>æ’ä»¶ã€‚</p><p>å®‰è£…å‘½ä»¤å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> i <span class="token parameter variable">--save</span> hexo-wordcount<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>ç„¶ååªéœ€åœ¨ä¸»é¢˜ themesæ–‡ä»¶å¤¹çš„materyæ–‡ä»¶å¤¹ä¸‹çš„ <code>_config.yml</code> æ–‡ä»¶ä¸­ï¼Œå°†å„ä¸ªæ–‡ç« å­—æ•°ç›¸å…³çš„é…ç½®æ¿€æ´»å³å¯ï¼š</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">postInfo</span><span class="token punctuation">:</span>  <span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">update</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">wordCount</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># è®¾ç½®æ–‡ç« å­—æ•°ç»Ÿè®¡ä¸º true.</span>  <span class="token key atrule">totalCount</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># è®¾ç½®ç«™ç‚¹æ–‡ç« æ€»å­—æ•°ç»Ÿè®¡ä¸º true.</span>  <span class="token key atrule">min2read</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># é˜…è¯»æ—¶é•¿.</span>  <span class="token key atrule">readCount</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># é˜…è¯»æ¬¡æ•°.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="5-13-æ·»åŠ emojiè¡¨æƒ…æ”¯æŒï¼ˆå¯é€‰çš„ï¼‰"><a href="#5-13-æ·»åŠ emojiè¡¨æƒ…æ”¯æŒï¼ˆå¯é€‰çš„ï¼‰" class="headerlink" title="5.13 æ·»åŠ emojiè¡¨æƒ…æ”¯æŒï¼ˆå¯é€‰çš„ï¼‰"></a>5.13 æ·»åŠ emojiè¡¨æƒ…æ”¯æŒï¼ˆå¯é€‰çš„ï¼‰</h3><p>æœ¬ä¸»é¢˜æ–°å¢äº†å¯¹<code>emoji</code>è¡¨æƒ…çš„æ”¯æŒï¼Œä½¿ç”¨åˆ°äº† <a href="https://npm.taobao.org/package/hexo-filter-github-emojis">hexo-filter-github-emojis</a> çš„ Hexo æ’ä»¶æ¥æ”¯æŒ <code>emoji</code>è¡¨æƒ…çš„ç”Ÿæˆï¼ŒæŠŠå¯¹åº”çš„<code>markdown emoji</code>è¯­æ³•ï¼ˆ<code>::</code>,ä¾‹å¦‚ï¼š<code>:smile:</code>ï¼‰è½¬å˜æˆä¼šè·³è·ƒçš„<code>emoji</code>è¡¨æƒ…ï¼Œå®‰è£…å‘½ä»¤å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> hexo-filter-github-emojis <span class="token parameter variable">--save</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>åœ¨ä½ åšå®¢ç›®å½•ä¸‹çš„ <code>_config.yml</code> æ–‡ä»¶ä¸­ï¼Œæ–°å¢ä»¥ä¸‹çš„é…ç½®é¡¹ï¼š</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">githubEmojis</span><span class="token punctuation">:</span>  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">className</span><span class="token punctuation">:</span> github<span class="token punctuation">-</span>emoji  <span class="token key atrule">inject</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">styles</span><span class="token punctuation">:</span>  customEmojis<span class="token punctuation">:</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰§è¡Œ <code>hexo clean &amp;&amp; hexo g</code> é‡æ–°ç”Ÿæˆåšå®¢æ–‡ä»¶ï¼Œç„¶åå°±å¯ä»¥åœ¨æ–‡ç« ä¸­å¯¹åº”ä½ç½®çœ‹åˆ°ä½ ç”¨<code>emoji</code>è¯­æ³•å†™çš„è¡¨æƒ…äº†ã€‚</p><h3 id="5-14-æ·»åŠ -RSS-è®¢é˜…æ”¯æŒï¼ˆå¯é€‰çš„ï¼‰"><a href="#5-14-æ·»åŠ -RSS-è®¢é˜…æ”¯æŒï¼ˆå¯é€‰çš„ï¼‰" class="headerlink" title="5.14 æ·»åŠ  RSS è®¢é˜…æ”¯æŒï¼ˆå¯é€‰çš„ï¼‰"></a>5.14 æ·»åŠ  RSS è®¢é˜…æ”¯æŒï¼ˆå¯é€‰çš„ï¼‰</h3><p>æœ¬ä¸»é¢˜ä¸­è¿˜ä½¿ç”¨åˆ°äº† <a href="https://github.com/hexojs/hexo-generator-feed">hexo-generator-feed</a> çš„ Hexo æ’ä»¶æ¥åš <code>RSS</code>ï¼Œå®‰è£…å‘½ä»¤å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> hexo-generator-feed <span class="token parameter variable">--save</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>åœ¨ä½ åšå®¢ç›®å½•ä¸‹çš„ <code>_config.yml</code> æ–‡ä»¶ä¸­ï¼Œæ–°å¢ä»¥ä¸‹çš„é…ç½®é¡¹ï¼š</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">feed</span><span class="token punctuation">:</span>  <span class="token key atrule">type</span><span class="token punctuation">:</span> atom  <span class="token key atrule">path</span><span class="token punctuation">:</span> atom.xml  <span class="token key atrule">limit</span><span class="token punctuation">:</span> <span class="token number">20</span>  <span class="token key atrule">hub</span><span class="token punctuation">:</span>  <span class="token key atrule">content</span><span class="token punctuation">:</span>  <span class="token key atrule">content_limit</span><span class="token punctuation">:</span> <span class="token number">140</span>  <span class="token key atrule">content_limit_delim</span><span class="token punctuation">:</span> <span class="token string">' '</span>  <span class="token key atrule">order_by</span><span class="token punctuation">:</span> <span class="token punctuation">-</span>date<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ‰§è¡Œ <code>hexo clean &amp;&amp; hexo g</code> é‡æ–°ç”Ÿæˆåšå®¢æ–‡ä»¶ï¼Œç„¶ååœ¨ <code>public</code> æ–‡ä»¶å¤¹ä¸­å³å¯çœ‹åˆ° <code>atom.xml</code> æ–‡ä»¶ï¼Œè¯´æ˜ä½ å·²ç»å®‰è£…æˆåŠŸäº†ã€‚</p><h3 id="5-15-ä¿®æ”¹é¡µè„š"><a href="#5-15-ä¿®æ”¹é¡µè„š" class="headerlink" title="5.15 ä¿®æ”¹é¡µè„š"></a>5.15 ä¿®æ”¹é¡µè„š</h3><p>é¡µè„šä¿¡æ¯å¯èƒ½éœ€è¦åšå®šåˆ¶åŒ–ä¿®æ”¹ï¼Œè€Œä¸”å®ƒä¸ä¾¿äºåšæˆé…ç½®ä¿¡æ¯ï¼Œæ‰€ä»¥å¯èƒ½éœ€è¦ä½ è‡ªå·±å»å†ä¿®æ”¹å’ŒåŠ å·¥ã€‚ä¿®æ”¹çš„åœ°æ–¹åœ¨ä¸»é¢˜æ–‡ä»¶çš„ <code>/layout/_partial/footer.ejs</code> æ–‡ä»¶ä¸­ï¼ŒåŒ…æ‹¬ç«™ç‚¹ã€ä½¿ç”¨çš„ä¸»é¢˜ã€è®¿é—®é‡ç­‰ã€‚</p><h3 id="5-16-æ·»åŠ ä¸­æ–‡ç¹ç®€è½¬æ¢"><a href="#5-16-æ·»åŠ ä¸­æ–‡ç¹ç®€è½¬æ¢" class="headerlink" title="5.16 æ·»åŠ ä¸­æ–‡ç¹ç®€è½¬æ¢"></a>5.16 æ·»åŠ ä¸­æ–‡ç¹ç®€è½¬æ¢</h3><p>åœ¨ä¸»é¢˜çš„ <code>_config.yml</code> æ–‡ä»¶ä¸­ï¼Œå¼€å¯ translate ä¸º enableã€‚</p><blockquote><p>å¼€å¯ä¸­æ–‡ç¹ç®€è½¬æ¢å¦‚ä¸‹ä¿®æ”¹ã€‚é»˜è®¤ä¸å¼€å¯ã€‚ å®ä¾‹æ¼”ç¤ºï¼š <a href="https://blog.17lai.site/">ç¹ç®€è½¬æ¢</a> åº•ä¸‹ footer æ </p></blockquote><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">translate</span><span class="token punctuation">:</span>  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="5-17-ä¿®æ”¹ç¤¾äº¤é“¾æ¥"><a href="#5-17-ä¿®æ”¹ç¤¾äº¤é“¾æ¥" class="headerlink" title="5.17 ä¿®æ”¹ç¤¾äº¤é“¾æ¥"></a>5.17 ä¿®æ”¹ç¤¾äº¤é“¾æ¥</h3><p>åœ¨ä¸»é¢˜çš„ <code>_config.yml</code> æ–‡ä»¶ä¸­ï¼Œé»˜è®¤æ”¯æŒ <code>QQ</code>ã€<code>GitHub</code> å’Œé‚®ç®±ç­‰çš„é…ç½®ï¼Œä½ å¯ä»¥åœ¨ä¸»é¢˜æ–‡ä»¶çš„ <code>/layout/_partial/social-link.ejs</code> æ–‡ä»¶ä¸­ï¼Œæ–°å¢ã€ä¿®æ”¹ä½ éœ€è¦çš„ç¤¾äº¤é“¾æ¥åœ°å€ï¼Œå¢åŠ é“¾æ¥å¯å‚è€ƒå¦‚ä¸‹ä»£ç ï¼š</p><pre class="line-numbers language-ejs" data-language="ejs"><code class="language-ejs"><span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%</span><span class="token language-javascript"> <span class="token keyword">if</span> <span class="token punctuation">(</span>theme<span class="token punctuation">.</span>socialLink<span class="token punctuation">.</span>github<span class="token punctuation">)</span> <span class="token punctuation">{</span> </span><span class="token delimiter punctuation">%&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%=</span><span class="token language-javascript"> theme<span class="token punctuation">.</span>socialLink<span class="token punctuation">.</span>github </span><span class="token delimiter punctuation">%&gt;</span></span><span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tooltipped<span class="token punctuation">"</span></span> <span class="token attr-name">target</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>_blank<span class="token punctuation">"</span></span> <span class="token attr-name">data-tooltip</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>è®¿é—®æˆ‘çš„GitHub<span class="token punctuation">"</span></span> <span class="token attr-name">data-position</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>top<span class="token punctuation">"</span></span> <span class="token attr-name">data-delay</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>50<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>i</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fab fa-github<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>i</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span><span class="token ejs language-ejs"><span class="token delimiter punctuation">&lt;%</span><span class="token language-javascript"> <span class="token punctuation">}</span> </span><span class="token delimiter punctuation">%&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…¶ä¸­ï¼Œç¤¾äº¤å›¾æ ‡ï¼ˆå¦‚ï¼š<code>fa-github</code>ï¼‰ä½ å¯ä»¥åœ¨ <a href="https://fontawesome.com/icons">Font Awesome</a> ä¸­æœç´¢æ‰¾åˆ°ã€‚ä»¥ä¸‹æ˜¯å¸¸ç”¨ç¤¾äº¤å›¾æ ‡çš„æ ‡è¯†ï¼Œä¾›ä½ å‚è€ƒï¼š</p><ul><li>Facebook: <code>fab fa-facebook</code></li><li>Twitter: <code>fab fa-twitter</code></li><li>Google-plus: <code>fab fa-google-plus</code></li><li>Linkedin: <code>fab fa-linkedin</code></li><li>Tumblr: <code>fab fa-tumblr</code></li><li>Medium: <code>fab fa-medium</code></li><li>Slack: <code>fab fa-slack</code></li><li>Sina Weibo: <code>fab fa-weibo</code></li><li>Wechat: <code>fab fa-weixin</code></li><li>QQ: <code>fab fa-qq</code></li><li>Zhihu: <code>fab fa-zhihu</code></li></ul><blockquote><p><strong>æ³¨æ„</strong>: æœ¬ä¸»é¢˜ä¸­ä½¿ç”¨çš„ <code>Font Awesome</code> ç‰ˆæœ¬ä¸º <code>5.11.0</code>ã€‚</p></blockquote><h3 id="5-18-ä¿®æ”¹æ‰“èµçš„äºŒç»´ç å›¾ç‰‡"><a href="#5-18-ä¿®æ”¹æ‰“èµçš„äºŒç»´ç å›¾ç‰‡" class="headerlink" title="5.18 ä¿®æ”¹æ‰“èµçš„äºŒç»´ç å›¾ç‰‡"></a>5.18 ä¿®æ”¹æ‰“èµçš„äºŒç»´ç å›¾ç‰‡</h3><p>åœ¨ä¸»é¢˜æ–‡ä»¶çš„ <code>source/medias/reward</code> æ–‡ä»¶ä¸­ï¼Œä½ å¯ä»¥æ›¿æ¢æˆä½ çš„çš„å¾®ä¿¡å’Œæ”¯ä»˜å®çš„æ‰“èµäºŒç»´ç å›¾ç‰‡ã€‚</p><h3 id="5-19-é…ç½®éŸ³ä¹æ’­æ”¾å™¨ï¼ˆå¯é€‰çš„ï¼‰"><a href="#5-19-é…ç½®éŸ³ä¹æ’­æ”¾å™¨ï¼ˆå¯é€‰çš„ï¼‰" class="headerlink" title="5.19 é…ç½®éŸ³ä¹æ’­æ”¾å™¨ï¼ˆå¯é€‰çš„ï¼‰"></a>5.19 é…ç½®éŸ³ä¹æ’­æ”¾å™¨ï¼ˆå¯é€‰çš„ï¼‰</h3><p>è¦æ”¯æŒéŸ³ä¹æ’­æ”¾ï¼Œåœ¨ä¸»é¢˜çš„ <code>_config.yml</code> é…ç½®æ–‡ä»¶ä¸­æ¿€æ´»musicé…ç½®å³å¯ï¼š</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># æ˜¯å¦åœ¨é¦–é¡µæ˜¾ç¤ºéŸ³ä¹</span><span class="token key atrule">music</span><span class="token punctuation">:</span>  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token key atrule">title</span><span class="token punctuation">:</span>         <span class="token comment"># éå¸åº•æ¨¡å¼æœ‰æ•ˆ</span>    <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">show</span><span class="token punctuation">:</span> å¬å¬éŸ³ä¹  <span class="token key atrule">server</span><span class="token punctuation">:</span> netease   <span class="token comment"># require music platform: netease, tencent, kugou, xiami, baidu</span>  <span class="token key atrule">type</span><span class="token punctuation">:</span> playlist    <span class="token comment"># require song, playlist, album, search, artist</span>  <span class="token key atrule">id</span><span class="token punctuation">:</span> <span class="token number">503838841</span>     <span class="token comment"># require song id / playlist id / album id / search keyword</span>  <span class="token key atrule">fixed</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>      <span class="token comment"># å¼€å¯å¸åº•æ¨¡å¼</span>  <span class="token key atrule">autoplay</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>   <span class="token comment"># æ˜¯å¦è‡ªåŠ¨æ’­æ”¾</span>  <span class="token key atrule">theme</span><span class="token punctuation">:</span> <span class="token string">'#42b983'</span>  <span class="token key atrule">loop</span><span class="token punctuation">:</span> <span class="token string">'all'</span>       <span class="token comment"># éŸ³é¢‘å¾ªç¯æ’­æ”¾, å¯é€‰å€¼: 'all', 'one', 'none'</span>  <span class="token key atrule">order</span><span class="token punctuation">:</span> <span class="token string">'random'</span>   <span class="token comment"># éŸ³é¢‘å¾ªç¯é¡ºåº, å¯é€‰å€¼: 'list', 'random'</span>  <span class="token key atrule">preload</span><span class="token punctuation">:</span> <span class="token string">'auto'</span>   <span class="token comment"># é¢„åŠ è½½ï¼Œå¯é€‰å€¼: 'none', 'metadata', 'auto'</span>  <span class="token key atrule">volume</span><span class="token punctuation">:</span> <span class="token number">0.7</span>       <span class="token comment"># é»˜è®¤éŸ³é‡ï¼Œè¯·æ³¨æ„æ’­æ”¾å™¨ä¼šè®°å¿†ç”¨æˆ·è®¾ç½®ï¼Œç”¨æˆ·æ‰‹åŠ¨è®¾ç½®éŸ³é‡åé»˜è®¤éŸ³é‡å³å¤±æ•ˆ</span>  <span class="token key atrule">listFolded</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token comment"># åˆ—è¡¨é»˜è®¤æŠ˜å </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><code>server</code>å¯é€‰<code>netease</code>ï¼ˆç½‘æ˜“äº‘éŸ³ä¹ï¼‰ï¼Œ<code>tencent</code>ï¼ˆQQéŸ³ä¹ï¼‰ï¼Œ<code>kugou</code>ï¼ˆé…·ç‹—éŸ³ä¹ï¼‰ï¼Œ<code>xiami</code>ï¼ˆè™¾ç±³éŸ³ä¹ï¼‰ï¼Œ<code>baidu</code>ï¼ˆç™¾åº¦éŸ³ä¹ï¼‰ã€‚</p><p><code>type</code>å¯é€‰<code>song</code>ï¼ˆæ­Œæ›²ï¼‰ï¼Œ<code>playlist</code>ï¼ˆæ­Œå•ï¼‰ï¼Œ<code>album</code>ï¼ˆä¸“è¾‘ï¼‰ï¼Œ<code>search</code>ï¼ˆæœç´¢å…³é”®å­—ï¼‰ï¼Œ<code>artist</code>ï¼ˆæ­Œæ‰‹ï¼‰ã€‚</p><p><code>id</code>è·å–æ–¹æ³•ç¤ºä¾‹: æµè§ˆå™¨æ‰“å¼€ç½‘æ˜“äº‘éŸ³ä¹ï¼Œç‚¹å‡»æˆ‘å–œæ¬¢çš„éŸ³ä¹æ­Œå•ï¼Œæµè§ˆå™¨åœ°å€æ åé¢ä¼šæœ‰ä¸€ä¸²æ•°å­—ï¼Œ<code>playlist</code>çš„<code>id</code>å³ä¸ºè¿™ä¸²æ•°å­—ã€‚</p></blockquote><h3 id="5-20-æ–‡ç« -Front-matter-ä»‹ç»"><a href="#5-20-æ–‡ç« -Front-matter-ä»‹ç»" class="headerlink" title="5.20 æ–‡ç«  Front-matter ä»‹ç»"></a>5.20 æ–‡ç«  Front-matter ä»‹ç»</h3><p>Front-matter é€‰é¡¹è¯¦è§£</p><p><code>Front-matter</code> é€‰é¡¹ä¸­çš„æ‰€æœ‰å†…å®¹å‡ä¸º<strong>éå¿…å¡«</strong>çš„ã€‚ä½†æˆ‘ä»ç„¶å»ºè®®è‡³å°‘å¡«å†™ <code>title</code> å’Œ <code>date</code> çš„å€¼ã€‚</p><table><thead><tr><th>é…ç½®é€‰é¡¹</th><th>é»˜è®¤å€¼</th><th>æè¿°</th></tr></thead><tbody><tr><td>title</td><td><code>Markdown</code> çš„æ–‡ä»¶æ ‡é¢˜</td><td>æ–‡ç« æ ‡é¢˜ï¼Œå¼ºçƒˆå»ºè®®å¡«å†™æ­¤é€‰é¡¹</td></tr><tr><td>date</td><td>æ–‡ä»¶åˆ›å»ºæ—¶çš„æ—¥æœŸæ—¶é—´</td><td>å‘å¸ƒæ—¶é—´ï¼Œå¼ºçƒˆå»ºè®®å¡«å†™æ­¤é€‰é¡¹ï¼Œä¸”æœ€å¥½ä¿è¯å…¨å±€å”¯ä¸€</td></tr><tr><td>author</td><td>æ ¹ <code>_config.yml</code> ä¸­çš„ <code>author</code></td><td>æ–‡ç« ä½œè€…</td></tr><tr><td>img</td><td><code>featureImages</code> ä¸­çš„æŸä¸ªå€¼</td><td>æ–‡ç« ç‰¹å¾å›¾ï¼Œæ¨èä½¿ç”¨å›¾åºŠ(è…¾è®¯äº‘ã€ä¸ƒç‰›äº‘ã€åˆæ‹äº‘ç­‰)æ¥åšå›¾ç‰‡çš„è·¯å¾„.å¦‚: <code>http://xxx.com/xxx.jpg</code></td></tr><tr><td>top</td><td><code>true</code></td><td>æ¨èæ–‡ç« ï¼ˆæ–‡ç« æ˜¯å¦ç½®é¡¶ï¼‰ï¼Œå¦‚æœ <code>top</code> å€¼ä¸º <code>true</code>ï¼Œåˆ™ä¼šä½œä¸ºé¦–é¡µæ¨èæ–‡ç« </td></tr><tr><td>hide</td><td><code>false</code></td><td>éšè—æ–‡ç« ï¼Œå¦‚æœ<code>hide</code>å€¼ä¸º<code>true</code>ï¼Œåˆ™æ–‡ç« ä¸ä¼šåœ¨é¦–é¡µæ˜¾ç¤º</td></tr><tr><td>cover</td><td><code>false</code></td><td><code>v1.0.2</code>ç‰ˆæœ¬æ–°å¢ï¼Œè¡¨ç¤ºè¯¥æ–‡ç« æ˜¯å¦éœ€è¦åŠ å…¥åˆ°é¦–é¡µè½®æ’­å°é¢ä¸­</td></tr><tr><td>coverImg</td><td>æ— </td><td><code>v1.0.2</code>ç‰ˆæœ¬æ–°å¢ï¼Œè¡¨ç¤ºè¯¥æ–‡ç« åœ¨é¦–é¡µè½®æ’­å°é¢éœ€è¦æ˜¾ç¤ºçš„å›¾ç‰‡è·¯å¾„ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™é»˜è®¤ä½¿ç”¨æ–‡ç« çš„ç‰¹è‰²å›¾ç‰‡</td></tr><tr><td>password</td><td>æ— </td><td>æ–‡ç« é˜…è¯»å¯†ç ï¼Œå¦‚æœè¦å¯¹æ–‡ç« è®¾ç½®é˜…è¯»éªŒè¯å¯†ç çš„è¯ï¼Œå°±å¯ä»¥è®¾ç½® <code>password</code> çš„å€¼ï¼Œè¯¥å€¼å¿…é¡»æ˜¯ç”¨ <code>SHA256</code> åŠ å¯†åçš„å¯†ç ï¼Œé˜²æ­¢è¢«ä»–äººè¯†ç ´ã€‚å‰ææ˜¯åœ¨ä¸»é¢˜çš„ <code>config.yml</code> ä¸­æ¿€æ´»äº† <code>verifyPassword</code> é€‰é¡¹</td></tr><tr><td>toc</td><td><code>true</code></td><td>æ˜¯å¦å¼€å¯ TOCï¼Œå¯ä»¥é’ˆå¯¹æŸç¯‡æ–‡ç« å•ç‹¬å…³é—­ TOC çš„åŠŸèƒ½ã€‚å‰ææ˜¯åœ¨ä¸»é¢˜çš„ <code>config.yml</code> ä¸­æ¿€æ´»äº† <code>toc</code> é€‰é¡¹</td></tr><tr><td>mathjax</td><td><code>false</code></td><td>æ˜¯å¦å¼€å¯æ•°å­¦å…¬å¼æ”¯æŒ ï¼Œæœ¬æ–‡ç« æ˜¯å¦å¼€å¯ <code>mathjax</code>ï¼Œä¸”éœ€è¦åœ¨ä¸»é¢˜çš„ <code>_config.yml</code> æ–‡ä»¶ä¸­ä¹Ÿéœ€è¦å¼€å¯æ‰è¡Œ</td></tr><tr><td>summary</td><td>æ— </td><td>æ–‡ç« æ‘˜è¦ï¼Œè‡ªå®šä¹‰çš„æ–‡ç« æ‘˜è¦å†…å®¹ï¼Œå¦‚æœè¿™ä¸ªå±æ€§æœ‰å€¼ï¼Œæ–‡ç« å¡ç‰‡æ‘˜è¦å°±æ˜¾ç¤ºè¿™æ®µæ–‡å­—ï¼Œå¦åˆ™ç¨‹åºä¼šè‡ªåŠ¨æˆªå–æ–‡ç« çš„éƒ¨åˆ†å†…å®¹ä½œä¸ºæ‘˜è¦</td></tr><tr><td>categories</td><td>æ— </td><td>æ–‡ç« åˆ†ç±»ï¼Œæœ¬ä¸»é¢˜çš„åˆ†ç±»è¡¨ç¤ºå®è§‚ä¸Šå¤§çš„åˆ†ç±»ï¼Œåªå»ºè®®ä¸€ç¯‡æ–‡ç« ä¸€ä¸ªåˆ†ç±»</td></tr><tr><td>tags</td><td>æ— </td><td>æ–‡ç« æ ‡ç­¾ï¼Œä¸€ç¯‡æ–‡ç« å¯ä»¥å¤šä¸ªæ ‡ç­¾</td></tr><tr><td>keywords</td><td>æ–‡ç« æ ‡é¢˜</td><td>æ–‡ç« å…³é”®å­—ï¼ŒSEO æ—¶éœ€è¦</td></tr><tr><td>reprintPolicy</td><td>cc_by</td><td>æ–‡ç« è½¬è½½è§„åˆ™ï¼Œ å¯ä»¥æ˜¯ cc_by, cc_by_nd, cc_by_sa, cc_by_nc, cc_by_nc_nd, cc_by_nc_sa, cc0, noreprint æˆ– pay ä¸­çš„ä¸€ä¸ª</td></tr></tbody></table><blockquote><p><strong>æ³¨æ„</strong>:</p><ol><li>å¦‚æœ <code>img</code> å±æ€§ä¸å¡«å†™çš„è¯ï¼Œæ–‡ç« ç‰¹è‰²å›¾ä¼šæ ¹æ®æ–‡ç« æ ‡é¢˜çš„ <code>hashcode</code> çš„å€¼å–ä½™ï¼Œç„¶åé€‰å–ä¸»é¢˜ä¸­å¯¹åº”çš„ç‰¹è‰²å›¾ç‰‡ï¼Œä»è€Œè¾¾åˆ°è®©æ‰€æœ‰æ–‡ç« çš„ç‰¹è‰²å›¾<strong>å„æœ‰ç‰¹è‰²</strong>ã€‚</li><li><code>date</code> çš„å€¼å°½é‡ä¿è¯æ¯ç¯‡æ–‡ç« æ˜¯å”¯ä¸€çš„ï¼Œå› ä¸ºæœ¬ä¸»é¢˜ä¸­ <code>Gitalk</code> å’Œ <code>Gitment</code> è¯†åˆ« <code>id</code> æ˜¯é€šè¿‡ <code>date</code> çš„å€¼æ¥ä½œä¸ºå”¯ä¸€æ ‡è¯†çš„ã€‚</li><li>å¦‚æœè¦å¯¹æ–‡ç« è®¾ç½®é˜…è¯»éªŒè¯å¯†ç çš„åŠŸèƒ½ï¼Œä¸ä»…è¦åœ¨ Front-matter ä¸­è®¾ç½®é‡‡ç”¨äº† SHA256 åŠ å¯†çš„ password çš„å€¼ï¼Œè¿˜éœ€è¦åœ¨ä¸»é¢˜çš„ <code>_config.yml</code> ä¸­æ¿€æ´»äº†é…ç½®ã€‚æœ‰äº›åœ¨çº¿çš„ SHA256 åŠ å¯†çš„åœ°å€ï¼Œå¯ä¾›ä½ ä½¿ç”¨ï¼š<a href="http://tool.oschina.net/encrypt?type=2">å¼€æºä¸­å›½åœ¨çº¿å·¥å…·</a>ã€<a href="http://encode.chahuo.com/">chahuo</a>ã€<a href="http://tool.chinaz.com/tools/hash.aspx">ç«™é•¿å·¥å…·</a>ã€‚</li><li>æ‚¨å¯ä»¥åœ¨æ–‡ç« mdæ–‡ä»¶çš„ front-matter ä¸­æŒ‡å®š reprintPolicy æ¥ç»™å•ä¸ªæ–‡ç« é…ç½®è½¬è½½è§„åˆ™</li></ol></blockquote><p>ä»¥ä¸‹ä¸ºæ–‡ç« çš„ <code>Front-matter</code> ç¤ºä¾‹ã€‚</p><h4 id="æœ€ç®€ç¤ºä¾‹"><a href="#æœ€ç®€ç¤ºä¾‹" class="headerlink" title="æœ€ç®€ç¤ºä¾‹"></a>æœ€ç®€ç¤ºä¾‹</h4><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token front-matter-block"><span class="token punctuation">---</span><span class="token front-matter yaml language-yaml"><span class="token key atrule">title</span><span class="token punctuation">:</span> typora<span class="token punctuation">-</span>vue<span class="token punctuation">-</span>themeä¸»é¢˜ä»‹ç»<span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token datetime number">2018-09-07 09:25:00</span></span><span class="token punctuation">---</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h4 id="æœ€å…¨ç¤ºä¾‹"><a href="#æœ€å…¨ç¤ºä¾‹" class="headerlink" title="æœ€å…¨ç¤ºä¾‹"></a>æœ€å…¨ç¤ºä¾‹</h4><pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token front-matter-block"><span class="token punctuation">---</span><span class="token front-matter yaml language-yaml"><span class="token key atrule">title</span><span class="token punctuation">:</span> hexo<span class="token punctuation">-</span>githubæ­å»ºä¸ªäººåšå®¢æ•™ç¨‹<span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token datetime number">2025-04-22 09:25:00</span><span class="token key atrule">author</span><span class="token punctuation">:</span> å¢¨å®‡Logic<span class="token key atrule">img</span><span class="token punctuation">:</span> /source/images/xxx.jpg<span class="token key atrule">top</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token key atrule">hide</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">cover</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token key atrule">coverImg</span><span class="token punctuation">:</span> /images/1.jpg<span class="token key atrule">password</span><span class="token punctuation">:</span> 8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92<span class="token key atrule">toc</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">mathjax</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">summary</span><span class="token punctuation">:</span> è¿™æ˜¯ä½ è‡ªå®šä¹‰çš„æ–‡ç« æ‘˜è¦å†…å®¹ï¼Œå¦‚æœè¿™ä¸ªå±æ€§æœ‰å€¼ï¼Œæ–‡ç« å¡ç‰‡æ‘˜è¦å°±æ˜¾ç¤ºè¿™æ®µæ–‡å­—ï¼Œå¦åˆ™ç¨‹åºä¼šè‡ªåŠ¨æˆªå–æ–‡ç« çš„éƒ¨åˆ†å†…å®¹ä½œä¸ºæ‘˜è¦<span class="token key atrule">categories</span><span class="token punctuation">:</span> Markdown<span class="token key atrule">tags</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> Typora  <span class="token punctuation">-</span> Markdown</span><span class="token punctuation">---</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="æ–°å»ºæ–‡ç« æ¨¡æ¿ä¿®æ”¹"><a href="#æ–°å»ºæ–‡ç« æ¨¡æ¿ä¿®æ”¹" class="headerlink" title="æ–°å»ºæ–‡ç« æ¨¡æ¿ä¿®æ”¹"></a>æ–°å»ºæ–‡ç« æ¨¡æ¿ä¿®æ”¹</h4><p>é¦–å…ˆä¸ºäº†æ–°å»ºæ–‡ç« æ–¹ä¾¿ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹ä¸€ä¸‹æ–‡ç« æ¨¡æ¿ï¼Œå»ºè®®å°†<code>/scaffolds/post.md</code>ä¿®æ”¹ä¸ºå¦‚ä¸‹ä»£ç ï¼š</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span><span class="token key atrule">title</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> title <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> date <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token key atrule">author</span><span class="token punctuation">:</span> <span class="token key atrule">img</span><span class="token punctuation">:</span> <span class="token key atrule">coverImg</span><span class="token punctuation">:</span> <span class="token key atrule">top</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">cover</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">toc</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token key atrule">mathjax</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token key atrule">password</span><span class="token punctuation">:</span><span class="token key atrule">summary</span><span class="token punctuation">:</span><span class="token key atrule">tags</span><span class="token punctuation">:</span><span class="token key atrule">categories</span><span class="token punctuation">:</span><span class="token punctuation">---</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™æ ·æ–°å»ºæ–‡ç« å ä¸€äº›<code>Front-matter</code>å‚æ•°ä¸ç”¨ä½ è‡ªå·±è¡¥å……äº†ï¼Œä¿®æ”¹å¯¹åº”ä¿¡æ¯å°±å¯ä»¥äº†ã€‚</p><h3 id="è‡ªå®šåˆ¶ä¿®æ”¹"><a href="#è‡ªå®šåˆ¶ä¿®æ”¹" class="headerlink" title="è‡ªå®šåˆ¶ä¿®æ”¹"></a>è‡ªå®šåˆ¶ä¿®æ”¹</h3><p>åœ¨æœ¬ä¸»é¢˜çš„ <code>_config.yml</code> ä¸­å¯ä»¥ä¿®æ”¹éƒ¨åˆ†è‡ªå®šä¹‰ä¿¡æ¯ï¼Œæœ‰ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š</p><ul><li>èœå•</li><li>æˆ‘çš„æ¢¦æƒ³</li><li>é¦–é¡µçš„éŸ³ä¹æ’­æ”¾å™¨å’Œè§†é¢‘æ’­æ”¾å™¨é…ç½®</li><li>æ˜¯å¦æ˜¾ç¤ºæ¨èæ–‡ç« åç§°å’ŒæŒ‰é’®é…ç½®</li><li><code>favicon</code> å’Œ <code>Logo</code></li><li>ä¸ªäººä¿¡æ¯</li><li>TOC ç›®å½•</li><li>æ–‡ç« æ‰“èµä¿¡æ¯</li><li>å¤åˆ¶æ–‡ç« å†…å®¹æ—¶è¿½åŠ ç‰ˆæƒä¿¡æ¯</li><li>MathJax</li><li>æ–‡ç« å­—æ•°ç»Ÿè®¡ã€é˜…è¯»æ—¶é•¿</li><li>ç‚¹å‡»é¡µé¢çš„â€™çˆ±å¿ƒâ€™æ•ˆæœ</li><li>æˆ‘çš„é¡¹ç›®</li><li>æˆ‘çš„æŠ€èƒ½</li><li>æˆ‘çš„ç›¸å†Œ</li><li><code>Gitalk</code>ã€<code>Gitment</code>ã€<code>Valine</code> å’Œ <code>disqus</code> è¯„è®ºé…ç½®</li><li><a href="http://busuanzi.ibruce.info/">ä¸è’œå­ç»Ÿè®¡</a>å’Œè°·æ­Œåˆ†æï¼ˆ<code>Google Analytics</code>ï¼‰</li><li>é»˜è®¤ç‰¹è‰²å›¾çš„é›†åˆã€‚å½“æ–‡ç« æ²¡æœ‰è®¾ç½®ç‰¹è‰²å›¾æ—¶ï¼Œæœ¬ä¸»é¢˜ä¼šæ ¹æ®æ–‡ç« æ ‡é¢˜çš„ <code>hashcode</code> å€¼å–ä½™ï¼Œæ¥é€‰æ‹©å±•ç¤ºå¯¹åº”çš„ç‰¹è‰²å›¾</li></ul><p><strong>æˆ‘è®¤ä¸ºä¸ªäººåšå®¢åº”è¯¥éƒ½æœ‰è‡ªå·±çš„é£æ ¼å’Œç‰¹è‰²</strong>ã€‚å¦‚æœæœ¬ä¸»é¢˜ä¸­çš„è¯¸å¤šåŠŸèƒ½å’Œä¸»é¢˜è‰²å½©ä½ ä¸æ»¡æ„ï¼Œå¯ä»¥åœ¨ä¸»é¢˜ä¸­è‡ªå®šä¹‰ä¿®æ”¹ï¼Œå¾ˆå¤šæ›´è‡ªç”±çš„åŠŸèƒ½å’Œç»†èŠ‚ç‚¹çš„ä¿®æ”¹éš¾ä»¥åœ¨ä¸»é¢˜çš„ <code>_config.yml</code> ä¸­å®Œæˆï¼Œéœ€è¦ä¿®æ”¹æºä»£ç æ‰æ¥å®Œæˆã€‚ä»¥ä¸‹åˆ—å‡ºäº†å¯èƒ½å¯¹ä½ æœ‰ç”¨çš„åœ°æ–¹ï¼š</p><h3 id="ä¿®æ”¹ä¸»é¢˜é¢œè‰²"><a href="#ä¿®æ”¹ä¸»é¢˜é¢œè‰²" class="headerlink" title="ä¿®æ”¹ä¸»é¢˜é¢œè‰²"></a>ä¿®æ”¹ä¸»é¢˜é¢œè‰²</h3><p>åœ¨ä¸»é¢˜æ–‡ä»¶çš„ <code>/source/css/matery.css</code> æ–‡ä»¶ä¸­ï¼Œæœç´¢ <code>.bg-color</code> æ¥ä¿®æ”¹èƒŒæ™¯é¢œè‰²ï¼š</p><pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token comment">/* æ•´ä½“èƒŒæ™¯é¢œè‰²ï¼ŒåŒ…æ‹¬å¯¼èˆªã€ç§»åŠ¨ç«¯çš„å¯¼èˆªã€é¡µå°¾ã€æ ‡ç­¾é¡µç­‰çš„èƒŒæ™¯é¢œè‰². */</span><span class="token selector">.bg-color</span> <span class="token punctuation">{</span>    <span class="token property">background-image</span><span class="token punctuation">:</span> <span class="token function">linear-gradient</span><span class="token punctuation">(</span>to right<span class="token punctuation">,</span> #4cbf30 0%<span class="token punctuation">,</span> #0f9d58 100%<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token atrule"><span class="token rule">@-webkit-keyframes</span> rainbow</span> <span class="token punctuation">{</span>   <span class="token comment">/* åŠ¨æ€åˆ‡æ¢èƒŒæ™¯é¢œè‰². */</span><span class="token punctuation">}</span><span class="token atrule"><span class="token rule">@keyframes</span> rainbow</span> <span class="token punctuation">{</span>    <span class="token comment">/* åŠ¨æ€åˆ‡æ¢èƒŒæ™¯é¢œè‰². */</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ä¿®æ”¹-banner-å›¾å’Œæ–‡ç« ç‰¹è‰²å›¾"><a href="#ä¿®æ”¹-banner-å›¾å’Œæ–‡ç« ç‰¹è‰²å›¾" class="headerlink" title="ä¿®æ”¹ banner å›¾å’Œæ–‡ç« ç‰¹è‰²å›¾"></a>ä¿®æ”¹ banner å›¾å’Œæ–‡ç« ç‰¹è‰²å›¾</h3><p>ä½ å¯ä»¥ç›´æ¥åœ¨ <code>/source/medias/banner</code> æ–‡ä»¶å¤¹ä¸­æ›´æ¢ä½ å–œæ¬¢çš„ <code>banner</code> å›¾ç‰‡ï¼Œä¸»é¢˜ä»£ç ä¸­æ˜¯æ¯å¤©åŠ¨æ€åˆ‡æ¢ä¸€å¼ ï¼Œåªéœ€ <code>7</code> å¼ å³å¯ã€‚å¦‚æœä½ ä¼š <code>JavaScript</code> ä»£ç ï¼Œå¯ä»¥ä¿®æ”¹æˆä½ è‡ªå·±å–œæ¬¢åˆ‡æ¢é€»è¾‘ï¼Œå¦‚ï¼šéšæœºåˆ‡æ¢ç­‰ï¼Œ<code>banner</code> åˆ‡æ¢çš„ä»£ç ä½ç½®åœ¨ <code>/layout/_partial/bg-cover-content.ejs</code> æ–‡ä»¶çš„ <code>&lt;script&gt;&lt;/script&gt;</code> ä»£ç ä¸­ï¼š</p><pre class="line-numbers language-ejs" data-language="ejs"><code class="language-ejs">$('.bg-cover').css('background-image', 'url(/medias/banner/' + new Date().getDay() + '.jpg)');<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>åœ¨ <code>/source/medias/featureimages</code> æ–‡ä»¶å¤¹ä¸­é»˜è®¤æœ‰ 24 å¼ ç‰¹è‰²å›¾ç‰‡ï¼Œä½ å¯ä»¥å†å¢åŠ æˆ–è€…å‡å°‘ï¼Œå¹¶éœ€è¦åœ¨ <code>_config.yml</code> åšåŒæ­¥ä¿®æ”¹ã€‚</p><h3 id="å›¾åºŠ"><a href="#å›¾åºŠ" class="headerlink" title="å›¾åºŠ"></a>å›¾åºŠ</h3><p>å½“åšæ–‡ä¸­æœ‰å›¾ç‰‡æ—¶ï¼Œè‹¥æ˜¯å°‘é‡å›¾ç‰‡ï¼Œå¯ä»¥ç›´æ¥æŠŠå›¾ç‰‡å­˜æ”¾åœ¨ <code>source</code> æ–‡ä»¶å¤¹ä¸­ï¼Œä½†è¿™æ˜¾ç„¶ä¸åˆç†çš„ï¼Œå› ä¸ºå›¾ç‰‡ä¼šå æ®å¤§é‡çš„å­˜å‚¨çš„ç©ºé—´ï¼ŒåŠ è½½çš„æ—¶å€™ç›¸å¯¹ç¼“æ…¢ ï¼Œè¿™æ—¶è€ƒè™‘æŠŠåšæ–‡é‡Œçš„å›¾ç‰‡ä¸Šä¼ åˆ°æŸä¸€ç½‘ç«™ï¼Œç„¶åè·å¾—å¤–éƒ¨é“¾æ¥ï¼Œä½¿ç”¨ <code>Markdown</code> è¯­æ³•ï¼Œ<code>![å›¾ç‰‡ä¿¡æ¯](å¤–éƒ¨é“¾æ¥)</code> å®Œæˆå›¾ç‰‡çš„æ’å…¥ï¼Œè¿™ç§ç½‘ç«™å°±è¢«æˆä¸ºå›¾åºŠã€‚</p><p>æˆ‘ç”¨çš„å›¾åºŠï¼š<a href="https://www.superbed.cn/">èšåˆå›¾åºŠ</a></p><h2 id="å…­ã€åšå®¢ç»´æŠ¤"><a href="#å…­ã€åšå®¢ç»´æŠ¤" class="headerlink" title="å…­ã€åšå®¢ç»´æŠ¤"></a>å…­ã€åšå®¢ç»´æŠ¤</h2><p>åˆ°æ­¤ä¸ºæ­¢ï¼Œæˆ‘ä»¬çš„ä¸ªäººåšå®¢å°±å½»åº•æ­å»ºå®Œæˆå•¦ã€‚åç»­æˆ‘ä»¬åªéœ€è¦ä¿®æ”¹åšå®¢çš„é…ç½®æ–‡ä»¶å’Œåšå®¢æœ¬èº«çš„markdownæºæ–‡ä»¶ï¼Œç„¶åæ‰§è¡Œå‘½ä»¤ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hexo clean <span class="token operator">&amp;&amp;</span> hexo g <span class="token operator">&amp;&amp;</span> hexo d<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è¿™æ ·æˆ‘ä»¬å°±èƒ½å°†æˆ‘ä»¬ä¿®æ”¹åçš„å†…å®¹ä¸Šä¼ åˆ°GitHubï¼Œç„¶åNetlifyä¼šè‡ªåŠ¨åŒæ­¥ï¼Œå°†ç”Ÿæˆåœ¨publicæ–‡ä»¶å¤¹ä¸­çš„é™æ€ç½‘é¡µéƒ¨ç½²å‡ºå»ã€‚</p><p><strong>æ›´å¤šå®ç”¨æ–‡ç« å’ŒAIå¤§æ¨¡å‹åº”ç”¨å¼€å‘æ–‡ç« æ¬¢è¿åˆ°æˆ‘ä¸ªäººåšå®¢æ¥è§‚çœ‹ï¼š</strong><a href="https://blog.csdn.net/etrospect/article/details/blog.ismoyu.cn">å¢¨å®‡Logic</a></p>]]></content>
      
      
      <categories>
          
          <category> åšå®¢æ­å»ºæ•™ç¨‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Markdown </tag>
            
            <tag> css </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
